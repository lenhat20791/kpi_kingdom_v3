<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>H·ªçc Vi·ªán KPI - H·ªì S∆° Nh√¢n V·∫≠t</title>
        
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="css/skills.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paper': '#fdf6e3',       /* M√†u gi·∫•y c·ªï */
                        'ink': '#2c3e50',         /* M√†u m·ª±c xanh ƒëen */
                        'warrior-red': '#c0392b', /* ƒê·ªè chi·∫øn binh */
                        'warrior-gold': '#d35400',/* V√†ng ƒë·ªìng */
                        'mage-blue': '#2980b9',   /* Xanh ph√°p s∆∞ */
                        'mage-silver': '#7f8c8d'  /* B·∫°c */
                    },
                    fontFamily: {
                        'rpg': ['Cinzel', 'serif'], /* Font ti√™u ƒë·ªÅ Game */
                        'body': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Hi·ªáu ·ª©ng n·ªÅn gi·∫•y */
        body {
            background-color: #fdf6e3;
            background-image: radial-gradient(#e6dab3 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Scrollbar ƒë·∫πp */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1e7c8; }
        ::-webkit-scrollbar-thumb { background: #d4ac0d; border-radius: 4px; }

        /* Card 3D Effect */
        .rpg-card {
            background: white;
            border: 2px solid #e2d1a3;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .rpg-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Hero Frame Animation */
        .hero-frame {
            position: relative;
            z-index: 10;
        }
        .hero-frame::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(45deg, #d4ac0d, #f1c40f, #d4ac0d);
            z-index: -1;
            border-radius: 1rem;
            animation: border-glow 3s infinite linear;
        }
        @keyframes border-glow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        /*chuy·ªÉn c·∫£nh tab*/
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #fef3c7; }
        /* --- CSS CHO TH√ÅP TH√ç LUY·ªÜN --- */
        .tower-bg {
            background-image: url('/assets/background/thap.png');
            background-size: cover;
            background-position: center;
        }

        /* --- BOSS BATTLE STYLES --- */

        /* --- 1. ANIMATION (Kh·ªõp v·ªõi value trong Admin) --- */
        /* Stand: Kh√¥ng c·∫ßn CSS v√¨ m·∫∑c ƒë·ªãnh l√† ƒë·ª©ng y√™n */
        
        .anim-float { animation: bossFloat 3s ease-in-out infinite; }
        @keyframes bossFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .anim-breathe { animation: bossBreathe 4s ease-in-out infinite; }
        @keyframes bossBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .anim-shake { animation: bossShake 0.5s infinite; }
        @keyframes bossShake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            75% { transform: translate(3px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(1deg); }
        }

        /* --- C·∫¨P NH·∫¨T VFX (FIX L·ªñI KH√îNG HI·ªÜN) --- */
        .vfx-container {
            position: absolute;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50; /* ƒê·∫£m b·∫£o cao h∆°n ·∫£nh Boss (z-10) */
            border-radius: 20px;
            overflow: hidden;
        }

        /* --- C·∫¨P NH·∫¨T VFX (FIX L·ªñI L·ªÜCH TR√ÅI & TR·ªêNG PH·∫¢I) --- */
    
        /* --- C·∫¨P NH·∫¨T VFX (FIX L·ªÜCH: D·ªúI SANG PH·∫¢I & TƒÇNG M·∫¨T ƒê·ªò) --- */
        
        .vfx-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 50; 
            border-radius: 20px;
            overflow: hidden;
        }

        /* üî• T√†n L·ª≠a (ƒê√£ d·ªùi sang ph·∫£i) */
        .vfx-fire {
            position: absolute;
            top: 0; left: 0;
            
            /* M·ªü r·ªông chi·ªÅu ngang l√™n 120% ƒë·ªÉ d∆∞ ra che l·∫•p c√°c g√≥c tr·ªëng */
            width: 120%; 
            left: -10%; /* CƒÉn ch·ªânh l·∫°i ƒë·ªÉ kh√¥ng b·ªã h·ªü b√™n tr√°i */
            
            height: 100%;
            z-index: 51;
            
            background-repeat: repeat;
            
            /* V·∫Ω th√™m nhi·ªÅu h·∫°t ·ªü t·ªça ƒë·ªô > 50% (B√™n ph·∫£i) */
            background-image: 
                radial-gradient(2px 2px at 10% 90%, rgba(255, 160, 0, 0.9), transparent),
                radial-gradient(3px 3px at 30% 80%, rgba(255, 69, 0, 0.9), transparent),
                radial-gradient(2px 2px at 50% 70%, rgba(255, 200, 50, 0.9), transparent),
                /* üëá Khu v·ª±c b√™n ph·∫£i (60-95%) ƒë∆∞·ª£c th√™m h·∫°t d√†y ƒë·∫∑c h∆°n */
                radial-gradient(4px 4px at 70% 60%, rgba(255, 100, 0, 0.9), transparent),
                radial-gradient(2px 2px at 80% 50%, rgba(255, 215, 0, 0.9), transparent),
                radial-gradient(3px 3px at 90% 40%, rgba(255, 80, 0, 0.8), transparent),
                radial-gradient(2px 2px at 95% 30%, rgba(255, 180, 0, 0.9), transparent),
                radial-gradient(3px 3px at 85% 20%, rgba(255, 120, 0, 0.9), transparent),
                radial-gradient(2px 2px at 60% 10%, rgba(255, 255, 255, 0.9), transparent);

            background-size: 250px 250px;
            filter: drop-shadow(0 0 4px rgba(255, 69, 0, 1));
            
            animation: emberFloat 3s linear infinite;
        }

        @keyframes emberFloat {
            /* D·ªãch tr·ª•c X t·ª´ 'center' sang '65%' ƒë·ªÉ ƒë·∫©y hi·ªáu ·ª©ng qua ph·∫£i */
            0% { background-position: 65% 250px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { background-position: 65% 0; opacity: 0; }
        }

        /* ‚ùÑÔ∏è Tuy·∫øt r∆°i (ƒê√£ d·ªùi sang ph·∫£i) */
        /* ‚ùÑÔ∏è Tuy·∫øt r∆°i (B·∫£n Fix L·ªói L·ªách & Tr·ªëng Ph·∫£i) */
        .vfx-snow {
            position: absolute;
            top: 0; left: 0;
            
            /* M·ªü r·ªông 120% ƒë·ªÉ l·∫•p ƒë·∫ßy 2 b√™n */
            width: 120%; 
            left: -10%; 
            
            height: 100%;
            z-index: 51;
            pointer-events: none;
            
            /* L·∫∑p l·∫°i ƒë·ªÉ kh√¥ng b·ªã kho·∫£ng tr·ªëng */
            background-repeat: repeat;
            background-position: center top;
            
            /* T·∫°o h·∫°t tuy·∫øt r∆°i */
            background-image: 
                radial-gradient(3px 3px at 20% 10%, #fff, transparent), 
                radial-gradient(4px 4px at 40% 30%, #fff, transparent), 
                radial-gradient(3px 3px at 60% 50%, #fff, transparent), /* Th√™m h·∫°t gi·ªØa */
                radial-gradient(5px 5px at 80% 70%, #fff, transparent), /* Th√™m h·∫°t ph·∫£i */
                radial-gradient(3px 3px at 95% 90%, #fff, transparent);
                
            background-size: 200px 200px;
            animation: snowFall 4s linear infinite;
        }
        
        @keyframes snowFall { 
            /* D·ªãch chuy·ªÉn ch√©o nh·∫π ƒë·ªÉ t·∫°o c·∫£m gi√°c t·ª± nhi√™n */
            0% { background-position: 50% 0; } 
            100% { background-position: 55% 200px; } 
        }

        /* 3. Damage Popup (S·ªë v√†ng n·∫£y l√™n) */
        .damage-number {
            position: absolute;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 900;
            font-size: 2.5rem;
            color: #fbbf24; /* V√†ng */
            text-shadow: 3px 3px 0px #7f1d1d; /* Vi·ªÅn ƒë·ªè ƒë·∫≠m */
            pointer-events: none; /* ƒê·ªÉ ko che chu·ªôt */
            animation: popupRise 1s forwards ease-out;
            z-index: 100;
        }

        @keyframes popupRise {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1); opacity: 0; }
        }

        

        /* =========================================
        üè™ CSS TI·ªÜM T·∫†P H√ìA (STYLE K·ªÜ G·ªñ)
        ========================================= */

        /* 1. KHUNG V·∫¨T PH·∫®M (Item Card) */
        .shop-item {
            position: relative; /* ƒê·ªÉ cƒÉn ch·ªânh c√°i k·ªá g·ªó b√™n d∆∞·ªõi */
            background-color: #fff8e1; /* M√†u gi·∫•y c≈© (Parchment) */
            border: 1px solid #d7ccc8;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            
            /* ƒê·∫£m b·∫£o item kh√¥ng b·ªã co qu√° nh·ªè */
            min-width: 160px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Hi·ªáu ·ª©ng nh·∫•c l√™n khi di chu·ªôt */
        .shop-item:hover {
            transform: translateY(-8px); /* Bay l√™n */
            box-shadow: 0 10px 15px rgba(0,0,0,0.4);
            z-index: 10;
        }

        /* 2. T·∫†O C√ÅI K·ªÜ G·ªñ (D√πng ::after) */
        /* ƒê√¢y l√† m·∫•u ch·ªët: V·∫Ω m·ªôt kh·ªëi m√†u n√¢u d∆∞·ªõi ch√¢n m·ªói item */
        .shop-item::after {
            content: "";
            position: absolute;
            bottom: -12px; /* N·∫±m d∆∞·ªõi item 12px */
            left: -10px;   /* B√® ra 2 b√™n 1 ch√∫t */
            right: -10px;
            height: 12px;  /* ƒê·ªô d√†y c·ªßa t·∫•m g·ªó */
            
            background-color: #5d4037; /* M√†u g·ªó n√¢u */
            border-top: 3px solid #3e2723; /* V√¢n g·ªó ƒë·∫≠m ph√≠a tr√™n */
            border-radius: 2px;
            box-shadow: 0 5px 8px rgba(0,0,0,0.5); /* B√≥ng ƒë·ªï xu·ªëng n·ªÅn */
            z-index: -1; /* N·∫±m ch√¨m xu·ªëng d∆∞·ªõi item */
        }

        /* 3. ·∫¢NH V·∫¨T PH·∫®M */
        .shop-item img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            margin: 0 auto 10px auto;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
        }

        /* 4. T√äN & M√î T·∫¢ */
        .shop-item h4 {
            color: #3e2723;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
            /* Gi·ªõi h·∫°n 2 d√≤ng t√™n */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .shop-item .desc {
            font-size: 11px;
            color: #6d4c41;
            font-style: italic;
            margin-bottom: 10px;
            height: 32px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho m√¥ t·∫£ */
            overflow: hidden;
        }

        /* 5. N√öT MUA (C∆° b·∫£n) */
        .btn-buy {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            transition: filter 0.2s;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-buy:hover { filter: brightness(1.2); }
        .btn-buy:active { transform: scale(0.95); }

        /* 6. M√ÄU N√öT THEO LO·∫†I TI·ªÄN (Kh·ªõp v·ªõi API) */
        /* Xanh d∆∞∆°ng: Tri th·ª©c */
        .btn-buy.cost-tri_thuc { 
            background: linear-gradient(to bottom, #42a5f5, #1e88e5); 
            box-shadow: 0 3px 0 #1565c0;
        }
        /* V√†ng cam: Vinh d·ª± */
        .btn-buy.cost-vinh_du { 
            background: linear-gradient(to bottom, #ffa726, #f57c00); 
            box-shadow: 0 3px 0 #e65100;
        }
        /* ƒê·ªè: Chi·∫øn t√≠ch */
        .btn-buy.cost-chien_tich { 
            background: linear-gradient(to bottom, #ef5350, #d32f2f); 
            box-shadow: 0 3px 0 #b71c1c;
        }
        /* 1. N√öT ƒêI·ªÄU KHI·ªÇN */
        .toggle-btn {
            position: fixed;
            top: 15px; /* C√°ch ƒë·ªânh 15px */
            left: 15px; /* C√°ch tr√°i 15px */
            z-index: 9999; /* Lu√¥n n·ªïi tr√™n c√πng */
            
            padding: 8px 16px;
            background-color: #b45f06; /* M√†u cam gi·ªëng theme c·ªßa b·∫°n */
            color: white;
            border: 2px solid #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background-color: #8c4a04;
            transform: scale(1.05);
        }

        /* 2. SIDEBAR CUSTOM (Ghi ƒë√® l√™n Tailwind khi c·∫ßn) */
        .sidebar-custom {
            transition: all 0.3s ease-in-out !important; /* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t */
            position: relative; /* M·∫∑c ƒë·ªãnh ƒë·ªÉ n√≥ n·∫±m trong d√≤ng ch·∫£y flex */
            left: 0;
        }

        /* KHI ·∫®N: D√πng fixed ƒë·ªÉ tr∆∞·ª£t h·∫≥n ra ngo√†i m√†n h√¨nh */
        .sidebar-custom.hidden-sidebar {
            position: fixed !important;
            left: -300px !important; /* ƒê·∫©y khu·∫•t sang tr√°i */
            height: 100vh;
            z-index: 9000;
        }

        /* 3. N·ªòI DUNG CH√çNH */
        /* Khi menu ·∫©n th√¨ n·ªôi dung c·∫ßn bung ra */
        #main-content {
            transition: all 0.3s ease;
        }
    </style>
</head>

<body class="font-body text-ink antialiased h-screen flex overflow-hidden">
    <button id="toggle-btn" class="toggle-btn" onclick="toggleSidebar()">
        ·∫®n Menu
    </button>
    <aside id="sidebar" class="sidebar-custom w-64 bg-amber-50 shadow-xl hidden md:flex flex-col border-r border-amber-200">
        <div class="p-6 border-b border-amber-200 text-center">
            <h1 class="text-2xl font-bold text-amber-800 font-cinzel">
                <i class="fas fa-shield-alt text-amber-600"></i> KPI KINGDOM
            </h1>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
    
            <div id="menu-group-admin" class="hidden">
                <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2">Qu·∫£n Tr·ªã T·ªï</p>
                
                <a href="#" onclick="switchMainScreen('team-manager'); loadFreeAgents(); return false;" 
                    class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                    <i class="fas fa-crown w-6 text-center mr-2 text-yellow-600"></i> Qu·∫£n L√Ω T·ªï
                </a>
                
                <a href="#" id="nav-grading" onclick="switchMainScreen('grading'); return false;" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                    <i class="fas fa-pen-nib w-6 text-center mr-2 text-blue-600"></i> Nh·∫≠p ƒêi·ªÉm
                </a>
                
                
                <div class="border-b border-amber-200 my-2 mx-6"></div>
            </div>

            <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2">Nh√¢n V·∫≠t & T√†i S·∫£n</p>
            
            <a href="#" onclick="switchMainScreen('dashboard'); return false;" id="nav-dashboard" class="flex items-center px-6 py-3 bg-amber-100 text-amber-900 font-bold border-r-4 border-amber-600 transition-all cursor-pointer">
                <i class="fas fa-home w-6 text-center mr-2"></i> T·ªïng Quan
            </a>
            
            <a href="#" onclick="switchMainScreen('inventory'); return false;" id="nav-inventory" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-50 hover:text-amber-900 transition-all cursor-pointer">
                <i class="fas fa-suitcase w-6 text-center mr-2 text-yellow-700"></i> T√∫i ƒê·ªì & Ch·ª£ ƒêen 
            </a>
            
            <a href="#" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fas fa-paw w-6 text-center mr-2 text-orange-500"></i> B·∫°n ƒê·ªìng H√†nh
            </a>

            <a href="#" onclick="switchMainScreen('skills'); return false;" id="nav-skills" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fas fa-book-journal-whills w-6 text-center mr-2 text-indigo-600"></i> B√≠ K√≠p K·ªπ NƒÉng
            </a>

            <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4">Ho·∫°t ƒê·ªông & Chi·∫øn ƒê·∫•u</p>
            
            <a href="#" onclick="switchMainScreen('arena'); return false;" id="nav-arena" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors relative">
                <i class="fas fa-fort-awesome w-6 text-center mr-2 text-red-600"></i> L√¥i ƒê√†i
                
                <span id="nav-arena-badge" class="hidden absolute right-4 top-3 w-3 h-3 bg-red-600 rounded-full animate-pulse border border-white"></span>
            </a>
            
            <a href="#" onclick="switchMainScreen('tower'); return false;" id="nav-tower" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fab fa-fort-awesome w-6 text-center mr-2 text-gray-600"></i> Th√°p Th√≠ Luy·ªán
            </a>

            <a href="#" onclick="switchMainScreen('boss')" data-tab="boss" 
                class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fas fa-dragon w-6 text-center mr-2 text-red-800"></i> ƒê·∫°i Chi·∫øn Boss
            </a>

            <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4">H·ªá Th·ªëng</p>
            
            <a href="#" onclick="switchMainScreen('shop')" class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fas fa-store w-6 text-center mr-2 text-green-600"></i> Ti·ªám T·∫°p H√≥a
            </a>
            <a href="#" onclick="openChangePassModal(); return false;" 
                class="flex items-center px-6 py-3 text-gray-700 hover:bg-amber-100 hover:text-amber-900 transition-colors">
                <i class="fas fa-key w-6 text-center mr-2 text-blue-600"></i> ƒê·ªïi M·∫≠t Kh·∫©u
            </a>
            <div class="mt-auto border-t border-amber-200 mt-4 pt-2">
                <a href="#" onclick="logout(); return false;" class="flex items-center px-6 py-3 text-red-600 hover:bg-red-50 transition-colors">
                    <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i> 
                    <span class="font-bold">ƒêƒÉng Xu·∫•t</span>
                </a>
            </div>
        </nav>
        
        <div class="p-4 bg-amber-100 border-t border-amber-200 flex items-center">
            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-gray-600 mr-3">
                US
            </div>
            <div>
                <p id="mini-name" class="text-sm font-bold text-gray-800">H·ªçc Sinh</p>
                <p class="text-xs text-gray-500">Level <span id="mini-level">1</span></p>
            </div>
        </div>
    </aside>

        <main id="main-content" class="flex-1 flex flex-col h-full overflow-y-auto relative bg-gray-50">

            <div id="main-view-dashboard" class="flex flex-col h-full w-full animate-fade-in">
                
                <header class="h-16 bg-white/90 backdrop-blur border-b border-[#e2d1a3] flex items-center justify-between px-6 shadow-sm z-10">
                    <h1 class="font-rpg text-xl font-bold text-yellow-800">
                        <i class="fa-solid fa-scroll mr-2"></i> H·ªì S∆° Chi·∫øn Binh
                    </h1>
                    
                    <div class="flex space-x-4">
                        <div class="flex items-center bg-blue-50 px-3 py-1 rounded-full border border-blue-200">
                            <i class="fa-solid fa-book text-blue-500 mr-2"></i>
                            <span id="wallet-exp" class="font-bold text-blue-700">0</span>
                        </div>
                        <div class="flex items-center bg-yellow-50 px-3 py-1 rounded-full border border-yellow-200">
                            <i class="fa-solid fa-coins text-yellow-500 mr-2"></i>
                            <span id="wallet-gold" class="font-bold text-yellow-700">0</span>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-6 lg:p-8">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-7xl mx-auto">
                        <div class="lg:col-span-4 space-y-6">
                            <div id="hero-card-container" class="rpg-card rounded-2xl p-1 hero-frame bg-white">
                                <div class="relative h-96 rounded-xl overflow-hidden bg-gray-200 group">
                                    <img id="hero-image" class="w-full h-full object-cover transition duration-500 group-hover:scale-105" 
                                        src="https://placehold.co/400x600/e2e8f0/475569?text=Loading..." alt="Hero">
                                    
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-6 pt-20 text-white">
                                        <div class="flex justify-between items-end mb-2">
                                            <div>
                                                <div id="hero-class" class="text-xs font-bold uppercase tracking-wider text-yellow-400 mb-1">...</div>
                                                <h2 id="hero-name" class="font-rpg text-2xl font-bold leading-none">ƒêang t·∫£i...</h2>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-xs text-gray-400 uppercase">Level</div>
                                                <div id="hero-level" class="font-rpg text-2xl font-bold text-white">1</div>
                                            </div>
                                        </div>

                                        <div class="space-y-3 mt-4">
                                            <div>
                                                <div class="flex justify-between text-xs font-bold mb-1">
                                                    <span class="text-red-400"><i class="fa-solid fa-heart mr-1"></i> HP (Sinh M·ªánh)</span>
                                                    <span id="hp-text">100/100</span>
                                                </div>
                                                <div class="w-full bg-gray-700 rounded-full h-3 border border-gray-600">
                                                    <div id="hp-bar" class="bg-red-500 h-2.5 rounded-full transition-all duration-1000" style="width: 100%"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="flex justify-between text-xs font-bold mb-1">
                                                    <span class="text-blue-400"><i class="fa-solid fa-fire mr-1"></i> ATK (S·ª©c M·∫°nh)</span>
                                                    <span id="atk-text">0</span>
                                                </div>
                                                <div class="w-full bg-gray-700 rounded-full h-3 border border-gray-600">
                                                    <div id="atk-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-8 space-y-6">
                
                            <div class="rpg-card rounded-xl p-5 bg-white border border-blue-100 shadow-sm relative overflow-hidden">
                                <div class="absolute right-0 top-0 opacity-10 pointer-events-none">
                                    <i class="fas fa-bolt text-8xl text-blue-500 -mr-4 -mt-4"></i>
                                </div>

                                <div class="relative z-10">
                                    <div class="flex justify-between items-end mb-3">
                                        <div class="flex items-center gap-3">
                                            <div class="bg-gradient-to-br from-yellow-400 to-orange-600 text-white px-3 py-1 rounded-lg shadow-md border-b-4 border-orange-700 flex items-center gap-2 transform hover:scale-105 transition-transform cursor-default">
                                                <i class="fas fa-crown text-sm animate-bounce"></i> 
                                                <span class="font-bold text-xs uppercase opacity-80 tracking-wider">LEVEL</span>
                                                <span id="progress-level-number" class="font-black text-2xl drop-shadow-md">1</span>
                                            </div>
                                            
                                            <span class="text-xs text-gray-400 italic hidden sm:block" id="exp-message">ƒêang t·∫£i...</span>
                                        </div>

                                        <span class="font-mono text-sm font-bold text-blue-800 bg-blue-50 px-2 py-1 rounded border border-blue-100">
                                            <span id="current-exp" class="text-blue-600 text-lg">0</span> 
                                            <span class="text-gray-400">/</span> 
                                            <span id="next-level-exp" class="text-gray-500">100</span> <span class="text-[10px] uppercase">EXP</span>
                                        </span>
                                    </div>
                                    
                                    <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner border border-gray-300 relative overflow-hidden">
                                        <div id="exp-bar-width" 
                                            class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-1 shadow-[0_0_10px_rgba(37,99,235,0.5)]" 
                                            style="width: 0%">
                                            <div class="h-full w-full absolute top-0 left-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImEiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgNDBMMzAgMEg0MEwxMCA0MHoiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNhKSIvPjwvc3ZnPg==')] animate-[moveStripe_1s_linear_infinite]"></div>
                                            <div class="h-2 w-2 bg-white rounded-full opacity-80 animate-ping mr-1"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="sm:hidden mt-2 text-center">
                                        <span class="text-xs text-gray-400 italic" id="exp-message-mobile"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                
                                <div class="rpg-card rounded-xl p-4 border-l-4 border-l-yellow-500 bg-white shadow-sm hover:-translate-y-1 transition-transform duration-300">
                                    <div class="text-xs text-gray-500 uppercase font-bold">KPI T·ªïng</div>
                                    <div id="stat-kpi" class="text-2xl font-rpg font-bold text-yellow-600 mt-1">0</div>
                                    <div class="text-xs text-gray-400 mt-1">X·∫øp h·∫°ng l·ªõp</div>
                                </div>

                                <div class="rpg-card rounded-xl p-4 border-l-4 border-l-red-500 bg-white relative overflow-hidden shadow-sm hover:-translate-y-1 transition-transform duration-300">
                                    <div class="text-xs text-red-500 uppercase font-bold">Vi Ph·∫°m</div>
                                    <div id="stat-violation" class="text-2xl font-rpg font-bold text-red-600 mt-1">0</div>
                                    <i class="fa-solid fa-triangle-exclamation absolute -right-2 -bottom-2 text-6xl text-red-50 opacity-20"></i>
                                </div>

                                <div class="rpg-card rounded-xl p-4 border-l-4 border-l-orange-500 bg-white shadow-sm hover:-translate-y-1 transition-transform duration-300">
                                    <div class="text-xs text-gray-500 uppercase font-bold">Chi·∫øn T√≠ch</div>
                                    <div id="stat-chientich" class="text-2xl font-rpg font-bold text-orange-600 mt-1">0</div>
                                    <div class="text-xs text-gray-400 mt-1">Ruby</div>
                                </div>

                                <div class="rpg-card rounded-xl p-4 border-l-4 border-l-purple-500 bg-white shadow-sm hover:-translate-y-1 transition-transform duration-300">
                                    <div class="text-xs text-gray-500 uppercase font-bold">Vinh D·ª±</div>
                                    <div id="stat-vinhdu" class="text-2xl font-rpg font-bold text-purple-600 mt-1">0</div>
                                    <div class="text-xs text-gray-400 mt-1">Badge</div>
                                </div>

                                <div class="rpg-card rounded-xl p-4 border-l-4 border-l-cyan-500 bg-white shadow-sm hover:-translate-y-1 transition-transform duration-300">
                                    <div class="text-xs text-gray-500 uppercase font-bold">Tri Th·ª©c</div>
                                    <div id="stat-trithuc" class="text-2xl font-rpg font-bold text-cyan-600 mt-1">0</div>
                                    <div class="text-xs text-gray-400 mt-1">Gold</div>
                                </div>
                            </div>

                            <div class="rpg-card rounded-xl bg-white overflow-hidden shadow-sm">
                                <div class="bg-amber-50 px-6 py-3 border-b border-[#e2d1a3] flex justify-between items-center">
                                    <h3 class="font-rpg font-bold text-yellow-800"><i class="fa-solid fa-graduation-cap mr-2"></i> K·∫øt Qu·∫£ H·ªçc T·∫≠p</h3>
                                    <span class="text-xs bg-white border border-yellow-200 px-2 py-1 rounded text-yellow-700">H·ªçc k·ª≥ I</span>
                                </div>
                                <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                                    <div class="group">
                                        <div class="w-12 h-12 mx-auto bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mb-2 group-hover:scale-110 transition">
                                            <i class="fa-solid fa-hand-sparkles text-xl"></i>
                                        </div>
                                        <div id="score-speech" class="font-rpg text-xl font-bold text-gray-800">0</div>
                                        <div class="text-xs text-gray-400 uppercase mt-1">Ph√°t Bi·ªÉu</div>
                                    </div>
                                    <div class="group">
                                        <div class="w-12 h-12 mx-auto bg-green-50 rounded-full flex items-center justify-center text-green-500 mb-2 group-hover:scale-110 transition">
                                            <i class="fa-solid fa-book-open text-xl"></i>
                                        </div>
                                        <div id="score-tx" class="font-rpg text-xl font-bold text-gray-800">0</div>
                                        <div class="text-xs text-gray-400 uppercase mt-1">Ki·ªÉm Tra TX</div>
                                    </div>
                                    <div class="group">
                                        <div class="w-12 h-12 mx-auto bg-pink-50 rounded-full flex items-center justify-center text-pink-500 mb-2 group-hover:scale-110 transition">
                                            <i class="fa-solid fa-flask text-xl"></i>
                                        </div>
                                        <div id="score-product" class="font-rpg text-xl font-bold text-gray-800">0</div>
                                        <div class="text-xs text-gray-400 uppercase mt-1">S·∫£n Ph·∫©m</div>
                                    </div>
                                    <div class="group">
                                        <div class="w-12 h-12 mx-auto bg-purple-50 rounded-full flex items-center justify-center text-purple-500 mb-2 group-hover:scale-110 transition">
                                            <i class="fa-solid fa-scroll text-xl"></i>
                                        </div>
                                        <div id="score-hk" class="font-rpg text-xl font-bold text-gray-800">0</div>
                                        <div class="text-xs text-gray-400 uppercase mt-1">Thi H·ªçc K·ª≥</div>
                                    </div>
                                </div>
                            </div>

                            <div class="rpg-card rounded-xl bg-white flex-1 min-h-[200px] flex flex-col shadow-sm">
                                <div class="bg-amber-50 rounded-xl p-4 border border-amber-200 shadow-sm h-64 overflow-y-auto">
                                    <h3 class="font-bold text-amber-800 mb-3 flex items-center">
                                        <i class="fas fa-history mr-2"></i> L·ªäCH S·ª¨ NH·∫¨P ƒêI·ªÇM
                                    </h3>
                                    <ul id="activity-log" class="space-y-3">
                                        <li class="text-gray-400 text-sm text-center italic">ƒêang t·∫£i d·ªØ li·ªáu...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-inventory" class="hidden flex-col min-h-full overflow-y-visible w-full animate-fade-in p-6 lg:p-8 overflow-y-auto">
                
                <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-amber-900 font-rpg"><i class="fas fa-suitcase mr-2"></i> H√†nh Trang H·ªçc T·∫≠p</h2>
                        <p class="text-gray-500 italic text-sm mt-1">"Qu·∫£n l√Ω v·∫≠t ph·∫©m, trang b·ªã v√† giao d·ªãch t·∫°i Ch·ª£ ƒêen"</p>
                    </div>
                    
                    <div class="flex bg-white rounded-xl shadow-sm p-1 border border-gray-200">
                        <button onclick="switchInventoryTab('equip')" id="btn-tab-equip" class="px-6 py-2 rounded-lg font-bold text-amber-900 bg-amber-100 shadow-sm transition-all">
                            üõ°Ô∏è Trang B·ªã
                        </button>
                        <button onclick="switchInventoryTab('bag')" id="btn-tab-bag" class="px-6 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-100 transition-all">
                            üéí T√∫i ƒê·ªì
                        </button>
                        <button onclick="switchInventoryTab('market')" id="btn-tab-market" class="px-6 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-100 transition-all">
                            ‚öñÔ∏è Ch·ª£ ƒêen
                        </button>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-[#e2d1a3] p-6 relative bg-[url('assets/bg_paper.jpg')] bg-cover min-h-[500px]">
                    
                    <div id="view-equip" class="inv-tab-content block h-full">
                        <div class="flex justify-center gap-6 mb-8">
                            <div class="bg-red-50 border-2 border-red-100 rounded-xl p-3 w-40 text-center shadow-sm">
                                <div class="text-xs text-red-400 font-bold uppercase tracking-wider">S·ª©c Kh·ªèe (HP)</div>
                                <div id="view-stat-hp" class="text-2xl font-black text-red-600 mt-1">-- / --</div>
                            </div>
                            <div class="bg-blue-50 border-2 border-blue-100 rounded-xl p-3 w-40 text-center shadow-sm">
                                <div class="text-xs text-blue-400 font-bold uppercase tracking-wider">S·ª©c M·∫°nh (ATK)</div>
                                <div id="view-stat-atk" class="text-2xl font-black text-blue-600 mt-1">--</div>
                            </div>
                        </div>
                        <div class="flex justify-center gap-6 flex-wrap" id="equip-slots-container">
                            </div>
                    </div>

                    <div id="view-bag" class="inv-tab-content hidden h-full">
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="bag-grid">
                            </div>
                    </div>

                    <div id="view-market" class="inv-tab-content hidden h-full space-y-8">
                        <div class="bg-amber-50/80 p-5 rounded-xl border border-amber-200">
                            <h3 class="font-bold text-amber-800 mb-4 flex items-center text-lg">
                                <i class="fas fa-store mr-2"></i> S·∫°p H√†ng C·ªßa T√¥i
                            </h3>
                            <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-amber-300" id="market-my-items">
                                </div>
                        </div>

                        <div>
                            <h3 class="font-bold text-amber-800 mb-4 flex items-center text-lg">
                                <i class="fas fa-globe-asia mr-2"></i> Gian H√†ng Chung
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="market-public-items">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-arena" class="hidden flex-col min-h-full w-full relative animate-fade-in overflow-y-visible">
    
                <div class="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat" 
                    style="background-image: url('assets/background/arena_bg.jpg'); filter: brightness(0.4);">
                </div>

                <div class="relative z-10 p-6 lg:p-8 flex flex-col gap-6">
                    
                    <div class="text-white mb-2 flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-bold font-rpg text-yellow-400 drop-shadow-md uppercase tracking-wider">
                                <i class="fas fa-swords mr-3"></i> ƒê·∫•u Tr∆∞·ªùng Tri Th·ª©c
                            </h2>
                            <p class="text-gray-200 italic">"N∆°i b·∫£n lƒ©nh l√™n ti·∫øng v√† KPI ƒë·ªïi ch·ªß"</p>
                        </div>
                        <div class="bg-black/50 px-4 py-2 rounded-lg border border-yellow-500 text-yellow-400 font-bold">
                            KPI Hi·ªán c√≥: <span id="arena-wallet-display">...</span>
                        </div>
                    </div>

                    <div class="bg-slate-900/90 backdrop-blur-md border-2 border-blue-500 rounded-xl p-6 shadow-[0_0_20px_rgba(59,130,246,0.3)]">
                        <h3 class="text-xl font-bold text-blue-400 mb-4 border-b border-blue-500/30 pb-2 uppercase flex items-center">
                            <i class="fas fa-scroll mr-2"></i> Thi·∫øt L·∫≠p Tr·∫≠n ƒê·∫•u
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 text-blue-100">
                            <div>
                                <label class="block text-xs font-bold text-blue-300 mb-1">Th·ªÉ th·ª©c</label>
                                <select id="arena-mode" class="w-full bg-slate-800 text-white border border-blue-700 rounded p-2 focus:border-blue-400 outline-none">
                                    <option value="1vs1">‚öîÔ∏è Solo (1 vs 1)</option>
                                    <option value="2vs2">üõ°Ô∏è ƒê·ªìng ƒê·ªôi (2 vs 2)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-blue-300 mb-1">ƒê·ªô kh√≥</label>
                                <select id="arena-difficulty" class="w-full bg-slate-800 text-white border border-blue-700 rounded p-2 focus:border-blue-400 outline-none">
                                    <option value="hard">üî• Kh√≥ (Hard)</option>
                                    <option value="super_hard">üíÄ Si√™u Kh√≥ (Extreme)</option>
                                    <option value="hell">üëø ƒê·ªãa Ng·ª•c (Hell)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-blue-300 mb-1">Ch·ªçn ƒê·ªëi Th·ªß (Cho 1vs1)</label>
                                <select id="arena-opponent" class="w-full bg-slate-800 text-white border border-blue-700 rounded p-2 focus:border-blue-400 outline-none">
                                    <option value="">-- T√¨m ng∆∞·ªùi --</option>
                                    </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-blue-300 mb-1">M·ª©c C∆∞·ª£c (KPI)</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="arena-bet-range" min="1" max="5" value="1" 
                                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                        oninput="document.getElementById('bet-value').innerText = this.value">
                                    <span id="bet-value" class="text-2xl font-bold text-blue-400 w-8 text-center">1</span>
                                </div>
                            </div>
                        </div>

                        <div class="text-right">
                            <button onclick="sendChallenge()" class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-2 px-8 rounded border border-blue-400 shadow-lg transition-transform active:scale-95">
                                G·ª¨I TH∆Ø CHI·∫æN <i class="fas fa-paper-plane ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2"> <div class="bg-white/90 backdrop-blur rounded-xl p-4 border-l-4 border-green-600 shadow-lg min-h-[150px]">
                        <h3 class="font-bold text-green-800 mb-3 flex items-center justify-between">
                            <span><i class="fas fa-envelope-open-text mr-2"></i> L·ªùi M·ªùi ƒê·∫øn</span>
                            <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden" id="badge-incoming">0</span>
                        </h3>
                        <div id="arena-incoming-list" class="space-y-2 overflow-y-auto max-h-32 custom-scrollbar"> <p class="text-sm text-gray-500 italic text-center py-4">Ch∆∞a c√≥ ai th√°ch ƒë·∫•u b·∫°n...</p>
                        </div>
                    </div>

                    <div class="bg-white/90 backdrop-blur rounded-xl p-4 border-l-4 border-gray-500 shadow-lg min-h-[150px]">
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-paper-plane mr-2"></i> ƒê√£ G·ª≠i ƒêi
                        </h3>
                        <div id="arena-outgoing-list" class="space-y-2 overflow-y-auto max-h-32 custom-scrollbar"> <p class="text-sm text-gray-500 italic text-center py-4">B·∫°n ch∆∞a th√°ch ƒë·∫•u ai...</p>
                        </div>
                    </div>
                </div>

                <div class="mt-2 mb-6"> <h3 class="text-xl font-bold text-yellow-400 mb-2 flex items-center drop-shadow-md uppercase tracking-wide">
                        <i class="fas fa-scroll mr-2 text-yellow-500"></i> 
                        L·ªãch s·ª≠ ƒë·∫•u tr∆∞·ªùng (5 tr·∫≠n g·∫ßn nh·∫•t)
                    </h3>

                    <div class="bg-white/95 backdrop-blur rounded-xl shadow-xl border border-yellow-600/30 overflow-hidden">
                        <div class="max-h-[200px] overflow-y-auto custom-scrollbar"> 
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 sticky top-0 z-20">
                                    <tr class="text-[11px] text-gray-500 uppercase border-b border-gray-200">
                                        <th class="py-2 px-4">Tr·∫≠n #</th>
                                        <th class="py-2 px-4">Ch·∫ø ƒë·ªô</th>
                                        <th class="py-2 px-4">Ng∆∞·ªùi t·∫°o</th>
                                        <th class="py-2 px-4">K·∫øt qu·∫£</th>
                                        <th class="py-2 px-4 text-right">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="arena-history-list" class="text-xs divide-y divide-gray-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                    <div class="bg-orange-950/90 backdrop-blur border-2 border-orange-600 rounded-xl p-6 flex-1 min-h-[300px] shadow-[0_0_20px_rgba(234,88,12,0.3)]">
                        <div class="flex justify-between items-center mb-4 border-b border-orange-700/50 pb-2">
                            <h3 class="text-xl font-bold text-orange-400 uppercase">
                                <i class="fas fa-users mr-2"></i> S·∫£nh Ch·ªù (ƒê·∫•u ƒê·ªôi 2vs2)
                            </h3>
                            <button onclick="loadArenaLobby()" class="text-sm text-orange-300 hover:text-white flex items-center bg-orange-900 px-3 py-1 rounded border border-orange-700">
                                <i class="fas fa-sync-alt mr-1"></i> L√†m m·ªõi
                            </button>
                        </div>

                        <div id="arena-lobby-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                            <p class="col-span-3 text-center text-orange-200 italic mt-10">ƒêang t·∫£i danh s√°ch ph√≤ng...</p>
                        </div>
                    </div>

                </div>

                <div id="quiz-modal" class="hidden absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden border-4 border-yellow-600 relative">
                        <div class="bg-gray-800 p-4 flex justify-between items-center text-white">
                            <div class="font-bold text-yellow-400 text-xl"><i class="fas fa-clock mr-2"></i> <span id="quiz-timer">15</span>s</div>
                            <div class="font-bold text-lg">C√¢u <span id="quiz-current-index">1</span> / 5</div>
                        </div>
                        <div class="p-8 text-center min-h-[200px] flex flex-col justify-center bg-amber-50">
                            <h3 id="quiz-question-content" class="text-2xl font-bold text-gray-800 mb-6 leading-relaxed">ƒêang t·∫£i c√¢u h·ªèi...</h3>
                            <div id="quiz-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            <div id="quiz-feedback-area" class="hidden mt-6 p-4 rounded-xl border-2 transition-all">
                                <div class="flex items-start space-x-3">
                                    <div id="feedback-icon" class="text-3xl"></div>
                                    <div>
                                        <h4 id="feedback-title" class="text-xl font-bold mb-1"></h4>
                                        <p id="feedback-explanation" class="text-gray-700"></p>
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex justify-end">
                                    <button id="btn-next-question" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transform active:scale-95 transition-all">
                                        C√¢u ti·∫øp theo ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-200 w-full">
                            <div id="quiz-progress-bar" class="h-full bg-yellow-500" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-tower" class="hidden h-full w-full relative bg-gray-900 overflow-hidden animate-fade-in">
    
                <div id="tower-lobby" class="absolute inset-0 z-10 flex flex-col items-center justify-center tower-bg bg-[url('assets/background/thap.png')] bg-cover bg-center transition-all duration-1000">
                    <div class="absolute inset-0 bg-black/60"></div>

                    <div class="relative z-20 text-center w-full max-w-4xl px-4">
                        <h1 class="text-5xl md:text-7xl font-rpg text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,1)] mb-4 animate-pulse">
                            TH√ÅP V√î T·∫¨N
                        </h1>
                        <p class="text-gray-300 italic mb-8 text-lg">"Ch·ªâ nh·ªØng k·∫ª m·∫°nh nh·∫•t m·ªõi ch·∫°m t·ªõi ƒë·ªânh th√°p"</p>

                        <div class="bg-black/40 backdrop-blur-md border border-yellow-600/50 rounded-xl p-6 mb-8 max-w-lg mx-auto" style="display: none;">
                            <h3 class="text-yellow-200 font-bold uppercase tracking-widest border-b border-yellow-600/30 pb-2 mb-4">
                                üèÜ B·∫£ng Phong Th·∫ßn (Top 5)
                            </h3>
                            <ul id="tower-leaderboard" class="space-y-3 text-left min-h-[100px]">
                                <li class="text-gray-400 italic text-center text-sm py-4">ƒêang t·∫£i d·ªØ li·ªáu...</li>
                            </ul>
                        </div>

                        <button onclick="startTowerCombat()" class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-red-700 font-rpg rounded-lg hover:bg-red-600 hover:scale-105 shadow-[0_0_20px_rgba(220,38,38,0.5)] border-2 border-red-400">
                            <span class="mr-2 text-2xl">‚öîÔ∏è</span>
                            <span class="text-xl tracking-wider">TI·∫æN V√ÄO T·∫¶NG <span id="lobby-current-floor">1</span></span>
                            <div class="absolute -inset-3 rounded-lg bg-red-400/20 blur-lg group-hover:opacity-100 transition duration-1000 group-hover:duration-200"></div>
                        </button>
                    </div>

                    <div class="absolute bottom-0 w-full bg-gray-900/90 border-t border-gray-700 p-4 flex justify-between items-center z-20">
                        <div class="flex items-center gap-4">
                            <img id="tower-player-avatar" src="" class="w-12 h-12 rounded-full border-2 border-yellow-500 bg-gray-800 object-cover">
                            <div>
                                <div class="text-yellow-400 font-bold font-rpg" id="tower-player-name">Player</div>
                                <div class="text-xs text-gray-400">Level <span id="tower-player-level">1</span></div>
                            </div>
                        </div>
                        <div class="flex-1 mx-8 max-w-md">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>EXP</span>
                                <span id="tower-exp-text">0 / 100</span>
                            </div>
                            <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                <div id="tower-exp-bar" class="bg-purple-500 h-full w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tower-combat" class="absolute inset-0 z-50 hidden flex-col bg-gray-900 font-sans">
    
                    <div id="tower-combat-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-700 z-0">
                        <div class="absolute inset-0 bg-black/30 backdrop-blur-[1px]"></div> 
                    </div>

                    <div class="h-[60%] md:h-[65%] relative z-10 w-full flex justify-between items-end pb-4 md:pb-8 px-4 md:px-12">
                        
                        <div class="relative w-1/3 flex flex-col items-center group">
                            <div class="w-24 md:w-40 mb-3 relative group-hover:scale-105 transition-transform">
                                <div class="flex justify-between text-white text-[10px] md:text-xs font-bold shadow-black drop-shadow-md px-1 mb-1">
                                    <span class="text-green-400">YOU</span>
                                    <span id="combat-player-hp-text" class="text-green-300">100</span>
                                </div>
                                <div class="h-2 md:h-3 bg-gray-800 rounded-full border border-gray-600 overflow-hidden shadow-inner">
                                    <div id="combat-player-hp-bar" class="h-full bg-gradient-to-r from-green-600 to-emerald-400 transition-all duration-300 relative" style="width: 100%;">
                                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="relative">
                                <img id="combat-player-img" src="" class="h-32 md:h-56 object-contain drop-shadow-[0_0_20px_rgba(50,255,50,0.3)] filter brightness-110">
                                <div id="combat-player-img-damage" class="absolute -top-10 left-1/2 -translate-x-1/2"></div>
                            </div>
                        </div>

                        <div class="flex-1 h-full relative pointer-events-none flex items-center justify-center">
                            <div id="vfx-layer-global" class="absolute inset-0"></div>
                        </div>

                        <div class="relative w-1/3 flex flex-col items-center">
                            <div class="w-24 md:w-40 mb-3 relative">
                                <div class="flex justify-between text-white text-[10px] md:text-xs font-bold shadow-black drop-shadow-md px-1 mb-1">
                                    <span id="combat-monster-name" class="text-red-400 truncate max-w-[80px]">BOSS</span>
                                    <span id="combat-monster-hp-text" class="text-red-300">500</span>
                                </div>
                                <div class="h-2 md:h-3 bg-gray-900 rounded-full border border-red-900 overflow-hidden shadow-inner">
                                    <div id="combat-monster-hp-bar" class="h-full bg-gradient-to-r from-red-700 to-orange-600 transition-all duration-300" style="width: 100%;"></div>
                                </div>
                            </div>

                            <div class="relative">
                                <img id="combat-monster-img" src="assets/character/warrior.png" class="h-32 md:h-56 object-contain drop-shadow-[0_0_25px_rgba(255,50,50,0.5)]">
                                <div id="combat-monster-img-damage" class="absolute -top-10 left-1/2 -translate-x-1/2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="h-[40%] md:h-[35%] relative z-20 bg-gray-900/95 border-t-4 border-amber-700 shadow-[0_-10px_40px_rgba(0,0,0,0.9)] flex flex-col p-4">
                        
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-800">
                            <div id="combat-timer-bar" class="h-full bg-amber-500 shadow-[0_0_10px_#f59e0b] transition-linear" style="width: 100%"></div>
                        </div>

                        <div class="flex justify-between items-center mb-4 text-blue-200 text-xs md:text-sm font-bold tracking-wider px-2 uppercase">
                            <span><i class="fas fa-scroll mr-2 text-amber-500"></i>C√¢u h·ªèi <span id="combat-q-index" class="text-white text-lg mx-1">1</span></span>
                            <span class="text-amber-400"><i class="fas fa-hourglass-half mr-2"></i><span id="combat-timer-text">Turn</span></span>
                        </div>

                        <div class="relative flex-1 w-full max-w-5xl mx-auto flex flex-col">
                            
                            <h3 id="combat-q-content" class="text-white text-base md:text-xl font-bold text-center mb-4 leading-relaxed min-h-[3rem] flex items-center justify-center drop-shadow-md">
                                ƒêang tri·ªáu h·ªìi qu√°i v·∫≠t...
                            </h3>

                            <div id="combat-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full overflow-y-auto pr-1 custom-scrollbar" style="max-height: 200px;">
                                </div>

                            <div id="combat-feedback-overlay" class="hidden absolute inset-0 bg-gray-900/95 z-50 flex flex-col items-center justify-center text-center animate-fade-in rounded-lg border border-gray-700">
                                <div id="feedback-icon" class="text-5xl mb-2 animate-bounce"></div>
                                
                                <h3 id="feedback-title" class="text-2xl font-bold mb-2 uppercase tracking-widest"></h3>
                                
                                <div class="bg-black/40 border border-gray-600 p-3 rounded-lg mb-4 w-full max-w-2xl overflow-y-auto max-h-[100px] custom-scrollbar">
                                    <p class="text-gray-400 text-xs font-bold mb-1 text-left uppercase">üí° Ki·∫øn th·ª©c:</p>
                                    <p id="feedback-explain" class="text-amber-200 font-serif text-base leading-relaxed text-left pl-2 border-l-2 border-amber-600">
                                        </p>
                                </div>

                                <button id="feedback-btn" class="px-8 py-3 bg-gradient-to-r from-amber-700 to-orange-600 hover:from-amber-600 hover:to-orange-500 text-white font-bold rounded-lg shadow-lg transform transition hover:scale-105 ring-2 ring-orange-400/50 flex items-center gap-2">
                                    TI·∫æP THEO <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                    
                    <button onclick="endTowerCombat(false)" class="absolute top-4 right-4 z-50 text-gray-400 hover:text-white bg-black/50 hover:bg-red-600/80 rounded-full w-10 h-10 flex items-center justify-center transition-all border border-gray-600 hover:border-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div id="main-view-skills" class="hidden flex-col h-full w-full animate-fade-in p-6 lg:p-8 bg-gray-900 relative overflow-hidden">
    
                <div class="absolute inset-0 bg-[url('/assets/bg_magic.jpg')] opacity-20 bg-cover bg-center z-0"></div>

                <div class="relative z-10 flex flex-col h-full gap-6">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold font-rpg text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-purple-500">
                                <i class="fa-solid fa-book-journal-whills mr-3"></i>B√≠ K√≠p K·ªπ NƒÉng
                            </h2>
                            <p class="text-gray-400 italic text-sm mt-1">"Lƒ©nh ng·ªô tri th·ª©c, khai m·ªü s·ª©c m·∫°nh ti·ªÅm ·∫©n"</p>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-xs text-gray-500 uppercase font-bold">ƒêi·ªÉm K·ªπ NƒÉng</div>
                                <div class="text-2xl font-rpg font-bold text-yellow-500" id="skill-points-display">--</div>
                            </div>
                            <div class="bg-gray-800 p-2 rounded-lg border border-gray-700">
                                <i class="fa-solid fa-hat-wizard text-2xl text-blue-400"></i>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 flex gap-6 overflow-hidden">
                        
                        <div class="w-full lg:w-2/3 bg-gray-800/80 backdrop-blur border border-gray-700 rounded-xl flex flex-col shadow-xl">
                            <div class="p-4 border-b border-gray-700 bg-black/20 flex justify-between items-center">
                                <h3 class="font-bold text-gray-200"><i class="fa-solid fa-network-wired mr-2"></i>L·ªô Tr√¨nh ThƒÉng Ti·∫øn</h3>
                                <div class="flex gap-2 text-[10px] uppercase font-bold">
                                    <span class="px-2 py-1 rounded bg-gray-700 text-gray-400"><i class="fa-solid fa-lock mr-1"></i>Ch∆∞a ƒë·∫°t</span>
                                    <span class="px-2 py-1 rounded bg-yellow-900/50 text-yellow-500 border border-yellow-700"><i class="fa-solid fa-unlock mr-1"></i>C√≥ th·ªÉ h·ªçc</span>
                                    <span class="px-2 py-1 rounded bg-blue-900/50 text-blue-400 border border-blue-700"><i class="fa-solid fa-check mr-1"></i>ƒê√£ h·ªçc</span>
                                </div>
                            </div>
                            
                            <div id="skill-tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-8 relative">
                                <div class="text-center mt-20 text-gray-500 italic">ƒêang t·∫£i d·ªØ li·ªáu b√≠ k√≠p...</div>
                            </div>
                        </div>

                        <div class="hidden lg:flex w-1/3 bg-gray-900/90 backdrop-blur border-2 border-yellow-600/30 rounded-xl p-6 flex-col relative shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                            <div id="skill-detail-panel" class="flex-1 flex flex-col">
                                <div class="m-auto text-center opacity-40">
                                    <i class="fa-solid fa-hand-pointer text-5xl mb-4 text-gray-500"></i>
                                    <p class="font-bold text-gray-400">Ch·ªçn m·ªôt k·ªπ nƒÉng ƒë·ªÉ xem chi ti·∫øt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-shop" class="hidden flex flex-col h-full w-full animate-fade-in">
                
                <header class="h-16 bg-white/90 backdrop-blur border-b border-[#e2d1a3] flex items-center justify-between px-6 shadow-sm z-10">
                    <div class="flex items-center">
                        <button onclick="switchMainScreen('dashboard')" class="mr-4 w-8 h-8 rounded-full bg-gray-100 hover:bg-yellow-100 flex items-center justify-center text-gray-600 hover:text-yellow-700 transition">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        
                        <h1 class="font-rpg text-xl font-bold text-yellow-800">
                            <i class="fa-solid fa-store mr-2"></i> Ti·ªám T·∫°p H√≥a
                        </h1>
                    </div>
                    
                    <div class="flex space-x-4">
                        <div class="flex items-center bg-blue-50 px-3 py-1 rounded-full border border-blue-200">
                            <i class="fa-solid fa-book text-blue-500 mr-2"></i>
                            <span id="shop-wallet-trithuc" class="font-bold text-blue-700">0</span>
                        </div>
                        <div class="flex items-center bg-yellow-50 px-3 py-1 rounded-full border border-yellow-200">
                            <i class="fa-solid fa-coins text-yellow-500 mr-2"></i>
                            <span id="shop-wallet-vinhdu" class="font-bold text-yellow-700">0</span>
                        </div>
                        <div class="flex items-center bg-red-50 px-3 py-1 rounded-full border border-red-200">
                            <i class="fa-solid fa-fire text-red-500 mr-2"></i>
                            <span id="shop-wallet-chientich" class="font-bold text-red-700">0</span>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-6 lg:p-8 bg-[#3e2723]"> 
                    <div class="max-w-7xl mx-auto">
                        
                        <div class="bg-[#5d4037] text-amber-100 p-4 rounded-xl mb-8 border-2 border-[#8d6e63] shadow-lg flex items-center justify-center">
                            <i class="fa-solid fa-bullhorn mr-3 text-2xl text-yellow-400 animate-bounce"></i>
                            <p class="font-rpg text-lg italic">"M·∫°i d√¥, m·∫°i d√¥! C√≥ ti·ªÅn th√¨ mua, kh√¥ng c√≥ ti·ªÅn th√¨... ƒëi l√†m b√†i t·∫≠p ki·∫øm ti·ªÅn ƒëi!"</p>
                        </div>

                        <div id="shop-items-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 pb-10">
                            
                            <div class="col-span-full text-center text-white/50 py-20">
                                <i class="fa-solid fa-spinner fa-spin text-4xl mb-4"></i>
                                <p class="font-rpg text-xl">ƒêang d·ªçn h√†ng ra k·ªá...</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-boss" class="hidden h-screen flex flex-col relative bg-gray-900 overflow-hidden">
    
                <div id="boss-battle-arena" class="w-full h-full relative hidden">
                    <button id="btn-retreat" onclick="quitBossBattle()" class="hidden absolute top-6 left-6 z-50 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold px-6 py-3 rounded-full shadow-[0_0_15px_rgba(220,38,38,0.6)] transition-all hover:scale-110 active:scale-95 border-2 border-red-500/50 backdrop-blur-sm">
                        <i class="fa-solid fa-person-walking-arrow-right mr-2 animate-pulse"></i> R√öT LUI
                    </button>
                    <div class="absolute top-0 w-full z-20 p-4">
                        <div class="max-w-4xl mx-auto">
                            <h2 id="battle-boss-name" class="text-3xl md:text-5xl font-bold text-center text-red-500 mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,1)] font-serif tracking-widest">
                                BOSS NAME
                            </h2>
                            
                            <div class="relative w-full h-8 md:h-10 bg-gray-800 rounded-full border-4 border-red-900 shadow-2xl overflow-hidden">
                                <div id="battle-boss-hp-bar" class="h-full bg-gradient-to-r from-red-600 via-orange-500 to-red-600 transition-all duration-500 ease-out" style="width: 100%;"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="battle-boss-hp-text" class="text-white font-bold text-lg md:text-xl drop-shadow-md tracking-wider">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-full h-full flex items-center justify-center relative z-10 pt-20 pb-40"> 
                        <div class="absolute w-[600px] h-[600px] bg-red-600/20 rounded-full blur-[100px] animate-pulse"></div>
                        
                        <div class="relative inline-flex justify-center items-end" style="height: 60vh;">
                            <img id="battle-boss-image" 
                                src="" 
                                class="h-full w-auto object-contain drop-shadow-[0_0_30px_rgba(255,50,50,0.5)] transition-transform duration-300 z-10 block"
                                alt="Boss">

                            <div id="battle-boss-vfx" class="vfx-container hidden"></div>
                        </div>

                        <div id="damage-overlay" class="absolute inset-0 pointer-events-none flex justify-center items-center"></div>
                    </div>

                    <div class="absolute bottom-0 w-full z-30 bg-gray-900/95 border-t-4 border-red-900 backdrop-blur-xl shadow-[0_-10px_60px_rgba(0,0,0,0.8)] pb-6 pt-4">
                        <div class="max-w-5xl mx-auto px-4 flex flex-col gap-3">
                            
                            <div class="flex flex-wrap justify-between items-end border-b border-gray-700 pb-2 mb-2">
                                <div class="flex gap-4 text-sm md:text-base">
                                    <div class="flex items-center bg-gray-800 px-3 py-1 rounded border border-gray-600">
                                        <span class="text-green-400 font-bold mr-2">HP:</span>
                                        <span id="battle-player-hp" class="text-white font-mono">---</span>
                                    </div>
                                    <div class="flex items-center bg-gray-800 px-3 py-1 rounded border border-gray-600">
                                        <span class="text-yellow-400 font-bold mr-2">ATK:</span>
                                        <span id="battle-player-atk" class="text-white font-mono">---</span>
                                    </div>
                                </div>
                                
                                <div id="battle-timer-container" class="hidden flex items-center gap-2">
                                    <span class="text-gray-400 text-xs uppercase font-bold">Th·ªùi gian:</span>
                                    <span id="battle-timer" class="text-3xl font-bold text-red-500 font-mono animate-pulse">00:00</span>
                                </div>
                            </div>

                            <div id="boss-lobby-ui" class="text-center py-4">
                                <h3 class="text-yellow-400 font-bold mb-2 animate-bounce">S·∫¥N S√ÄNG CHI·∫æN ƒê·∫§U?</h3>
                                <button onclick="startBossBattle()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-10 rounded-full text-xl shadow-[0_0_15px_red] transform transition hover:scale-105 active:scale-95">
                                    <i class="fa-solid fa-skull mr-2"></i> B·∫ÆT ƒê·∫¶U NGAY
                                </button>
                                <p class="text-gray-500 text-xs mt-2 italic">H√£y chu·∫©n b·ªã k·ªπ nƒÉng, Boss r·∫•t m·∫°nh!</p>
                            </div>

                            <div id="boss-combat-ui" class="hidden relative">

                                <div class="text-center">
                                    <div id="battle-question-text" class="text-xl md:text-2xl font-bold text-yellow-400 font-serif mb-3 min-h-[3rem] flex items-center justify-center px-4 drop-shadow-sm">
                                        ƒêang t·∫£i d·ªØ li·ªáu...
                                    </div>
                                </div>

                                <div id="battle-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    </div>
                            </div>

                        </div>
                    </div>
                </div> 

                <div id="boss-waiting-screen" class="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center hidden">
                    <div class="text-6xl mb-4">üíÄ</div>
                    <h2 class="text-3xl text-gray-500 font-bold">CH∆ØA C√ì BOSS</h2>
                    <p class="text-gray-600 mt-2">H√£y quay l·∫°i sau khi Admin tri·ªáu h·ªìi!</p>
                </div>
            </div>

            <div id="main-view-team-manager" class="hidden flex flex-col h-full w-full animate-fade-in bg-gray-50">
    
                <header class="h-16 bg-white/90 backdrop-blur border-b border-[#e2d1a3] flex items-center justify-between px-6 shadow-sm z-10">
                    <h1 class="font-rpg text-xl font-bold text-yellow-800">
                        <i class="fas fa-crown mr-2"></i> Qu·∫£n L√Ω Th√†nh Vi√™n T·ªï
                    </h1>
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full border border-yellow-300">
                        Quy·ªÅn h·∫°n: T·ªï Tr∆∞·ªüng
                    </span>
                </header>

                <div class="flex-1 overflow-y-auto p-6 lg:p-8">
                    <div class="max-w-4xl mx-auto space-y-6">

                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-bold text-red-800 uppercase">L∆∞u √Ω quan tr·ªçng</h3>
                                    <div class="mt-1 text-sm text-red-700">
                                        <p>H√£y ki·ªÉm tra k·ªπ danh s√°ch tr∆∞·ªõc khi b·∫•m "X√°c Nh·∫≠n". N·∫øu ch·ªçn nh·∫ßm, b·∫°n <b>kh√¥ng th·ªÉ t·ª± x√≥a</b> m√† ph·∫£i b√°o c√°o Admin x·ª≠ l√Ω.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-[#e2d1a3] overflow-hidden">
                            <div class="bg-amber-50 px-6 py-4 border-b border-[#e2d1a3] flex justify-between items-center">
                                <h3 class="font-bold text-amber-900">
                                    <i class="fas fa-user-plus mr-2"></i> Danh S√°ch H·ªçc Sinh T·ª± Do
                                </h3>
                                <span class="text-xs text-gray-500 italic">Ch·ªçn c√°c b·∫°n ƒë·ªÉ th√™m v√†o t·ªï</span>
                            </div>

                            <div class="p-6">
                                <div id="free-agent-list" class="h-96 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 divide-y divide-gray-100 custom-scrollbar">
                                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                        <i class="fas fa-spinner fa-spin mb-2 text-2xl"></i>
                                        <p>ƒêang t·∫£i danh s√°ch l·ªõp...</p>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                                    <div class="text-sm text-gray-600">
                                        ƒê√£ ch·ªçn: <span id="selected-count" class="font-bold text-blue-600 text-lg">0</span> h·ªçc sinh
                                    </div>
                                    
                                    <button onclick="submitRecruitMembers()" class="bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transform transition active:scale-95 flex items-center">
                                        <i class="fas fa-check-circle mr-2"></i> X√ÅC NH·∫¨N TH√äM
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 bg-white rounded-xl shadow-lg border border-[#e2d1a3] overflow-hidden">
                            <div class="bg-gradient-to-r from-amber-700 to-yellow-600 px-6 py-4 flex justify-between items-center text-white">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white/20 p-2 rounded-full">
                                        <i class="fas fa-users text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg uppercase tracking-wide">Danh S√°ch T·ªï <span id="team-id-display" class="text-yellow-300 font-black text-xl">...</span></h3>
                                        <p class="text-xs text-amber-100 opacity-80">Qu·∫£n l√Ω s·ª©c m·∫°nh ƒë·ªôi ng≈©</p>
                                    </div>
                                </div>

                                <div class="text-right">
                                    <div class="text-xs uppercase text-amber-200 font-bold">T·ªïng KPI C·∫£ T·ªï</div>
                                    <div class="font-rpg text-3xl font-bold text-white drop-shadow-md" id="team-total-kpi">0</div>
                                </div>
                            </div>

                            <div class="p-0 overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-amber-50 text-amber-900 text-xs uppercase font-bold border-b border-amber-200">
                                        <tr>
                                            <th class="py-4 px-6">Th√†nh Vi√™n</th>
                                            <th class="py-4 px-6 text-center">Vai Tr√≤</th>
                                            <th class="py-4 px-6 text-center">C·∫•p ƒê·ªô</th>
                                            <th class="py-4 px-6 text-right">KPI C√° Nh√¢n</th>
                                            <th id="th-action" class="py-4 px-6 text-center hidden">B·ªï Nhi·ªám</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-members-list" class="divide-y divide-gray-100 text-sm">
                                        <tr>
                                            <td colspan="4" class="py-8 text-center text-gray-500 italic">ƒêang t·∫£i danh s√°ch th√†nh vi√™n...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-view-grading" class="hidden flex flex-col h-full w-full animate-fade-in bg-gray-50">
    
                <header class="h-16 bg-white/90 backdrop-blur border-b border-[#e2d1a3] flex items-center justify-between px-6 shadow-sm z-10">
                    <h1 class="font-rpg text-xl font-bold text-blue-800">
                        <i class="fas fa-pen-nib mr-2"></i> S·ªï ƒêi·ªÉm
                    </h1>
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full border border-blue-300">
                        Quy·ªÅn h·∫°n: U1
                    </span>
                </header>

                <div class="flex-1 overflow-y-auto p-6 lg:p-8">
                    <div class="max-w-3xl mx-auto space-y-8">

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <label class="block text-gray-700 font-bold mb-2 uppercase text-sm">Ch·ªçn th√†nh vi√™n c·∫ßn nh·∫≠p:</label>
                            <div class="relative">
                                <select id="grading-student-select" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-3 font-bold">
                                    <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-green-50 rounded-xl p-6 border border-green-200 shadow-sm relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                                    <i class="fas fa-book-open text-8xl text-green-600"></i>
                                </div>
                                
                                <h3 class="text-lg font-bold text-green-800 mb-4 flex items-center">
                                    <i class="fas fa-plus-circle mr-2"></i> ƒêI·ªÇM H·ªåC T·∫¨P (KPI+)
                                </h3>

                                <div class="space-y-4 relative z-10">
                                    <div>
                                        <label class="text-xs font-bold text-green-700 uppercase">Lo·∫°i ƒëi·ªÉm</label>
                                        <select id="score-type" class="w-full mt-1 p-2 rounded border border-green-300 focus:outline-none focus:border-green-500">
                                            <option value="speech">üôã‚Äç‚ôÇÔ∏è Ph√°t bi·ªÉu (+1)</option>
                                            <option value="tx">üìù Ki·ªÉm tra TX (Theo ƒëi·ªÉm s·ªë)</option>
                                            <option value="product">üé® S·∫£n ph·∫©m (Theo ƒëi·ªÉm s·ªë)</option>
                                            <option value="hk">üèÜ Thi H·ªçc K·ª≥ (Theo ƒëi·ªÉm s·ªë)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-green-700 uppercase">Gi√° tr·ªã ƒëi·ªÉm</label>
                                        <input type="number" id="score-value" class="w-full mt-1 p-2 rounded border border-green-300 focus:outline-none focus:border-green-500 font-bold text-green-800" placeholder="VD: 8.5 ho·∫∑c 1">
                                    </div>
                                    <button onclick="preSubmitScore('academic')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow transition transform active:scale-95">
                                        GHI NH·∫¨N TH√ÄNH T√çCH
                                    </button>
                                </div>
                            </div>

                            <div class="bg-red-50 rounded-xl p-6 border border-red-200 shadow-sm relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                                    <i class="fas fa-gavel text-8xl text-red-600"></i>
                                </div>

                                <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center">
                                    <i class="fas fa-minus-circle mr-2"></i> K·ª∂ LU·∫¨T (KPI-)
                                </h3>

                                <div class="space-y-4 relative z-10">
                                    <div>
                                        <label class="text-xs font-bold text-red-700 uppercase">L·ªói vi ph·∫°m</label>
                                        <select id="violation-reason" class="w-full mt-1 p-2 rounded border border-red-300 focus:outline-none focus:border-red-500">
                                            <option value="-3">‚è∞ ƒêi tr·ªÖ (-3 ƒëi·ªÉm)</option>
                                            <option value="-2">üó£Ô∏è N√≥i chuy·ªán ri√™ng (-2 ƒëi·ªÉm)</option>
                                            <option value="-5">ü§¨ Ng√¥n t·ª´ kh√¥ng chu·∫©n m·ª±c (-5 ƒëi·ªÉm)</option>
                                            <option value="-10">ü•ä G√¢y g·ªï, ƒë√°nh nhau (-10 ƒëi·ªÉm)</option>
                                            <option value="-10">üìù B·ªã ghi t√™n s·ªï ƒë·∫ßu b√†i (-10 ƒëi·ªÉm)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="p-3 bg-red-100 rounded text-xs text-red-700 italic border border-red-200">
                                        <i class="fas fa-info-circle mr-1"></i> ƒêi·ªÉm s·∫Ω b·ªã tr·ª´ tr·ª±c ti·∫øp v√†o KPI c·ªßa th√†nh vi√™n v√† kh√¥ng th·ªÉ ho√†n t√°c.
                                    </div>

                                    <button onclick="preSubmitScore('violation')" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded shadow transition transform active:scale-95 mt-6">
                                        X√ÅC NH·∫¨N PH·∫†T
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="confirm-score-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-yellow-500 transform transition-all scale-100">
                    <div class="bg-yellow-500 p-4 text-white font-bold text-lg text-center uppercase tracking-wide">
                        <i class="fas fa-exclamation-triangle mr-2"></i> C·∫£nh B√°o Quan Tr·ªçng
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4 text-center">
                            B·∫°n ƒëang th·ª±c hi·ªán nh·∫≠p d·ªØ li·ªáu cho: <br>
                            <span id="confirm-student-name" class="font-bold text-xl text-blue-800">Nguy·ªÖn VƒÉn A</span>
                        </p>

                        <div class="bg-gray-100 rounded p-4 mb-4 border border-gray-300">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500">N·ªôi dung:</span>
                                <span id="confirm-type" class="font-bold text-gray-800">ƒêi·ªÉm Ki·ªÉm Tra</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Gi√° tr·ªã thay ƒë·ªïi:</span>
                                <span id="confirm-value" class="font-bold text-2xl">0</span>
                            </div>
                        </div>

                        <p class="text-red-500 text-xs italic text-center font-bold mb-6">
                            L∆ØU √ù: D·ªØ li·ªáu sau khi nh·∫≠p s·∫Ω KH√îNG TH·ªÇ S·ª¨A ƒê·ªîI.<br>
                            N·∫øu nh·∫≠p sai, b·∫°n bu·ªôc ph·∫£i b√°o c√°o v·ªõi Gi√°o Vi√™n ƒë·ªÉ x·ª≠ l√Ω.
                        </p>

                        <div class="flex gap-3">
                            <button onclick="closeConfirmModal()" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded">
                                H·ªßy b·ªè
                            </button>
                            <button id="btn-confirm-submit" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded shadow-lg">
                                T√îI CH·∫ÆC CH·∫ÆN
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
        </main>

    <script>
        // üëá --- PH·∫¶N KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C (GLOBAL VARIABLES) --- üëá

        // 1. Logic L√¥i ƒê√†i & Quiz
        let currentQuizData = [];       // Ch·ª©a danh s√°ch 5 c√¢u h·ªèi
        let currentQuizIndex = 0;       // ƒêang l√†m c√¢u s·ªë m·∫•y (0, 1, 2...)
        let userAnswers = {};           // L∆∞u ƒë√°p √°n ng∆∞·ªùi ch∆°i ch·ªçn
        let quizTimerInterval = null;   // L∆∞u b·ªô ƒë·∫øm gi·ªù ƒë·ªÉ c√≤n t·∫Øt ƒëi
        let arenaLobbyInterval = null;  // Bi·∫øn gi·ªØ nh·ªãp t·ª± ƒë·ªông c·∫≠p nh·∫≠t

        // 2. D·ªØ li·ªáu H·ªá th·ªëng & Player
        let dashboardData = null;       // [QUAN TR·ªåNG] L∆∞u data nh√¢n v·∫≠t
        let globalSkillsList = [];      // T·ª´ ƒëi·ªÉn Skill to√†n c·ª•c
        let myStatus = {
            tri_thuc: 0,
            equipped: null,
            class_type: 'MAGE'
        };

        // 3. Logic Ch·ª£ & Kho ƒë·ªì
        let currentSellItemId = null;
        let maxSellAmount = 0;

        // 4. Logic Boss & Combat (ƒê√É G·ªòP V√ÄO ƒê√ÇY)
        let currentBossId = null;
        let bossData = null;
        
        // üëá [QUAN TR·ªåNG] Ch·ªâ khai b√°o bossState M·ªòT L·∫¶N DUY NH·∫§T ·ªü ƒë√¢y
        let bossState = {
            isProcessing: false,    // Ch·ªëng spam click
            timerInterval: null,    // ID c·ªßa ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c c√¢u h·ªèi
            currentQuestion: null,
            isFighting: false   
        };

        // 5. C√°c Interval ch·∫°y ng·∫ßm (Timer)
        let bossPollInterval = null;    // Check tr·∫°ng th√°i Boss ƒë·ªãnh k·ª≥
        let deathTimerInterval = null;  // ƒê·∫øm ng∆∞·ª£c m√†n h√¨nh ch·∫øt
        // let bossTimerInterval = null; // (ƒê√£ g·ªôp v√†o bossState.timerInterval n√™n b·ªè d√≤ng n√†y)

        // 6. Bi·∫øn h·ªó tr·ª£ hi·ªÉn th·ªã Boss
        let bossCurrentCorrectAns = "";
        let bossCurrentExplanation = ""; // Bi·∫øn l∆∞u l·ªùi gi·∫£i

        // --- LOGIC QU·∫¢N L√ù T·ªî (U1) ---
        let selectedStudentIds = new Set();
    // -----------------------------------------------------------
        // 1. H√†m chuy·ªÉn ƒë·ªïi m√†n h√¨nh ch√≠nh (ƒê√É C·∫¨P NH·∫¨T LOGIC TH√ÅP)
        // 1. H√†m chuy·ªÉn ƒë·ªïi m√†n h√¨nh ch√≠nh (UPDATE: TEAM MANAGER)
        function switchMainScreen(screenName) {
            // A. ·∫®n t·∫•t c·∫£ c√°c view ch√≠nh
            const views = [
                'main-view-dashboard', // üëà [M·ªöI] Th√™m view n√†y v√†o danh s√°ch ·∫©n
                'main-view-inventory',
                'main-view-arena',
                'main-view-tower',
                'main-view-skills',
                'main-view-shop',
                'main-view-boss',
                'main-view-team-manager',
                'main-view-grading' 
            ];

            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // B. Reset style c·ªßa Menu (V·ªÅ tr·∫°ng th√°i ch∆∞a ch·ªçn)
            const navs = {
                'dashboard': document.getElementById('nav-dashboard'),
                'inventory': document.getElementById('nav-inventory'),
                'arena': document.getElementById('nav-arena'),
                'tower': document.getElementById('nav-tower'),
                'skills': document.getElementById('nav-skills'),
                'boss': document.getElementById('nav-boss'),
                'team-manager': document.getElementById('nav-team-manager') // üëà [M·ªöI] Th√™m ID n√∫t menu n√†y
            };

            const setInactive = (el) => {
                if(el) el.className = "flex items-center px-6 py-3 text-gray-700 hover:bg-amber-50 hover:text-amber-900 transition-all cursor-pointer";
            };
            const setActive = (el) => {
                if(el) el.className = "flex items-center px-6 py-3 bg-amber-100 text-amber-900 font-bold border-r-4 border-amber-600 transition-all cursor-pointer";
            };

            // Reset t·∫•t c·∫£ n√∫t v·ªÅ tr·∫°ng th√°i th∆∞·ªùng
            Object.values(navs).forEach(el => setInactive(el));

            // C. T·∫Øt c√°c ti·∫øn tr√¨nh ch·∫°y ng·∫ßm (Ti·∫øt ki·ªám t√†i nguy√™n)
            if (typeof stopLobbyAutoUpdate === 'function') stopLobbyAutoUpdate();
            if (typeof resetBossCombat === 'function') resetBossCombat();

            // D. X·ª≠ l√Ω hi·ªÉn th·ªã theo t√™n m√†n h√¨nh
            if (screenName === 'dashboard') {
                const view = document.getElementById('main-view-dashboard');
                if(view) view.classList.remove('hidden');
                setActive(navs.dashboard);
                if(window.loadDashboardData) window.loadDashboardData(); 
                if(typeof loadActivityLogs === 'function') loadActivityLogs();
            } 
            else if (screenName === 'inventory') {
                const view = document.getElementById('main-view-inventory');
                if(view) view.classList.remove('hidden');
                setActive(navs.inventory);
                if (typeof loadInventoryDataFull === 'function') loadInventoryDataFull();
                if (typeof switchInventoryTab === 'function') switchInventoryTab('bag'); 
            }
            else if (screenName === 'arena') {
                const view = document.getElementById('main-view-arena');
                if(view) view.classList.remove('hidden');
                setActive(navs.arena);
                if (typeof loadArenaData === 'function') loadArenaData();
                if (typeof startLobbyAutoUpdate === 'function') startLobbyAutoUpdate();
            }
            else if (screenName === 'tower') {
                const view = document.getElementById('main-view-tower');
                if(view) view.classList.remove('hidden');
                setActive(navs.tower);
                if (typeof resetTowerUI === 'function') {
                    resetTowerUI(); 
                } else {
                    document.getElementById('tower-lobby').classList.remove('hidden');
                    document.getElementById('tower-combat').classList.add('hidden');
                }
            }
            else if (screenName === 'skills') {
                const view = document.getElementById('main-view-skills');
                if(view) view.classList.remove('hidden');
                setActive(navs.skills);
                if (typeof loadSkillTab === 'function') loadSkillTab();
            }
            else if (screenName === 'shop') {
                const view = document.getElementById('main-view-shop');
                if(view) view.classList.remove('hidden');
                
                // ƒê·ªìng b·ªô ti·ªÅn t·ªá header shop
                if(document.getElementById('wallet-exp')) document.getElementById('shop-wallet-trithuc').innerText = document.getElementById('wallet-exp').innerText;
                if(document.getElementById('stat-vinhdu')) document.getElementById('shop-wallet-vinhdu').innerText = document.getElementById('stat-vinhdu').innerText;
                if(document.getElementById('stat-chientich')) document.getElementById('shop-wallet-chientich').innerText = document.getElementById('stat-chientich').innerText;

                if (typeof loadShopItems === 'function') loadShopItems();
            }
            else if (screenName === 'boss') {
                const view = document.getElementById('main-view-boss');
                if(view) view.classList.remove('hidden');
                setActive(navs.boss);
                if (dashboardData && dashboardData.stats && typeof checkBossStatus === 'function') {
                    checkBossStatus();
                }
            }
            // üëá [M·ªöI] X·ª¨ L√ù QU·∫¢N L√ù T·ªî (TEAM MANAGER) üëá
            else if (screenName === 'team-manager') {
                const view = document.getElementById('main-view-team-manager');
                if(view) view.classList.remove('hidden');
                setActive(navs['team-manager']); // Highlight n√∫t menu
                
                // G·ªçi h√†m t·∫£i danh s√°ch h·ªçc sinh
                if (typeof loadFreeAgents === 'function') {
                    loadFreeAgents();
                }
                if (typeof loadTeamMembers === 'function') loadTeamMembers();
            }

            // x·ª≠ l√Ω nh·∫≠p ƒëi·ªÉm

            else if (screenName === 'grading') {
                const view = document.getElementById('main-view-grading');
                if(view) view.classList.remove('hidden');
                
                // Highlight menu
                const navGrading = document.getElementById('nav-grading');
                if(navGrading) setActive(navGrading); // Gi·∫£ s·ª≠ b·∫°n d√πng l·∫°i h√†m setActive/setInactive c≈©

                // G·ªçi h√†m t·∫£i dropdown h·ªçc sinh
                if (typeof loadGradingStudents === 'function') loadGradingStudents();
            }
        }

        function loadDashboardData() {
            console.log("Dang tai du lieu...");
            const modal = document.getElementById('class-modal');
            const username = localStorage.getItem('kpi_username');
            // [B·∫¢O V·ªÜ] N·∫øu kh√¥ng t√¨m th·∫•y user (ch∆∞a ƒëƒÉng nh·∫≠p) -> ƒê√° v·ªÅ trang Login
            if (!username) {
                alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
                window.location.href = '/index.html';
                return;
            }
            fetch(`/api/player/dashboard?username=${username}`)
                .then(function(response) {
                    if (!response.ok) throw new Error("L·ªói Server: " + response.statusText);
                    return response.json();
                })
                .then(function(data) {
                    console.log("‚úÖ D·ªØ li·ªáu t·∫£i th√†nh c√¥ng:", data);
                    window.dashboardData = data;
                    try { dashboardData = data; } catch(e) {}
                    window.myStatus = {
                                    ...data.info,
                        tri_thuc: data.wallet.tri_thuc,
                        learned: data.info.learned || {}, // Danh s√°ch skill ƒë√£ h·ªçc
                        equipped: data.info.equipped_skill || data.info.equipped || null // Skill ƒëang d√πng
                    };
                    console.log("‚öîÔ∏è Skill ƒë√£ n·∫°p l·∫°i sau khi F5:", window.myStatus.equipped);
                    if (typeof checkBossStatus === 'function') {
                        console.log("üîî D·ªØ li·ªáu ƒë√£ v·ªÅ -> K√≠ch ho·∫°t ki·ªÉm tra Boss ngay!");
                        checkBossStatus();
                    }
                    const modal = document.getElementById('class-modal'); // ƒê·∫£m b·∫£o ƒë√£ l·∫•y ƒë∆∞·ª£c bi·∫øn modal
                    
                    // KI·ªÇM TRA: N·∫øu ch∆∞a c√≥ class (ho·∫∑c l√† NOVICE)
                    if (!data.info.class_type || data.info.class_type === "NOVICE") {
                        // Ch·ªâ l√∫c n√†y m·ªõi cho hi·ªán ra
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                    } else {
                        // ƒê√£ c√≥ class th√¨ ƒë·∫£m b·∫£o n√≥ lu√¥n ·∫©n (kh√¥ng l√†m g√¨ c·∫£ v√¨ m·∫∑c ƒë·ªãnh HTML ƒë√£ hidden)
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }

                    renderUI(data);
                })
            .catch(function(error) {
                // 1. Log l·ªói ra console ƒë·ªÉ l·∫≠p tr√¨nh vi√™n bi·∫øt
                console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu (Critical Error):", error);
                
                // 2. Th√¥ng b√°o r√µ r√†ng cho ng∆∞·ªùi d√πng
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n.\nVui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");

                // 3. X·ª≠ l√Ω an to√†n: ƒê∆∞a ng∆∞·ªùi d√πng v·ªÅ trang ƒëƒÉng nh·∫≠p
                // V√¨ kh√¥ng c√≥ d·ªØ li·ªáu th√¨ kh√¥ng th·ªÉ ch∆°i game ƒë∆∞·ª£c, n√™n gi·ªØ l·∫°i trang dashboard tr·∫Øng c≈©ng v√¥ nghƒ©a
                window.location.href = 'index.html'; 
            });
        }

        function renderUI(data) {
            // 1. INFO C∆† B·∫¢N
            var info = data.info || {}; // Ch·ª©a th√¥ng tin t·ª´ b·∫£ng Player
            var stats = data.stats || {}; 
            
            // [S·ª¨A 1]: Model l√† full_name, n√™n g·ªçi info.full_name m·ªõi ƒë√∫ng
            var displayName = info.full_name || info.fullname || "Ch∆∞a ƒë·∫∑t t√™n";
            document.getElementById('hero-name').innerText = displayName;
            document.getElementById('mini-name').innerText = displayName;
            
            document.getElementById('hero-level').innerText = info.level || 1;
            
            // X·ª≠ l√Ω Class & Avatar
            var classType = info.class_type || "NOVICE";
            document.getElementById('hero-class').innerText = classType;
            
            const classConfig = {
                "WARRIOR": "/assets/character/warrior.png", // Th√™m d·∫•u / cho ch·∫Øc
                "MAGE":    "/assets/character/mage.png", 
                "NOVICE":  "/assets/character/mage.png"
            };
            var avatarUrl = classConfig[classType] || classConfig["NOVICE"];
            
            var imgElement = document.getElementById('hero-image');
            if (imgElement) {
                imgElement.src = avatarUrl;
                imgElement.onerror = function() { this.src = classConfig["NOVICE"]; };
            }
            
            // --- [S·ª¨A 2: QUAN TR·ªåNG NH·∫§T] THANH M√ÅU (HP) ---
            var hp = info.hp || 0;
            
            // Trong Model l√† hp_max -> N√™n ·ªü ƒë√¢y PH·∫¢I l·∫•y info.hp_max
            // Logic: ∆Øu ti√™n info.hp_max, n·∫øu kh√¥ng c√≥ th√¨ t√¨m c√°c bi·∫øn d·ª± ph√≤ng
            var maxHp = info.hp_max || stats.hp_max || 100; 

            // T√≠nh ph·∫ßn trƒÉm
            var hpPercent = 0;
            if (maxHp > 0) {
                hpPercent = Math.max(0, Math.min((hp / maxHp) * 100, 100));
            }
            
            document.getElementById('hp-text').innerText = hp + "/" + maxHp;
            document.getElementById('hp-bar').style.width = hpPercent + "%";
            
            // Hi·ªáu ·ª©ng m√°u ƒë·ªè
            if (hpPercent < 30) {
                document.getElementById('hp-bar').className = "bg-red-600 animate-pulse h-2.5 rounded-full transition-all";
            } else {
                document.getElementById('hp-bar').className = "bg-green-500 h-2.5 rounded-full transition-all";
            }

            // --- [S·ª¨A 3] THANH T·∫§N C√îNG (ATK) ---
            // Model c√≥ c·ªôt atk, n√™n l·∫•y info.atk l√† chu·∫©n
            var atk = info.atk || 0;
            var maxAtk = 20000; // M·ªëc hi·ªÉn th·ªã cho ƒë·∫πp
            var atkPercent = Math.min((atk / maxAtk) * 100, 100);
            document.getElementById('atk-text').innerText = atk;
            document.getElementById('atk-bar').style.width = atkPercent + "%";

            // --- [S·ª¨A 4] THANH KINH NGHI·ªÜM (EXP) ---
            // Model c√≥ c·ªôt exp v√† next_level_exp
            var currentExp = info.exp || 0;
            var nextLevelExp = info.next_level_exp || 100; // M·∫∑c ƒë·ªãnh 100 theo Model
            
            document.getElementById('progress-level-number').innerText = info.level || 1;
            
            var expPercent = 0;
            if (nextLevelExp > 0) {
                expPercent = (currentExp / nextLevelExp) * 100;
                if (expPercent > 100) expPercent = 100;
            }

            // C·∫≠p nh·∫≠t s·ªë li·ªáu HTML
            var curExpEl = document.getElementById('current-exp');
            var nextExpEl = document.getElementById('next-level-exp');
            var expBarEl = document.getElementById('exp-bar-width');
            var expMsgEl = document.getElementById('exp-message');

            if (curExpEl) curExpEl.innerText = currentExp.toLocaleString();
            if (nextExpEl) nextExpEl.innerText = nextLevelExp.toLocaleString();
            if (expBarEl) expBarEl.style.width = expPercent + "%";

            // C·∫≠p nh·∫≠t th√¥ng b√°o ƒë·ªông vi√™n
            if (expMsgEl) {
                var missingExp = nextLevelExp - currentExp;
                if (missingExp > 0) {
                    expMsgEl.innerText = `C·∫ßn ${missingExp} EXP ƒë·ªÉ l√™n c·∫•p!`;
                    expMsgEl.className = "text-[10px] text-gray-400 italic";
                } else {
                    expMsgEl.innerText = "S·∫µn s√†ng thƒÉng c·∫•p!";
                    expMsgEl.className = "text-[10px] text-yellow-600 font-bold animate-pulse";
                }
            }

            // --- [4] C√ÅC CH·ªà S·ªê TI·ªÄN T·ªÜ & KPI ---
            var wallet = data.wallet || {};
            var infoStats = data.stats || {}; // L·∫•y l·∫°i bi·∫øn stats cho ch·∫Øc

            document.getElementById('stat-kpi').innerText = infoStats.kpi || 0;
            document.getElementById('stat-violation').innerText = infoStats.violation || 0;
            
            // C·∫≠p nh·∫≠t Ti·ªÅn t·ªá
            document.getElementById('stat-chientich').innerText = wallet.chien_tich || 0;
            document.getElementById('stat-vinhdu').innerText = wallet.vinh_du || 0;
            
            // [M·ªöI] C·∫≠p nh·∫≠t Tri Th·ª©c (Gold)
            var triThucEl = document.getElementById('stat-trithuc');
            if (triThucEl) {
                triThucEl.innerText = (wallet.tri_thuc || 0).toLocaleString();
            }

            // --- [5] ƒêI·ªÇM S·ªê H·ªåC T·∫¨P ---
            var scores = data.scores || {};
            document.getElementById('score-speech').innerText = scores.speech || 0;
            document.getElementById('score-tx').innerText = scores.midterm || 0;
            document.getElementById('score-product').innerText = scores.product || 0;
            document.getElementById('score-hk').innerText = scores.final || 0;
        
            // --- [6] L·ªäCH S·ª¨ NH·∫¨P ƒêI·ªÇM ---
            var historyList = data.history || [];
            var logContainer = document.getElementById('activity-log');
            
            if (logContainer) {
                logContainer.innerHTML = ""; 

                if (historyList.length === 0) {
                    logContainer.innerHTML = '<li class="text-gray-500 text-sm text-center">Ch∆∞a c√≥ ghi nh·∫≠n ƒëi·ªÉm s·ªë n√†o.</li>';
                } else {
                    historyList.forEach(function(item) {
                        var colorClass = "text-green-600"; 
                        if (item.type === "danger" || (item.change && item.change.includes("-"))) {
                            colorClass = "text-red-600"; 
                        }

                        var html = `
                            <li class="bg-white p-3 rounded border border-amber-100 flex justify-between items-center shadow-sm">
                                <div>
                                    <p class="text-sm font-bold text-gray-800">${item.action}</p>
                                    <p class="text-xs text-gray-500">
                                        <i class="far fa-clock"></i> ${item.time} | 
                                        <i class="fas fa-user-edit"></i> ${item.by}
                                    </p>
                                </div>
                                <span class="${colorClass} font-bold text-lg">${item.change}</span>
                            </li>
                        `;
                        logContainer.insertAdjacentHTML('beforeend', html);
                    });
                }
            }
        
        // --- [M·ªöI] X·ª¨ L√ù PH√ÇN QUY·ªÄN MENU (SIDEBAR) ---
        var role = (info.role || "U3").toUpperCase(); // L·∫•y role, m·∫∑c ƒë·ªãnh l√† U3
        
        var adminMenu = document.getElementById('menu-group-admin');
        var bonhiemBtn = document.getElementById('menu-item-bonhiem');

        if (adminMenu) {
            // Nh√≥m 1: Hi·ªán n·∫øu l√† ADMIN, GV, U1, ho·∫∑c U2
            if (["ADMIN", "GV", "U1", "U2"].includes(role)) {
                adminMenu.classList.remove('hidden');
                
                // M·ª•c B·ªï Nhi·ªám: Ch·ªâ hi·ªán n·∫øu l√† ADMIN, GV ho·∫∑c U1 (U2 kh√¥ng ƒë∆∞·ª£c xem)
                if (bonhiemBtn) {
                    if (["ADMIN", "GV", "U1"].includes(role)) {
                        bonhiemBtn.classList.remove('hidden');
                    } else {
                        bonhiemBtn.classList.add('hidden');
                    }
                }
            } else {
                // N·∫øu l√† U3 (H·ªçc sinh th∆∞·ªùng) -> ·∫®n h·∫øt nh√≥m 1
                adminMenu.classList.add('hidden');
            }
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin Mini Profile d∆∞·ªõi ƒë√°y Menu
        document.getElementById('mini-level').innerText = info.level || 1;
        }
        // --- LOGIC POPUP CHUY·ªÇN NGH·ªÄ ---    
        function openClassModal() {
            document.getElementById('class-modal').classList.remove('hidden');
            document.getElementById('class-modal').classList.add('flex');
        }

        function closeClassModal() {
            document.getElementById('class-modal').classList.add('hidden');
            document.getElementById('class-modal').classList.remove('flex');
        }
        // H√†m ch·ªçn class (G·ªçi API)
        function selectClass(className) {
            // 1. X√°c nh·∫≠n ng∆∞·ªùi d√πng (UX)
            if(!confirm("B·∫°n s·∫Ω tr·ªü th√†nh " + className + ". H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) return;

            // 2. L·∫•y Username t·ª´ b·ªô nh·ªõ (Quan tr·ªçng: Backend c·∫ßn c√°i n√†y)
            const username = localStorage.getItem("kpi_username");
            
            if (!username) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëƒÉng nh·∫≠p! H√£y ƒëƒÉng nh·∫≠p l·∫°i.");
                window.location.href = '/';
                return;
            }

            console.log(`‚è≥ ƒêang chuy·ªÉn class: ${className} cho user: ${username}`);

            // 3. G·ªçi Backend (D√πng Query Param chu·∫©n x√°c)
            // Th√™m /api/user v√†o ph√≠a tr∆∞·ªõc ƒë·ªÉ n√≥ t√¨m ƒë√∫ng h√†m trong file user.py
            const url = `/api/user/player/choose-class?username=${username}&class_name=${className}`;

            fetch(url, {
                method: 'POST' 
                // Kh√¥ng c·∫ßn Header Authorization n·ªØa v√¨ ta ƒëang d√πng username tr·ª±c ti·∫øp
            })
            .then(function(response) {
                if (!response.ok) {
                    // N·∫øu l·ªói, n√©m ra ƒë·ªÉ catch b·∫Øt
                    throw new Error("L·ªói Server (" + response.status + "): " + response.statusText);
                }
                return response.json();
            })
            .then(function(data) {
                console.log("‚úÖ Ch·ªçn class th√†nh c√¥ng:", data);
                alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ch√≠nh th·ª©c tr·ªü th√†nh " + className);

                // 4. ·∫®n Modal ngay l·∫≠p t·ª©c
                const modal = document.getElementById('class-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }

                // 5. Load l·∫°i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t thanh m√°u v√† ch·ªâ s·ªë m·ªõi
                loadDashboardData(); 
            })
            .catch(function(err) {
                console.error("‚ùå L·ªói:", err);
                alert("Kh√¥ng th·ªÉ ch·ªçn nh√¢n v·∫≠t: " + err.message);
            });
        }
        // --- H√ÄM ƒêƒÇNG XU·∫§T ---
        function logout() {
            // 1. H·ªèi x√°c nh·∫≠n cho ch·∫Øc (tr√°nh b·∫•m nh·∫ßm)
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi kh·ªèi H·ªçc Vi·ªán kh√¥ng?")) {
                return; 
            }

            console.log("üëã ƒêang ƒëƒÉng xu·∫•t...");

            // 2. X√≥a s·∫°ch d·∫•u v·∫øt trong b·ªô nh·ªõ tr√¨nh duy·ªát
            localStorage.removeItem('kpi_username');
            localStorage.removeItem('kpi_fullname');
            // N·∫øu c√≥ l∆∞u token hay g√¨ kh√°c th√¨ x√≥a n·ªët
            localStorage.clear(); 

            // 3. ƒê√° v·ªÅ trang Login (C·ªïng ch√≠nh)
            window.location.href = '/';
        }
        

        /* ============================================================
        üéí LOGIC KHO ƒê·ªí & TRANG B·ªä (ƒê√É H·ª¢P NH·∫§T & FIX L·ªñI)
        ============================================================ */

        // 1. H√ÄM CHUY·ªÇN TAB (Gi·ªØ nguy√™n logic t·ªët c·ªßa b·∫°n, ch·ªâ tinh ch·ªânh ID)
        function switchInventoryTab(tabName) {
            // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
            document.querySelectorAll('.inv-tab-content').forEach(el => el.classList.add('hidden'));

            // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
            const targetTab = document.getElementById(`view-${tabName}`);
            if (targetTab) targetTab.classList.remove('hidden');

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m
            ['equip', 'bag', 'market'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                if (btn) {
                    if (t === tabName) {
                        // Active: M√†u v√†ng/cam
                        btn.className = "px-6 py-2 rounded-lg font-bold text-amber-900 bg-amber-100 shadow-sm transition-all border border-amber-200";
                    } else {
                        // Inactive: M√†u x√°m
                        btn.className = "px-6 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-50 transition-all border border-transparent";
                    }
                }
            });

            // N·∫øu b·∫•m tab Ch·ª£ -> T·∫£i d·ªØ li·ªáu ch·ª£
            if (tabName === 'market' && typeof loadMarketData === 'function') {
                loadMarketData();
            }
        }

        // 2. H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ªîNG H·ª¢P (G·ªôp c·∫£ Stats v√† Items v√†o 1 h√†m duy nh·∫•t)
        async function loadInventoryDataFull() {
            console.log("üöÄ [B∆Ø·ªöC 1] B·∫Øt ƒë·∫ßu h√†m loadInventoryDataFull...");
            // A. C·∫≠p nh·∫≠t Stats (M√°u/S·ª©c m·∫°nh) t·ª´ Dashboard Data (N·∫øu c√≥)
            if (window.dashboardData) {
                const data = window.dashboardData;
                // Logic l·∫•y m√°u an to√†n t·ª´ file c≈© c·ªßa b·∫°n
                let currentHP = (data.info && data.info.hp !== undefined) ? data.info.hp : (data.stats && data.stats.hp) || 0;
                let maxHP = (data.info && data.info.hp_max) ? data.info.hp_max : (data.stats && data.stats.max_hp) || 100;
                let atk = (data.stats && data.stats.atk !== undefined) ? data.stats.atk : (data.info && data.info.atk) || 0;

                const hpEl = document.getElementById('view-stat-hp');
                const atkEl = document.getElementById('view-stat-atk');
                if (hpEl) hpEl.innerText = `${currentHP} / ${maxHP}`;
                if (atkEl) atkEl.innerText = `ATK: ${atk}`;
            }

            // B. T·∫£i danh s√°ch v·∫≠t ph·∫©m
            const username = localStorage.getItem('username');
            console.log("üë§ [B∆Ø·ªöC 2] Username t√¨m th·∫•y:", username);
            
            if (!username) {
                console.error("‚ùå L·ªói: Kh√¥ng c√≥ username, d·ª´ng l·∫°i!");
                return;
            }

            // M·ªü tab
            console.log("üîÑ [B∆Ø·ªöC 3] ƒêang g·ªçi switchInventoryTab('bag')...");
            if (typeof switchInventoryTab === 'function') {
                switchInventoryTab('bag');
            } else {
                console.warn("‚ö†Ô∏è C·∫£nh b√°o: H√†m switchInventoryTab ch∆∞a ƒë∆∞·ª£c khai b√°o!");
            }

            try {
                console.log("üì° [B∆Ø·ªöC 4] B·∫Øt ƒë·∫ßu g·ªçi API...");
                const res = await fetch(`/api/inventory/get?username=${username}`);
                console.log("üì° [B∆Ø·ªöC 5] API ph·∫£n h·ªìi status:", res.status);

                const data = await res.json();
                console.log("üì¶ [B∆Ø·ªöC 6] D·ªØ li·ªáu JSON t·ª´ Server:", data);

                if (res.ok) {
                    const listItems = data.bag || data.inventory || [];
                    const listEquip = data.equipment || data.equipped || {};

                    console.log(`üé® [B∆Ø·ªöC 7] T√¨m th·∫•y ${listItems.length} m√≥n ƒë·ªì. ƒêang g·ªçi renderBag...`);
                    
                    // Ki·ªÉm tra xem h√†m renderBag c√≥ t·ªìn t·∫°i kh√¥ng
                    if (typeof renderBag === 'function') {
                        renderBag(listItems);
                        console.log("‚úÖ [B∆Ø·ªöC 8] ƒê√£ ch·∫°y xong renderBag.");
                    } else {
                        console.error("‚ùå [L·ªñI CH·∫æT NG∆Ø·ªúI] Kh√¥ng t√¨m th·∫•y h√†m renderBag() trong file JS!");
                    }

                    if (typeof renderEquip === 'function') {
                        renderEquip(listEquip);
                    }
                } else {
                    console.error("‚ùå [L·ªñI API] Server b√°o l·ªói:", data);
                }
            } catch (err) {
                console.error("‚ùå [CRASH] L·ªói s·∫≠p h√†m:", err);
            }
        }

        // H√ÄM V·∫º T√öI ƒê·ªí (Phi√™n b·∫£n "B·∫•t T·ª≠" - Ch·∫•p m·ªçi lo·∫°i HTML)
        function renderBag(items) {
            // 1. Th·ª≠ t√¨m c√°i r·ªï t√™n 'bag-grid' (HTML x·ªãn)
            let container = document.getElementById('bag-grid');
            
            // 2. N·∫øu kh√¥ng th·∫•y, th·ª≠ t√¨m c√°i r·ªï t√™n 'inventory-grid' (HTML c≈©)
            if (!container) {
                container = document.getElementById('inventory-grid');
            }

            // 3. N·∫øu v·∫´n kh√¥ng th·∫•y -> B√°o ƒë·ªông ƒë·ªè
            if (!container) {
                console.error("‚ùå L·ªñI NGHI√äM TR·ªåNG: Kh√¥ng t√¨m th·∫•y th·∫ª HTML n√†o ƒë·ªÉ hi·ªÉn th·ªã t√∫i ƒë·ªì!");
                return;
            }

            console.log("‚úÖ ƒê√£ t√¨m th·∫•y khung ch·ª©a ƒë·ªì. ƒêang v·∫Ω", items.length, "m√≥n...");

            // 4. X√≥a s·∫°ch c≈©
            container.innerHTML = '';

            // 5. Ki·ªÉm tra t√∫i r·ªóng
            if (!items || items.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-gray-400 italic py-10">T√∫i tr·ªëng tr∆°n. H√£y mua g√¨ ƒë√≥ ƒëi!</div>`;
                return;
            }

            // 6. V·∫Ω t·ª´ng m√≥n
            container.innerHTML = items.map(item => {
                // L·∫•y d·ªØ li·ªáu an to√†n
                const qty = item.amount || item.quantity || 1;
                const img = item.image_url || item.image || 'https://placehold.co/100';
                const name = item.name || "V·∫≠t ph·∫©m";
                
                // ID ƒë·ªÉ d√πng item
                const useId = item.item_id || item.id; 

                // --- A. LOGIC N√öT H√ÄNH ƒê·ªòNG (D√πng/Trang b·ªã/Kh√≥a) ---
                let actionBtn = '';
                if (item.is_usable) {
                    // N√∫t D√πng (Xanh l√°)
                    actionBtn = `<button onclick="useItem(${useId})" class="flex-1 py-1.5 bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold rounded shadow transition flex items-center justify-center gap-1">‚ö° D√πng</button>`;
                } else if (item.is_equippable) {
                    // N√∫t Trang b·ªã (Xanh d∆∞∆°ng)
                    actionBtn = `<button onclick="equipItem(${useId})" class="flex-1 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold rounded shadow transition flex items-center justify-center gap-1">üõ°Ô∏è ƒê·ªì</button>`;
                } else {
                    // N√∫t Kh√≥a (X√°m)
                    actionBtn = `<span class="flex-1 py-1.5 bg-gray-700 text-gray-500 text-[10px] font-bold rounded border border-gray-600 flex items-center justify-center cursor-not-allowed">üîí Kh√≥a</span>`;
                }

                // --- B. LOGIC N√öT B√ÅN (M√†u V√†ng Cam) ---
                // L∆∞u √Ω: truy·ªÅn item.item_id (ho·∫∑c useId), t√™n, ·∫£nh, v√† s·ªë l∆∞·ª£ng t·ªëi ƒëa v√†o h√†m openSellPopup
                // S·ª≠ d·ª•ng replace ƒë·ªÉ tr√°nh l·ªói n·∫øu t√™n c√≥ d·∫•u nh√°y ƒë∆°n
                const safeName = name.replace(/'/g, "\\'"); 
                const safeImg = img.replace(/'/g, "\\'");
                
                const sellBtn = `<button onclick="openSellPopup(${useId}, '${safeName}', '${safeImg}', ${qty})" class="flex-1 py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-[10px] font-bold rounded shadow transition flex items-center justify-center gap-1">üí∞ B√°n</button>`;

                // HTML hi·ªÉn th·ªã (Card ƒë·∫πp)
                return `
                    <div class="bg-gray-800 border border-gray-600 p-3 rounded-xl shadow-lg hover:shadow-xl hover:border-amber-400 transition duration-300 relative group">
                        <span class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow border border-white/20 z-10">
                            x${qty}
                        </span>

                        <div class="h-16 w-full flex items-center justify-center mb-2 bg-gray-900/50 rounded-lg p-1">
                            <img src="${img}" class="h-full object-contain drop-shadow-md hover:scale-110 transition" onerror="this.src='https://placehold.co/64?text=Item'">
                        </div>

                        <div class="text-center">
                            <h4 class="font-bold text-gray-200 text-xs truncate mb-2" title="${name}">${name}</h4>
                            
                            <div class="flex gap-2">
                                ${actionBtn}
                                ${sellBtn}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 4. Render Trang B·ªã (4 Slots)
        // 1. S·ª≠a h√†m renderEquip (Ch·ªânh m√†u ƒë·∫≠m h∆°n)
        function renderEquip(equipped) {
            const container = document.getElementById('equip-slots-container');
            container.innerHTML = '';

            for (let i = 1; i <= 4; i++) {
                const slotKey = `slot_${i}`;
                const item = equipped[slotKey];
                
                let content = '';
                if (item) {
                    // C√ì ƒê·ªí: Hi·ªÉn th·ªã ƒë·∫πp h∆°n
                    content = `
                        <div class="relative w-full h-full flex flex-col items-center justify-center group">
                            <img src="${item.image}" class="w-20 h-20 object-contain drop-shadow-md transition-transform group-hover:scale-110">
                            <span class="text-xs font-bold mt-1 text-center bg-white/90 px-2 py-0.5 rounded border border-gray-300 text-gray-800 shadow-sm whitespace-nowrap overflow-hidden max-w-[90%] text-ellipsis">${item.name}</span>
                            <button onclick="unequipItem(${i})" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-700 shadow-lg border-2 border-white font-bold z-10" title="Th√°o ƒë·ªì">&times;</button>
                        </div>
                    `;
                } else {
                    // SLOT TR·ªêNG: M√†u n√¢u ƒë·∫≠m (Amber-900) & Icon to h∆°n
                    content = `
                        <div class="flex flex-col items-center justify-center text-amber-900 opacity-60 hover:opacity-100 transition-opacity">
                            <i class="fas fa-plus-circle text-4xl mb-2"></i>
                            <span class="text-sm font-extrabold uppercase tracking-wide">Slot ${i}</span>
                        </div>
                    `;
                }

                // Khung vi·ªÅn ƒë·∫≠m h∆°n (border-amber-600)
                const slotHtml = `
                    <div class="w-32 h-40 bg-[#e8dcc5] border-2 border-dashed border-amber-700 rounded-xl flex items-center justify-center hover:bg-amber-200/50 transition-colors relative shadow-inner">
                        ${content}
                    </div>
                `;
                container.innerHTML += slotHtml;
            }
        }
        // 5. Render Ch·ª£ ƒêen
        async function loadMarketData() {
            try {
                const token = localStorage.getItem("access_token"); // L·∫•y token
                if (!token) {
                    console.error("Ch∆∞a ƒëƒÉng nh·∫≠p, kh√¥ng th·ªÉ t·∫£i ch·ª£!");
                    return;
                }

                // 1. TH√äM HEADER AUTH (Quan tr·ªçng)
                const res = await fetch('/api/market/list', {
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!res.ok) {
                    console.error("L·ªói API:", res.status);
                    return;
                }

                const rawData = await res.json();
                
                // üëá LOG ƒê·ªÇ SOI XEM API TR·∫¢ V·ªÄ C√ÅI G√å
                console.log("üì¶ Market Data Raw:", rawData);

                // 2. X·ª¨ L√ù D·ªÆ LI·ªÜU AN TO√ÄN (Fix l·ªói forEach)
                // Logic: N·∫øu l√† m·∫£ng -> d√πng lu√¥n. N·∫øu l√† object c√≥ key 'items' -> l·∫•y items. N·∫øu null -> m·∫£ng r·ªóng.
                let marketList = [];
                if (Array.isArray(rawData)) {
                    marketList = rawData;
                } else if (rawData && Array.isArray(rawData.items)) {
                    marketList = rawData.items;
                } else {
                    console.warn("‚ö†Ô∏è API kh√¥ng tr·∫£ v·ªÅ danh s√°ch h·ª£p l·ªá. D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", rawData);
                    marketList = []; 
                }

                const myName = localStorage.getItem('kpi_username');
                const myContainer = document.getElementById('market-my-items');
                const pubContainer = document.getElementById('market-public-items');
                
                // Reset giao di·ªán
                if(myContainer) myContainer.innerHTML = '';
                if(pubContainer) pubContainer.innerHTML = '';

                if (marketList.length === 0) {
                    if(pubContainer) pubContainer.innerHTML = '<p class="text-gray-500 italic">Ch·ª£ v·∫Øng tanh nh∆∞ ch√πa b√† ƒêanh...</p>';
                    return;
                }

                // 3. CH·∫†Y V√íNG L·∫∂P TR√äN BI·∫æN ƒê√É L·ªåC (marketList)
                marketList.forEach(item => {
                    const currencyIcon = item.currency === 'tri_thuc' ? 'üü°' : (item.currency === 'chien_tich' ? 'üî¥' : 'üîµ');
                    
                    // Th·∫ª Item Ch·ª£
                    const card = `
                        <div class="bg-white border-b-4 border-amber-700 p-3 rounded shadow-sm flex gap-3 items-center min-w-[250px]">
                            <img src="${item.item_image || '/assets/images/items/default_box.png'}" class="w-16 h-16 object-contain border rounded bg-gray-50">
                            <div class="flex-1">
                                <div class="font-bold text-amber-900 text-sm">${item.item_name} <span class="text-gray-500 text-xs">(x${item.amount})</span></div>
                                <div class="text-xs text-gray-500 mb-1">Ng∆∞·ªùi b√°n: <span class="font-semibold text-blue-600">${item.seller_name}</span></div>
                                <div class="font-bold text-lg text-green-700">${item.price} ${currencyIcon}</div>
                                
                                ${item.seller_name === myName 
                                    ? `<button onclick="cancelSell(${item.id})" class="mt-1 w-full text-xs bg-red-100 text-red-600 py-1 rounded hover:bg-red-200">H·ªßy B√°n</button>`
                                    : `<button onclick="buyItem(${item.id})" class="mt-1 w-full text-xs bg-blue-600 text-white py-1 rounded hover:bg-blue-700 font-bold">MUA NGAY</button>`
                                }
                            </div>
                        </div>
                    `;

                    if (item.seller_name === myName) {
                        if(myContainer) myContainer.innerHTML += card;
                    } else {
                        if(pubContainer) pubContainer.innerHTML += card;
                    }
                });

            } catch (e) {
                console.error("L·ªói crash h√†m loadMarketData:", e);
            }
        }
        // --- C√ÅC H√ÄM H√ÄNH ƒê·ªòNG (ACTIONS) ---
        // A. Trang b·ªã (Auto v√†o slot tr·ªëng ƒë·∫ßu ti√™n)
        async function showEquipOptions(itemId) {
            // ƒê·ªÉ ƒë∆°n gi·∫£n: T·ª± t√¨m slot tr·ªëng 1->4. N·∫øu full th√¨ b√°o l·ªói.
            // Logic n√¢ng cao: Hi·ªán popup ch·ªçn slot (Ta l√†m sau n·∫øu c·∫ßn).
            for (let i = 1; i <= 4; i++) {
                // G·ªçi API th·ª≠ l·∫Øp v√†o slot i
                // Nh∆∞ng logic API c·ªßa ta l√† "N·∫øu slot c√≥ ƒë·ªì th√¨ thay th·∫ø". 
                // V·∫≠y n√™n c·ª© l·∫Øp v√†o Slot 1 cho nhanh, ho·∫∑c h·ªèi ng∆∞·ªùi ch∆°i.
                // T·∫°m th·ªùi: L·∫Øp v√†o Slot 1.
            }
            // C√°ch t·ªët nh·∫•t: H·ªèi ng∆∞·ªùi d√πng nh·∫≠p Slot mu·ªën l·∫Øp (Prompt ƒë∆°n gi·∫£n)
            const slot = prompt("B·∫°n mu·ªën l·∫Øp v√†o Slot n√†o? (Nh·∫≠p 1, 2, 3 ho·∫∑c 4)", "1");
            if(!slot || isNaN(slot) || slot < 1 || slot > 4) return;

            try {
                const res = await fetch('/api/inventory/equip', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: localStorage.getItem('kpi_username'),
                        item_id: itemId,
                        slot_index: parseInt(slot)
                    })
                });
                
                if (res.ok) {
                    alert("Trang b·ªã th√†nh c√¥ng!");
                    loadInventoryDataFull();
                    // C·∫≠p nh·∫≠t l·∫°i stats Dashboard (Load l·∫°i c·∫£ trang ho·∫∑c g·ªçi h√†m update Dashboard)
                    if(window.loadDashboardData) window.loadDashboardData(); 
                } else {
                    const err = await res.json();
                    alert("L·ªói: " + err.detail);
                }
            } catch (e) { console.error(e); }
        }
        // B. Th√°o trang b·ªã
        async function unequipItem(slotIndex) {
            try {
                const res = await fetch('/api/inventory/unequip', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: localStorage.getItem('kpi_username'),
                        slot_index: slotIndex
                    })
                });
                if (res.ok) {
                    loadInventoryDataFull();
                    if(window.loadDashboardData) window.loadDashboardData();
                }
            } catch (e) { console.error(e); }
        }
        // C. S·ª≠ d·ª•ng Item
        async function useItem(itemId) {
            try {
                const res = await fetch('/api/inventory/use', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: localStorage.getItem('kpi_username'),
                        item_id: itemId
                    })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert("üéâ " + data.message);
                    window.location.reload();
                    // N·∫øu l√† r∆∞∆°ng th√¨ data.data.received s·∫Ω c√≥ list ƒë·ªì
                    loadInventoryDataFull();
                    if(window.loadDashboardData) window.loadDashboardData();
                } else {
                    alert("‚ö†Ô∏è " + data.message);
                }
            } catch (e) { console.error(e); }
        }
        // D. Logic B√°n H√†ng (Popup)
        function openSellPopup(id, name, img, maxQty) {
            currentSellItemId = id;
            maxSellAmount = maxQty;
            
            document.getElementById('sell-item-name').innerText = name;
            document.getElementById('sell-item-img').src = img;
            document.getElementById('sell-amount').max = maxQty;
            document.getElementById('sell-amount').value = 1;
            document.getElementById('sellModal').classList.remove('hidden');
        }

        async function confirmSellItem() {
            const amount = parseInt(document.getElementById('sell-amount').value);
            const price = parseInt(document.getElementById('sell-price').value);
            const currency = document.getElementById('sell-currency').value;

            if (amount > maxSellAmount) {
                alert("B·∫°n kh√¥ng ƒë·ªß h√†ng!");
                return;
            }

            try {
                const res = await fetch('/api/market/sell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: localStorage.getItem('kpi_username'),
                        item_id: currentSellItemId,
                        amount: amount,
                        price: price,
                        currency: currency
                    })
                });
                
                if (res.ok) {
                    alert("ƒê√£ ƒëƒÉng b√°n th√†nh c√¥ng!");
                    document.getElementById('sellModal').classList.add('hidden');
                    loadInventoryDataFull();
                } else {
                    alert("L·ªói khi ƒëƒÉng b√°n");
                }
            } catch (e) { console.error(e); }
        }

        // E. Mua h√†ng & H·ªßy b√°n
        async function buyItem(listingId) {
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën mua m√≥n h√†ng n√†y?")) return;
            
            try {
                const res = await fetch('/api/market/buy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        buyer_username: localStorage.getItem('kpi_username'),
                        listing_id: listingId
                    })
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert("Mua th√†nh c√¥ng!");
                    loadMarketData();
                    // Update ti·ªÅn tr√™n Dashboard
                    if(window.loadDashboardData) window.loadDashboardData(); 
                } else {
                    alert("L·ªói: " + data.detail);
                }
            } catch (e) { console.error(e); }
        }

        async function cancelSell(listingId) {
            if (!confirm("G·ª° m√≥n h√†ng n√†y xu·ªëng?")) return;

            try {
                const res = await fetch('/api/market/cancel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        buyer_username: localStorage.getItem('kpi_username'),
                        listing_id: listingId
                    })
                });
                
                if (res.ok) {
                    loadMarketData();
                }
            } catch (e) { console.error(e); }
        }

        // ============================================================
        // ‚öîÔ∏è H·ªÜ TH·ªêNG L√îI ƒê√ÄI (ARENA LOGIC)
        // ============================================================

        // --- 1. H√ÄM KH·ªûI T·∫†O (G·ªåI KHI B·∫§M V√ÄO TAB L√îI ƒê√ÄI) ---
        async function loadArenaData() {
            const username = localStorage.getItem('kpi_username');
            if (!username) return;

            console.log("üèüÔ∏è ƒêang t·∫£i d·ªØ li·ªáu L√¥i ƒë√†i...");

            // 1. Load danh s√°ch ƒë·ªëi th·ªß (H√†m v·ª´a vi·∫øt xong)
            loadOpponentsList();

            // 2. Load V√≠ ti·ªÅn KPI (ƒê·ªÇ NG∆Ø·ªúI CH∆†I BI·∫æT C√íN BAO NHI√äU M√Ä C∆Ø·ª¢C)
            try {
                const resStats = await fetch(`/api/players/${username}`);
                const playerStats = await resStats.json();
                // C·∫≠p nh·∫≠t s·ªë d∆∞ l√™n giao di·ªán
                const walletDisplay = document.getElementById('arena-wallet-display');
                if (walletDisplay) {
                    walletDisplay.innerText = playerStats.kpi || 0;
                }
            } catch (e) {
                console.error("L·ªói t·∫£i v√≠ ti·ªÅn:", e);
            }

            // 3. Load danh s√°ch tr·∫≠n ƒë·∫•u (Inbox) & Badge th√¥ng b√°o
            try {
                const res = await fetch(`/api/arena/list-my-matches?username=${username}`);
                const data = await res.json();
                
                renderIncomingMatches(data.incoming);
                renderOutgoingMatches(data.outgoing);
                
                // üëáüëáüëá TH√äM D√íNG N√ÄY V√ÄO ƒê√ÇY üëáüëáüëá
                // N·∫øu Backend c√≥ tr·∫£ v·ªÅ history th√¨ hi·ªÉn th·ªã, kh√¥ng th√¨ th√¥i
                if (data.history) {
                    renderHistory(data.history);
                }
                // üëÜüëÜüëÜ H·∫æT PH·∫¶N TH√äM üëÜüëÜüëÜ

                
                // --- Ph·∫ßn c·∫≠p nh·∫≠t ch·∫•m ƒë·ªè (Badge) gi·ªØ nguy√™n ---
                const badge = document.getElementById('nav-arena-badge');
                const badgeText = document.getElementById('badge-incoming');
                
                if (data.incoming.length > 0) {
                    if(badge) badge.classList.remove('hidden');
                    if(badgeText) {
                        badgeText.innerText = data.incoming.length;
                        badgeText.classList.remove('hidden');
                    }
                } else {
                    if(badge) badge.classList.add('hidden');
                    if(badgeText) badgeText.classList.add('hidden');
                }

            } catch (e) {
                console.error("L·ªói load Inbox:", e);
            }

            // 4. Load ph√≤ng ch·ªù 2vs2 (Lobby)
            loadArenaLobby();
        }
        async function loadArenaLobby() {
            const myUsername = localStorage.getItem('kpi_username');
            const container = document.getElementById('arena-lobby-list');
            
            try {
                container.innerHTML = '<p class="col-span-3 text-center text-orange-200 italic mt-4"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                
                const res = await fetch(`/api/arena/lobby`);
                const lobbyData = await res.json();
                
                container.innerHTML = ''; // X√≥a loading

                if(lobbyData.length === 0) {
                    container.innerHTML = `<p class="text-orange-300/50 italic col-span-3 text-center border-2 border-dashed border-orange-800/50 rounded-lg py-8">
                        Ch∆∞a c√≥ ph√≤ng 2vs2 n√†o. H√£y t·∫°o ph√≤ng m·ªõi ·ªü tr√™n!
                    </p>`;
                    return;
                }

                lobbyData.forEach(room => {
                    // Check xem m√¨nh c√≥ ƒëang trong ph√≤ng n√†y kh√¥ng
                    const inTeamA = room.team_a.includes(myUsername);
                    const inTeamB = room.team_b.includes(myUsername);
                    const isFullA = room.team_a.length >= 2;
                    const isFullB = room.team_b.length >= 2;

                    // Render danh s√°ch th√†nh vi√™n
                    const renderMembers = (members) => {
                        if(members.length === 0) return '<div class="text-gray-500 text-xs italic">(Tr·ªëng)</div><div class="text-gray-500 text-xs italic">(Tr·ªëng)</div>';
                        let html = '';
                        members.forEach(m => html += `<div class="text-white text-sm font-bold truncate">üë§ ${m}</div>`);
                        if(members.length < 2) html += '<div class="text-gray-500 text-xs italic mt-1">(ƒêang ƒë·ª£i...)</div>';
                        return html;
                    };

                    // Logic n√∫t b·∫•m Team A
                    let btnA = '';
                    if (inTeamA) {
                        // ƒê√£ v√†o -> Hi·ªán n√∫t R√∫t Lui (G·ªçi API Cancel n·∫øu l√† ch·ªß, ho·∫∑c leave n·∫øu l√† member - T·∫°m th·ªùi d√πng logic Cancel chung)
                        btnA = `<button onclick="cancelMatch(${room.id})" class="w-full mt-2 bg-red-900/80 hover:bg-red-700 text-red-200 text-xs py-2 rounded border border-red-500 transition">‚õî R√∫t Lui</button>`;
                    } else if (!inTeamB && !isFullA) {
                        // Ch∆∞a v√†o b√™n n√†o & c√≤n ch·ªó -> Hi·ªán n√∫t Tham Gia
                        btnA = `<button onclick="joinLobby(${room.id}, 'A')" class="w-full mt-2 bg-blue-700 hover:bg-blue-600 text-white text-xs py-2 rounded border border-blue-400 shadow transition">‚úÖ Tham Gia</button>`;
                    } else {
                        // Full ho·∫∑c ƒë√£ ·ªü team kia -> ·∫®n/Disable
                        btnA = `<button disabled class="w-full mt-2 bg-gray-800 text-gray-500 text-xs py-2 rounded border border-gray-700 cursor-not-allowed">Kh√≥a</button>`;
                    }

                    // Logic n√∫t b·∫•m Team B
                    let btnB = '';
                    if (inTeamB) {
                        btnB = `<button onclick="cancelMatch(${room.id})" class="w-full mt-2 bg-red-900/80 hover:bg-red-700 text-red-200 text-xs py-2 rounded border border-red-500 transition">‚õî R√∫t Lui</button>`;
                    } else if (!inTeamA && !isFullB) {
                        btnB = `<button onclick="joinLobby(${room.id}, 'B')" class="w-full mt-2 bg-orange-700 hover:bg-orange-600 text-white text-xs py-2 rounded border border-orange-400 shadow transition">‚úÖ Tham Gia</button>`;
                    } else {
                        btnB = `<button disabled class="w-full mt-2 bg-gray-800 text-gray-500 text-xs py-2 rounded border border-gray-700 cursor-not-allowed">Kh√≥a</button>`;
                    }

                    // HTML C·ªßa Th·∫ª Ph√≤ng (Card)
                    const html = `
                    <div class="bg-gray-900 border border-orange-600/50 rounded-lg overflow-hidden shadow-lg group hover:border-orange-400 transition-all">
                        <div class="bg-gradient-to-r from-orange-900 to-gray-900 px-3 py-2 flex justify-between items-center border-b border-orange-800">
                            <span class="text-xs text-orange-300 font-mono">ID: #${room.id}</span>
                            <span class="text-xs font-bold text-yellow-400 bg-black/40 px-2 py-1 rounded">C∆∞·ª£c: ${room.bet} KPI</span>
                        </div>

                        <div class="flex relative h-32">
                            <div class="w-1/2 bg-slate-800/50 p-3 flex flex-col justify-between border-r border-gray-700">
                                <div>
                                    <div class="text-blue-400 font-bold text-xs uppercase mb-1">Team A (Blue)</div>
                                    ${renderMembers(room.team_a)}
                                </div>
                                ${btnA}
                            </div>

                            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10">
                                <span class="text-2xl font-black text-red-600 italic drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] stroke-white">VS</span>
                            </div>

                            <div class="w-1/2 bg-orange-900/20 p-3 flex flex-col justify-between">
                                <div class="text-right">
                                    <div class="text-orange-400 font-bold text-xs uppercase mb-1">Team B (Red)</div>
                                    <div class="flex flex-col items-end">
                                        ${renderMembers(room.team_b)}
                                    </div>
                                </div>
                                ${btnB}
                            </div>
                        </div>
                        
                        <div class="bg-black/40 px-3 py-1 text-center">
                            <span class="text-[10px] text-gray-400 uppercase tracking-widest">${room.difficulty} MODE</span>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            } catch (e) {
                console.error("L·ªói load Lobby:", e);
                container.innerHTML = `<p class="col-span-3 text-red-400 text-center">L·ªói t·∫£i d·ªØ li·ªáu.</p>`;
            }
        }

        // --- 2. C√ÅC H√ÄM RENDER HTML ---

        function renderIncomingMatches(matches) {
            const container = document.getElementById('arena-incoming-list');
            container.innerHTML = '';
            
            const currentUser = localStorage.getItem("username"); 

            if (matches.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-4">Ch∆∞a c√≥ ai th√°ch ƒë·∫•u b·∫°n...</p>';
                return;
            }

            matches.forEach(m => {
                let actionBtnHtml = '';

                // 1. N·∫øu tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c -> Hi·ªán n√∫t Xem K·∫øt Qu·∫£
                if (m.status === 'finished') {
                    actionBtnHtml = `
                        <div class="text-right">
                            <span class="text-xs font-bold text-green-600 block mb-1">üèÜ ${m.winner_team} th·∫Øng</span>
                            <button onclick="viewMatchResult(${m.match_id})" class="text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600 shadow">
                                Xem KQ
                            </button>
                        </div>
                    `;
                }
                // 2. N·∫øu m√¨nh ch∆∞a ch·∫•p nh·∫≠n (ho·∫∑c ch∆∞a l√†m b√†i) -> Hi·ªán n√∫t Chi·∫øn
                // (Ki·ªÉm tra logs xem t√™n m√¨nh c√≥ trong ƒë√≥ ch∆∞a cho ch·∫Øc ƒÉn)
                else {
                    let iHavePlayed = false;
                    try {
                        let logs = m.logs;
                        if (typeof logs === 'string') logs = JSON.parse(logs.replace(/'/g, '"'));
                        logs = logs || {};
                        if (logs.hasOwnProperty(currentUser)) iHavePlayed = true;
                    } catch (e) { iHavePlayed = false; }

                    if (!iHavePlayed) {
                        // Ch∆∞a ch∆°i -> N√∫t Chi·∫øn
                        actionBtnHtml = `
                            <button onclick="acceptMatch(${m.match_id})" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow font-bold animate-pulse border border-green-500">
                                ‚öîÔ∏è Chi·∫øn ngay
                            </button>
                        `;
                    } else {
                        // ƒê√£ ch∆°i r·ªìi -> N√∫t Ch·ªù
                        actionBtnHtml = `
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded border border-gray-300 italic">
                                ‚è≥ ƒê√£ xong. ƒê·ª£i ƒë·ªëi th·ªß...
                            </span>
                        `;
                    }
                }

                container.innerHTML += `
                <div class="bg-blue-50 p-3 rounded border border-blue-200 flex justify-between items-center mb-2 shadow-sm">
                    <div>
                        <div class="font-bold text-blue-800">‚ö° ${m.creator} <span class="text-xs font-normal text-gray-500">(${m.mode})</span></div>
                        <div class="text-xs text-red-600 font-bold">C∆∞·ª£c: ${m.bet} KPI <span class="text-gray-400">| ${m.difficulty}</span></div>
                        ${m.status === 'finished' ? '<div class="text-[10px] text-gray-400">ƒê√£ k·∫øt th√∫c</div>' : ''}
                    </div>
                    <div class="flex gap-2 items-center">
                        ${actionBtnHtml}
                    </div>
                </div>`;
            });
        }

        function renderOutgoingMatches(matches) {
            const container = document.getElementById('arena-outgoing-list');
            container.innerHTML = '';

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-4">B·∫°n ch∆∞a th√°ch ƒë·∫•u ai...</p>';
                return;
            }

            matches.forEach(m => {
                const date = new Date(m.created_at).toLocaleString('vi-VN');
                
                // --- 1. X·ª¨ L√ù LOGS AN TO√ÄN ---
                let logsObj = {};
                try {
                    if (!m.logs) logsObj = {};
                    else if (typeof m.logs === 'object') logsObj = m.logs;
                    else if (typeof m.logs === 'string') {
                        // Fix l·ªói nh√°y ƒë∆°n c·ªßa Python
                        logsObj = JSON.parse(m.logs.replace(/'/g, '"'));
                    }
                } catch (e) { console.error("Parse logs error:", e); }

                // --- 2. KI·ªÇM TRA M√åNH (PLAYER 1) ƒê√É CH∆†I CH∆ØA ---
                const p1Name = String(m.player_1).trim();
                const playedList = Object.keys(logsObj).map(name => name.trim());
                const creatorHasPlayed = playedList.includes(p1Name);

                // --- 3. QUY·∫æT ƒê·ªäNH HI·ªÇN TH·ªä ---
                let actionHtml = '';

                // CH·ªà C√íN 2 TR∆Ø·ªúNG H·ª¢P (V√¨ tr·∫≠n Finished ƒë√£ sang b·∫£ng L·ªãch s·ª≠)
                if (!creatorHasPlayed) {
                    // TR∆Ø·ªúNG H·ª¢P 1: Ch∆∞a l√†m b√†i -> Hi·ªán n√∫t START MATCH (Quan tr·ªçng)
                    actionHtml = `
                        <div class="text-right">
                            <button onclick="startMatch(${m.match_id})" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded shadow animate-pulse hover:bg-blue-500 font-bold mb-1 w-full flex items-center justify-center gap-1 border border-blue-700">
                                ‚ö° V√†o thi ngay
                            </button>
                            <div class="text-[10px] text-red-500 italic font-bold">‚ö†Ô∏è T·ªõi l∆∞·ª£t b·∫°n!</div>
                        </div>
                    `;
                } else {
                    // TR∆Ø·ªúNG H·ª¢P 2: ƒê√£ l√†m b√†i -> Hi·ªán ƒêANG CH·ªú
                    actionHtml = `
                        <div class="text-right">
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mb-1 block text-center border border-yellow-200 font-medium">
                                ‚è≥ ƒê√£ l√†m b√†i
                            </span>
                            <div class="text-[10px] text-gray-500">ƒê·ª£i ƒë·ªëi th·ªß...</div>
                        </div>
                    `;
                }

                // --- 4. RENDER HTML ---
                container.innerHTML += `
                <div class="bg-gray-100 p-3 rounded border border-gray-300 flex justify-between items-center mb-2 shadow-sm">
                    <div>
                        <div class="font-bold text-gray-700">Tr·∫≠n #${m.match_id} <span class="text-xs text-gray-500">(${m.mode})</span></div>
                        <div class="text-xs text-blue-600 font-bold">C∆∞·ª£c: ${m.bet_amount || m.bet} KPI</div>
                        <div class="text-xs text-gray-500">Vs: ${m.player_2}</div>
                    </div>
                    
                    <div class="flex flex-col items-end min-w-[120px]">
                        ${actionHtml}
                        <button onclick="cancelMatch(${m.match_id})" class="text-xs text-gray-400 underline hover:text-red-600 mt-2">H·ªßy</button>
                    </div>
                </div>`;
            });
        }

        // --- 2. ghi l·∫°i k√™t qu·∫£ tran dau loi dai ---
        function renderHistory(matches) {
            const container = document.getElementById('arena-history-list');
            if (!container) return; // Ph√≤ng tr∆∞·ªùng h·ª£p ch∆∞a d√°n HTML
            container.innerHTML = '';

            if (!matches || matches.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400 italic">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o k·∫øt th√∫c.</td></tr>';
                return;
            }

            const currentUser = localStorage.getItem("username");

            matches.forEach(m => {
                // --- Logic x√°c ƒë·ªãnh Th·∫Øng/Thua ƒë·ªÉ t√¥ m√†u ---
                let resultBadge = '';
                const winner = m.winner_team || "Draw";
                
                if (winner === 'Draw' || winner === 'H√≤a') {
                    resultBadge = '<span class="text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded">ü§ù H√≤a</span>';
                } 
                // N·∫øu winner tr√πng t√™n m√¨nh HO·∫∂C winner l√† Team c·ªßa m√¨nh (Logic ƒë∆°n gi·∫£n)
                else if (winner === currentUser || (winner === 'Team A' && m.created_by === currentUser)) {
                    resultBadge = '<span class="text-green-700 font-bold bg-green-100 px-2 py-1 rounded">üèÜ Th·∫Øng</span>';
                } 
                else {
                    resultBadge = '<span class="text-red-600 font-bold bg-red-100 px-2 py-1 rounded">üíÄ Thua</span>';
                }

                container.innerHTML += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                        <td class="py-3 px-4 font-mono text-xs text-gray-500">#${m.match_id}</td>
                        <td class="py-3 px-4 text-sm font-semibold text-blue-600">${m.mode}</td>
                        <td class="py-3 px-4 text-sm">${m.created_by}</td>
                        <td class="py-3 px-4 text-sm">${resultBadge}</td>
                        <td class="py-3 px-4 text-right">
                            <button onclick="viewMatchResult(${m.match_id})" class="text-xs bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-100 hover:text-blue-600 transition shadow-sm">
                                Xem chi ti·∫øt
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        // --- 3. C√ÅC H√ÄM H√ÄNH ƒê·ªòNG (ACTION) ---

        async function sendChallenge() {
            const username = localStorage.getItem('kpi_username');
            const mode = document.getElementById('arena-mode').value;
            const difficulty = document.getElementById('arena-difficulty').value;
            const opponent = document.getElementById('arena-opponent').value;
            const bet = parseInt(document.getElementById('arena-bet-range').value);

            // Validate
            if (mode === '1vs1' && !opponent) {
                alert("Vui l√≤ng ch·ªçn ƒë·ªëi th·ªß ƒë·ªÉ solo!");
                return;
            }

            const payload = {
                mode: mode,
                difficulty: difficulty,
                bet_amount: bet,
                opponent_name: (mode === '1vs1') ? opponent : null
            };

            try {
                const res = await fetch(`/api/arena/create?username=${username}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    loadArenaData(); // Reload l·∫°i inbox
                    // Tr·ª´ ti·ªÅn hi·ªÉn th·ªã tr√™n header ngay l·∫≠p t·ª©c (UI trick)
                    updateWalletUI_Temp(-bet); 
                } else {
                    alert("‚ö†Ô∏è " + (data.detail || data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
                }
            } catch (e) {
                console.error(e);
                alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i th∆∞.");
            }
        }

        async function acceptMatch(matchId) {
            const username = localStorage.getItem('kpi_username');
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ch·∫•p nh·∫≠n? S·∫Ω b·ªã tr·ª´ KPI c∆∞·ª£c ngay l·∫≠p t·ª©c.")) return;

            try {
                const res = await fetch(`/api/arena/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ match_id: matchId, username: username })
                });
                const data = await res.json();
                if(data.success) {
                    alert("ƒê√£ v√†o tr·∫≠n! H·ªá th·ªëng s·∫Ω chuy·ªÉn b·∫°n ƒë·∫øn m√†n h√¨nh thi ƒë·∫•u ngay.");
                    startMatch(matchId); // B·∫ÆT ƒê·∫¶U NGAY
                } else {
                    alert("‚ö†Ô∏è " + (data.detail || data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi"); }
        }

        async function joinLobby(matchId, team) {
            const username = localStorage.getItem('kpi_username');
            if(!confirm(`Tham gia Team ${team}? B·∫°n s·∫Ω b·ªã tr·ª´ KPI c∆∞·ª£c.`)) return;
            
            try {
                const res = await fetch(`/api/arena/join-lobby`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ match_id: matchId, username: username, team: team })
                });
                const data = await res.json();
                if(data.success) {
                    alert(data.message);
                    loadArenaLobby(); // Reload lobby
                    // N·∫øu message b√°o b·∫Øt ƒë·∫ßu -> Start game (C·∫ßn logic check k·ªπ h∆°n, t·∫°m th·ªùi alert)
                    if(data.message.includes("B·∫ÆT ƒê·∫¶U")) {
                        startMatch(matchId);
                    }
                } else {
                    alert("‚ö†Ô∏è " + (data.detail || data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi"); }
        }

        async function cancelMatch(matchId) {
            const username = localStorage.getItem('kpi_username');
            if(!confirm("H·ªßy tr·∫≠n n√†y? B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n ti·ªÅn.")) return;
            
            try {
                const res = await fetch(`/api/arena/cancel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ match_id: matchId, username: username })
                });
                const data = await res.json();
                if(data.success) {
                    alert(data.message);
                    loadArenaData();
                    // Ho√†n ti·ªÅn UI
                    updateWalletUI_Temp(0); // Reload dashboard data ƒë·ªÉ l·∫•y ti·ªÅn chu·∫©n
                }
            } catch (e) { alert("L·ªói"); }
        }

        // ============================================================
        // H√ÄM XEM K·∫æT QU·∫¢ TR·∫¨N ƒê·∫§U (Popup Scoreboard)
        // ============================================================
        async function viewMatchResult(matchId) {
            try {
                // 1. G·ªçi API l·∫•y d·ªØ li·ªáu tr·∫≠n ƒë·∫•u
                const response = await fetch(`/api/arena/match/${matchId}`);
                if (!response.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");
                
                const match = await response.json();
                
                // 2. Parse logs (chuy·ªÉn chu·ªói JSON th√†nh Object ƒëi·ªÉm s·ªë)
                let scores = {};
                try {
                    if (typeof match.logs === 'string') {
                        // Thay th·∫ø nh√°y ƒë∆°n th√†nh nh√°y k√©p ƒë·ªÉ parse chu·∫©n
                        scores = JSON.parse(match.logs.replace(/'/g, '"'));
                    } else {
                        scores = match.logs || {};
                    }
                } catch (e) { scores = {}; }

                // 3. T·∫°o n·ªôi dung hi·ªÉn th·ªã (Format chu·ªói Text)
                // Chuy·ªÉn logs th√†nh danh s√°ch s·∫Øp x·∫øp: [Ng∆∞·ªùi A: 50 ƒëi·ªÉm, Ng∆∞·ªùi B: 40 ƒëi·ªÉm...]
                let scoreBoardText = Object.entries(scores)
                    .map(([name, score]) => `üë§ ${name}: ${score} ƒëi·ªÉm`)
                    .join("\n");

                if (scoreBoardText === "") scoreBoardText = "(Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm)";

                // 4. Hi·ªÉn th·ªã th√¥ng b√°o (D√πng alert cho nhanh, ho·∫∑c SweetAlert n·∫øu c√≥)
                const msg = `
        üèÜ K·∫æT QU·∫¢ TR·∫¨N #${match.match_id || match.id}
        --------------------------------
        üëë ƒê·ªôi th·∫Øng: ${match.winner_team}
        --------------------------------
        B·∫¢NG ƒêI·ªÇM CHI TI·∫æT:
        ${scoreBoardText}
                `;
                
                alert(msg);

            } catch (error) {
                console.error(error);
                alert("‚ùå Kh√¥ng th·ªÉ xem k·∫øt qu·∫£ l√∫c n√†y.");
            }
        }
        // --- 4. LOGIC L√ÄM B√ÄI THI (QUIZ GAMEPLAY) ---

        async function startMatch(matchId) {
            const username = localStorage.getItem('kpi_username');
            
            // 1. L·∫•y ƒë·ªÅ thi t·ª´ Server
            try {
                const res = await fetch(`/api/arena/quiz?match_id=${matchId}&username=${username}`);
                
                // ƒê·ªçc l·ªói chi ti·∫øt t·ª´ Server n·∫øu c√≥ (ƒë·ªÉ bi·∫øt t·∫°i sao l·ªói 400)
                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Kh√¥ng th·ªÉ l·∫•y ƒë·ªÅ thi");
                }
                
                // L·∫•y g√≥i d·ªØ li·ªáu v·ªÅ
                const data = await res.json(); 
                
                // üëá FIX QUAN TR·ªåNG: L·∫•y m·∫£ng c√¢u h·ªèi t·ª´ thu·ªôc t√≠nh .questions
                if (data.questions && Array.isArray(data.questions)) {
                    currentQuizData = data.questions;
                } else {
                    throw new Error("D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (Thi·∫øu danh s√°ch c√¢u h·ªèi)");
                }
                
                // 2. Reset tr·∫°ng th√°i
                currentQuizIndex = 0;
                userAnswers = {}; // S·ª≠a th√†nh object {} ƒë·ªÉ l∆∞u d·∫°ng { "id_c√¢u": "ƒë√°p_√°n" } cho d·ªÖ x·ª≠ l√Ω
                
                // 3. Hi·ªÉn th·ªã Modal & L∆∞u ID tr·∫≠n ƒë·∫•u
                const modal = document.getElementById('quiz-modal'); // Ki·ªÉm tra l·∫°i ID modal c·ªßa b·∫°n l√† 'quiz-modal' hay 'arena-quiz-modal' nh√©!
                if (modal) {
                    modal.classList.remove('hidden');
                    // L∆∞u match_id v√†o modal ƒë·ªÉ t√≠ n·ªØa h√†m n·ªôp b√†i (finishQuiz) l·∫•y ra d√πng
                    modal.setAttribute('data-match-id', data.match_id);
                } else {
                    // Fallback n·∫øu b·∫°n d√πng ID kh√°c
                    document.getElementById('arena-quiz-modal').classList.remove('hidden');
                    document.getElementById('arena-quiz-modal').setAttribute('data-match-id', data.match_id);
                }
                
                // 4. B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã c√¢u ƒë·∫ßu ti√™n
                renderQuestion();
                
            } catch (e) {
                console.error(e);
                alert("L·ªói v√†o tr·∫≠n: " + e.message);
            }
        }

        // --- H√ÄM HI·ªÇN TH·ªä C√ÇU H·ªéI (C·∫¨P NH·∫¨T GIAO DI·ªÜN) ---
        function renderQuestion() {
            const question = currentQuizData[currentQuizIndex];
            if (!question) { finishQuiz(); return; }

            console.log("D·ªØ li·ªáu c√¢u h·ªèi:", question);

            // --- A. Reset giao di·ªán v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu ---
            document.getElementById('quiz-feedback-area').classList.add('hidden'); // ·∫®n gi·∫£i th√≠ch
            const optionsContainer = document.getElementById('quiz-options-container');
            optionsContainer.innerHTML = ''; 
            optionsContainer.classList.remove('pointer-events-none'); // Cho ph√©p b·∫•m l·∫°i

            // --- B. ƒêi·ªÅn n·ªôi dung c√¢u h·ªèi ---
            document.getElementById('quiz-current-index').innerText = currentQuizIndex + 1;
            document.getElementById('quiz-question-content').innerText = question.content;

            // C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô
            const progress = ((currentQuizIndex + 1) / 5) * 100;
            const progressBar = document.getElementById('quiz-progress-bar');
            if (progressBar) progressBar.style.width = `${progress}%`;

            // --- C. Render ƒë√°p √°n (Gi·ªØ nguy√™n style c·ªßa b·∫°n) ---
            const labels = ["A", "B", "C", "D"]; 

            question.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                
                // G√°n ID ƒë·ªÉ l√°t n·ªØa t√¥ m√†u (Quan tr·ªçng!)
                btn.id = `option-btn-${index}`;

                // Style c≈© c·ªßa b·∫°n (Gi·ªØ nguy√™n)
                btn.className = "group relative w-full bg-white border-2 border-slate-200 p-4 rounded-xl hover:bg-amber-50 hover:border-amber-400 transition-all text-left flex items-center shadow-sm hover:shadow-md";
                
                btn.innerHTML = `
                    <span class="w-8 h-8 flex items-center justify-center bg-slate-100 text-slate-600 font-bold rounded-full mr-3 group-hover:bg-amber-400 group-hover:text-white transition-colors">
                        ${labels[index] || "?"}
                    </span>
                    <span class="text-slate-700 font-medium text-lg flex-1">
                        ${opt}
                    </span>
                `;
                
                // S·ª∞ KI·ªÜN CLICK: Truy·ªÅn th√™m index ƒë·ªÉ bi·∫øt n√∫t n√†o ƒë∆∞·ª£c b·∫•m
                btn.onclick = () => selectAnswer(question, opt, index);
                
                optionsContainer.appendChild(btn);
            });

            // --- D. C·∫≠p nh·∫≠t ch·ªØ cho n√∫t Next ---
            const btnNext = document.getElementById('btn-next-question');
            if (currentQuizIndex === currentQuizData.length - 1) {
                btnNext.innerHTML = "Ho√†n th√†nh & N·ªôp b√†i üèÅ";
            } else {
                btnNext.innerHTML = "C√¢u ti·∫øp theo ‚û°";
            }

            // Reset ƒë·ªìng h·ªì
            resetQuizTimer();
        }

        function startTimer() {
            let timeLeft = 15;
            const timerEl = document.getElementById('quiz-timer');
            const barEl = document.getElementById('quiz-progress-bar');
            
            // Reset visual
            timerEl.innerText = timeLeft;
            barEl.style.width = '100%';
            barEl.style.transition = 'none'; // T·∫Øt animation ƒë·ªÉ reset v·ªÅ 100% ngay l·∫≠p t·ª©c
            
            // Force reflow
            void barEl.offsetWidth; 
            
            // Start animation
            barEl.style.transition = 'width 15s linear';
            barEl.style.width = '0%';

            if (arenaTimer) clearInterval(arenaTimer);

            arenaTimer = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(arenaTimer);
                    // H·∫øt gi·ªù -> T·ª± ch·ªçn sai (ho·∫∑c b·ªè tr·ªëng) v√† qua c√¢u sau
                    selectAnswer(null); 
                }
            }, 1000);
        }

        // ============================================================
        // 2. H√ÄM X·ª¨ L√ù CH·ªåN ƒê√ÅP √ÅN (LOGIC M·ªöI: D·ª™NG L·∫†I & GI·∫¢I TH√çCH)
        // ============================================================
        function selectAnswer(questionObj, userChoice, indexChoice) {
            // 1. D·ª´ng ƒë·ªìng h·ªì ngay
            if (quizTimerInterval) clearInterval(quizTimerInterval);

            // 2. L∆∞u ƒë√°p √°n
            userAnswers[questionObj.id] = userChoice;
            console.log(`ƒê√£ ch·ªçn: ${userChoice}`);

            // 3. Kh√≥a t·∫•t c·∫£ c√°c n√∫t (Kh√¥ng cho ch·ªçn l·∫°i)
            document.getElementById('quiz-options-container').classList.add('pointer-events-none');

            // 4. Ki·ªÉm tra ƒê√∫ng/Sai (So s√°nh text)
            // Server g·ª≠i correct_answer, ta so s√°nh v·ªõi userChoice
            const correctText = String(questionObj.correct_answer).trim().toLowerCase();
            const userText = String(userChoice).trim().toLowerCase();
            const isCorrect = (userText === correctText);

            // 5. T√¥ m√†u n√∫t
            const selectedBtn = document.getElementById(`option-btn-${indexChoice}`);
            
            if (isCorrect) {
                // N·∫æU ƒê√öNG: T√¥ xanh n√∫t v·ª´a ch·ªçn
                if(selectedBtn) {
                    selectedBtn.className = "w-full bg-green-100 border-2 border-green-500 p-4 rounded-xl flex items-center shadow-md transition-all";
                    selectedBtn.querySelector('span').className = "w-8 h-8 flex items-center justify-center bg-green-500 text-white font-bold rounded-full mr-3";
                }
            } else {
                // N·∫æU SAI: T√¥ ƒë·ªè n√∫t v·ª´a ch·ªçn
                if(selectedBtn) {
                    selectedBtn.className = "w-full bg-red-100 border-2 border-red-500 p-4 rounded-xl flex items-center shadow-md transition-all";
                    selectedBtn.querySelector('span').className = "w-8 h-8 flex items-center justify-center bg-red-500 text-white font-bold rounded-full mr-3";
                }
                
                // ...V√† t√¨m n√∫t ƒë√∫ng ƒë·ªÉ t√¥ xanh cho ng∆∞·ªùi ch∆°i bi·∫øt
                questionObj.options.forEach((opt, idx) => {
                    if (String(opt).trim().toLowerCase() === correctText) {
                        const correctBtn = document.getElementById(`option-btn-${idx}`);
                        if (correctBtn) {
                            correctBtn.className = "w-full bg-green-100 border-2 border-green-500 p-4 rounded-xl flex items-center shadow-md opacity-80";
                            correctBtn.querySelector('span').className = "w-8 h-8 flex items-center justify-center bg-green-500 text-white font-bold rounded-full mr-3";
                        }
                    }
                });
            }

            // 6. Hi·ªÉn th·ªã khung Gi·∫£i th√≠ch
            showFeedback(isCorrect, questionObj.explanation);
        }

        // ============================================================
        // 3. H√ÄM HI·ªÇN TH·ªä KHUNG GI·∫¢I TH√çCH
        // ============================================================
        function showFeedback(isCorrect, explanationText) {
            const feedbackArea = document.getElementById('quiz-feedback-area');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackExpl = document.getElementById('feedback-explanation');

            feedbackArea.classList.remove('hidden');

            if (isCorrect) {
                feedbackArea.className = "mt-6 p-5 rounded-xl border-2 transition-all shadow-md bg-green-50 border-green-200";
                feedbackIcon.innerText = "üéâ"; // Icon vui
                feedbackTitle.innerText = "Ch√≠nh x√°c!";
                feedbackTitle.className = "text-xl font-bold mb-2 text-green-700";
            } else {
                feedbackArea.className = "mt-6 p-5 rounded-xl border-2 transition-all shadow-md bg-red-50 border-red-200";
                feedbackIcon.innerText = "ü§î"; // Icon suy ng·∫´m
                feedbackTitle.innerText = "Ch∆∞a ƒë√∫ng r·ªìi!";
                feedbackTitle.className = "text-xl font-bold mb-2 text-red-700";
            }

            feedbackExpl.innerText = explanationText || "Kh√¥ng c√≥ gi·∫£i th√≠ch chi ti·∫øt.";
        }

        async function finishQuiz() {
            // 1. D·ª´ng ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c ngay l·∫≠p t·ª©c
            if (typeof quizTimerInterval !== 'undefined') clearInterval(quizTimerInterval);

            // 2. Thu th·∫≠p d·ªØ li·ªáu c∆° b·∫£n
            const username = localStorage.getItem('kpi_username');
            const modal = document.getElementById('quiz-modal'); // ƒê·∫£m b·∫£o ID ƒë√∫ng
            const matchId = modal.getAttribute('data-match-id');

            if (!matchId) {
                alert("L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c tr·∫≠n ƒë·∫•u!");
                return;
            }

            // 3. L·∫•y ƒë√°p √°n (S·ª∞ THAY ƒê·ªîI QUAN TR·ªåNG NH·∫§T)
            // Thay v√¨ qu√©t HTML, ta l·∫•y t·ª´ bi·∫øn to√†n c·ª•c 'userAnswers' ƒë√£ ƒë∆∞·ª£c l∆∞u khi b·∫•m ch·ªçn
            const finalAnswers = userAnswers; 

            console.log("üì§ ƒêang n·ªôp b√†i:", { matchId, username, answers: finalAnswers });

            // 4. G·ª≠i v·ªÅ Backend (Gi·ªØ nguy√™n logic fetch)
            try {
                const res = await fetch('/api/arena/submit', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        match_id: parseInt(matchId),
                        username: username,
                        answers: finalAnswers
                    })
                });

                // 5. X·ª≠ l√Ω l·ªói t·ª´ Server
                if (!res.ok) {
                    const errText = await res.text();
                    console.error("L·ªói Server:", errText);
                    alert("L·ªói n·ªôp b√†i: " + errText);
                    
                    // N·∫øu l·ªói, v·∫´n ƒë√≥ng modal ƒë·ªÉ ng∆∞·ªùi ch∆°i kh√¥ng b·ªã k·∫πt
                    modal.classList.add('hidden');
                    return;
                }

                const data = await res.json();
                
                // 6. Th√¥ng b√°o th√†nh t√≠ch
                // D√πng SweetAlert ho·∫∑c Alert th∆∞·ªùng ƒë·ªÅu ƒë∆∞·ª£c
                alert(`üèÅ HO√ÄN TH√ÄNH!\n\n‚úÖ B·∫°n ƒë√∫ng: ${data.correct_count}/5 c√¢u\nüí∞ ƒêi·ªÉm nh·∫≠n ƒë∆∞·ª£c: ${data.score} KPI`);
                
                // 7. ƒê√≥ng giao di·ªán thi & Reset
                modal.classList.add('hidden');
                
                // Reset bi·∫øn t·∫°m
                currentQuizData = [];
                userAnswers = {};
                
                // T·∫£i l·∫°i d·ªØ li·ªáu l√¥i ƒë√†i ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i tr·∫≠n ƒë·∫•u
                loadArenaData(); 

            } catch (e) {
                console.error("L·ªói m·∫°ng:", e);
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Server ƒë·ªÉ n·ªôp b√†i!");
            }
        }

        // ============================================================
        // 4. H√ÄM CHUY·ªÇN C√ÇU (G·∫Øn v√†o n√∫t Next)
        // ============================================================
        function nextQuestion() {
            currentQuizIndex++; // TƒÉng ch·ªâ s·ªë
            if (currentQuizIndex < currentQuizData.length) {
                renderQuestion(); // Render c√¢u ti·∫øp theo
            } else {
                finishQuiz(); // N·ªôp b√†i
            }
        }

        // ============================================================
        // 5. H√ÄM TIMER (C·∫≠p nh·∫≠t x·ª≠ l√Ω khi h·∫øt gi·ªù)
        // ============================================================
        function resetQuizTimer() {
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            
            let timeLeft = 30; // 30 gi√¢y suy nghƒ©
            const timerElement = document.getElementById('quiz-timer');
            if(timerElement) timerElement.innerText = timeLeft;
            
            quizTimerInterval = setInterval(() => {
                timeLeft--;
                if(timerElement) timerElement.innerText = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    // H·∫øt gi·ªù -> T·ª± ƒë·ªông coi nh∆∞ ch·ªçn sai (TIMEOUT)
                    const question = currentQuizData[currentQuizIndex];
                    selectAnswer(question, "TIMEOUT", -1); // -1 ƒë·ªÉ kh√¥ng t√¥ m√†u n√∫t n√†o c·ªßa user
                }
            }, 1000);
        }
        

        // --- H√ÄM B·∫¨T/T·∫ÆT T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T ---
        function startLobbyAutoUpdate() {
            // N·∫øu ƒëang ch·∫°y r·ªìi th√¨ th√¥i, tr√°nh b·ªã ch·ªìng ch√©o
            if (arenaLobbyInterval) return;
            
            console.log("üîÑ B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông c·∫≠p nh·∫≠t S·∫£nh ch·ªù...");
            
            // C·ª© 30 gi√¢y g·ªçi h√†m loadArenaLobby 1 l·∫ßn
            arenaLobbyInterval = setInterval(() => {
                // Ch·ªâ reload ph·∫ßn lobby (ph√≤ng ch·ªù) cho nh·∫π, kh√¥ng reload to√†n b·ªô inbox
                loadArenaLobby(); 
            }, 30000); 
        }

        function stopLobbyAutoUpdate() {
            if (arenaLobbyInterval) {
                clearInterval(arenaLobbyInterval);
                arenaLobbyInterval = null;
                console.log("‚èπÔ∏è ƒê√£ d·ª´ng c·∫≠p nh·∫≠t S·∫£nh ch·ªù.");
            }
        }

        // d·ªØ li·ªáu ds hs 1vs1
        async function loadOpponentsList() {
            const myUsername = localStorage.getItem('kpi_username');
            const selectBox = document.getElementById('arena-opponent');
            
            console.log(`üîç [DEBUG-FE] B·∫Øt ƒë·∫ßu t√¨m ƒë·ªëi th·ªß cho: ${myUsername}`);

            // 1. Reset giao di·ªán
            selectBox.innerHTML = '<option value="">‚è≥ ƒêang t·∫£i danh s√°ch...</option>';

            try {
                // 2. G·ªçi API
                const url = `/api/arena/opponents?current_user=${myUsername}`;
                console.log(`üì° [DEBUG-FE] ƒêang fetch URL: ${url}`);
                
                const res = await fetch(url);
                
                // 3. Ki·ªÉm tra m√£ l·ªói HTTP (200 l√† OK, 404/500 l√† L·ªói)
                console.log(`üì° [DEBUG-FE] HTTP Status Code: ${res.status}`);
                
                if (!res.ok) {
                    const errorText = await res.text(); // ƒê·ªçc n·ªôi dung l·ªói server tr·∫£ v·ªÅ
                    console.error(`‚ùå [DEBUG-FE] Server b√°o l·ªói: ${errorText}`);
                    selectBox.innerHTML = `<option value="">‚ùå L·ªói Server: ${res.status}</option>`;
                    return;
                }

                // 4. ƒê·ªçc d·ªØ li·ªáu JSON
                const players = await res.json();
                console.log("üì¶ [DEBUG-FE] D·ªØ li·ªáu JSON nh·∫≠n ƒë∆∞·ª£c:", players);

                // 5. Ki·ªÉm tra ƒë·ªãnh d·∫°ng d·ªØ li·ªáu
                if (!Array.isArray(players)) {
                    console.error("‚ùå [DEBUG-FE] D·ªØ li·ªáu kh√¥ng ph·∫£i l√† danh s√°ch (Array)!", players);
                    selectBox.innerHTML = '<option value="">‚ùå L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu</option>';
                    return;
                }

                // 6. X·ª≠ l√Ω hi·ªÉn th·ªã
                selectBox.innerHTML = '<option value="">-- Ch·ªçn ƒë·ªëi th·ªß --</option>';
                
                if (players.length === 0) {
                    console.warn("‚ö†Ô∏è [DEBUG-FE] Danh s√°ch r·ªóng (Kh√¥ng c√≥ ai kh√°c).");
                    selectBox.innerHTML += '<option disabled>Kh√¥ng t√¨m th·∫•y ai kh√°c</option>';
                    return;
                }

                players.forEach(p => {
                    const displayText = `${p.full_name} (${p.class_type} | ${p.kpi} KPI)`;
                    const option = document.createElement('option');
                    option.value = p.username;
                    option.text = displayText;
                    selectBox.appendChild(option);
                });
                
                console.log(`‚úÖ [DEBUG-FE] ƒê√£ render xong ${players.length} ƒë·ªëi th·ªß.`);

            } catch (e) {
                console.error("‚ùå [DEBUG-FE] L·ªói Javascript (Crash):", e);
                selectBox.innerHTML = '<option value="">‚ùå L·ªói k·∫øt n·ªëi</option>';
            }
        }

        function updateWalletUI_Temp(change) {
            // H√†m n√†y ch·ªâ ƒë·ªÉ update s·ªë KPI tr√™n header cho vui m·∫Øt ngay l·∫≠p t·ª©c
            // D·ªØ li·ªáu th·∫≠t s·∫Ω ƒë∆∞·ª£c update khi reload trang
        }

        // --- BI·∫æN TO√ÄN C·ª§C CHO TH√ÅP ---
        let towerState = {
            isCombat: false,
            floor: 1,
            questions: [],
            currentQIndex: 0,
            playerHP: 100,
            playerMaxHP: 100,
            monsterHP: 100,
            monsterMaxHP: 100,
            monsterAtk: 10,
            timer: null
        };

        // 1. KH·ªûI T·∫†O & RESET S·∫¢NH CH·ªú (C√ì T·ª∞ ƒê·ªòNG S·ª¨A L·ªñI ·∫¢NH)
        function resetTowerUI() {
            console.log("üîÑ ƒêang reset giao di·ªán Th√°p...");

            // A. L·∫§Y D·ªÆ LI·ªÜU
            const data = window.dashboardData || {};
            const info = data.info || {};

            // B. HI·ªÜN S·∫¢NH, ·∫®N COMBAT
            const lobby = document.getElementById('tower-lobby');
            const combat = document.getElementById('tower-combat');
            if (lobby) lobby.classList.remove('hidden');
            if (combat) {
                combat.classList.add('hidden');
                combat.classList.remove('flex');
            }
            
            // D·ª´ng ƒë·ªìng h·ªì
            if (typeof towerState !== 'undefined' && towerState.timer) {
                clearInterval(towerState.timer);
            }

            // C. C·∫¨P NH·∫¨T TH√îNG TIN
            // 1. T√™n
            const elName = document.getElementById('tower-player-name');
            if(elName) elName.innerText = info.fullname || info.full_name || info.username || "H·ªçc Vi√™n";

            // 2. AVATAR (LOGIC S·ª¨A L·ªñI 404 T·∫†I ƒê√ÇY)
            const elAvatar = document.getElementById('tower-player-avatar');
            if(elAvatar) {
                // B∆∞·ªõc 1: C·ª© th·ª≠ g√°n ƒë∆∞·ªùng d·∫´n t·ª´ DB (D√π c√≥ th·ªÉ sai)
                elAvatar.src = info.avatar;

                // B∆∞·ªõc 2: N·∫øu ·∫£nh b·ªã l·ªói (404), tr√¨nh duy·ªát s·∫Ω ch·∫°y h√†m n√†y
                elAvatar.onerror = function() {
                    console.warn("‚ö†Ô∏è ·∫¢nh t·ª´ DB b·ªã l·ªói, ƒëang chuy·ªÉn sang ·∫£nh Local...");
                    
                    // L·∫•y class nh√¢n v·∫≠t
                    const userClass = info.class_type || "NOVICE";
                    
                    // Map c·ª©ng ƒë∆∞·ªùng d·∫´n chu·∫©n trong folder d·ª± √°n c·ªßa b·∫°n
                    if (userClass === 'WARRIOR') {
                        this.src = "assets/character/warrior.png";
                    } else if (userClass === 'MAGE') {
                        this.src = "assets/character/mage.png";
                    } else {
                        this.src = "assets/character/mage.png"; // M·∫∑c ƒë·ªãnh
                    }
                    
                    // X√≥a s·ª± ki·ªán ƒë·ªÉ tr√°nh l·∫∑p v√¥ t·∫≠n
                    this.onerror = null;
                };
            }

            // 3. Level & EXP
            const elLevel = document.getElementById('tower-player-level');
            if(elLevel) elLevel.innerText = info.level || 1;

            // Thanh EXP
            const curExp = info.exp || 0;
            const maxExp = info.next_level_exp || 100;
            const pct = Math.min(100, (curExp / maxExp) * 100);
            
            const elExpText = document.getElementById('tower-exp-text');
            const elExpBar = document.getElementById('tower-exp-bar');

            if(elExpText) elExpText.innerText = `${curExp} / ${maxExp}`;
            if(elExpBar) {
                elExpBar.style.width = `${pct}%`;
                if (pct >= 80) {
                    elExpBar.className = 'bg-yellow-400 animate-pulse h-full transition-all duration-500';
                } else {
                    elExpBar.className = 'bg-purple-500 h-full transition-all duration-500';
                }
            }
            
            // 4. S·ªë t·∫ßng
            const currentFloor = info.tower_floor || 1;
            const floorDisplay = document.getElementById('lobby-current-floor');
            if(floorDisplay) floorDisplay.innerText = currentFloor;
        }        

        // ============================================================
        // 2. B·∫ÆT ƒê·∫¶U CHI·∫æN ƒê·∫§U (FIX 422 & 401)
        // ============================================================
        async function startTowerCombat(floorIndex) {
            if (!window.dashboardData || !window.dashboardData.stats) {
                console.error("‚ùå D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng!", window.dashboardData);
                alert("D·ªØ li·ªáu nh√¢n v·∫≠t ƒëang t·∫£i... Vui l√≤ng ƒë·ª£i 1 gi√¢y r·ªìi b·∫•m l·∫°i!");
                
                // Th·ª≠ g·ªçi n·∫°p l·∫°i d·ªØ li·ªáu c·ª©u c√°nh
                if (typeof loadDashboardData === 'function') loadDashboardData();
                return; // D·ª´ng l·∫°i ngay, kh√¥ng cho ch·∫°y ti·∫øp ƒë·ªÉ tr√°nh l·ªói Crash
            }
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            if (!token) return (window.location.href = '/login');

            const cleanFloor = parseInt(floorIndex) || towerState.floor || 1;
            console.log("‚öîÔ∏è ƒêang chu·∫©n b·ªã d·ªØ li·ªáu cho t·∫ßng:", cleanFloor);

            try {
                const [towerRes, statusRes, allSkillsRes] = await Promise.all([
                    fetch('/api/tower/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ floor: cleanFloor })
                    }),
                    fetch('/api/skills/my-status', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/skills/get-all', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                if (!towerRes.ok || !statusRes.ok || !allSkillsRes.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

                const data = await towerRes.json();
                
                window.myStatus = await statusRes.json(); 
                window.globalSkillsList = await allSkillsRes.json();

                console.log("‚úÖ D·ªØ li·ªáu ƒë√£ ƒë·ªìng b·ªô ho√†n to√†n.");

                // --- C·∫¨P NH·∫¨T STATE TR·∫¨N ƒê·∫§U (QUAN TR·ªåNG) ---
                towerState.isCombat = true;
                towerState.questions = data.questions;
                
                // 1. C·∫≠p nh·∫≠t ch·ªâ s·ªë Qu√°i
                towerState.monsterHP = data.monster.monster_hp;
                towerState.monsterMaxHP = data.monster.monster_hp;
                towerState.monsterAtk = data.monster.monster_atk || 10; // ƒê·ª´ng qu√™n c√°i n√†y

                // 2. C·∫≠p nh·∫≠t ch·ªâ s·ªë Ng∆∞·ªùi ch∆°i (FIX L·ªñI ATK = 10)
                // L·∫•y t·ª´ dashboardData.stats (atk, str, ho·∫∑c damage t√πy backend tr·∫£ v·ªÅ)
                const pStats = window.dashboardData.stats || {};
                towerState.playerHP = pStats.hp;
                towerState.playerMaxHP = pStats.max_hp;
                
                // ∆Øu ti√™n l·∫•y atk, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y str (Warrior), int (Mage), cu·ªëi c√πng m·ªõi l√† 15
                towerState.playerAtk = pStats.atk || pStats.str || pStats.int || pStats.damage || 15;

                // 3. Kh·ªüi t·∫°o danh s√°ch Passive k√≠ch ho·∫°t (D√†nh cho Skill Ki√™n ƒê·ªãnh)
                towerState.activePassiveSkills = {}; 

                console.log(`üìä Ch·ªâ s·ªë v√†o tr·∫≠n: Player ATK=${towerState.playerAtk}, HP=${towerState.playerHP}`);

                // V·∫Ω UI v√† k√≠ch ho·∫°t Passive
                setupCombatUI(window.dashboardData.info, data.monster);
                
                setTimeout(() => {  
                    triggerPassiveVFX();
                }, 300); 

                renderTowerQuestion();
            } catch (error) {
                console.error("‚ùå L·ªói h·ªá th·ªëng:", error);
            }
        }

        // ============================================================
        // 3. THI·∫æT L·∫¨P GIAO DI·ªÜN CHI·∫æN ƒê·∫§U (PHI√äN B·∫¢N HO√ÄN CH·ªàNH)
        // ============================================================
        function setupCombatUI(playerInfo, monsterInfo) {
            console.log("üé® ƒêang v·∫Ω giao di·ªán chi·∫øn ƒë·∫•u...", playerInfo, monsterInfo);

            // 1. HI·ªÜN KHUNG GIAO DI·ªÜN
            const combatView = document.getElementById('tower-combat');
            if (combatView) {
                combatView.classList.remove('hidden');
                combatView.classList.add('flex');
            }

            // --- A. HI·ªÇN TH·ªä AVATAR NG∆Ø·ªúI CH∆†I (THEO CLASS) ---
            const pImg = document.getElementById('combat-player-img');
            if (pImg) {
                // L·∫•y class (Warrior/Mage) -> Chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
                const classType = (playerInfo.class_type || 'warrior').toLowerCase(); 
                
                // ƒê∆∞·ªùng d·∫´n chu·∫©n: assets/character/mage.png
                pImg.src = `assets/character/${classType}.png`;
                
                // N·∫øu ·∫£nh l·ªói -> D√πng Warrior m·∫∑c ƒë·ªãnh
                pImg.onerror = function() {
                    this.src = 'assets/character/warrior.png';
                };
            }

            // --- B. RANDOM BACKGROUND TH√ÅP ---
            const bgEl = document.getElementById('tower-combat-bg');
            if (bgEl) {
                const availableBackgrounds = [
                    'thap1.jpg', 'thap2.jpg', 'thap3.jpg', 'thap4.jpg',
                    'thap5.png', 'thap6.png', 'thap7.png', 'thap8.png'
                ];
                
                const randomIndex = Math.floor(Math.random() * availableBackgrounds.length);
                const selectedBgFilename = availableBackgrounds[randomIndex];
                
                bgEl.style.backgroundImage = `url('assets/background/${selectedBgFilename}')`;
            }

            // --- C. HI·ªÇN TH·ªä QU√ÅI V·∫¨T (C·∫¨P NH·∫¨T LOGIC RANDOM) ---
            const mName = document.getElementById('combat-monster-name');
            if (mName) mName.innerText = monsterInfo.monster_name || "Qu√°i V·∫≠t";

            const mImg = document.getElementById('combat-monster-img');
            if (mImg) {
                // Backend tr·∫£ v·ªÅ ƒë∆∞·ªùng d·∫´n ng·∫´u nhi√™n: assets/monsters/5.png (v√≠ d·ª•)
                mImg.src = monsterInfo.image;

                // Reset class CSS cho ·∫£nh tƒ©nh (tr√°nh d√≠nh class animation c≈© n·∫øu c√≥)
                mImg.className = "h-32 md:h-56 object-contain drop-shadow-[0_0_25px_rgba(255,50,50,0.5)] transition-transform duration-200";

                // Logic Fallback (Ch·ªëng l·ªói ·∫£nh):
                // N·∫øu ƒë∆∞·ªùng d·∫´n Backend tr·∫£ v·ªÅ b·ªã l·ªói (VD: ch∆∞a c√≥ ·∫£nh 7.png) -> Load ·∫£nh 1.png
                mImg.onerror = function() {
                    console.warn(`‚ö†Ô∏è ·∫¢nh qu√°i l·ªói: ${this.src} -> Th·ª≠ load 1.png`);
                    this.src = "assets/monsters/1.png"; 
                    
                    // N·∫øu ·∫£nh 1.png c≈©ng kh√¥ng c√≥ -> Load warrior.png (ch·ªëng ch√°y cu·ªëi c√πng)
                    this.onerror = function() { 
                        this.src = "assets/character/warrior.png"; 
                    };
                };
            }

            // --- D. C√ÅC CH·ªà S·ªê M√ÅU & THANH TR·∫†NG TH√ÅI ---
            const playerHP = towerState.playerHP;
            const playerMaxHP = towerState.playerMaxHP;
            const playerPct = Math.max(0, (playerHP / playerMaxHP) * 100);

            // C·∫≠p nh·∫≠t Text M√°u
            const pHPText = document.getElementById('combat-player-hp-text');
            if (pHPText) pHPText.innerText = `${Math.round(playerHP)}/${playerMaxHP}`;
            
            const mHPText = document.getElementById('combat-monster-hp-text');
            if (mHPText) mHPText.innerText = Math.round(towerState.monsterHP);

            // C·∫≠p nh·∫≠t Thanh M√°u (Width %)
            const pBar = document.getElementById('combat-player-hp-bar');
            if(pBar) pBar.style.width = `${playerPct}%`;

            const mBar = document.getElementById('combat-monster-hp-bar');
            if(mBar) mBar.style.width = '100%'; // M·ªõi v√†o qu√°i ƒë·∫ßy m√°u

            // Reset s·ªë nh·∫£y damage c≈©
            const pDamage = document.getElementById('combat-player-img-damage');
            const mDamage = document.getElementById('combat-monster-img-damage');
            if(pDamage) pDamage.innerText = "";
            if(mDamage) mDamage.innerText = "";

            // Reset s·ªë c√¢u h·ªèi v·ªÅ 1/5
            const qIndex = document.getElementById('combat-q-index');
            if (qIndex) qIndex.innerText = "1/5";
            
            // Reset thanh th·ªùi gian
            const timerBar = document.getElementById('combat-timer-bar');
            if (timerBar) timerBar.style.width = '100%';
            towerState.activePassiveSkills = {};
            // üëáüëáüëá TH√äM ƒêO·∫†N N√ÄY V√ÄO CU·ªêI H√ÄM üëáüëáüëá
            console.log("üî• Giao di·ªán ƒë√£ s·∫µn s√†ng. K√≠ch ho·∫°t hi·ªáu ·ª©ng Passive...");
            
            // ƒê·ª£i 500ms (n·ª≠a gi√¢y) cho giao di·ªán hi·ªán m∆∞·ª£t m√† r·ªìi m·ªõi buff hi·ªáu ·ª©ng
            setTimeout(() => {
                if (typeof triggerPassiveVFX === 'function') {
                    triggerPassiveVFX();
                } else {
                    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h√†m triggerPassiveVFX!");
                }
            }, 500);
        }        

        // ============================================================
        // 4. HI·ªÇN TH·ªä C√ÇU H·ªéI (LOGIC TURN-BASED M·ªöI)
        // ============================================================
        function renderTowerQuestion() {
            // --- A. D·ªåN D·∫∏P GIAO DI·ªÜN C≈® (QUAN TR·ªåNG) ---
            // 1. ·∫®n b·∫£ng gi·∫£i th√≠ch/k·∫øt qu·∫£ (n·∫øu ƒëang hi·ªán)
            const feedbackOverlay = document.getElementById('combat-feedback-overlay');
            if (feedbackOverlay) {
                feedbackOverlay.classList.add('hidden'); 
            }

            // 2. M·ªü kh√≥a click (ƒê·ªÉ ng∆∞·ªùi ch∆°i c√≥ th·ªÉ ch·ªçn ƒë√°p √°n m·ªõi)
            towerState.isProcessing = false;

            // --- B. KI·ªÇM TRA D·ªÆ LI·ªÜU ---
            // 3. Ki·ªÉm tra danh s√°ch c√¢u h·ªèi an to√†n
            if (!towerState.questions || towerState.questions.length === 0) {
                console.error("‚ùå Danh s√°ch c√¢u h·ªèi r·ªóng!");
                return;
            }

            // 4. Ki·ªÉm tra ch·ªâ s·ªë c√¢u h·ªèi
            const qIndex = towerState.currentQIndex;
            
            // N·∫øu v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng c√¢u h·ªèi -> T·ª©c l√† ƒë√£ th·∫Øng (Logic d·ª± ph√≤ng)
            if (qIndex >= towerState.questions.length) {
                endTowerCombat(true); 
                return;
            }

            const currentQ = towerState.questions[qIndex];
            console.log(`üìù ƒêang hi·ªán c√¢u h·ªèi s·ªë: ${qIndex + 1} / ${towerState.questions.length}`);


            // 5. C·∫≠p nh·∫≠t s·ªë th·ª© t·ª± (V√≠ d·ª•: 1/5)
            const qIndexEl = document.getElementById('combat-q-index');
            if (qIndexEl) qIndexEl.innerText = `${qIndex + 1}/${towerState.questions.length}`;

            // 6. C·∫≠p nh·∫≠t n·ªôi dung c√¢u h·ªèi
            const contentEl = document.getElementById('combat-q-content');
            if (contentEl) contentEl.innerText = currentQ.content;

            // 7. V·∫º C√ÅC N√öT ƒê√ÅP √ÅN
            const optionsDiv = document.getElementById('combat-options');
            if (!optionsDiv) return;

            optionsDiv.innerHTML = ''; // X√≥a s·∫°ch n√∫t c≈©

            const keys = ['a', 'b', 'c', 'd'];

            keys.forEach(key => {
                // L·∫•y n·ªôi dung ƒë√°p √°n (option_a, option_b...)
                const text = currentQ[`option_${key}`]; 

                // Ch·ªâ t·∫°o n√∫t n·∫øu c√≥ n·ªôi dung
                if (text) {
                    const btn = document.createElement('button');
                    
                    // Style n√∫t (Gi·ªØ nguy√™n style ƒë·∫πp c·ªßa b·∫°n)
                    // Th√™m class 'group' ƒë·ªÉ hover hi·ªáu ·ª©ng cho ch·ªØ c√°i A,B,C...
                    btn.className = "w-full bg-gray-800 hover:bg-amber-700 text-white p-4 rounded-lg border border-gray-600 font-medium transition-all active:scale-95 text-left shadow-md flex items-center group";
                    
                    btn.innerHTML = `
                        <span class='font-bold text-amber-500 text-xl mr-3 uppercase group-hover:text-white transition-colors'>${key}.</span> 
                        <span class='text-gray-200 group-hover:text-white'>${text}</span>
                    `;
                    
                    // G·∫Øn s·ª± ki·ªán click
                    btn.onclick = () => answerQuestion(key);

                    optionsDiv.appendChild(btn);
                }
            });

            // 8. Reset l·∫°i ƒë·ªìng h·ªì (N·∫øu game c√≥ t√≠nh gi·ªù t·ª´ng c√¢u)
            // L∆∞u √Ω: N·∫øu mu·ªën t√≠nh gi·ªù to√†n tr·∫≠n th√¨ b·ªè d√≤ng n√†y ƒëi
            if (typeof startQuestionTimer === "function") {
                startQuestionTimer();
            }
        }

        // 4. X·ª¨ L√ù TR·∫¢ L·ªúI (ƒê√É C√ÇN B·∫∞NG DAMAGE THEO S·ªê C√ÇU H·ªéI)
        function handleTowerAnswer(isCorrect) {
            clearInterval(towerState.timer); // D·ª´ng ƒë·ªìng h·ªì ngay

            if (isCorrect) {
                // === NG∆Ø·ªúI CH∆†I ƒê√ÅNH QU√ÅI ===
                // Logic m·ªõi: Chia ƒë·ªÅu m√°u Boss theo s·ªë c√¢u h·ªèi. 
                // V√≠ d·ª•: 5 c√¢u -> M·ªói c√¢u tr·ª´ 20% m√°u. Tr·∫£ l·ªùi ƒë√∫ng h·∫øt m·ªõi th·∫Øng tuy·ªát ƒë·ªëi.
                // Th√™m +1 ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p chia l·∫ª c√≤n d∆∞ 1-2 m√°u.
                const totalQuestions = towerState.questions.length || 5;
                const damage = Math.ceil(towerState.maxMonsterHP / totalQuestions) + 1; 
                
                towerState.monsterHP = Math.max(0, towerState.monsterHP - damage);
                
                // Hi·ªáu ·ª©ng Visual
                showDamagePopup('combat-monster', damage);
                const monImg = document.getElementById('combat-monster-img');
                if(monImg) {
                    monImg.classList.add('shake-effect');
                    setTimeout(() => monImg.classList.remove('shake-effect'), 500);
                }

            } else {
                // === QU√ÅI ƒê√ÅNH NG∆Ø·ªúI CH∆†I ===
                // Logic m·ªõi: Tr·ª´ m√°u theo ch·ªâ s·ªë ATK c·ªßa Qu√°i (l·∫•y t·ª´ Server)
                const damage = towerState.monsterAtk || 20; 
                towerState.playerHP = Math.max(0, towerState.playerHP - damage);
                
                // Hi·ªáu ·ª©ng Visual
                showDamagePopup('combat-player', damage);
                const mainView = document.getElementById('main-view-tower');
                if(mainView) {
                    mainView.classList.add('shake-effect');
                    setTimeout(() => mainView.classList.remove('shake-effect'), 500);
                }
            }

            updateHealthBars();

            // KI·ªÇM TRA K·∫æT QU·∫¢ NGAY L·∫¨P T·ª®C
            if (towerState.monsterHP <= 0) {
                setTimeout(() => endTowerCombat(true), 800); // Th·∫Øng
            } else if (towerState.playerHP <= 0) {
                setTimeout(() => endTowerCombat(false), 800); // Thua
            } else {
                // CH∆ØA C√ì AI CH·∫æT -> C√ÇU TI·∫æP THEO
                setTimeout(() => {
                    towerState.currentQIndex++;
                    renderTowerQuestion();
                }, 1200);
            }
        }

        // 5. K·∫æT TH√öC TR·∫¨N ƒê·∫§U
        function endTowerCombat(isWin) {
            // üõ°Ô∏è 1. CH·ªêNG SPAM
            if (towerState.isProcessingEnd) {
                console.warn("üö´ ƒêang g·ª≠i k·∫øt qu·∫£ l√™n Server, vui l√≤ng ch·ªù...");
                return;
            }
            
            towerState.isProcessingEnd = true;

            // üõ°Ô∏è 2. D·ª™NG ƒê·ªíNG H·ªí
            if (towerState.timer) clearInterval(towerState.timer);

            console.log(`üì° ƒêang g·ª≠i k·∫øt qu·∫£: ${isWin ? 'TH·∫ÆNG' : 'THUA'}...`);

            const token = localStorage.getItem('access_token');

            fetch('/api/tower/complete-floor', { 
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ 
                    floor: towerState.floor, 
                    is_win: isWin 
                })
            })
            .then(res => {
                if (res.status === 401) {
                    alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    window.location.href = '/index.html';
                    return null; 
                }
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.detail || "L·ªói x·ª≠ l√Ω k·∫øt qu·∫£!"); });
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;

                console.log("‚úÖ K·∫øt qu·∫£ Server tr·∫£ v·ªÅ:", data);

                if (isWin) {
                    // --- TR∆Ø·ªúNG H·ª¢P TH·∫ÆNG (GI·ªÆ NGUY√äN) ---
                    const rewardMsg = data.rewards_text ? data.rewards_text.join('\n') : "Ph·∫ßn th∆∞·ªüng ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v√†o t√∫i!";
                    alert(`üéâ CHI·∫æN TH·∫ÆNG!\n\n${rewardMsg}`);
                    
                    // C·∫≠p nh·∫≠t l·∫°i Level/EXP/Ti·ªÅn
                    if(window.loadDashboardData) window.loadDashboardData();

                    // Quay v·ªÅ S·∫£nh (Reset m·ªÅm)
                    resetTowerUI(); 
                } else {
                    // --- TR∆Ø·ªúNG H·ª¢P THUA (S·ª¨A L·∫†I: RELOAD TRANG) ---
                    // Alert s·∫Ω ch·∫∑n l·∫°i, ng∆∞·ªùi d√πng b·∫•m OK xong m·ªõi ch·∫°y d√≤ng d∆∞·ªõi
                    alert("‚ò†Ô∏è TH·∫§T B·∫†I!\nQu√°i v·∫≠t qu√° m·∫°nh.\n(Trang web s·∫Ω t·∫£i l·∫°i ƒë·ªÉ h·ªìi ph·ª•c tr·∫°ng th√°i)");
                    
                    // üëá L·ªÜNH QUAN TR·ªåNG NH·∫§T: Reload l·∫°i trang ƒë·ªÉ reset v·ªÅ c√¢u 1/5
                    window.location.reload(); 
                }
            })
            .catch(err => {
                console.error("‚ùå L·ªói l∆∞u k·∫øt qu·∫£:", err);
                
                if (isWin) {
                    alert("ƒê√£ chi·∫øn th·∫Øng nh∆∞ng m·∫•t k·∫øt n·ªëi Server (C√≥ th·ªÉ ch∆∞a nh·∫≠n ƒë∆∞·ª£c qu√†).");
                    resetTowerUI();
                } else {
                    alert("Th·∫•t b·∫°i! (L·ªói k·∫øt n·ªëi)");
                    // N·∫øu l·ªói m·∫°ng khi thua, c≈©ng n√™n reload cho ch·∫Øc
                    window.location.reload();
                }
            })
            .finally(() => {
                // N·∫øu ƒë√£ g·ªçi reload() th√¨ d√≤ng n√†y kh√¥ng c√≤n √Ω nghƒ©a (v√¨ trang web t·∫Øt r·ªìi), 
                // nh∆∞ng c·ª© ƒë·ªÉ ƒë√≥ c≈©ng kh√¥ng sao.
                towerState.isProcessingEnd = false;
            });
        }
        // 6. HELPER FUNCTIONS (Gi·ªØ nguy√™n, ch·ªâ ƒë·∫£m b·∫£o c√≥ ƒë·ªß ID)
        function updateHealthBars() {
            // --- PLAYER (ID: combat-player-hp-bar) ---
            const pHP = towerState.playerHP;
            const pMax = towerState.playerMaxHP;
            const pPercent = Math.max(0, (pHP / pMax) * 100); // Kh√¥ng ƒë·ªÉ √¢m
            
            const pBar = document.getElementById('combat-player-hp-bar');
            const pText = document.getElementById('combat-player-hp-text');
            
            if (pBar) pBar.style.width = `${pPercent}%`;
            if (pText) pText.innerText = Math.round(pHP);

            // --- MONSTER (ID: combat-monster-hp-bar) ---
            const mHP = towerState.monsterHP;
            const mMax = towerState.monsterMaxHP;
            const mPercent = Math.max(0, (mHP / mMax) * 100);

            const mBar = document.getElementById('combat-monster-hp-bar');
            const mText = document.getElementById('combat-monster-hp-text');
            
            if (mBar) mBar.style.width = `${mPercent}%`;
            if (mText) mText.innerText = Math.round(mHP); // S·ª≠a l·ªói hi·ªÉn th·ªã text monster
        }

        // ============================================================
        // 6. X·ª¨ L√ù TR·∫¢ L·ªúI C√ÇU H·ªéI (LOGIC TURN-BASED + SKILL + OVERLAY)
        // ============================================================
        async function answerQuestion(selectedKey) {
            // 1. Ch·∫∑n click li√™n t·ª•c & spam
            if (towerState.isProcessing) return;
            towerState.isProcessing = true; 

            // Helper l√†m s·∫°ch ID (D√πng chung cho c·∫£ Active v√† Passive)
            // Bi·∫øn 'TH·∫¶N_KI·∫æM_TH·∫®M_PH√ÅN' -> 'thankiemthamphan' ƒë·ªÉ so s√°nh d·ªÖ d√†ng
            const cleanID = (str) => (!str) ? "" : str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-zA-Z0-9]/g, "").trim();

            // ============================================================
            // üõ°Ô∏è FIX 1: CH·ªêNG CRASH KHI H·∫æT GI·ªú (SelectedKey = -1)
            // ============================================================
            const currentQ = towerState.questions[towerState.currentQIndex];
            
            // √âp ki·ªÉu v·ªÅ chu·ªói
            const userAns = String(selectedKey).trim().toLowerCase();
            const correctAns = String(currentQ.correct_ans).trim().toLowerCase();

            const isCorrect = (userAns === correctAns);
            
            console.log(`ü§î Ch·ªçn: ${userAns} | ƒê√°p √°n: ${correctAns} -> ${isCorrect ? "ƒê√öNG" : "SAI"}`);

            // ============================================================
            // TR∆Ø·ªúNG H·ª¢P 1: TR·∫¢ L·ªúI ƒê√öNG (T·∫§N C√îNG)
            // ============================================================
            // ƒê·∫£m b·∫£o h√†m answerQuestion c√≥ t·ª´ kh√≥a 'async' ·ªü ƒë·∫ßu
            if (isCorrect) {
                // 1. CH·ªêT CH·∫∂N: N·∫øu danh s√°ch r·ªóng -> T·∫£i ngay l·∫≠p t·ª©c
                if (!window.globalSkillsList || window.globalSkillsList.length === 0) {
                    console.warn("üö® Danh s√°ch r·ªóng! ƒêang t·∫£i c·∫•p t·ªëc...");
                    if (typeof loadGlobalSkills === 'function') {
                        await loadGlobalSkills(); // Ch·ªù t·∫£i xong m·ªõi ƒëi ti·∫øp
                    }
                }

                let skillVFX = 'fx-fireball'; 
                let skillMult = 1.0;          
                let skillName = "ƒê√°nh th∆∞·ªùng";

                // L·∫•y bi·∫øn danh s√°ch t·ª´ window ƒë·ªÉ ch·∫Øc ch·∫Øn c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t
                const currentList = window.globalSkillsList || [];

                if (myStatus && myStatus.equipped) {
                    const equippedID = myStatus.equipped; 
                    
                    // 2. T√åM KI·∫æM TH√îNG MINH
                    const equippedSkill = currentList.find(s => 
                        s.skill_id === equippedID || s.name === equippedID
                    );

                    if (equippedSkill) {
                        console.log("‚úÖ ƒê√É KH·ªöP SKILL:", equippedSkill.name);
                        
                        let conf = equippedSkill.config_data || equippedSkill.config || {}; 
                        if (typeof conf === 'string') { try { conf = JSON.parse(conf); } catch(e) {} }

                        skillVFX = conf.vfx_class || 'fx-fireball';
                        skillMult = parseFloat(conf.base_mult || 1.5);
                        skillName = equippedSkill.name;
                        
                    } else {
                        console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID:", equippedID, "trong danh s√°ch:", currentList);
                        
                        // 3. C·ª®U C√ÅNH (D·ª± ph√≤ng cu·ªëi c√πng)
                        if (equippedID.includes("TH·∫¶N_KI·∫æM")) {
                            skillVFX = 'fx-thankiem';
                            skillName = "Th·∫ßn Ki·∫øm Th·∫©m Ph√°n";
                            console.log("üî• K√≠ch ho·∫°t ch·∫ø ƒë·ªô C·ª©u C√°nh: Th·∫ßn Ki·∫øm");
                        } else {
                            // Debug chi ti·∫øt n·∫øu l·ªói
                            console.error(`‚ùå V·∫™N KH√îNG T√åM TH·∫§Y ID [${equippedID}]`);
                            console.log("üìã Danh s√°ch hi·ªán c√≥:", currentList.map(s => s.skill_id));
                        }
                    }
                    if (skillName) {
                        // Hi·ªán ch·ªØ m√†u v√†ng kim (#fbbf24) tr√™n ƒë·∫ßu nh√¢n v·∫≠t
                        showFloatingText(skillName, 'combat-player-img', '#fbbf24');
                    }
                } 
            
            
                // üëÜüëÜüëÜ H·∫æT PH·∫¶N S·ª¨A üëÜüëÜüëÜ

                // T√≠nh to√°n Damage
                const baseDmg = towerState.playerAtk || 15;
                let totalMultiplier = 1.0; 

                // C·ªông Passive Buff
                if (window.myStatus && window.myStatus.learned) {
                    Object.keys(window.myStatus.learned).forEach(rawID => {
                        const searchID = cleanID(rawID);
                        const skill = window.globalSkillsList.find(s => cleanID(s.skill_id) === searchID);
                        
                        if (skill) {
                            let conf = skill.config_data || skill.config || {};
                            if (typeof conf === 'string') { try { conf = JSON.parse(conf); } catch(e){} }
                            
                            const val = parseFloat(conf.value || skill.value || 0);
                            const condition = (skill.condition || conf.condition || "").toString();

                            // Buff Tƒ©nh (Always)
                            if (val > 0 && (condition.includes('always') || condition === '')) {
                                totalMultiplier += val; 
                            }
                            // Buff ƒê·ªông (K√≠ch ho·∫°t)
                            if (towerState.activePassiveSkills && towerState.activePassiveSkills[searchID] && val > 0) {
                                totalMultiplier += val;
                            }
                        }
                    });
                }

                const finalMult = skillMult * totalMultiplier;
                const finalDmg = Math.floor(baseDmg * finalMult);

                // Tr·ª´ m√°u qu√°i
                towerState.monsterHP = Math.max(0, towerState.monsterHP - finalDmg);
                if (typeof updateHealthBars === 'function') updateHealthBars();

                // VFX T·∫•n c√¥ng
                if(typeof playVFX === 'function') {
                    const vfxToPlay = skillVFX || 'fx-fireball';
                    // Ch·ªâ nh·ªØng skill n√†y m·ªõi bay t·ª´ ng∆∞·ªùi sang qu√°i
                    // Th·∫ßn ki·∫øm (fx-thankiem) KH√îNG n·∫±m trong n√†y -> N√≥ s·∫Ω r∆°i t·ª´ tr√™n tr·ªùi xu·ªëng (ƒë√∫ng logic CSS)
                    const projectileSkills = ['fx-fireball', 'fx-meteor', 'fx-arrow', 'fx-ice-shard'];
                    const isProjectile = projectileSkills.includes(vfxToPlay);
                    
                    playVFX(vfxToPlay, 'combat-monster-img', isProjectile); 
                }
                showDamagePopup('combat-monster-img', finalDmg, 'text-red-500'); 
            } 
            
            // ============================================================
            // TR∆Ø·ªúNG H·ª¢P 2: TR·∫¢ L·ªúI SAI (B·ªä QU√ÅI ƒê√ÅNH + CHECK H·ªíI M√ÅU)
            // ============================================================
            else {
                const monsterDmg = towerState.monsterAtk || 15;
                towerState.playerHP = Math.max(0, towerState.playerHP - monsterDmg);

                showDamagePopup('combat-player-img', monsterDmg, 'text-purple-600');
                if (typeof updateHealthBars === 'function') updateHealthBars();

                // üëá LOGIC H·ªíI M√ÅU (Gi·ªØ nguy√™n)
                if (window.myStatus && window.myStatus.learned) {
                    Object.keys(window.myStatus.learned).forEach(rawID => {
                        const searchID = cleanID(rawID);
                        const skill = window.globalSkillsList.find(s => cleanID(s.skill_id) === searchID);
                        if (!skill) return;

                        let conf = skill.config_data || skill.config || {};
                        if (typeof conf === 'string') { try { conf = JSON.parse(conf); } catch(e) {} }

                        let condition = (skill.condition || conf.condition || "always").toString().toLowerCase();
                        if (searchID.includes('kien_dinh') && condition === 'always') condition = 'hp_below';

                        if (condition.includes('hp_below') || condition.includes('d∆∞·ªõi')) {
                            const threshold = (conf.threshold !== undefined) ? parseFloat(conf.threshold) : 0.5;
                            const currentHpPercent = towerState.playerHP / (towerState.playerMaxHP || 100);

                            if (currentHpPercent < threshold && !towerState.activePassiveSkills[searchID]) {
                                towerState.activePassiveSkills[searchID] = true; // ƒê√°nh d·∫•u ƒë√£ d√πng

                                let healAmount = 0;
                                if (conf.heal_percent > 0) healAmount += Math.floor((towerState.playerMaxHP || 100) * parseFloat(conf.heal_percent));
                                if (conf.heal_flat > 0) healAmount += parseInt(conf.heal_flat);

                                if (healAmount > 0) {
                                    towerState.playerHP = Math.min(towerState.playerMaxHP, towerState.playerHP + healAmount);
                                    if (typeof updateHealthBars === 'function') updateHealthBars();
                                    setTimeout(() => { if(showFloatingText) showFloatingText(`+${healAmount} HP`, 'combat-player-img', '#22c55e'); }, 400);
                                }

                                const vfxName = conf.vfx_class || skill.vfx_class || "fx-kiendinh";
                                if (vfxName && typeof playVFX === 'function') playVFX(vfxName, 'combat-player-img');
                                if (typeof showFloatingText === 'function') showFloatingText(`${skill.name}!`, 'combat-player-img', '#eab308');
                            }
                        }
                    });
                }
            }

            // ============================================================
            // 3. HI·ªÇN TH·ªä K·∫æT QU·∫¢ & CHECK END GAME
            // ============================================================
            setTimeout(() => {
                const overlay = document.getElementById('combat-feedback-overlay');
                const iconEl = document.getElementById('feedback-icon');
                const titleEl = document.getElementById('feedback-title');
                const explainEl = document.getElementById('feedback-explain');
                const btnEl = document.getElementById('feedback-btn');

                if (!overlay) return;

                const explainText = currentQ.explain || `ƒê√°p √°n ƒë√∫ng l√†: ${currentQ.correct_ans.toUpperCase()}.`;
                explainEl.innerText = explainText;

                if (isCorrect) {
                    iconEl.innerText = "‚öîÔ∏è";
                    titleEl.innerText = "T·∫§N C√îNG TH√ÄNH C√îNG!";
                    titleEl.className = "text-xl md:text-2xl font-bold mb-2 text-green-400 uppercase tracking-widest drop-shadow-md";
                } else {
                    iconEl.innerText = "üõ°Ô∏è";
                    titleEl.innerText = "B·ªä PH·∫¢N ƒê√íN!";
                    titleEl.className = "text-xl md:text-2xl font-bold mb-2 text-red-500 uppercase tracking-widest drop-shadow-md";
                }

                // --- CHECK END GAME ---
                if (towerState.playerHP <= 0) {
                    btnEl.innerHTML = '<i class="fas fa-skull mr-2"></i> TH·∫§T B·∫†I - R·ªúI KH·ªéI TH√ÅP';
                    btnEl.className = "px-6 py-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg w-full md:w-auto";
                    btnEl.onclick = () => endTowerCombat(false); 
                }
                else if (towerState.monsterHP <= 0) {
                    btnEl.innerHTML = '<i class="fas fa-trophy mr-2"></i> CHI·∫æN TH·∫ÆNG - NH·∫¨N QU√Ä';
                    btnEl.className = "px-6 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-lg w-full md:w-auto animate-pulse";
                    btnEl.onclick = () => endTowerCombat(true);
                }
                else {
                    if (towerState.currentQIndex >= towerState.questions.length - 1) {
                        titleEl.innerText = "H·∫æT L∆Ø·ª¢T - QU√ÅI V·∫™N S·ªêNG!";
                        explainEl.innerText = "B·∫°n ƒë√£ h·∫øt c√¢u h·ªèi nh∆∞ng ch∆∞a h·∫° g·ª•c ƒë∆∞·ª£c qu√°i v·∫≠t.";
                        btnEl.innerHTML = '<i class="fas fa-door-open mr-2"></i> CH·∫§P NH·∫¨N TH·∫§T B·∫†I';
                        btnEl.className = "px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg w-full md:w-auto";
                        btnEl.onclick = () => endTowerCombat(false);
                    } 
                    else {
                        btnEl.innerHTML = 'TI·∫æP THEO <i class="fas fa-arrow-right ml-2"></i>';
                        btnEl.className = "px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg w-full md:w-auto transform transition hover:scale-105";
                        btnEl.onclick = () => {
                            towerState.currentQIndex++;
                            renderTowerQuestion(); 
                        };
                    }
                }

                overlay.classList.remove('hidden');

            }, 800); 
        }
        //H√†m ki·ªÉm tra k·∫øt qu·∫£
        function checkCombatStatus() {
            // 1. Qu√°i ch·∫øt -> Th·∫Øng
            if (towerState.monsterHP <= 0) {
                towerState.monsterHP = 0;
                setTimeout(() => endTowerCombat(true), 500); // Th·∫Øng
                return;
            }

            // 2. Ng∆∞·ªùi ch∆°i ch·∫øt -> Thua
            if (towerState.playerHP <= 0) {
                towerState.playerHP = 0;
                setTimeout(() => endTowerCombat(false), 500); // Thua
                return;
            }

            // 3. Ch∆∞a ai ch·∫øt -> Qua c√¢u ti·∫øp theo
            towerState.currentQIndex++;
            
            // Delay m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi ch∆°i k·ªãp nh√¨n k·∫øt qu·∫£ r·ªìi m·ªõi qua c√¢u m·ªõi
            setTimeout(() => {
                renderTowerQuestion();
            }, 1000); 
        }
        // ============================================================
        // 7. H·ªÜ TH·ªêNG ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C (TIMER)
        // ============================================================
        function startQuestionTimer() {
            // 1. X√≥a ƒë·ªìng h·ªì c≈© n·∫øu ƒëang ch·∫°y
            if (towerState.timer) clearInterval(towerState.timer);

            // 2. Thi·∫øt l·∫≠p th·ªùi gian (V√≠ d·ª• 15 gi√¢y m·ªói c√¢u)
            let timeLeft = 15; 
            const totalTime = 15;

            // L·∫•y c√°c th·∫ª HTML
            const timerText = document.getElementById('combat-timer-text');
            const timerBar = document.getElementById('combat-timer-bar');

            // Reset giao di·ªán ngay l·∫≠p t·ª©c
            if (timerText) timerText.innerText = timeLeft;
            if (timerBar) timerBar.style.width = '100%';

            // 3. B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            towerState.timer = setInterval(() => {
                timeLeft--;

                // C·∫≠p nh·∫≠t text v√† thanh ti·∫øn ƒë·ªô
                if (timerText) timerText.innerText = timeLeft;
                if (timerBar) {
                    const percent = (timeLeft / totalTime) * 100;
                    timerBar.style.width = `${percent}%`;
                }

                // 4. Ki·ªÉm tra h·∫øt gi·ªù
                if (timeLeft <= 0) {
                    clearInterval(towerState.timer);
                    
                    console.log("‚åõ H·∫æT GI·ªú! -> T√≠nh l√† tr·∫£ l·ªùi SAI");
                    
                    // THAY ƒê·ªîI ·ªû ƒê√ÇY:
                    // Thay v√¨ g·ªçi handleAnswerTimeout(), ta g·ªçi th·∫≥ng h√†m tr·∫£ l·ªùi v·ªõi ƒë√°p √°n sai (-1)
                    // ƒê·ªÉ n√≥ ch·∫°y v√†o logic: Tr·ª´ m√°u Player -> Check H·ªìi m√°u -> Next c√¢u
                    if (typeof answerQuestion === 'function') {
                        answerQuestion(-1); 
                    }
                }
            }, 1000);
        }

        // H√ÄM X·ª¨ L√ù KHI H·∫æT GI·ªú (B·ªã qu√°i ƒë√°nh)
        function handleAnswerTimeout() {
            console.log("‚è∞ H·∫øt gi·ªù! B·∫°n b·ªã t·∫•n c√¥ng.");
            
            // Tr·ª´ m√°u ng∆∞·ªùi ch∆°i (S√°t th∆∞∆°ng t·ª´ qu√°i)
            const dmg = towerState.monsterAtk || 10;
            towerState.playerHP -= dmg;

            // C·∫≠p nh·∫≠t thanh m√°u
            updateHealthBars();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o (t√πy ch·ªçn) ho·∫∑c chuy·ªÉn c√¢u lu√¥n
            // ·ªû ƒë√¢y ta g·ªçi checkCombatStatus ƒë·ªÉ xem ng∆∞·ªùi ch∆°i c√≥ ch·∫øt kh√¥ng
            checkCombatStatus();
        }
        // ============================================================
        // 5. H√ÄM THO√ÅT (G·∫Øn v√†o n√∫t X g√≥c ph·∫£i)
        // ============================================================
        function closeCombatView() {
            const combatView = document.getElementById('tower-combat');
            if (combatView) {
                combatView.classList.add('hidden');
                combatView.classList.remove('flex');
            }
            // N·∫øu c√≥ h√†m resetTowerUI th√¨ g·ªçi n√≥ ƒë·ªÉ d·ªçn d·∫πp
            if (typeof resetTowerUI === 'function') resetTowerUI();
        }

        // =======================================================
        //  H·ªÜ TH·ªêNG SKILL TREE (LOGIC HO√ÄN CH·ªàNH)
        // =======================================================

        const SKILL_ICONS = {
            "H·ªéA_C·∫¶U_THU·∫¨T": "/assets/skill_icon/fireball.png",
            "PHONG_H·ªéA_LI√äU_NGUY√äN": "/assets/skill_icon/flame-pillar.png",
            "THI√äN_NGO·∫†I_V·∫™N_TH·∫†CH": "/assets/skill_icon/meteor.png",
            "THANH_QUANG": "/assets/vfx/thanh_quang.png",
            "H·ªéA_TH·∫¶N_NH·∫¨P_TH·ªÇ": "/assets/skill_icon/hoa_than.png",
            "GIAO_K√àO_V·ªöI_QU·ª∂": "/assets/skill_icon/dealdevil.png",
            "H√ÄO_QUANG_THI√äN_S·ª®": "/assets/skill_icon/thiensu.png",
            "CHI·∫æN_√ù_B·∫§T_KHU·∫§T": "/assets/skill_icon/chieny.png",
            "TH·∫¶N_KI·∫æM_TH·∫®M_PH√ÅN": "/assets/skill_icon/thankiem.png"
        };



        async function loadSkillTab() {
            // 1. L·∫•y token
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');

            if (!token) {
                alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                window.location.href = '/login';
                return;
            }

            const container = document.getElementById('skill-tree-container');
            container.innerHTML = '<div class="text-center mt-20 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3"></i><p>ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p></div>';

            // 2. T·∫°o headers d√πng chung
            const authHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            try {
                // 3. G·ªçi ƒë·ªìng th·ªùi 2 API v·ªõi Header ƒë·∫ßy ƒë·ªß
                const [resSkills, resStatusResponse] = await Promise.all([
                    fetch('/api/skills/get-all', { headers: authHeaders }), // API l·∫•y skill theo Class
                    fetch('/api/skills/my-status', { headers: authHeaders }) // API l·∫•y ƒëi·ªÉm tri th·ª©c, skill ƒë√£ h·ªçc
                ]);

                // 4. Ki·ªÉm tra quy·ªÅn truy c·∫≠p (401)
                if (resSkills.status === 401 || resStatusResponse.status === 401) {
                    alert("H·∫øt h·∫°n ƒëƒÉng nh·∫≠p!");
                    window.location.href = '/login';
                    return;
                }

                if (!resSkills.ok || !resStatusResponse.ok) throw new Error("L·ªói k·∫øt n·ªëi Server ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");

                // 5. G√°n d·ªØ li·ªáu v√†o bi·∫øn global
                globalSkillsList = await resSkills.json();
                myStatus = await resStatusResponse.json(); 

                // 6. C·∫≠p nh·∫≠t giao di·ªán
                const skillPointsEl = document.getElementById('skill-points-display');
                if (skillPointsEl) {
                    skillPointsEl.innerText = myStatus.tri_thuc;
                }

                // V·∫Ω c√¢y skill (D√πng d·ªØ li·ªáu t·ª´ myStatus.learned)
                renderSkillTree(99, myStatus.learned);

            } catch (e) {
                console.error("‚ùå L·ªói loadSkillTab:", e);
                container.innerHTML = `<div class="text-center mt-20 text-red-500">${e.message}</div>`;
            }
        }

        function renderSkillTree(level, learned) {
            const container = document.getElementById('skill-tree-container');
            container.innerHTML = '';

            const playerClass = myStatus.class_type || 'MAGE'; 

            const classSkills = globalSkillsList.filter(s => s.class_type === playerClass);
            if (classSkills.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10">B·∫°n thu·ªôc l·ªõp ${playerClass}, ch∆∞a c√≥ k·ªπ nƒÉng n√†o ƒë∆∞·ª£c c·∫≠p nh·∫≠t.</div>`;
                return;
            }
            classSkills.sort((a, b) => (a.min_level || 1) - (b.min_level || 1));

            classSkills.forEach((skill, index) => {
                const isLearned = learned[skill.skill_id];
                const isEquipped = myStatus.equipped === skill.skill_id;
                const hasPrereq = !skill.prerequisite_id || learned[skill.prerequisite_id];
                const isLevelOk = level >= (skill.min_level || 1);

                let status = "LOCKED";
                if (isLearned) status = "LEARNED";
                else if (hasPrereq && isLevelOk) status = "AVAILABLE";

                const iconPath = SKILL_ICONS[skill.skill_id] || "/assets/skill_icon/default.png";
                
                let borderClass = "border-gray-700 bg-gray-900 grayscale opacity-50";
                if (status === "AVAILABLE") borderClass = "border-yellow-500 bg-gray-800 animate-pulse";
                if (status === "LEARNED") borderClass = "border-blue-500 bg-blue-900";
                if (isEquipped) borderClass = "border-green-500 bg-green-900 shadow-[0_0_15px_#22c55e]"; // ƒêang trang b·ªã s√°ng xanh

                const node = document.createElement('div');
                node.className = "flex flex-col items-center mb-12 relative group";
                
                if (index > 0) node.innerHTML += `<div class="absolute -top-12 w-1 h-12 bg-gray-700 -z-10"></div>`;

                node.innerHTML += `
                    <div onclick="selectSkill('${skill.skill_id}', '${status}')" 
                        class="w-24 h-24 rounded-2xl border-4 ${borderClass} flex items-center justify-center cursor-pointer transition-transform hover:scale-110 z-10 relative">
                        <img src="${iconPath}" onerror="this.src='https://placehold.co/100?text=NoIcon'" class="w-20 h-20 object-contain">
                        ${status === 'LOCKED' ? '<div class="absolute inset-0 flex items-center justify-center bg-black/50"><i class="fa-solid fa-lock text-2xl text-gray-400"></i></div>' : ''}
                        ${isEquipped ? '<div class="absolute -top-3 -right-3 bg-green-600 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-black shadow-lg">E</div>' : ''}
                    </div>
                    <div class="mt-2 text-center">
                        <p class="text-white font-bold text-sm">${skill.name}</p>
                        ${isEquipped ? '<p class="text-green-400 text-[10px] font-bold uppercase">ƒêANG D√ôNG</p>' : ''}
                    </div>
                `;
                container.appendChild(node);
            });
        }

        function selectSkill(skillId, status) {
            // 1. T√¨m Skill
            const skill = globalSkillsList.find(s => s.skill_id === skillId);
            if (!skill) return;

            const iconPath = SKILL_ICONS[skillId] || "/assets/skill_icon/default.png";
            const isEquipped = myStatus.equipped === skillId;
            
            // 2. Parse Config (Gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
            let config = {};
            let rawConf = skill.config_data || skill.config || {}; 

            if (typeof rawConf === 'string') {
                try { config = JSON.parse(rawConf); } catch(e) { config = {}; }
            } else {
                config = rawConf;
            }
            
            const cost = config.base_cost !== undefined ? parseInt(config.base_cost) : 0;
            
            // ============================================================
            // üìä X·ª¨ L√ù HI·ªÇN TH·ªä S·ª®C M·∫†NH (N√ÇNG C·∫§P)
            // ============================================================
            let mainStatHtml = ""; // Bi·∫øn ch·ª©a c√°c d√≤ng HTML hi·ªÉn th·ªã ch·ªâ s·ªë
            const sType = (skill.skill_type || "").toUpperCase();

            if (sType === 'PASSIVE') {
                // --- A. Hi·ªÉn th·ªã Buff Ch·ªâ s·ªë (N·∫øu c√≥) ---
                const val = parseFloat(config.value || 0);
                if (val > 0) {
                    mainStatHtml += `
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-orange-500 font-bold">Hi·ªáu Qu·∫£</span>
                            <span class="text-xl font-bold text-green-400">+${Math.round(val * 100)}%</span>
                        </div>`;
                }

                // --- B. Hi·ªÉn th·ªã H·ªìi M√°u (M·ªöI TH√äM) ---
                if ((config.heal_percent && config.heal_percent > 0) || (config.heal_flat && config.heal_flat > 0)) {
                    let healText = "";
                    // Gh√©p chu·ªói: 30% HP + 500
                    if (config.heal_percent > 0) healText += `${Math.round(config.heal_percent * 100)}% HP`;
                    if (config.heal_flat > 0) healText += (healText ? " + " : "") + `${config.heal_flat}`;

                    mainStatHtml += `
                        <div class="flex justify-between items-center text-xs mt-1">
                            <span class="text-pink-500 font-bold">H·ªìi Ph·ª•c</span>
                            <span class="text-md font-bold text-pink-300">${healText}</span>
                        </div>`;
                }

                // --- C. Hi·ªÉn th·ªã ƒêi·ªÅu ki·ªán (M·ªöI TH√äM) ---
                if (config.condition === 'hp_below') {
                    const thresh = (config.threshold || 0.5) * 100;
                    mainStatHtml += `
                        <div class="text-[10px] text-gray-400 text-right italic mt-1">
                            (K√≠ch ho·∫°t khi HP d∆∞·ªõi ${thresh}%)
                        </div>`;
                } else if (config.condition === 'chance_on_hit') {
                    mainStatHtml += `
                        <div class="text-[10px] text-gray-400 text-right italic mt-1">
                            (Khi b·ªã t·∫•n c√¥ng)
                        </div>`;
                }

                // N·∫øu kh√¥ng c√≥ g√¨ ƒë·ªÉ hi·ªán (Skill r·ªóng)
                if (mainStatHtml === "") {
                    mainStatHtml = `<div class="text-center text-gray-500 text-xs">N·ªôi t·∫°i ·∫©n</div>`;
                }

            } else {
                // --- ACTIVE SKILL (Gi·ªØ nguy√™n) ---
                const val = parseFloat(config.base_mult || 1.0); 
                mainStatHtml = `
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-orange-500 font-bold">S√°t Th∆∞∆°ng</span>
                        <span class="text-xl font-bold text-orange-400">x${val}</span>
                    </div>`;
            }

            // --- LOGIC N√öT B·∫§M (Gi·ªØ nguy√™n logic c·ªßa b·∫°n) ---
            let btnHtml = '';
            
            if (status === 'LOCKED') {
                btnHtml = `
                    <button class="w-full py-3 bg-gray-700 text-gray-400 rounded-lg cursor-not-allowed font-bold border border-gray-600">
                        <i class="fa-solid fa-lock"></i> Y√äU C·∫¶U LEVEL ${skill.min_level || 1}
                    </button>`;
            } 
            else if (status === 'AVAILABLE') {
                const currentMoney = myStatus.tri_thuc || 0;
                const canAfford = currentMoney >= cost;
                
                if (canAfford) {
                    btnHtml = `
                        <button onclick="apiAction('learn', '${skillId}')" class="w-full py-3 rounded-lg font-bold text-white shadow-lg bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 animate-bounce-slow">
                            <i class="fa-solid fa-book-open"></i> Lƒ®NH NG·ªò (${cost} TRI TH·ª®C)
                        </button>`;
                } else {
                    btnHtml = `
                        <button class="w-full py-3 bg-gray-600 text-gray-300 rounded-lg cursor-not-allowed font-bold border border-gray-500">
                            <i class="fa-solid fa-ban"></i> THI·∫æU TI·ªÄN (${cost} TRI TH·ª®C)
                        </button>`;
                }
            } 
            else if (status === 'LEARNED') {
                if (sType === 'PASSIVE') {
                    btnHtml = `<button class="w-full py-3 bg-blue-900/50 text-blue-400 border border-blue-600 rounded-lg cursor-default font-bold">‚ö° B·ªä ƒê·ªòNG - T·ª∞ K√çCH HO·∫†T</button>`;
                } else if (isEquipped) {
                    btnHtml = `<button onclick="apiAction('unequip')" class="w-full py-3 bg-red-900/80 hover:bg-red-800 text-red-200 border border-red-700 rounded-lg font-bold transition"><i class="fa-solid fa-times"></i> G·ª† B·ªé</button>`;
                } else {
                    btnHtml = `<button onclick="apiAction('equip', '${skillId}')" class="w-full py-3 bg-green-700 hover:bg-green-600 text-white rounded-lg font-bold transition shadow-lg"><i class="fa-solid fa-shield-alt"></i> TRANG B·ªä</button>`;
                }
            }

            // 3. Render Panel Chi Ti·∫øt
            const detailPanel = document.getElementById('skill-detail-panel');
            if (detailPanel) {
                detailPanel.innerHTML = `
                    <div class="text-center mb-4">
                        <img src="${iconPath}" class="w-24 h-24 mx-auto rounded-lg border-2 ${isEquipped ? 'border-green-500 shadow-[0_0_15px_#22c55e]' : 'border-yellow-500'} bg-gray-900 object-contain shadow-lg">
                        <h3 class="text-2xl font-bold text-white mt-4 font-rpg">${skill.name}</h3>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-4 italic text-gray-300 text-center text-sm">
                        "${skill.description || 'Ch∆∞a c√≥ m√¥ t·∫£'}"
                    </div>

                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 space-y-2 mb-6">
                        
                        ${mainStatHtml} 

                        <div class="w-full h-[1px] bg-gray-700 my-2"></div>

                        <div class="flex justify-between items-center text-xs">
                            <span class="text-blue-400 font-bold">Lo·∫°i</span>
                            <span class="text-white">${sType}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-400 font-bold">Level Y√™u C·∫ßu</span>
                            <span class="text-white font-bold">Lv.${skill.min_level || 1}</span>
                        </div>
                    </div>
                    
                    <div class="mt-auto">${btnHtml}</div>
                `;
            }
        }

        // H√ÄM G·ªåI API x·ª≠ l√Ω n√∫t b·∫•m l∆∞u skill ƒë√£ trang b·ªã
        async function apiAction(action, skillId = '') {
            // 1. Ki·ªÉm tra Token
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            
            if (!token) {
                alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                // üëá S·ª¨A T·∫†I ƒê√ÇY: Chuy·ªÉn v·ªÅ index.html thay v√¨ /login
                window.location.href = 'index.html'; 
                return;
            }

            if (action === 'learn' && !confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªçc k·ªπ nƒÉng n√†y?")) return;

            // 2. C·∫§U H√åNH URL CHU·∫®N (Kh·ªõp v·ªõi file main.py v√† skill.py c·ªßa b·∫°n)
            let url = `/api/skills/${action}`;
            
            // N·∫øu l√† trang b·ªã (equip) ho·∫∑c h·ªçc (learn) th√¨ m·ªõi c·ªông th√™m skillId v√†o URL
            if (skillId && action !== 'unequip') {
                url += `/${skillId}`; 
            }

            try {
                console.log(`üöÄ ƒêang g·ªçi API: ${url}`);

                const res = await fetch(url, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({}) 
                });

                // Ki·ªÉm tra n·∫øu l√† l·ªói 401 (H·∫øt h·∫°n token)
                if (res.status === 401) {
                    alert("H·∫øt h·∫°n ƒëƒÉng nh·∫≠p!");
                    window.location.href = 'index.html'; // üëá S·ª≠a ti·∫øp ·ªü ƒë√¢y
                    return;
                }

                const data = await res.json();
                
                if (res.ok) {
                    console.log("‚úÖ Th√†nh c√¥ng:", data);
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i t·∫°m th·ªùi ƒë·ªÉ giao di·ªán ƒë·ªïi m√†u n√∫t ngay
                    if (action === 'equip') window.myStatus.equipped = skillId;
                    if (action === 'unequip') window.myStatus.equipped = null;

                    // G·ªçi c√°c h√†m t·∫£i l·∫°i d·ªØ li·ªáu c·ªßa b·∫°n
                    if (typeof loadSkillTab === 'function') loadSkillTab(); 
                    if (typeof loadDashboardData === 'function') loadDashboardData();

                } else {
                    console.error("Server Error:", data);
                    alert("L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ th·ª±c hi·ªán"));
                }
            } catch(e) { 
                console.error("L·ªói k·∫øt n·ªëi:", e);
                alert("L·ªói k·∫øt n·ªëi server!"); 
            }
        }
        // ============================================================
        // 5. HI·ªÜU ·ª®NG S√ÅT TH∆Ø∆†NG (PHI√äN B·∫¢N N√ÇNG C·∫§P)
        // ============================================================
        function showDamagePopup(targetId, amount, colorClass = "text-yellow-400") {
            // 1. Gi·ªØ nguy√™n logic ID c≈©
            const damageId = targetId + '-damage';
            let el = document.getElementById(damageId);

            // 2. Logic t·∫°o th·∫ª (GI·ªÆ NGUY√äN CODE C·ª¶A B·∫†N, ch·ªâ s·ª≠a style l√∫c t·∫°o)
            if (!el) {
                const targetEl = document.getElementById(targetId);
                if (!targetEl) return;

                if (window.getComputedStyle(targetEl).position === 'static') {
                    targetEl.style.position = 'relative';
                }

                el = document.createElement('div');
                el.id = damageId;
                // G·∫Øn v√†o cha c·ªßa target nh∆∞ c≈©
                targetEl.parentElement.appendChild(el); 
            }

            // 3. [N√ÇNG C·∫§P HI·ªÇN TH·ªä] 
            // - top-1/2 left-1/2: ƒê∆∞a v√†o CH√çNH GI·ªÆA h√¨nh ·∫£nh (thay v√¨ top-0 b·ªã l·ªách l√™n tr√™n)
            // - text-6xl: Ch·ªØ si√™u to (G·∫•p ƒë√¥i text-3xl c≈©)
            // - z-[100]: ƒê·∫£m b·∫£o ƒë√® l√™n thanh m√°u (th∆∞·ªùng z-index thanh m√°u ch·ªâ kho·∫£ng 10-50)
            // - drop-shadow...: Vi·ªÅn ƒëen d√†y ƒë·ªÉ n·ªïi b·∫≠t
            el.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 font-black text-6xl ${colorClass} z-[100] drop-shadow-[0_4px_4px_rgba(0,0,0,1)] pointer-events-none select-none`;

            el.innerText = `-${amount}`;

            // 4. [N√ÇNG C·∫§P HI·ªÜU ·ª®NG]
            el.style.animation = 'none';
            el.offsetHeight; /* Trigger reflow */
            
            // TƒÉng th·ªùi gian t·ª´ 1s l√™n 1.5s (Hi·ªán l√¢u h∆°n)
            el.style.animation = 'staticPop 1.5s ease-out forwards';
        }

        // 5. [KEYFRAME M·ªöI] ƒê·ª©ng y√™n & N·ªï to
        // Ki·ªÉm tra xem style ƒë√£ c√≥ ch∆∞a ƒë·ªÉ tr√°nh t·∫°o tr√πng l·∫∑p m·ªói l·∫ßn g·ªçi h√†m
        if (!document.getElementById('damage-style-sheet')) {
            const styleSheet = document.createElement("style");
            styleSheet.id = 'damage-style-sheet'; // ƒê·∫∑t ID ƒë·ªÉ qu·∫£n l√Ω
            styleSheet.innerText = `
            @keyframes staticPop {
                /* Giai ƒëo·∫°n 1: N·ªï ra (0% -> 15%) */
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                15% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); } 
                
                /* Giai ƒëo·∫°n 2: Thu nh·ªè nh·∫π & ƒê·ª®NG Y√äN (15% -> 80%) */
                /* Gi·ªØ nguy√™n v·ªã tr√≠ translate(-50%, -50%) ƒë·ªÉ kh√¥ng b·ªã bay */
                30% { transform: translate(-50%, -50%) scale(1.2); }
                80% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 
                
                /* Giai ƒëo·∫°n 3: Bi·∫øn m·∫•t (80% -> 100%) */
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
            }
            `;
            document.head.appendChild(styleSheet);
        }

  
        // 8. H·ªÜ TH·ªêNG VFX (ƒê√É C·∫¨P NH·∫¨T: H·ªñ TR·ª¢ C·∫¢ PASSIVE/SELF TARGET)
        // ============================================================
        function playVFX(vfxName, targetId, isProjectile = false) {
            if (!vfxName) return;
            
            // 1. Chu·∫©n h√≥a t√™n class
            const className = vfxName.replace('.', '').trim();
            
            // 2. T√¨m container (Gi·ªØ nguy√™n logic c≈©)
            const container = document.getElementById('vfx-container');
            if (!container) return; // Kh√¥ng t√¨m th·∫•y container th√¨ tho√°t √™m

            // üëá THAY ƒê·ªîI QUAN TR·ªåNG: T√¨m m·ª•c ti√™u T·ªîNG QU√ÅT (Player ho·∫∑c Monster ƒë·ªÅu ƒë∆∞·ª£c)
            const targetEl = document.getElementById(targetId);
            
            // N·∫øu kh√¥ng t√¨m th·∫•y m·ª•c ti√™u -> C·∫£nh b√°o nh·∫π v√† tho√°t (Kh√¥ng crash)
            if (!targetEl) {
                console.warn(`‚ö†Ô∏è [VFX] Kh√¥ng t√¨m th·∫•y m·ª•c ti√™u id='${targetId}'. B·ªè qua hi·ªáu ·ª©ng.`);
                return;
            }

            // Reset container
            container.innerHTML = '';
            container.className = "vfx-container"; 
            container.classList.remove('hidden');
            container.style.width = ''; 
            container.style.height = '';
            // 3. T√≠nh to√°n t·ªça ƒë·ªô ƒê√çCH (D√πng chung cho c·∫£ Monster v√† Player)
            const targetRect = targetEl.getBoundingClientRect();
            // T·ªça ƒë·ªô t√¢m c·ªßa m·ª•c ti√™u
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;

            console.log(`üìç VFX Target [${targetId}]: X=${endX}, Y=${endY}`);

            // T·∫°o th·∫ª hi·ªáu ·ª©ng
            const vfxEl = document.createElement('div');
            vfxEl.classList.add(className);
            container.appendChild(vfxEl);

            // --- LOGIC X·ª¨ L√ù RI√äNG (GI·ªÆ NGUY√äN LOGIC C≈®, CH·ªà THAY ƒê·ªîI BI·∫æN) ---
            
            if (className === 'fx-meteor') {
                // [CASE 1: THI√äN TH·∫†CH]
                // Logic: Bay t·ª´ tr√™n tr·ªùi xu·ªëng ƒë·∫ßu m·ª•c ti√™u (endX, endY)
                let startX = endX - 50; // Bay ch√©o nh·∫π t·ª´ tr√°i sang
                let startY = -150;      // T·ª´ ngo√†i m√†n h√¨nh

                // Setup v·ªã tr√≠ xu·∫•t ph√°t
                container.style.transition = 'none';
                container.style.left = startX + 'px';
                container.style.top = startY + 'px';
                container.style.transform = 'translate(-50%, -50%) rotate(-45deg)'; 

                // K√≠ch ho·∫°t bay
                requestAnimationFrame(() => {
                    container.style.transition = 'top 0.8s ease-in, left 0.8s linear'; 
                    container.style.left = endX + 'px';
                    container.style.top = endY + 'px';
                });

                // X√≥a
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1200);
            } 
            else if (className === 'fx-flame-pillar') {
                // [CASE 2: C·ªòT L·ª¨A]
                // Logic: M·ªçc t·ª´ ch√¢n m·ª•c ti√™u
                console.log("üî• ƒêang ch·∫°y logic PILLAR");
                container.style.transition = 'none';
                container.style.left = endX + 'px';
                container.style.top = (targetRect.bottom - 20) + 'px'; // L·∫•y ch√¢n target
                container.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1000);
            }
            else if (isProjectile && targetId !== 'combat-player-img') { 
                // [CASE 3: ƒê·∫†N BAY - FIREBALL]
                // L∆∞u √Ω: Ch·ªâ bay n·∫øu m·ª•c ti√™u KH√îNG PH·∫¢I l√† b·∫£n th√¢n (tr√°nh t·ª± b·∫Øn m√¨nh)
                const playerEl = document.getElementById('combat-player-img');
                if(playerEl) {
                    const playerRect = playerEl.getBoundingClientRect();
                    const startX = playerRect.left + playerRect.width / 2;
                    const startY = playerRect.top + playerRect.height / 2;
                    
                    container.style.transition = 'none';
                    container.style.left = startX + 'px';
                    container.style.top = startY + 'px';
                    container.style.transform = 'translate(-50%, -50%)';

                    requestAnimationFrame(() => {
                        container.style.transition = 'top 0.5s linear, left 0.5s linear';
                        container.style.left = endX + 'px';
                        container.style.top = endY + 'px';
                    });
                }
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 600);
            }
            else if (className === 'fx-thankiem') {
                // [CASE ƒê·∫∂C BI·ªÜT: TH·∫¶N KI·∫æM] 
                // Logic: KH√îNG b·ªã gi·ªõi h·∫°n khung (Overflow visible) ƒë·ªÉ ki·∫øm to tho·∫£i m√°i
                
                // 1. Reset container cho tho√°ng
                container.style.width = '0px';  // Kh√¥ng quan tr·ªçng width/height
                container.style.height = '0px'; 
                container.style.overflow = 'visible'; // üëà QUAN TR·ªåNG: ƒê·ªÉ ki·∫øm l√≤i ra ngo√†i khung ƒë∆∞·ª£c
                
                // 2. ƒê·∫∑t v·ªã tr√≠ ngay ƒë·ªânh ƒë·∫ßu m·ª•c ti√™u
                container.style.transition = 'none';
                container.style.left = endX + 'px';
                // endY l√† gi·ªØa b·ª•ng qu√°i. Ki·∫øm c·∫Øm t·ª´ ƒë·∫ßu xu·ªëng -> ch·ªânh l√™n tr√™n 1 ch√∫t
                container.style.top = (endY - targetRect.height/2) + 'px'; 
                
                // CƒÉn gi·ªØa ƒëi·ªÉm neo
                container.style.transform = 'translate(-50%, 0)'; 

                // 3. X√≥a sau khi di·ªÖn xong (1.5 gi√¢y)
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1500);
            }
            else if (className === 'fx-thienphat') {
                // [CASE M·ªöI: THI√äN PH·∫†T]
                // Logic: R∆°i t·ª´ tr√™n ƒë·∫ßu qu√°i xu·ªëng (gi·ªëng Th·∫ßn Ki·∫øm nh∆∞ng d√πng ·∫£nh kh√°c)
                
                // 1. Reset container ƒë·ªÉ kh√¥ng b·ªã c·∫Øt ·∫£nh
                container.style.width = '0px';
                container.style.height = '0px';
                container.style.overflow = 'visible'; // Quan tr·ªçng: ƒê·ªÉ ·∫£nh to l√≤i ra ngo√†i
                
                // 2. ƒê·ªãnh v·ªã: Ngay ƒë·ªânh ƒë·∫ßu qu√°i
                container.style.transition = 'none';
                container.style.left = endX + 'px';
                container.style.top = (endY - targetRect.height/2) + 'px'; 
                
                // 3. CƒÉn gi·ªØa
                container.style.transform = 'translate(-50%, 0)'; 

                // 4. D·ªçn d·∫πp sau 1.5s
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1500);
            }
            else if (className === 'fx-nuilua') {
                // [CASE M·ªöI: N√öI L·ª¨A]
                // Logic: B√πng n·ªï ngay t·∫°i t√¢m qu√°i (Kh√¥ng r∆°i)
                
                // 1. Reset container
                container.style.width = '0px';
                container.style.height = '0px';
                container.style.overflow = 'visible'; // ƒê·ªÉ l·ª≠a to l√≤i ra ngo√†i khung
                const moveRight = 180;  // D·ªãch sang ph·∫£i 60px
                const moveDown  = 160;
                // 2. ƒê·ªãnh v·ªã: Ngay ch√≠nh gi·ªØa b·ª•ng qu√°i (T√¢m)
                container.style.transition = 'none';
                container.style.left = endX + 'px';
                container.style.top = endY + 'px'; 
                container.style.transform = 'translate(-50%, -50%)';
                // (Trong CSS ƒë√£ c√≥ translate(-50%, -50%) ƒë·ªÉ cƒÉn ch·ªânh t√¢m ·∫£nh tr√πng t√¢m qu√°i)

                // 3. D·ªçn d·∫πp sau 1.5s
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1500);
            }
            // passive skill
            else {
                // 1. T√≠nh to√°n k√≠ch th∆∞·ªõc "C·ª¨A S·ªî HI·ªÇN TH·ªä" (Container)
                // - Chi·ªÅu ngang: Ch·ªâ b·∫±ng 60% chi·ªÅu r·ªông nh√¢n v·∫≠t (R·∫•t h·∫πp, ƒë·ªÉ t·∫°o d√°ng c·ªôt kh√≠)
                // - Chi·ªÅu cao: B·∫±ng 100% chi·ªÅu cao nh√¢n v·∫≠t
                const maskWidth = targetRect.width * 0.6; 
                const maskHeight = targetRect.height * 1.0;

                // 2. Thi·∫øt l·∫≠p Container th√†nh "M·∫∂T N·∫†" (Mask)
                container.style.width = maskWidth + 'px';
                container.style.height = maskHeight + 'px';
                
                // üëá QUAN TR·ªåNG: C·∫Øt b·ªè ph·∫ßn th·ª´a 2 b√™n
                container.style.overflow = 'hidden'; 
                
                // üëá QUAN TR·ªåNG: CƒÉn gi·ªØa hi·ªáu ·ª©ng b√™n trong
                // (ƒê·ªÉ t√¢m c·ªßa hi·ªáu ·ª©ng lu√¥n n·∫±m gi·ªØa c√°i khung h·∫πp n√†y)
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';

                // ƒê·∫£m b·∫£o ·∫£nh Sprite b√™n trong KH√îNG B·ªä CO L·∫†I (Gi·ªØ nguy√™n size g·ªëc c·ªßa ·∫£nh)
                vfxEl.style.width = (targetRect.width * 1.8) + 'px'; 
                vfxEl.style.height = '100%'; 
                vfxEl.style.flexShrink = '0';   

                // 3. ƒê·∫∑t v·ªã tr√≠ Container
                container.style.transition = 'none';
                container.style.left = endX + 'px';
                container.style.top = endY + 'px';
                container.style.transform = 'translate(-50%, -50%)';
                
                // TƒÉng th·ªùi gian hi·ªÉn th·ªã l√™n 1.5s cho c√°c hi·ªáu ·ª©ng buff
                setTimeout(() => { vfxEl.remove(); container.classList.add('hidden'); }, 1500);
            }
        }

        // ============================================================
        // H√ÄM K√çCH HO·∫†T HI·ªÜU ·ª®NG PASSIVE (AN TO√ÄN TUY·ªÜT ƒê·ªêI)
        // ============================================================
        function triggerPassiveVFX() {
            // ============================================================
            // üõ°Ô∏è CH·ªêNG L·∫∂P (ANTI-DUPLICATE)
            // N·∫øu h√†m n√†y v·ª´a ch·∫°y c√°ch ƒë√¢y d∆∞·ªõi 2 gi√¢y -> Ch·∫∑n lu√¥n!
            // ============================================================
            const now = Date.now();
            if (window.lastPassiveTrigger && (now - window.lastPassiveTrigger < 2000)) {
                console.warn("üö´ ƒê√£ ch·∫∑n g·ªçi tr√πng l·∫∑p triggerPassiveVFX.");
                return;
            }
            window.lastPassiveTrigger = now;
            // ============================================================

            console.log("--- B·∫ÆT ƒê·∫¶U QU√âT PASSIVE (SEQUENCE MODE) ---");

            if (!window.myStatus || !window.globalSkillsList || window.globalSkillsList.length === 0) {
                return;
            }

            const PLAYER_ID = 'combat-player-img';
            const MONSTER_ID = 'combat-monster-img';
            const learnedKeys = Object.keys(window.myStatus.learned || {});

            // Bi·∫øn ƒë·∫øm th·ªùi gian
            let sequenceDelay = 0;
            const STEP_DELAY = 1200; // 1.2 gi√¢y

            const cleanID = (str) => (!str) ? "" : str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/-/g, '_').trim();

            learnedKeys.forEach(rawSkillID => {
                const searchID = cleanID(rawSkillID);
                const skillInfo = window.globalSkillsList.find(s => cleanID(s.skill_id) === searchID);

                if (!skillInfo) return;

                let conf = {};
                if (skillInfo.config_data) {
                    try {
                        conf = typeof skillInfo.config_data === 'string' ? JSON.parse(skillInfo.config_data) : skillInfo.config_data;
                    } catch (e) { conf = {}; }
                }

                const vfxClass = (skillInfo.vfx_class || conf.vfx_class || "").trim();
                let rawCondition = (skillInfo.condition || conf.condition || "always").toString();
                const sType = (skillInfo.skill_type || "").toUpperCase();

                if (searchID.includes('kien_dinh') && rawCondition === 'always') rawCondition = 'hp_below';

                const isHpBelow = rawCondition.includes('hp_below') || rawCondition.toLowerCase().includes('d∆∞·ªõi');
                
                // B·ªè qua skill ch·ªù m√°u
                if (isHpBelow) return;

                // K√çCH HO·∫†T V·ªöI DELAY
                if (sType === 'PASSIVE' && vfxClass) {
                    
                    setTimeout(() => {
                        const targetKey = skillInfo.vfx_target || conf.vfx_target || 'self';
                        const finalTargetID = (targetKey === 'enemy') ? MONSTER_ID : PLAYER_ID;
                        const targetEl = document.getElementById(finalTargetID);

                        if (targetEl) {
                            console.log(`‚è∞ [Time: ${sequenceDelay}ms] K√çCH HO·∫†T: ${skillInfo.name}`);
                            
                            if (typeof playVFX === 'function') {
                                playVFX(vfxClass, finalTargetID);
                            }

                            if (typeof showFloatingText === 'function') {
                                let color = '#fbbf24'; 
                                if (searchID.includes('chien_y')) color = '#f97316';
                                showFloatingText(`${skillInfo.name}!`, finalTargetID, color);
                            }
                        }
                    }, sequenceDelay);

                    sequenceDelay += STEP_DELAY;
                }
            });
        }
        // ============================================================
        // H√ÄM HI·ªÜN CH·ªÆ BAY (FLOATING TEXT)
        // ============================================================
        function showFloatingText(text, targetId, color = '#fbbf24') {
            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;

            // 1. T√≠nh v·ªã tr√≠ (Tr√™n ƒë·∫ßu nh√¢n v·∫≠t)
            const rect = targetEl.getBoundingClientRect();
            // X: Gi·ªØa nh√¢n v·∫≠t
            const x = rect.left + rect.width / 2;
            // Y: Tr√™n ƒë·ªânh ƒë·∫ßu m·ªôt ch√∫t (tr·ª´ ƒëi 50px)
            const y = rect.top - 50; 

            // 2. T·∫°o th·∫ª ch·ªØ
            const textEl = document.createElement('div');
            textEl.innerText = text;
            
            // 3. Style cho ch·ªØ (ƒê·∫≠m, c√≥ vi·ªÅn ƒëen, m√†u v√†ng kim)
            textEl.style.position = 'fixed';
            textEl.style.left = x + 'px';
            textEl.style.top = y + 'px';
            textEl.style.transform = 'translate(-50%, 0)'; // CƒÉn gi·ªØa
            textEl.style.color = color;
            textEl.style.fontSize = '18px';
            textEl.style.fontWeight = 'bold';
            textEl.style.fontFamily = 'Arial, sans-serif';
            textEl.style.textShadow = '2px 2px 0px #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000'; // Vi·ªÅn ƒëen d√†y
            textEl.style.zIndex = '9999'; // Lu√¥n n·∫±m tr√™n c√πng
            textEl.style.pointerEvents = 'none'; // Kh√¥ng ch·∫∑n chu·ªôt
            textEl.style.opacity = '0';
            textEl.style.transition = 'all 1.5s ease-out'; // Bay ch·∫≠m trong 1.5s

            // 4. G·∫Øn v√†o body
            document.body.appendChild(textEl);

            // 5. K√≠ch ho·∫°t Animation (Bay l√™n + Hi·ªán ra -> M·ªù d·∫ßn)
            requestAnimationFrame(() => {
                textEl.style.opacity = '1';
                textEl.style.top = (y - 80) + 'px'; // Bay l√™n cao th√™m 80px
                
                // Sau 1s th√¨ b·∫Øt ƒë·∫ßu m·ªù d·∫ßn
                setTimeout(() => {
                    textEl.style.opacity = '0';
                }, 1000);
            });

            // 6. X√≥a kh·ªèi DOM sau khi di·ªÖn xong
            setTimeout(() => {
                textEl.remove();
            }, 1600);
        }
        
        /* ============================================================
        üõçÔ∏è LOGIC TI·ªÜM T·∫†P H√ìA (SHOP SYSTEM)
        ============================================================ */
        // 2. M·ªü Shop & C·∫≠p nh·∫≠t V√≠ ti·ªÅn
        function openShopView() {
            switchView('shop');
            
            // ƒê·ªìng b·ªô s·ªë d∆∞ t·ª´ Dashboard sang Shop Header ƒë·ªÉ ng∆∞·ªùi ch∆°i ti·ªán theo d√µi
            document.getElementById('shop-wallet-trithuc').innerText = document.getElementById('wallet-exp').innerText; // Tri th·ª©c (d√πng slot EXP c≈©)
            document.getElementById('shop-wallet-vinhdu').innerText = document.getElementById('stat-vinhdu').innerText; 
            document.getElementById('shop-wallet-chientich').innerText = document.getElementById('stat-chientich').innerText; // Chi·∫øn t√≠ch

            // T·∫£i h√†ng h√≥a
            loadShopItems();
        }

        // 3. T·∫£i danh s√°ch h√†ng t·ª´ Server
        async function loadShopItems() {
            const container = document.getElementById('shop-items-container');
            container.innerHTML = '<div class="col-span-full text-center text-white py-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>ƒêang nh·∫≠p h√†ng...</div>';

            try {
                // üëá QUAN TR·ªåNG 1: Tr·ªè ƒë√∫ng v√†o API trong shop.py
                const response = await fetch('/admin/shop/items'); 
                
                // Backend tr·∫£ v·ªÅ th·∫≥ng 1 m·∫£ng (List), kh√¥ng ph·∫£i object status
                const data = await response.json(); 

                // üëá QUAN TR·ªåNG 2: Ki·ªÉm tra n·∫øu l√† m·∫£ng th√¨ v·∫Ω lu√¥n
                if (Array.isArray(data)) {
                    renderShopShelves(data);
                } else {
                    console.error("D·ªØ li·ªáu l·∫°:", data);
                    container.innerHTML = '<div class="col-span-full text-center text-red-300">L·ªói d·ªØ li·ªáu t·ª´ Server</div>';
                }

            } catch (err) {
                console.error("L·ªói shop:", err);
                container.innerHTML = '<div class="col-span-full text-center text-red-300">M·∫•t k·∫øt n·ªëi v·ªõi Server!</div>';
            }
        }

        // 4. V·∫Ω giao di·ªán K·ªá h√†ng
        function renderShopShelves(items) {
            const container = document.getElementById('shop-items-container');
            container.innerHTML = ''; 

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-amber-200 italic">"H√¥m nay ti·ªám ngh·ªâ b√°n nha con!"</div>';
                return;
            }

            items.forEach(item => {
                // üëá QUAN TR·ªåNG 3: Map t√™n bi·∫øn t·ª´ DB sang bi·∫øn d√πng hi·ªÉn th·ªã
                // DB d√πng 'currency_type', JS c≈© d√πng 'currency'
                const currencyType = item.currency_type || item.currency || 'tri_thuc'; 
                
                // DB d√πng 'image_url', JS c≈© d√πng 'icon'
                const imgUrl = item.image_url || item.icon || 'https://placehold.co/100';

                // Ch·ªçn m√†u s·∫Øc theo lo·∫°i ti·ªÅn
                let currencyLabel = 'Tri Th·ª©c';
                let currencyIcon = 'üìò';
                let btnClass = 'bg-blue-600 hover:bg-blue-500'; // M·∫∑c ƒë·ªãnh xanh

                if (currencyType === 'vinh_du') {
                    currencyLabel = 'Vinh D·ª±'; 
                    currencyIcon = 'üèÜ'; 
                    btnClass = 'bg-yellow-600 hover:bg-yellow-500';
                } else if (currencyType === 'chien_tich') {
                    currencyLabel = 'Chi·∫øn T√≠ch'; 
                    currencyIcon = '‚öîÔ∏è'; 
                    btnClass = 'bg-red-600 hover:bg-red-500';
                }

                // T·∫°o th·∫ª HTML
                const itemHtml = `
                    <div class="bg-[#4e342e] rounded-lg border border-[#795548] p-3 flex flex-col group hover:scale-105 transition duration-300 shadow-lg">
                        <div class="h-24 flex items-center justify-center mb-2 bg-[#3e2723] rounded overflow-hidden">
                            <img src="${imgUrl}" class="h-full object-contain" onerror="this.src='https://placehold.co/100?text=Item'">
                        </div>
                        
                        <div class="flex-1 text-center">
                            <h4 class="font-bold text-amber-100 text-sm truncate" title="${item.name}">${item.name}</h4>
                            <div class="text-xs text-amber-200/60 line-clamp-2 h-8 mb-2" title="${item.description}">${item.description || "Kh√¥ng m√¥ t·∫£"}</div>
                        </div>

                        <button class="w-full py-1.5 rounded text-white text-xs font-bold shadow ${btnClass} flex items-center justify-center gap-1" 
                            onclick="buyItem(${item.id}, '${item.name}', ${item.price}, '${currencyType}')">
                            ${currencyIcon} ${item.price}
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        // =========================================================
        // H√ÄM MUA V·∫¨T PH·∫®M (PHI√äN B·∫¢N T·ª∞ T√åM USERNAME N·∫æU B·ªä M·∫§T)
        // =========================================================
        async function buyItem(itemId, itemName, price, currencyType) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën mua [${itemName}] v·ªõi gi√° ${price}?`)) return;

            // 1. L·∫§Y TOKEN V√Ä USERNAME T·ª™ B·ªò NH·ªö
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            let username = localStorage.getItem('username');

            // üöë C∆† CH·∫æ "C·∫§P C·ª®U": N·∫æU M·∫§T USERNAME NH∆ØNG C√íN TOKEN
            if (!username && token) {
                console.warn("‚ö†Ô∏è M·∫•t username, ƒëang th·ª≠ kh√¥i ph·ª•c t·ª´ Token...");
                try {
                    // G·ªçi API /users/me ƒë·ªÉ l·∫•y l·∫°i th√¥ng tin (API n√†y c√≥ trong users.py c·ªßa b·∫°n)
                    const userRes = await fetch('/users/me', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (userRes.ok) {
                        const userData = await userRes.json();
                        username = userData.username; // L·∫•y ƒë∆∞·ª£c t√™n r·ªìi!
                        localStorage.setItem('username', username); // L∆∞u l·∫°i lu√¥n ƒë·ªÉ l·∫ßn sau kh√¥ng ph·∫£i h·ªèi n·ªØa
                        console.log("‚úÖ ƒê√£ kh√¥i ph·ª•c Username th√†nh c√¥ng:", username);
                    }
                } catch (e) {
                    console.error("‚ùå L·ªói kh√¥i ph·ª•c user:", e);
                }
            }

            // 2. KI·ªÇM TRA L·∫¶N CU·ªêI
            if (!username) {
                alert("‚ö†Ô∏è L·ªói: Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                // window.location.href = '/login.html'; // B·ªè comment d√≤ng n√†y n·∫øu mu·ªën ƒë√° v·ªÅ trang login
                return;
            }

            // 3. G·ªåI API MUA H√ÄNG (G·ª≠i ƒë√∫ng c·∫•u tr√∫c main.py y√™u c·∫ßu)
            try {
                const res = await fetch('/api/shop/buy', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // V·∫´n g·ª≠i k√®m token cho ch·∫Øc
                    },
                    body: JSON.stringify({
                        item_id: parseInt(itemId),
                        username: username // ‚úÖ Gi·ªù ch·∫Øc ch·∫Øn bi·∫øn n√†y ƒë√£ c√≥ d·ªØ li·ªáu
                    })
                });

                const result = await res.json();

                // 4. X·ª¨ L√ù K·∫æT QU·∫¢
                if (result.status === 'success') {
                    alert(`‚úÖ ${result.message}`);
                    
                    // C·∫≠p nh·∫≠t s·ªë d∆∞ tr√™n giao di·ªán
                    let walletId = 'shop-wallet-trithuc';
                    if (currencyType === 'vinh_du') walletId = 'shop-wallet-vinhdu';
                    else if (currencyType === 'chien_tich') walletId = 'shop-wallet-chientich';
                    else if (currencyType === 'kpi') walletId = 'shop-wallet-kpi'; // D·ª± ph√≤ng
                    
                    const walletEl = document.getElementById(walletId);
                    if (walletEl && result.new_balance !== undefined) {
                        walletEl.innerText = result.new_balance;
                    }

                    // G·ªçi h√†m c·∫≠p nh·∫≠t Dashboard ch√≠nh (n·∫øu c√≥)
                    if(typeof loadPlayerData === 'function') loadPlayerData();

                } else {
                    alert(`‚ùå TH·∫§T B·∫†I: ${result.message}`);
                }
            } catch (err) {
                console.error("L·ªói mua h√†ng:", err);
                alert("‚ùå L·ªói k·∫øt n·ªëi Server!");
            }
        }
        
        // ============================================================
        // 9. T·ª∞ ƒê·ªòNG T·∫¢I D·ªÆ LI·ªÜU KHI V√ÄO GAME (FIX L·ªñI F5)
        // S·ª± ki·ªán n√†y ch·∫°y ngay khi trang web t·∫£i xong
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üîÑ ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu ng∆∞·ªùi ch∆°i...");

            try {
                // B∆Ø·ªöC 1: T·∫£i danh s√°ch to√†n b·ªô Skill tr∆∞·ªõc (ƒë·ªÉ c√≥ data config, vfx)
                await loadGlobalSkills();

                // B∆Ø·ªöC 2: T·∫£i th√¥ng tin c√° nh√¢n (ƒë·ªÉ bi·∫øt ƒëang trang b·ªã c√°i n√†o)
                await loadMyStatus();

                console.log("‚úÖ Kh·ªüi t·∫°o ho√†n t·∫•t! Trang b·ªã hi·ªán t·∫°i:", myStatus.equipped);
                
                // B∆Ø·ªöC 3 (T√πy ch·ªçn): N·∫øu ƒëang ·ªü trong m√†n h√¨nh th√°p th√¨ c·∫≠p nh·∫≠t icon lu√¥n
                // initCombatSystem(); // N·∫øu b·∫°n c√≥ h√†m n√†y ƒë·ªÉ v·∫Ω icon n√∫t ƒë√°nh
            } catch (error) {
                console.error("‚ùå L·ªói kh·ªüi t·∫°o:", error);
            }
        });

        // --- H√ÄM T·∫¢I DANH S√ÅCH SKILL (FIX 401) ---
        async function loadGlobalSkills() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            
            if (!token) return; // Ch∆∞a ƒëƒÉng nh·∫≠p th√¨ th√¥i

            try {
                const res = await fetch('/api/skills/get-all', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // üëà QUAN TR·ªåNG: Ph·∫£i c√≥ d√≤ng n√†y
                    }
                });

                if (res.ok) {
                    // G√°n v√†o bi·∫øn window ƒë·ªÉ d√πng ·ªü m·ªçi n∆°i
                    window.globalSkillsList = await res.json();
                    console.log("üì¶ ƒê√£ t·∫£i danh s√°ch Skill:", window.globalSkillsList.length);
                } else {
                    console.error("‚ùå L·ªói t·∫£i Global Skills:", res.status);
                }
            } catch (e) {
                console.error("‚ùå L·ªói k·∫øt n·ªëi:", e);
            }
        }

        // --- H√ÄM T·∫¢I TR·∫†NG TH√ÅI NG∆Ø·ªúI CH∆†I (FIX 401) ---
        async function loadMyStatus() {
            // 1. L·∫•y Token t·ª´ kho l∆∞u tr·ªØ
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');

            // N·∫øu kh√¥ng c√≥ ch√¨a kh√≥a th√¨ ƒë·ª´ng g√µ c·ª≠a server l√†m g√¨
            if (!token) {
                console.warn("‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p: Kh√¥ng th·ªÉ t·∫£i MyStatus.");
                return;
            }

            try {
                // 2. G·ª≠i y√™u c·∫ßu K√àM THEO TOKEN
                const res = await fetch('/api/skills/my-status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // üëà ƒê√ÇY L√Ä D√íNG QUAN TR·ªåNG NH·∫§T
                    }
                });

                if (res.ok) {
                    const data = await res.json();
                    
                    // C·∫≠p nh·∫≠t v√†o bi·∫øn to√†n c·ª•c
                    // ƒê·∫£m b·∫£o bi·∫øn myStatus kh√¥ng b·ªã undefined tr∆∞·ªõc khi assign
                    if (typeof myStatus === 'undefined') window.myStatus = {};
                    
                    Object.assign(myStatus, data); 
                    
                    console.log("üë§ ƒê√£ c·∫≠p nh·∫≠t Status th√†nh c√¥ng:", myStatus);
                } else {
                    console.error(`‚ùå L·ªói t·∫£i Status: ${res.status} (C√≥ th·ªÉ do Token h·∫øt h·∫°n)`);
                }
            } catch (error) {
                console.error("‚ùå L·ªói k·∫øt n·ªëi:", error);
            }
        }
        
        // ============================================================
        // üëá H√ÄM M·ªöI: D√°n ƒëo·∫°n n√†y v√†o ƒë·ªÉ s·ª≠a l·ªói ReferenceError üëá
        // ============================================================
        function resetBossCombat() {
            console.log("üõë D·ªçn d·∫πp chi·∫øn tr∆∞·ªùng (Reset Boss Combat)...");
            
            // 1. T·∫Øt Timer ƒë·∫øm ng∆∞·ª£c c√¢u h·ªèi (N·∫øu c√≥ h√†m n√†y)
            if (typeof stopBossTimer === 'function') {
                stopBossTimer(); 
            }
            
            // 2. M·ªü kh√≥a n√∫t b·∫•m (Reset tr·∫°ng th√°i)
            if (typeof bossState !== 'undefined') {
                bossState.isProcessing = false;
            }

            // 3. T·∫Øt v√≤ng l·∫∑p check status (C√°i g√¢y spam log)
            if (window.bossPollInterval) {
                clearInterval(window.bossPollInterval);
                window.bossPollInterval = null;
            }

            // 4. T·∫Øt timer ƒë·∫øm ng∆∞·ª£c h·ªìi sinh (N·∫øu c√≥)
            if (window.deathTimerInterval) {
                clearInterval(window.deathTimerInterval);
                window.deathTimerInterval = null;
            }
        }

        // logic ƒë√°nh boss
        // 1. H√ÄM CHECK TR·∫†NG TH√ÅI BOSS (Ch·∫°y ƒë·ªãnh k·ª≥)
        async function checkBossStatus() {
            // 1. ƒê·ªìng b·ªô d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Window
            if (window.dashboardData && window.dashboardData.stats) {
                dashboardData = window.dashboardData;
            }

            // 2. N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu -> D·ª´ng ngay
            if (!dashboardData || !dashboardData.stats) {
                // console.warn("‚è≥ checkBossStatus: D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng...");
                return; 
            }

            // 3. L·∫•y c√°c ph·∫ßn t·ª≠ giao di·ªán
            const arena = document.getElementById('boss-battle-arena');
            const waitingScreen = document.getElementById('boss-waiting-screen');
            const deathOverlay = document.getElementById('death-screen-overlay');

            try {
                // =========================================================
                // A. X√ÅC ƒê·ªäNH TR·∫†NG TH√ÅI S·ªêNG / CH·∫æT
                // =========================================================
                let currentPlayerHP = dashboardData.stats.hp;
                let currentReviveAt = dashboardData.info ? dashboardData.info.revive_at : null;
                
                let isDead = false;

                // Ch·∫øt khi h·∫øt m√°u
                if (currentPlayerHP <= 0) isDead = true;
                
                // Ho·∫∑c ch·∫øt khi v·∫´n c√≤n th·ªùi gian h·ªìi sinh (Server Time)
                if (currentReviveAt) {
                    const reviveTime = new Date(currentReviveAt).getTime();
                    const now = new Date().getTime();
                    if (reviveTime > now) {
                        isDead = true;
                    }
                }

                // =========================================================
                // B. N·∫æU CH·∫æT -> KH√ìA GIAO DI·ªÜN NGAY L·∫¨P T·ª®C
                // =========================================================
                if (isDead) {
                    console.log("üíÄ CheckBossStatus: PH√ÅT HI·ªÜN T·ª¨ VONG! ReviveAt:", currentReviveAt);

                    // 1. D·ªçn d·∫πp Timer chi·∫øn ƒë·∫•u c≈©
                    if (typeof resetBossCombat === 'function') resetBossCombat();

                    // 2. ·∫®N NGAY L·∫¨P T·ª®C c√°c giao di·ªán ch∆°i game
                    if (arena) arena.classList.add('hidden');
                    if (waitingScreen) waitingScreen.classList.add('hidden');

                    // 3. B·∫¨T NGAY m√†n h√¨nh ƒëen tr√πm l√™n t·∫•t c·∫£ (Quan tr·ªçng!)
                    if (deathOverlay) {
                        deathOverlay.classList.remove('hidden');
                        deathOverlay.classList.add('flex');
                    }

                    // 4. G·ªçi h√†m ƒë·∫øm ng∆∞·ª£c (ƒë·ªÉ ch·∫°y ƒë·ªìng h·ªì)
                    if (typeof showDeathScreen === 'function') {
                        showDeathScreen(currentReviveAt); 
                    }
                    
                    // ‚õî QUAN TR·ªåNG: Return ngay, kh√¥ng cho ph√©p code ch·∫°y xu·ªëng ph·∫ßn t·∫£i Boss
                    return; 
                }

                // =========================================================
                // C. N·∫æU C√íN S·ªêNG -> D·ªåN D·∫∏P M√ÄN H√åNH CH·∫æT
                // =========================================================
                if (deathOverlay) {
                    deathOverlay.classList.add('hidden');
                    deathOverlay.classList.remove('flex');
                }
                // X√≥a interval ƒë·∫øm ng∆∞·ª£c n·∫øu c√≥
                if (window.deathTimerInterval) {
                    clearInterval(window.deathTimerInterval);
                    window.deathTimerInterval = null;
                }

                // =========================================================
                // D. T·∫¢I D·ªÆ LI·ªÜU BOSS (CH·ªà KHI C√íN S·ªêNG M·ªöI CH·∫†Y ƒêO·∫†N N√ÄY)
                // =========================================================
                // console.log("üîç Player c√≤n s·ªëng -> T·∫£i th√¥ng tin Boss...");
                const res = await fetch('/api/boss/active-info');
                if (!res.ok) return; 

                const result = await res.json();

                // üëá 1. QUAN TR·ªåNG: G√°n d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c ngay l·∫≠p t·ª©c
                // ƒê·ªÉ h√†m t·∫•n c√¥ng (checkAnswerAndAttack) c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c ID
                bossData = result; 

                // X·ª≠ l√Ω hi·ªÉn th·ªã Boss
                if (result.has_boss) {
                    if (waitingScreen) waitingScreen.classList.add('hidden');
                    if (arena) arena.classList.remove('hidden');

                    // üëá 2. C·∫≠p nh·∫≠t giao di·ªán (N√≥ s·∫Ω hi·ªán n√∫t B·∫ÆT ƒê·∫¶U theo logic m·ªõi)
                    if (typeof updateBossUI === 'function') {
                        updateBossUI(bossData);
                    }

                    // üõë 3. TUY·ªÜT ƒê·ªêI KH√îNG G·ªåI bossGenerateQuestion() ·ªû ƒê√ÇY
                    // N·∫øu g·ªçi ·ªü ƒë√¢y n√≥ s·∫Ω t·ª± v√†o game lu√¥n -> N√∫t B·∫Øt ƒë·∫ßu th√†nh v√¥ nghƒ©a.
                    // ƒê·ªÉ nguy√™n, ng∆∞·ªùi ch∆°i b·∫•m "B·∫Øt ƒë·∫ßu" th√¨ h√†m startBossBattle() m·ªõi g·ªçi c√¢u h·ªèi.

                } else {
                    // Kh√¥ng c√≥ Boss
                    bossData = null;
                    if (typeof resetBossCombat === 'function') resetBossCombat();
                    if (arena) arena.classList.add('hidden');
                    if (waitingScreen) waitingScreen.classList.remove('hidden');
                }
            } catch (err) {
                console.error("‚ùå L·ªói checkBossStatus:", err);
            }
        }

        // 2. H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN boss (T√°ch ra cho g·ªçn)

        function updateBossUI(boss) {
            // 0. KI·ªÇM TRA T√åNH TR·∫†NG PLAYER
            if (dashboardData && dashboardData.stats && dashboardData.stats.hp <= 0) {
                console.warn("üö´ Player ƒëang ch·∫øt -> H·ªßy updateBossUI");
                return; 
            }

            // 1. KI·ªÇM TRA D·ªÆ LI·ªÜU BOSS
            if (!boss || !boss.id) {
                // N·∫øu kh√¥ng c√≥ boss th√¨ hi·ªán m√†n h√¨nh ch·ªù "Ch∆∞a c√≥ Boss"
                document.getElementById('boss-battle-arena').classList.add('hidden');
                document.getElementById('boss-waiting-screen').classList.remove('hidden');
                return; 
            }

            // N·∫øu c√≥ Boss -> ·∫®n m√†n h√¨nh ch·ªù "Ch∆∞a c√≥ Boss" -> Hi·ªán ƒê·∫•u tr∆∞·ªùng
            document.getElementById('boss-waiting-screen').classList.add('hidden');
            document.getElementById('boss-battle-arena').classList.remove('hidden');

            // --- A. BOSS UI (RENDER TH√îNG TIN BOSS) ---
            const nameEl = document.getElementById('battle-boss-name');
            if (nameEl) nameEl.innerText = (boss.name || "Unknown Boss").toUpperCase();
            
            // HP Boss
            const bossCurrentHP = Number(boss.current_hp) || 0; 
            const bossMaxHP = Number(boss.max_hp) || 5000;
            const hpPercent = (bossCurrentHP / bossMaxHP) * 100;

            const barEl = document.getElementById('battle-boss-hp-bar');
            const textEl = document.getElementById('battle-boss-hp-text');
            
            if (barEl) {
                barEl.style.width = `${hpPercent}%`;
                if (hpPercent > 50) barEl.className = "h-full bg-gradient-to-r from-green-600 via-green-500 to-green-600 transition-all duration-500";
                else if (hpPercent > 20) barEl.className = "h-full bg-gradient-to-r from-yellow-500 via-orange-500 to-yellow-500 transition-all duration-500";
                else barEl.className = "h-full bg-gradient-to-r from-red-600 via-red-500 to-red-600 transition-all duration-500";
            }
            if (textEl) textEl.innerText = `${bossCurrentHP.toLocaleString()} / ${bossMaxHP.toLocaleString()}`;

            // Boss Image & VFX
            const imgEl = document.getElementById('battle-boss-image');
            if (imgEl && boss.image_url) {
                let finalSrc = boss.image_url;
                if (!boss.image_url.startsWith('http')) {
                    finalSrc = boss.image_url.includes('assets/') ? (boss.image_url.startsWith('/') ? boss.image_url : `/${boss.image_url}`) : `/assets/boss/${boss.image_url}`;
                }
                imgEl.src = finalSrc;
                imgEl.className = "h-full w-auto object-contain drop-shadow-[0_0_30px_rgba(255,50,50,0.5)] transition-transform duration-300 z-10 block";
                
                const animType = boss.animation || 'stand';
                if (animType !== 'stand') imgEl.classList.add(`anim-${animType}`);

                // VFX Overlay
                const vfxContainer = document.getElementById('battle-boss-vfx');
                if (vfxContainer) {
                    vfxContainer.className = "vfx-container hidden";
                    vfxContainer.innerHTML = "";
                    const vfxType = (boss.vfx || 'none').toLowerCase().trim();
                    if (vfxType === 'fire') {
                        vfxContainer.classList.remove('hidden');
                        vfxContainer.innerHTML = '<div class="vfx-fire"></div>';
                    } else if (vfxType === 'snow') {
                        vfxContainer.classList.remove('hidden');
                        vfxContainer.innerHTML = '<div class="vfx-snow"></div>';
                    }
                }
            }

            // --- B. PLAYER UI (RENDER TH√îNG TIN NG∆Ø·ªúI CH∆†I) ---
            let pHP = 0;
            let pMaxHP = 100;
            let pATK = 0;

            if (typeof dashboardData !== 'undefined' && dashboardData) {
                if (dashboardData.stats) {
                    pHP = dashboardData.stats.hp || 0;
                    pMaxHP = dashboardData.stats.max_hp || 100; 
                    pATK = dashboardData.stats.atk || 0;
                }
                // Fallback l·∫•y ATK t·ª´ Tri th·ª©c n·∫øu stats ch∆∞a c√≥
                if (pATK === 0 && dashboardData.wallet) {
                    pATK = dashboardData.wallet.tri_thuc || 0;
                }
            }

            const hpPlayerEl = document.getElementById('battle-player-hp');
            const atkPlayerEl = document.getElementById('battle-player-atk');
            
            if (hpPlayerEl) {
                hpPlayerEl.innerText = `${pHP.toLocaleString()} / ${pMaxHP.toLocaleString()}`;
                hpPlayerEl.style.color = (pHP < pMaxHP * 0.3) ? '#ef4444' : '#ffffff'; 
            }
            
            if (atkPlayerEl) {
                atkPlayerEl.innerText = pATK.toLocaleString();
            }

            // --- C. TR·∫†NG TH√ÅI S·∫¢NH CH·ªú (LOBBY) - [ƒêO·∫†N M·ªöI QUAN TR·ªåNG] ---
            // üõë ƒê√£ x√≥a ƒëo·∫°n t·ª± ƒë·ªông startBossTimer ·ªü ƒë√¢y
            
            // 1. Hi·ªán n√∫t "B·∫ÆT ƒê·∫¶U" (S·∫£nh ch·ªù)
            const lobbyUI = document.getElementById('boss-lobby-ui');
            const combatUI = document.getElementById('boss-combat-ui');
            const retreatBtn = document.getElementById('btn-retreat');
            const timerContainer = document.getElementById('battle-timer-container');

            // üëá KI·ªÇM TRA: N·∫øu ƒëang ƒë√°nh tr·∫≠n th√¨ KH√îNG ƒê∆Ø·ª¢C hi·ªán Lobby
            if (bossState.isFighting) {
                // ƒêANG TRONG TR·∫¨N:
                if (lobbyUI) lobbyUI.classList.add('hidden');         // ·∫®n n√∫t B·∫Øt ƒë·∫ßu
                if (combatUI) combatUI.classList.remove('hidden');    // Hi·ªán b√†n c·ªù
                if (retreatBtn) retreatBtn.classList.remove('hidden');// Hi·ªán n√∫t R√∫t lui
                if (timerContainer) timerContainer.classList.remove('hidden');
            } else {
                // ƒêANG ·ªû S·∫¢NH CH·ªú (M·ªõi v√†o ho·∫∑c v·ª´a R√∫t lui):
                if (lobbyUI) lobbyUI.classList.remove('hidden');      // Hi·ªán n√∫t B·∫Øt ƒë·∫ßu
                if (combatUI) combatUI.classList.add('hidden');       // ·∫®n b√†n c·ªù
                if (retreatBtn) retreatBtn.classList.add('hidden');   // ·∫®n n√∫t R√∫t lui
                if (timerContainer) timerContainer.classList.add('hidden');
            }
            
            console.log(`‚úÖ Boss UI Updated (In Combat: ${bossState.isFighting})`);
        }

        // ============================================================
        // C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN TR·∫¨N ƒê·∫§U boss (B·∫ÆT ƒê·∫¶U / R√öT LUI)
        // ============================================================

        // 1. H√ÄM B·∫ÆT ƒê·∫¶U (G·∫Øn v√†o n√∫t B·∫Øt ƒë·∫ßu)
        function startBossBattle() {
            console.log("‚öîÔ∏è Player ƒë√£ b·∫•m B·∫Øt ƒë·∫ßu!");
            bossState.isFighting = true;
            // A. Chuy·ªÉn ƒë·ªïi giao di·ªán
            document.getElementById('boss-lobby-ui').classList.add('hidden');       // ·∫®n n√∫t B·∫Øt ƒë·∫ßu
            document.getElementById('boss-combat-ui').classList.remove('hidden');   // Hi·ªán khung C√¢u h·ªèi
            
            // üëá TH√äM D√íNG N√ÄY: Hi·ªán n√∫t R√∫t lui m·ªõi
            document.getElementById('btn-retreat').classList.remove('hidden');

            const timerContainer = document.getElementById('battle-timer-container');
            if (timerContainer) timerContainer.classList.remove('hidden');          // Hi·ªán ƒê·ªìng h·ªì

            // B. G·ªçi h√†m sinh c√¢u h·ªèi (H√†m c≈© c·ªßa b·∫°n)
            // H√†m n√†y s·∫Ω t·ª± ƒë·ªông g·ªçi ti·∫øp startBossTimer b√™n trong n√≥
            bossGenerateQuestion(); 
        }

        // 2. H√ÄM R√öT LUI (G·∫Øn v√†o n√∫t R√∫t lui)
        function quitBossBattle() {
            if (!confirm("‚ö†Ô∏è R√∫t lui s·∫Ω h·ªßy l∆∞·ª£t ƒë√°nh n√†y v√† tho√°t ra. B·∫°n ch·∫Øc ch·ª©?")) return;
            bossState.isFighting = false;
            console.log("üè≥Ô∏è Player ƒë√£ r√∫t lui.");

            // A. D·ª´ng ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (Quan tr·ªçng)
            // (L∆∞u √Ω: H√£y ƒë·∫£m b·∫£o h√†m ƒë·∫øm gi·ªù c·ªßa b·∫°n g√°n interval v√†o bi·∫øn window.currentBossTimer)
            if (window.currentBossTimer) {
                clearInterval(window.currentBossTimer);
                window.currentBossTimer = null;
            }

            // B. Reset tr·∫°ng th√°i x·ª≠ l√Ω ƒë·ªÉ tr√°nh l·ªói click ƒë√∫p
            if (typeof bossState !== 'undefined') {
                bossState.isProcessing = false;
            }

            // C. Reset giao di·ªán v·ªÅ S·∫£nh ch·ªù (Lobby)
            document.getElementById('boss-combat-ui').classList.add('hidden');
            
            // üëá TH√äM D√íNG N√ÄY: ·∫®n n√∫t R√∫t lui m·ªõi
            document.getElementById('btn-retreat').classList.add('hidden');

            const timerContainer = document.getElementById('battle-timer-container');
            if (timerContainer) timerContainer.classList.add('hidden');

            document.getElementById('boss-lobby-ui').classList.remove('hidden'); // Hi·ªán l·∫°i n√∫t B·∫Øt ƒë·∫ßu
        }

        // --- H√ÄM 1: B·∫ÆT ƒê·∫¶U ƒê·∫æM NG∆Ø·ª¢C (ƒê√£ ƒë·ªìng b·ªô v·ªõi n√∫t R√∫t lui) ---
        function startBossTimer(seconds) {
            // 1. Reset timer c≈© tr∆∞·ªõc khi ch·∫°y c√°i m·ªõi
            stopBossTimer();
            
            let timeLeft = seconds;
            const timerEl = document.getElementById('battle-timer'); 
            
            // H√†m c·∫≠p nh·∫≠t m·ªói gi√¢y
            function updateDisplay() {
                // --- [QUAN TR·ªåNG] KI·ªÇM TRA S·ªêNG CH·∫æT TR∆Ø·ªöC ---
                if (typeof dashboardData !== 'undefined' && dashboardData.stats && dashboardData.stats.hp <= 0) {
                    console.log("üíÄ Ph√°t hi·ªán ƒë√£ ch·∫øt -> H·ªßy Timer.");
                    stopBossTimer();
                    return; 
                }

                // --- X·ª¨ L√ù H·∫æT GI·ªú ---
                if (timeLeft <= 0) {
                    stopBossTimer(); // D·ª´ng ƒë·ªìng h·ªì
                    
                    if (timerEl) timerEl.innerText = "00:00";
                    console.log("‚è∞ H·∫øt gi·ªù! T·ª± ƒë·ªông x·ª≠ l√Ω thua.");
                    
                    // G·ªçi h√†m t·∫•n c√¥ng (Server s·∫Ω x·ª≠ l√Ω tr·ª´ m√°u)
                    checkAnswerAndAttack('TIMEOUT', null); 
                    return;
                }
                
                // --- HI·ªÇN TH·ªä ---
                if (timerEl) {
                    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const s = (timeLeft % 60).toString().padStart(2, '0');
                    timerEl.innerText = `${m}:${s}`;
                    
                    // ƒê·ªïi m√†u ƒë·ªè khi c√≤n d∆∞·ªõi 5 gi√¢y
                    if (timeLeft <= 5) {
                        timerEl.classList.add('text-red-600', 'animate-pulse');
                    } else {
                        timerEl.classList.remove('text-red-600', 'animate-pulse');
                    }
                }
                
                timeLeft--;
            }

            updateDisplay(); // Ch·∫°y ngay l·∫≠p t·ª©c cho gi√¢y ƒë·∫ßu ti√™n
            
            // üëá [S·ª¨A QUAN TR·ªåNG]: G√°n v√†o window ƒë·ªÉ n√∫t 'R√∫t lui' c√≥ th·ªÉ t·∫Øt ƒë∆∞·ª£c
            window.currentBossTimer = setInterval(updateDisplay, 1000); 
        }

        // --- H√ÄM 2: D·ª™NG ƒê·ªíNG H·ªí ---
        function stopBossTimer() {
            // üëá [S·ª¨A QUAN TR·ªåNG]: T√¨m bi·∫øn window ƒë·ªÉ x√≥a
            if (window.currentBossTimer) {
                clearInterval(window.currentBossTimer);
                window.currentBossTimer = null;
            }
            
            // N·∫øu d√πng bi·∫øn c≈© bossState th√¨ x√≥a lu√¥n cho s·∫°ch (ph√≤ng h·ªù)
            if (typeof bossState !== 'undefined' && bossState.timerInterval) {
                clearInterval(bossState.timerInterval);
                bossState.timerInterval = null;
            }
            
            // Reset hi·ªÉn th·ªã
            const timerEl = document.getElementById('battle-timer');
            if (timerEl) {
                timerEl.classList.remove('text-red-600', 'animate-pulse');
                // Kh√¥ng c·∫ßn reset v·ªÅ 00:00 ·ªü ƒë√¢y v√¨ c√≥ th·ªÉ c√¢u sau s·∫Ω load ngay
            }
        }

        // 2. H√†m Render c√¢u h·ªèi Boss (H·ªçc t·∫≠p t·ª´ renderTowerQuestion)
        async function bossGenerateQuestion() {
            // 1. CH·∫∂N N·∫æU ƒêANG CH·∫æT (Quan tr·ªçng)
            if (dashboardData && dashboardData.stats && dashboardData.stats.hp <= 0) {
                console.log("üíÄ ƒêang ch·∫øt, kh√¥ng sinh c√¢u h·ªèi n·ªØa.");
                stopBossTimer();
                return;
            }
            const optionsContainer = document.getElementById('battle-options-container');
            const questionTextEl = document.getElementById('battle-question-text');
            if (!optionsContainer || !questionTextEl) return;

            // A. D·ªåN D·∫∏P
            optionsContainer.innerHTML = ''; 
            bossState.isProcessing = false;

            try {
                const res = await fetch(`/api/boss/get-question?boss_id=${bossData.id}`);
                if (!res.ok) throw new Error("Server Error");
                
                const qData = await res.json();
                bossState.currentQuestion = qData;

                // B. HI·ªÇN TH·ªä N·ªòI DUNG
                questionTextEl.innerText = qData.content;

                // C. RENDER N√öT ƒê√ÅP √ÅN ƒê·ªòNG
                const keys = ['a', 'b', 'c', 'd'];
                keys.forEach(key => {
                    const text = qData.options[key];
                    if (text) {
                        const btn = document.createElement('button');
                        // Style n√∫t b·∫•m (b·∫°n c√≥ th·ªÉ gi·ªØ nguy√™n style n√†y ho·∫∑c style c≈© t√πy √Ω)
                        btn.className = "battle-opt-btn bg-gray-700 hover:bg-amber-700 text-left px-4 py-3 rounded border-l-4 border-gray-500 transition-all active:scale-95 group flex items-center w-full mb-2"; // Th√™m w-full v√† mb-2 cho ƒë·∫πp
                        
                        btn.innerHTML = `
                            <span class="font-bold text-amber-500 mr-2 uppercase group-hover:text-white">${key}.</span>
                            <span class="text-white">${text}</span>
                        `;

                        // G·∫Øn s·ª± ki·ªán click
                        btn.onclick = () => checkAnswerAndAttack(key, btn);
                        optionsContainer.appendChild(btn);
                    }
                });

                // üëá [S·ª¨A L·∫†I] CHUY·ªÇN LOGIC TIMER V√ÄO ƒê√ÇY üëá
                // Ch·ªâ b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c khi m·ªçi th·ª© ƒë√£ t·∫£i xong xu√¥i
                const timeLimit = (bossData && bossData.time_limit) ? bossData.time_limit : 15;
                startBossTimer(timeLimit);

            } catch (err) {
                console.error("L·ªói t·∫£i c√¢u h·ªèi Boss:", err);
                questionTextEl.innerText = "‚ö†Ô∏è Boss ƒëang ni·ªám ch√∫... (L·ªói k·∫øt n·ªëi)";
                
                // N·∫øu l·ªói, ƒë·∫£m b·∫£o kh√¥ng c√≥ timer n√†o ch·∫°y ng·∫ßm
                if (typeof stopBossTimer === 'function') stopBossTimer();
            }
        }

        // 3. H√†m ki·ªÉm tra v√† t·∫•n c√¥ng
        // --- H√ÄM X·ª¨ L√ù TR·∫¢ L·ªúI & T·∫§N C√îNG (PHI√äN B·∫¢N ƒê·ªíNG B·ªò SERVER) ---
        async function checkAnswerAndAttack(selectedKey, btnElement) {
            // -----------------------------------------------------------
            // 1. CH·∫∂N SPAM CLICK & KI·ªÇM TRA ƒê·∫¶U V√ÄO
            // -----------------------------------------------------------
            if (bossState.isProcessing || !bossState.currentQuestion) return;
            bossState.isProcessing = true; // Kh√≥a ngay l·∫≠p t·ª©c

            // D·ª´ng ƒë·ªìng h·ªì ngay ƒë·ªÉ tr√°nh xung ƒë·ªôt
            if (typeof stopBossTimer === 'function') stopBossTimer();

            // -----------------------------------------------------------
            // 2. HI·ªÜU ·ª®NG VISUAL NGAY L·∫¨P T·ª®C (UX)
            // -----------------------------------------------------------
            const correctKey = bossState.currentQuestion.correct_ans;
            if (selectedKey !== 'TIMEOUT') {
                if (selectedKey !== correctKey) {
                    // N√∫t ƒë·ªè (Sai)
                    if (btnElement) {
                        btnElement.classList.remove('bg-white/10', 'border-white/10', 'hover:bg-white/20');
                        btnElement.classList.add('bg-red-900', 'border-red-500', 'text-white');
                    }
                } else {
                    // N√∫t xanh (ƒê√∫ng)
                    if (btnElement) {
                        btnElement.classList.remove('bg-white/10', 'border-white/10', 'hover:bg-white/20');
                        btnElement.classList.add('bg-green-600', 'border-green-400', 'text-white', 'shadow-[0_0_15px_rgba(74,222,128,0.5)]');
                    }
                }
            }

            try {
                // -----------------------------------------------------------
                // 3. CHU·∫®N B·ªä D·ªÆ LI·ªÜU G·ª¨I ƒêI
                // -----------------------------------------------------------
                const username = localStorage.getItem('kpi_username') || "unknown";
                const token = localStorage.getItem('access_token');
                
                // Ki·ªÉm tra bi·∫øn bossData c√≥ t·ªìn t·∫°i kh√¥ng ƒë·ªÉ tr√°nh l·ªói JS
                if (!bossData || !bossData.id) {
                    throw new Error("D·ªØ li·ªáu Boss kh√¥ng h·ª£p l·ªá (Missing ID). Vui l√≤ng t·∫£i l·∫°i trang.");
                }

                // L·∫•y ID ng∆∞·ªùi ch∆°i an to√†n
                let realPlayerId = 0;
                if (typeof dashboardData !== 'undefined' && dashboardData.info && dashboardData.info.id) {
                    realPlayerId = dashboardData.info.id;
                }

                // L·∫•y S√°t th∆∞∆°ng an to√†n
                let realDamage = 0;
                if (typeof dashboardData !== 'undefined' && dashboardData.stats) {
                    realDamage = dashboardData.stats.atk || 10;
                }

                // -----------------------------------------------------------
                // 4. G·ªåI API (C√ì KI·ªÇM TRA M·∫†NG)
                // -----------------------------------------------------------
                console.log("üì¶ D·ªØ li·ªáu chu·∫©n b·ªã g·ª≠i ƒëi:", {
                    boss_id: bossData ? bossData.id : "MISSING (R·ªñNG)", // <--- Soi k·ªπ ch·ªó n√†y
                    question_id: bossState.currentQuestion.id,
                    selected: selectedKey
                });
                
                const res = await fetch('/api/boss/attack', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        boss_id: bossData.id,
                        player_name: username,
                        player_id: realPlayerId,
                        damage: realDamage,
                        question_id: bossState.currentQuestion.id, 
                        selected_option: selectedKey 
                    })
                });

                // üî• B·∫¢O V·ªÜ 1: Ki·ªÉm tra xem Server c√≥ b√°o l·ªói HTTP kh√¥ng (404, 500...)
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`L·ªói Server (${res.status}): ${errText}`);
                }

                const result = await res.json();

                // üî• B·∫¢O V·ªÜ 2: Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ c√≥ b·ªã Null/Undefined kh√¥ng
                if (!result) {
                    throw new Error("Server tr·∫£ v·ªÅ d·ªØ li·ªáu R·ªóng! Ki·ªÉm tra l·∫°i Backend.");
                }

                // -----------------------------------------------------------
                // 5. X·ª¨ L√ù K·∫æT QU·∫¢ T·ª™ SERVER
                // -----------------------------------------------------------

                // --- TR∆Ø·ªúNG H·ª¢P A: NG∆Ø·ªúI CH∆†I ƒê√É CH·∫æT (GAME OVER) ---
                if (result.is_dead_player) {
                    // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
                    if (dashboardData && dashboardData.stats) {
                        dashboardData.stats.hp = 0;
                    }

                    // C·∫≠p nh·∫≠t giao di·ªán v·ªÅ 0
                    if (typeof updatePlayerHPUI === 'function') {
                        updatePlayerHPUI(0, dashboardData.stats.max_hp);
                    }
                    
                    // G·ªçi m√†n h√¨nh x·ª≠ l√Ω ch·∫øt
                    if (typeof handleGameOver === 'function') {
                        handleGameOver(result.message, result.revive_at);
                    } else {
                        alert("üíÄ B·∫†N ƒê√É CH·∫æT! (Vui l√≤ng F5 ƒë·ªÉ h·ªìi sinh)");
                        window.location.reload();
                    }
                    
                    return; // ‚õî D·ª™NG LU√îN
                }

                // --- TR∆Ø·ªúNG H·ª¢P B: TR·∫¢ L·ªúI SAI (B·ªã Boss ƒë√°nh & M·∫•t m√°u) ---
                    if (result.success === false && result.correct === false) {
                        
                        // 1. Logic tr·ª´ m√°u & Hi·ªÉn th·ªã popup damage (GI·ªÆ NGUY√äN CODE C·ª¶A B·∫†N)
                        let damageTaken = 0;
                        if (dashboardData && dashboardData.stats && result.player_hp !== undefined) {
                            damageTaken = dashboardData.stats.hp - result.player_hp;
                        }
                        if (damageTaken <= 0) damageTaken = result.damage_dealt || 50; 

                        if (typeof showDamagePopup === 'function') {
                            showDamagePopup('hero-image', damageTaken, 'text-red-600');
                        }

                        // C·∫≠p nh·∫≠t HP UI (GI·ªÆ NGUY√äN)
                        if (result.player_hp !== undefined) {
                            if (dashboardData && dashboardData.stats) dashboardData.stats.hp = result.player_hp;
                            if (typeof updatePlayerHPUI === 'function') updatePlayerHPUI(result.player_hp, dashboardData.stats.max_hp);
                            const arena = document.getElementById('boss-battle-arena');
                            if (arena) { arena.classList.add('bg-red-900/50'); setTimeout(() => arena.classList.remove('bg-red-900/50'), 300); }
                            const heroImg = document.getElementById('hero-image');
                            if (heroImg) { heroImg.classList.add('animate-shake'); setTimeout(() => heroImg.classList.remove('animate-shake'), 300); }
                        }

                        // ============================================================
                        // üëá [ƒê√É S·ª¨A] LOGIC L·∫§Y N·ªòI DUNG ƒê√ÅP √ÅN TH√îNG MINH H∆†N üëá
                        // ============================================================
                        const currentQ = bossState.currentQuestion;
                        
                        // 1. L·∫•y key ƒë√°p √°n (V√≠ d·ª•: "c")
                        // D·ªØ li·ªáu c·ªßa b·∫°n d√πng 'correct_ans'
                        let rawKey = String(currentQ.correct_ans || currentQ.correct || "").trim().toLowerCase();
                        
                        // 2. L·∫•y n·ªôi dung text t·ª´ 'options'
                        // D·ªØ li·ªáu c·ªßa b·∫°n: options: {a: '...', b: '...', c: 'C√°'}
                        let correctContent = "";
                        
                        if (currentQ.options && currentQ.options[rawKey]) {
                            correctContent = currentQ.options[rawKey]; // L·∫•y ƒë∆∞·ª£c ch·ªØ "C√°"
                        } 
                        // D·ª± ph√≤ng: N·∫øu sau n√†y ƒë·ªïi c·∫•u tr√∫c sang 'answers' ho·∫∑c 'ph·∫≥ng'
                        else if (currentQ.answers && currentQ.answers[rawKey]) {
                            correctContent = currentQ.answers[rawKey];
                        }
                        else if (currentQ[rawKey]) {
                            correctContent = currentQ[rawKey];
                        }

                        // 3. Gh√©p chu·ªói hi·ªÉn th·ªã
                        // K·∫øt qu·∫£: "C. C√°"
                        let fullCorrectText = "";
                        if (correctContent) {
                            fullCorrectText = `${rawKey.toUpperCase()}. ${correctContent}`;
                        } else {
                            // Fallback n·∫øu l·ªói
                            fullCorrectText = `ƒê√°p √°n: ${rawKey.toUpperCase()}`;
                        }

                        // 4. L·∫•y gi·∫£i th√≠ch (D·ªØ li·ªáu c·ªßa b·∫°n d√πng 'explanation')
                        // Code c≈© d√πng 'explain' -> Ta l·∫•y c·∫£ 2 cho ch·∫Øc
                        let explainText = currentQ.explanation || currentQ.explain;
                        
                        if (!explainText || explainText.trim() === "") {
                             explainText = "Ki·∫øn th·ª©c n√†y r·∫•t th√∫ v·ªã, h√£y ghi nh·ªõ nh√©!";
                        }

                        // 5. G·ªçi Popup
                        if (typeof showBossFeedback === 'function') {
                            showBossFeedback(false, explainText, fullCorrectText);
                        } else {
                            alert(`Sai r·ªìi!\n\n‚úÖ ${fullCorrectText}\n\nüí° ${explainText}`);
                            handleNextTurnLogic();
                        }

                        return;
                    }

                // --- TR∆Ø·ªúNG H·ª¢P C: TR·∫¢ L·ªúI ƒê√öNG (T·∫•n c√¥ng Boss) ---
                if (result.success) {
                    // 1. Popup s√°t th∆∞∆°ng bay l√™n
                    if (typeof showDamagePopup === 'function') {
                        showDamagePopup('battle-boss-image', result.damage, 'text-yellow-400');
                    }
                    
                    // 2. Rung ·∫£nh Boss
                    const img = document.getElementById('battle-boss-image');
                    if (img) { 
                        img.classList.add('boss-hit-effect'); 
                        setTimeout(() => img.classList.remove('boss-hit-effect'), 200); 
                    }

                    // 3. C·∫≠p nh·∫≠t thanh m√°u Boss UI
                    if (result.boss_hp !== undefined) {
                        bossData.current_hp = result.boss_hp;
                        updateBossUI(bossData);
                    }

                    // 4. KI·ªÇM TRA BOSS CH·∫æT
                    if (result.is_dead) {
                        // Hi·ªán th√¥ng b√°o chi·∫øn th·∫Øng t·ª´ Server
                        alert(result.message || "üéâ BOSS ƒê√É B·ªä TI√äU DI·ªÜT!");
                        
                        // RELOAD TRANG ƒë·ªÉ nh·∫≠n ti·ªÅn v√† item m·ªõi
                        window.location.reload(); 

                    } else {
                        // Boss ch∆∞a ch·∫øt -> C√¢u ti·∫øp theo
                        setTimeout(() => {
                            bossState.isProcessing = false;
                            bossGenerateQuestion(); 
                        }, 1000);
                    }
                }

            } catch (err) {
                // üî• B·∫¢O V·ªÜ 3: Catch l·ªói to√†n c·ª•c ƒë·ªÉ kh√¥ng treo game
                console.error("üö® L·ªñI T·∫§N C√îNG:", err);
                alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi: " + err.message);
                
                // M·ªü kh√≥a ƒë·ªÉ ng∆∞·ªùi ch∆°i th·ª≠ l·∫°i
                bossState.isProcessing = false;
                
                // N·∫øu n√∫t ƒëang ƒë·ªè/xanh th√¨ reset l·∫°i m√†u cho n√∫t ƒë√≥
                if (btnElement) {
                    btnElement.classList.remove('bg-red-900', 'border-red-500', 'bg-green-600', 'border-green-400');
                    btnElement.classList.add('bg-white/10', 'border-white/10');
                }
            }
        }

        // --- H√ÄM C·∫¨P NH·∫¨T UI THANH M√ÅU (D√πng s·ªë li·ªáu t·ª´ Server) ---
        function updatePlayerHPUI(currentHP, maxHP) {
            // C·∫≠p nh·∫≠t bi·∫øn d·ªØ li·ªáu c·ª•c b·ªô ƒë·ªÉ ƒë·ªìng b·ªô
            if (dashboardData && dashboardData.stats) {
                dashboardData.stats.hp = currentHP;
            }
            
            const hpText = document.getElementById('battle-player-hp');
            if (hpText) {
                // Format s·ªë ƒë·∫πp (VD: 1,200 / 2,000)
                hpText.innerText = `${currentHP.toLocaleString()} / ${maxHP.toLocaleString()}`;
                
                // ƒê·ªïi m√†u ƒë·ªè n·∫øu m√°u < 30%
                if (currentHP < (maxHP * 0.3)) {
                    hpText.style.color = '#ef4444'; // ƒê·ªè
                    hpText.style.textShadow = '0 0 5px red';
                } else {
                    hpText.style.color = '#ffffff'; // Tr·∫Øng
                    hpText.style.textShadow = 'none';
                }
            }
        }

        // --- H√ÄM CHUY·ªÇN L∆Ø·ª¢T (ƒê∆∞·ª£c g·ªçi khi ƒë√≥ng Popup gi·∫£i th√≠ch) ---
        function handleNextTurnLogic() {
            // 1. M·ªü kh√≥a ƒë·ªÉ b·∫•m ti·∫øp
            bossState.isProcessing = false;

            // 2. Reset m√†u c√°c n√∫t b·∫•m v·ªÅ m·∫∑c ƒë·ªãnh
            const buttons = document.querySelectorAll('.answer-btn'); // Class n√∫t tr·∫£ l·ªùi c·ªßa b·∫°n
            buttons.forEach(btn => {
                btn.classList.remove('bg-red-900', 'border-red-500', 'bg-green-600', 'border-green-400', 'text-white', 'shadow-[0_0_15px_rgba(74,222,128,0.5)]');
                btn.classList.add('bg-white/10', 'border-white/10', 'hover:bg-white/20'); // Class m·∫∑c ƒë·ªãnh
            });

            // 3. Ki·ªÉm tra xem c√≤n s·ªëng kh√¥ng
            let currentHp = 0;
            if (typeof dashboardData !== 'undefined' && dashboardData.stats) {
                currentHp = dashboardData.stats.hp;
            }

            if (currentHp > 0) {
                // N·∫øu c√≤n s·ªëng -> T·∫°o c√¢u h·ªèi m·ªõi
                bossGenerateQuestion();
            } else {
                // N·∫øu ch·∫øt -> ƒê√£ c√≥ logic x·ª≠ l√Ω ch·∫øt ·ªü ch·ªó kh√°c lo
                console.log("üíÄ HP = 0, d·ª´ng tr·∫≠n ƒë·∫•u.");
            }
        }

        // --- H√ÄM X·ª¨ L√ù GAME OVER (CH·∫æT & CH·ªú H·ªíI SINH) ---
        function handleGameOver(serverMessage, reviveAtVal) {
            // 1. D·ª™NG NGAY M·ªåI HO·∫†T ƒê·ªòNG
            stopBossTimer();
            bossState.isProcessing = true; // Kh√≥a kh√¥ng cho b·∫•m n√∫t n·ªØa

            // 2. C·∫≠p nh·∫≠t bi·∫øn d·ªØ li·ªáu c·ª•c b·ªô v·ªÅ 0 ngay l·∫≠p t·ª©c (Quan tr·ªçng ƒë·ªÉ l·∫ßn sau click tab kh√¥ng b·ªã l·ªói)
            if (typeof dashboardData !== 'undefined' && dashboardData.stats) {
                dashboardData.stats.hp = 0;
                // N·∫øu server c√≥ g·ª≠i th·ªùi gian h·ªìi sinh th√¨ l∆∞u l·∫°i lu√¥n
                if (reviveAtVal) dashboardData.info.revive_at = reviveAtVal;
            }

            // 3. ·∫®n Arena, ·∫®n Waiting
            const arena = document.getElementById('boss-battle-arena');
            const waiting = document.getElementById('boss-waiting-screen');
            if (arena) arena.classList.add('hidden');
            if (waiting) waiting.classList.add('hidden');

            // 4. G·ªçi m√†n h√¨nh ƒëen ƒë·∫øm ng∆∞·ª£c
            // N·∫øu ch∆∞a c√≥ th·ªùi gian reviveAt, t·ª± c·ªông 30 ph√∫t gi·∫£ ƒë·ªãnh ƒë·ªÉ hi·ªÉn th·ªã cho m∆∞·ª£t
            let reviveTimeStr = reviveAtVal;
            if (!reviveTimeStr) {
                const future = new Date();
                future.setMinutes(future.getMinutes() + 30);
                reviveTimeStr = future.toISOString();
            }
            
            // G·ªçi h√†m hi·ªÉn th·ªã m√†n h√¨nh ch·∫øt (H√†m showDeathScreen b·∫°n ƒë√£ th√™m ·ªü b∆∞·ªõc tr∆∞·ªõc)
            showDeathScreen(reviveTimeStr);
            
            // 5. Th√¥ng b√°o nh·∫π (Optional)
            // alert(serverMessage || "üíÄ B·∫†N ƒê√É G·ª§C NG√É!"); 
        }

        // --- H√ÄM HI·ªÇN TH·ªä GIAO DI·ªÜN CH·∫æT (ƒê·∫æM NG∆Ø·ª¢C) ---
        // --- H√ÄM X·ª¨ L√ù KHI NG∆Ø·ªúI D√ôNG B·∫§M "QUAY L·∫†I CHI·∫æN ƒê·∫§U" ---
        async function handleReviveConfirm() {
            const btn = document.getElementById('btn-revive-confirm');
            if (btn) {
                btn.innerText = "‚è≥ ƒêang h·ªìi ph·ª•c...";
                btn.disabled = true;
            }

            // 1. T·∫£i l·∫°i d·ªØ li·ªáu t·ª´ Server (L√∫c n√†y h·∫øt gi·ªù ph·∫°t -> Server s·∫Ω tr·∫£ v·ªÅ HP ƒë·∫ßy)
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData(); 
            }

            // 2. G·ªçi h√†m checkBossStatus ƒë·ªÉ n√≥ t·ª± nh·∫≠n di·ªán l√† "ƒê√£ s·ªëng l·∫°i" 
            // -> N√≥ s·∫Ω t·ª± ·∫©n Death Overlay v√† hi·ªán l·∫°i Boss Arena
            if (typeof checkBossStatus === 'function') {
                await checkBossStatus();
            }

            // 3. X√≥a timer auto reload (n·∫øu c√≥)
            if (window.autoReloadTimeout) clearTimeout(window.autoReloadTimeout);
        }

        // --- H√ÄM HI·ªÇN TH·ªä GIAO DI·ªÜN CH·∫æT (ƒê·∫æM NG∆Ø·ª¢C) ---
        function showDeathScreen(reviveAtString) {
            // 1. D·ªçn d·∫πp combat c≈©
            if (typeof resetBossCombat === 'function') resetBossCombat();

            const parentContainer = document.getElementById('main-view-boss');
            if (!parentContainer) return;
            
            // X√≥a m√†n h√¨nh ch·∫øt c≈© n·∫øu c√≥
            const oldScreen = document.getElementById('death-screen-overlay');
            if (oldScreen) oldScreen.remove();

            // T·∫°o m√†n h√¨nh m·ªõi
            const deathScreen = document.createElement('div');
            deathScreen.id = 'death-screen-overlay';
            deathScreen.className = "absolute inset-0 z-[60] flex flex-col items-center justify-center bg-gray-900/95 text-center animate-fadeIn p-4";
            parentContainer.appendChild(deathScreen);

            // T√≠nh to√°n th·ªùi gian
            let targetTime = 0;
            if (reviveAtString) {
                targetTime = new Date(reviveAtString).getTime();
            } else {
                targetTime = new Date().getTime() + 30 * 60 * 1000; // Fallback 30p
            }

            function updateTimer() {
                const now = new Date().getTime();
                const distance = targetTime - now;

                // --- TR∆Ø·ªúNG H·ª¢P A: ƒê√É H·ªíI SINH (H·∫æT GI·ªú) ---
                if (distance <= 0) {
                    deathScreen.innerHTML = `
                        <div class="text-6xl mb-4 animate-bounce">‚ú®</div>
                        <h3 class="text-2xl font-bold text-green-400 mb-2">ƒê√É H·ªíI PH·ª§C!</h3>
                        <p class="text-gray-300 mb-6">S·ª©c m·∫°nh c·ªßa b·∫°n ƒë√£ tr·ªü l·∫°i.</p>
                        
                        <button id="btn-revive-confirm" onclick="handleReviveConfirm()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-green-900/50 transition transform hover:scale-105 cursor-pointer">
                            QUAY L·∫†I CHI·∫æN ƒê·∫§U
                        </button>
                    `;
                    
                    // T·∫Øt timer ƒë·∫øm ng∆∞·ª£c hi·ªÉn th·ªã
                    if (window.deathTimerInterval) clearInterval(window.deathTimerInterval);
                    
                    // T·ª± ƒë·ªông b·∫•m n√∫t sau 3 gi√¢y (Thay v√¨ reload trang)
                    if (window.autoReloadTimeout) clearTimeout(window.autoReloadTimeout);
                    window.autoReloadTimeout = setTimeout(handleReviveConfirm, 3000);
                    return;
                }

                // --- TR∆Ø·ªúNG H·ª¢P B: ƒêANG ƒê·∫æM NG∆Ø·ª¢C ---
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const hStr = hours > 0 ? `${hours.toString().padStart(2, '0')}:` : '';
                const mStr = minutes.toString().padStart(2, '0');
                const sStr = seconds.toString().padStart(2, '0');

                deathScreen.innerHTML = `
                    <div class="text-6xl mb-4 animate-pulse">üíÄ</div>
                    <h2 class="text-4xl font-black text-red-600 mb-2 tracking-widest uppercase drop-shadow-lg">T·ª¨ N·∫†N</h2>
                    <div class="bg-black/60 px-10 py-6 rounded-xl border border-red-900/50 mb-8 shadow-2xl">
                        <span class="text-gray-500 text-xs uppercase tracking-wider block mb-2">H·ªìi sinh sau</span>
                        <span class="text-5xl font-mono font-bold text-white tracking-widest">
                            ${hStr}${mStr}:${sStr}
                        </span>
                    </div>
                    
                    <button onclick="switchMainScreen('dashboard')" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition">
                        V·ªÅ Trang Ch·ªß
                    </button>
                `;
            }

            updateTimer();
            
            if (window.deathTimerInterval) clearInterval(window.deathTimerInterval);
            window.deathTimerInterval = setInterval(updateTimer, 1000);
        }

        // --- H√ÄM HI·ªÜN POPUP GI·∫¢I TH√çCH ---
        function showBossFeedback(isCorrect, explainText) {
            const overlay = document.getElementById('boss-feedback-overlay');
            const iconEl = document.getElementById('boss-feedback-icon');
            const titleEl = document.getElementById('boss-feedback-title');
            const explainEl = document.getElementById('boss-feedback-explain');
            const correctBox = document.getElementById('boss-feedback-correct-box');
            const correctTextEl = document.getElementById('boss-feedback-correct-text');
            if (!overlay) return;

            if (isCorrect) {
                // Tr∆∞·ªùng h·ª£p ƒë√∫ng (Th∆∞·ªùng th√¨ ƒë√°nh lu√¥n, √≠t khi hi·ªán popup, nh∆∞ng c·ª© l√†m d·ª± ph√≤ng)
                iconEl.innerText = "‚öîÔ∏è";
                titleEl.innerText = "T·∫§N C√îNG TH√ÄNH C√îNG!";
                titleEl.className = "text-2xl font-bold text-green-500 mb-4 uppercase tracking-widest font-game";
            } else {
                // Tr∆∞·ªùng h·ª£p SAI
                iconEl.innerText = "üõ°Ô∏è"; // Ho·∫∑c ‚ùå
                titleEl.innerText = "Tr·∫£ l·ªùi sai, b·∫°n b·ªã Boss t·∫•n c√¥ng!";
                titleEl.className = "text-2xl font-bold text-red-500 mb-4 uppercase tracking-widest font-game";
            }

            // ƒêi·ªÅn n·ªôi dung gi·∫£i th√≠ch
            // N·∫øu kh√¥ng c√≥ explain trong DB th√¨ hi·ªán ƒë√°p √°n ƒë√∫ng
            explainEl.innerText = explainText || "Kh√¥ng c√≥ gi·∫£i th√≠ch chi ti·∫øt cho c√¢u n√†y.";

            // Hi·ªán Popup
            overlay.classList.remove('hidden');
        }

        // --- H√ÄM ƒê√ìNG POPUP ---
        function closeBossFeedback() {
            const overlay = document.getElementById('boss-feedback-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            
            // üî• QUAN TR·ªåNG: Sau khi ƒë√≥ng popup m·ªõi chuy·ªÉn c√¢u h·ªèi ho·∫∑c ƒë·ªÉ Boss ƒë√°nh
            // G·ªçi h√†m chuy·ªÉn l∆∞·ª£t t·∫°i ƒë√¢y (t√πy v√†o logic game c·ªßa b·∫°n ƒëang vi·∫øt)
            // V√≠ d·ª•: triggerBossAttack() ho·∫∑c nextQuestion();
            handleNextTurnLogic(); 
        }
        // --- H√ÄM 2: X·ª¨ L√ù KHI PLAYER B·ªä TH∆Ø∆†NG (ƒê√É FIX L·ªñI) ---
        function handlePlayerTakeDamage(amount) {
            // 1. Ki·ªÉm tra bi·∫øn dashboardData c√≥ t·ªìn t·∫°i kh√¥ng
            if (typeof dashboardData !== 'undefined' && dashboardData.stats) {
                
                // 2. L·∫•y d·ªØ li·ªáu an to√†n (D√πng || 0 ƒë·ªÉ tr√°nh l·ªói undefined)
                let currentHP = dashboardData.stats.hp || 0;
                
                // 3. T√¨m Max HP (Th·ª≠ c·∫£ 2 tr∆∞·ªùng h·ª£p t√™n bi·∫øn)
                // Backend c√≥ th·ªÉ tr·∫£ v·ªÅ 'max_hp' ho·∫∑c 'hp_max', ta l·∫•y c√°i n√†o c√≥ gi√° tr·ªã
                let maxHP = dashboardData.stats.max_hp || dashboardData.stats.hp_max || 100;

                // 4. Tr·ª´ m√°u logic
                currentHP -= amount;
                if (currentHP < 0) currentHP = 0;
                
                // L∆∞u ng∆∞·ª£c l·∫°i v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ l·∫ßn sau tr·ª´ ti·∫øp
                dashboardData.stats.hp = currentHP;
                
                // 5. C·∫≠p nh·∫≠t UI (Ch·ªâ ch·∫°y khi ƒë√£ c√≥ s·ªë li·ªáu chu·∫©n)
                const hpText = document.getElementById('battle-player-hp');
                if (hpText) {
                    // .toLocaleString() ch·ªâ ch·∫°y an to√†n v√¨ maxHP m·∫∑c ƒë·ªãnh l√† 100 (s·ªë)
                    hpText.innerText = `${currentHP.toLocaleString()} / ${maxHP.toLocaleString()}`;
                    
                    // ƒê·ªïi m√†u ƒë·ªè n·∫øu m√°u th·∫•p
                    hpText.style.color = currentHP < (maxHP * 0.3) ? '#ef4444' : '#ffffff';
                }
                
                // Hi·ªáu ·ª©ng m√†n h√¨nh ch·ªõp ƒë·ªè
                const arena = document.getElementById('boss-battle-arena');
                if (arena) {
                    arena.classList.add('bg-red-900/50');
                    setTimeout(() => arena.classList.remove('bg-red-900/50'), 300);
                }
            } else {
                console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y dashboardData, kh√¥ng th·ªÉ tr·ª´ m√°u Player.");
            }
        }
        // --- KH·ªûI CH·∫†Y H·ªÜ TH·ªêNG BOSS (ƒê√É N√ÇNG C·∫§P) ---

        // 1. Ch·∫°y ngay khi load trang ƒë·ªÉ l·∫•y d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
        checkBossStatus();
        
        // --- LOGIC ƒê·ªîI M·∫¨T KH·∫®U ---

        function openChangePassModal() {
            // Reset √¥ nh·∫≠p li·ªáu cho tr·ªëng
            document.getElementById('cp-old').value = '';
            document.getElementById('cp-new').value = '';
            // Hi·ªán modal
            document.getElementById('changePassModal').classList.remove('hidden');
        }

        async function submitChangePass() {
            const oldPass = document.getElementById('cp-old').value;
            const newPass = document.getElementById('cp-new').value;
            const token = localStorage.getItem("access_token");

            if (!oldPass || !newPass) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u!");
                return;
            }

            // Hi·ªáu ·ª©ng n√∫t b·∫•m ƒëang x·ª≠ l√Ω
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        old_password: oldPass,
                        new_password: newPass
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + data.message);
                    document.getElementById('changePassModal').classList.add('hidden');
                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Kh√¥ng th√†nh c√¥ng"));
                }
            } catch (e) {
                console.error(e);
                alert("‚ùå L·ªói k·∫øt n·ªëi Server!");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 1. H√†m t·∫£i danh s√°ch h·ªçc sinh t·ª± do
        async function loadFreeAgents() {
            console.log("üîÑ ƒêang t·∫£i danh s√°ch h·ªçc sinh t·ª± do..."); // Debug log
            const listContainer = document.getElementById('free-agent-list');
            
            // Ki·ªÉm tra xem c√≥ c√°i khung hi·ªÉn th·ªã ch∆∞a
            if (!listContainer) {
                console.error("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y th·∫ª div c√≥ id='free-agent-list'. H√£y ki·ªÉm tra l·∫°i ph·∫ßn HTML!");
                return;
            }

            const token = localStorage.getItem('access_token');
            
            // Reset giao di·ªán tr∆∞·ªõc khi t·∫£i
            selectedStudentIds.clear();
            if(document.getElementById('selected-count')) document.getElementById('selected-count').innerText = "0";
            
            listContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400"><i class="fas fa-spinner fa-spin mb-2"></i><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div>';

            try {
                // G·ªçi API (ƒê∆∞·ªùng d·∫´n n√†y ph·∫£i kh·ªõp v·ªõi backend routes/admin.py ho·∫∑c routes/user.py c·ªßa b·∫°n)
                // N·∫øu b·∫°n ƒë·ªÉ ·ªü routes/user.py th√¨ th∆∞·ªùng l√† /api/user/players/free-agents
                // N·∫øu b·∫°n ƒë·ªÉ ·ªü routes/admin.py th√¨ l√† /api/admin/players/free-agents (nh∆∞ng U1 ko g·ªçi dc admin)
                // üëâ H√£y th·ª≠ ƒë∆∞·ªùng d·∫´n ph·ªï bi·∫øn nh·∫•t:
                const res = await fetch('/api/user/players/free-agents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("Server tr·∫£ v·ªÅ l·ªói: " + res.status);
                
                const students = await res.json();
                listContainer.innerHTML = ''; // X√≥a loading

                if (students.length === 0) {
                    listContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="fas fa-check-circle text-4xl mb-2 text-green-200"></i>
                            <p>Kh√¥ng c√≥ h·ªçc sinh n√†o c·∫ßn v√†o t·ªï!</p>
                        </div>`;
                    return;
                }

                // V·∫Ω danh s√°ch ra m√†n h√¨nh
                students.forEach(st => {
                    const row = document.createElement('div');
                    row.className = "flex items-center p-3 hover:bg-amber-50 cursor-pointer transition-colors group border-b border-gray-100 last:border-0";
                    row.onclick = (e) => toggleStudentSelection(st.id, row);
                    
                    row.innerHTML = `
                        <div class="mr-4">
                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center bg-white transition-colors checkbox-indicator" id="check-${st.id}">
                                <i class="fas fa-check text-white text-xs opacity-0"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-gray-800 group-hover:text-amber-800">${st.full_name}</div>
                            <div class="text-xs text-gray-500">@${st.username}</div>
                        </div>
                        <span class="text-xs text-amber-600 bg-amber-100 px-2 py-1 rounded-full font-bold">T·ª± do</span>
                    `;
                    listContainer.appendChild(row);
                });

            } catch (err) {
                console.error(err);
                listContainer.innerHTML = '<p class="text-red-500 text-center p-4">L·ªói k·∫øt n·ªëi! H√£y ki·ªÉm tra Console (F12).</p>';
            }
        }

        // 2. H√†m ch·ªçn/b·ªè ch·ªçn
        function toggleStudentSelection(id, rowElement) {
            const checkbox = rowElement.querySelector(`#check-${id}`);
            const checkIcon = checkbox.querySelector('i');

            if (selectedStudentIds.has(id)) {
                // B·ªè ch·ªçn
                selectedStudentIds.delete(id);
                checkbox.classList.remove('bg-blue-500', 'border-blue-500');
                checkbox.classList.add('bg-white', 'border-gray-300');
                checkIcon.classList.add('opacity-0');
                rowElement.classList.remove('bg-blue-50');
            } else {
                // Ch·ªçn
                selectedStudentIds.add(id);
                checkbox.classList.remove('bg-white', 'border-gray-300');
                checkbox.classList.add('bg-blue-500', 'border-blue-500');
                checkIcon.classList.remove('opacity-0');
                rowElement.classList.add('bg-blue-50');
            }
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
            document.getElementById('selected-count').innerText = selectedStudentIds.size;
        }

        // 3. H√†m G·ª≠i danh s√°ch (Submit)
        async function submitRecruitMembers() {
            if (selectedStudentIds.size === 0) {
                alert("‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn h·ªçc sinh n√†o!");
                return;
            }

            if (!confirm(`X√ÅC NH·∫¨N:\nB·∫°n mu·ªën th√™m ${selectedStudentIds.size} th√†nh vi√™n v√†o t·ªï?\n\nL∆∞u √Ω: B·∫°n kh√¥ng th·ªÉ t·ª± x√≥a h·ªç sau khi th√™m!`)) {
                return;
            }

            const token = localStorage.getItem('access_token');
            
            try {
                // G·ªçi API th√™m th√†nh vi√™n
                const res = await fetch('/api/user/team/add-members', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        player_ids: Array.from(selectedStudentIds)
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ Th√†nh c√¥ng: " + data.message);
                    loadFreeAgents();
                    loadTeamMembers(); // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ c·∫≠p nh·∫≠t
                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ th√™m th√†nh vi√™n"));
                }

            } catch (err) {
                alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server!");
            }
        }

        // --- LOGIC HI·ªÇN TH·ªä DANH S√ÅCH T·ªî (ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn U1) ---

        async function loadTeamMembers() {
            const tableBody = document.getElementById('team-members-list');
            const token = localStorage.getItem('access_token');
            
            // 1. L·∫•y role c·ªßa ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
            // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o l√∫c Login b·∫°n ƒë√£ l∆∞u user_info v√†o localStorage
            const userInfoStr = localStorage.getItem('user_info');
            const userInfo = userInfoStr ? JSON.parse(userInfoStr) : {};
            const myRole = userInfo.role || 'U3'; // M·∫∑c ƒë·ªãnh l√† U3 n·∫øu l·ªói

            // 2. X·ª≠ l√Ω hi·ªÉn th·ªã C·ªôt Ti√™u ƒê·ªÅ (Header)
            const actionHeader = document.getElementById('th-action');
            if (actionHeader) {
                if (myRole === 'U1') {
                    actionHeader.classList.remove('hidden'); // Hi·ªán c·ªôt n·∫øu l√† U1
                } else {
                    actionHeader.classList.add('hidden');    // ·∫®n c·ªôt n·∫øu l√† U2, U3
                }
            }
            
            try {
                const res = await fetch('/api/user/team/members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("L·ªói t·∫£i danh s√°ch t·ªï");
                
                const data = await res.json();
                
                // C·∫≠p nh·∫≠t th√¥ng tin chung
                if(document.getElementById('team-id-display')) document.getElementById('team-id-display').innerText = data.team_id;
                if(document.getElementById('team-total-kpi')) document.getElementById('team-total-kpi').innerText = data.total_kpi;

                tableBody.innerHTML = '';
                
                if (data.members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="py-6 text-center text-gray-400">Ch∆∞a c√≥ th√†nh vi√™n n√†o</td></tr>';
                    return;
                }

                // S·∫Øp x·∫øp
                data.members.sort((a, b) => {
                    if (a.role === 'U1') return -1;
                    if (b.role === 'U1') return 1;
                    return b.kpi - a.kpi;
                });

                data.members.forEach(mem => {
                    let roleBadge = '';
                    let rowClass = 'hover:bg-gray-50 transition-colors';
                    let actionBtn = ''; 

                    // Logic hi·ªÉn th·ªã Badge
                    if (mem.role === 'U1') {
                        roleBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-300 font-bold text-xs"><i class="fas fa-crown mr-1"></i> T·ªï Tr∆∞·ªüng</span>';
                        rowClass = 'bg-yellow-50/50 hover:bg-yellow-50'; 
                        actionBtn = '<span class="text-gray-300 text-xs italic">--</span>';
                    } 
                    else if (mem.role === 'U2') {
                        roleBadge = '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-300 font-bold text-xs"><i class="fas fa-star mr-1"></i> T·ªï Ph√≥</span>';
                        actionBtn = `<button onclick="promoteMember(${mem.id}, '${mem.full_name}')" class="text-xs bg-orange-100 text-orange-700 border border-orange-300 px-3 py-1 rounded hover:bg-orange-200 transition font-bold"><i class="fas fa-arrow-down mr-1"></i> B√£i nhi·ªám</button>`;
                    } 
                    else { 
                        roleBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200 text-xs">Th√†nh Vi√™n</span>';
                        actionBtn = `<button onclick="promoteMember(${mem.id}, '${mem.full_name}')" class="text-xs bg-blue-100 text-blue-700 border border-blue-300 px-3 py-1 rounded hover:bg-blue-200 transition font-bold"><i class="fas fa-arrow-up mr-1"></i> B·ªï nhi·ªám</button>`;
                    }

                    // üëá QUAN TR·ªåNG: ·∫®n/Hi·ªán √¥ ch·ª©a n√∫t b·∫•m d·ª±a theo Role ng∆∞·ªùi xem
                    // N·∫øu m√¨nh l√† U1 -> class r·ªóng (hi·ªán). N·∫øu kh√¥ng -> class hidden (·∫©n)
                    const actionCellClass = (myRole === 'U1') ? 'text-center' : 'text-center hidden';

                    const tr = document.createElement('tr');
                    tr.className = rowClass;
                    tr.innerHTML = `
                        <td class="py-3 px-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-200 border border-gray-300 flex items-center justify-center overflow-hidden">
                                    <i class="fas fa-user ${mem.role === 'U1' ? 'text-yellow-600' : (mem.role === 'U2' ? 'text-blue-500' : 'text-gray-400')}"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${mem.full_name}</div>
                                    <div class="text-xs text-gray-500">@${mem.username}</div>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-6 text-center">${roleBadge}</td>
                        <td class="py-3 px-6 text-center font-bold text-gray-600">Lv.${mem.level}</td>
                        <td class="py-3 px-6 text-right">
                            <span class="font-rpg font-bold text-lg text-blue-600">${mem.kpi}</span>
                        </td>
                        
                        <td class="py-3 px-6 ${actionCellClass}">
                            ${actionBtn}
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

            } catch (err) {
                console.error(err);
                tableBody.innerHTML = '<tr><td colspan="5" class="py-6 text-center text-red-500">L·ªói k·∫øt n·ªëi!</td></tr>';
            }
        }
        // --- H√ÄM B·ªî NHI·ªÜM / B√ÉI NHI·ªÜM ---
        async function promoteMember(targetId, targetName) {
            const token = localStorage.getItem('access_token');
            
            // H·ªèi l·∫°i cho ch·∫Øc
            if (!confirm(`B·∫°n c√≥ mu·ªën thay ƒë·ªïi ch·ª©c v·ª• c·ªßa th√†nh vi√™n: ${targetName}?`)) {
                return;
            }

            try {
                const res = await fetch('/api/user/team/promote', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ target_id: targetId })
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + data.message);
                    loadTeamMembers(); // T·∫£i l·∫°i b·∫£ng ƒë·ªÉ th·∫•y ch·ª©c v·ª• m·ªõi
                } else {
                    alert("‚ùå L·ªói: " + data.detail);
                }
            } catch (err) {
                console.error(err);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }
        // --- LOGIC NH·∫¨P ƒêI·ªÇM & K·ª∂ LU·∫¨T ---
        // 1. Load danh s√°ch h·ªçc sinh v√†o Dropdown
        async function loadGradingStudents() {
            const select = document.getElementById('grading-student-select');
            const token = localStorage.getItem('access_token');
            
            // X√≥a c≈©
            select.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';

            try {
                // T·∫≠n d·ª•ng API l·∫•y danh s√°ch t·ªï ƒë√£ vi·∫øt l√∫c n√£y
                const res = await fetch('/api/user/team/members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                select.innerHTML = ''; // Clear loading
                
                if (!data.members || data.members.length === 0) {
                    select.innerHTML = '<option value="">B·∫°n ch∆∞a c√≥ th√†nh vi√™n n√†o</option>';
                    return;
                }

                // L·ªçc b·ªè b·∫£n th√¢n (T·ªï tr∆∞·ªüng kh√¥ng t·ª± ch·∫•m ƒëi·ªÉm m√¨nh - Tu·ª≥ logic tr∆∞·ªùng b·∫°n)
                // N·∫øu mu·ªën t·ª± ch·∫•m th√¨ b·ªè d√≤ng filter n√†y ƒëi
                // const members = data.members.filter(m => m.role !== 'U1'); 
                
                data.members.forEach(mem => {
                    const option = document.createElement('option');
                    option.value = mem.id;
                    option.text = `${mem.full_name} (@${mem.username})`;
                    option.dataset.name = mem.full_name; // L∆∞u t√™n ƒë·ªÉ hi·ªán l√™n popup
                    select.appendChild(option);
                });

            } catch (err) {
                console.error(err);
                select.innerHTML = '<option value="">L·ªói t·∫£i danh s√°ch</option>';
            }
        }

        // 2. Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi confirm
        let pendingScoreData = null;

        // 3. H√†m chu·∫©n b·ªã (Pre-submit) - Hi·ªán Popup
        function preSubmitScore(category) {
            const studentSelect = document.getElementById('grading-student-select');
            const studentId = studentSelect.value;
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.dataset.name;

            if (!studentId) {
                alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn h·ªçc sinh tr∆∞·ªõc!");
                return;
            }

            let payload = { target_player_id: parseInt(studentId), category: category };
            let displayType = "";
            let displayValue = "";
            let displayColor = "";

            if (category === 'academic') {
                const type = document.getElementById('score-type').value;
                const val = parseFloat(document.getElementById('score-value').value);
                
                if (isNaN(val)) {
                    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒëi·ªÉm s·ªë h·ª£p l·ªá!");
                    return;
                }

                // Mapping t√™n lo·∫°i ƒëi·ªÉm
                const typeNames = {
                    'speech': 'Ph√°t bi·ªÉu', 'tx': 'Ki·ªÉm tra TX', 
                    'product': 'S·∫£n ph·∫©m', 'hk': 'Thi H·ªçc K·ª≥'
                };

                payload.score_type = type;
                payload.value = val;
                
                displayType = `ƒêi·ªÉm C·ªông (${typeNames[type]})`;
                displayValue = `+${val}`;
                displayColor = "text-green-600";

            } else if (category === 'violation') {
                const selectVio = document.getElementById('violation-reason');
                const reasonText = selectVio.options[selectVio.selectedIndex].text;
                const penalty = parseInt(selectVio.value);

                payload.reason = reasonText;
                payload.penalty = penalty;

                displayType = "Vi Ph·∫°m K·ª∑ Lu·∫≠t";
                displayValue = `${penalty}`; // ƒê√£ l√† s·ªë √¢m
                displayColor = "text-red-600";
            }

            // L∆∞u v√†o bi·∫øn t·∫°m
            pendingScoreData = payload;

            // ƒêi·ªÅn th√¥ng tin v√†o Modal
            document.getElementById('confirm-student-name').innerText = studentName;
            document.getElementById('confirm-type').innerText = displayType;
            
            const valEl = document.getElementById('confirm-value');
            valEl.innerText = displayValue;
            valEl.className = `font-bold text-4xl ${displayColor}`;

            // Hi·ªán Modal
            document.getElementById('confirm-score-modal').classList.remove('hidden');
        }

        // 4. H√†m ƒë√≥ng Modal
        function closeConfirmModal() {
            document.getElementById('confirm-score-modal').classList.add('hidden');
            pendingScoreData = null;
        }

        // 5. H√†m G·ª≠i Th·∫≠t (Sau khi b·∫•m "T√¥i ch·∫Øc ch·∫Øn")
        document.getElementById('btn-confirm-submit').addEventListener('click', async () => {
            if (!pendingScoreData) return;

            const token = localStorage.getItem('access_token');
            const btn = document.getElementById('btn-confirm-submit');
            const originalText = btn.innerText;
            
            // Loading state
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            try {
                let url = "";
                let body = {};

                if (pendingScoreData.category === 'academic') {
                    url = "/api/user/team/submit-score";
                    body = {
                        target_player_id: pendingScoreData.target_player_id,
                        score_type: pendingScoreData.score_type,
                        value: pendingScoreData.value
                    };
                } else {
                    url = "/api/user/team/submit-violation";
                    body = {
                        target_player_id: pendingScoreData.target_player_id,
                        reason: pendingScoreData.reason,
                        penalty: pendingScoreData.penalty
                    };
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + data.message);
                    closeConfirmModal();
                    // Reset form input
                    document.getElementById('score-value').value = ''; 
                } else {
                    alert("‚ùå L·ªói: " + data.detail);
                    closeConfirmModal();
                }

            } catch (err) {
                console.error(err);
                alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server!");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- H√ÄM T·∫¢I L·ªäCH S·ª¨ NH·∫¨P ƒêI·ªÇM ---
        async function loadActivityLogs() {
            const list = document.getElementById('activity-log');
            // Ki·ªÉm tra xem khung hi·ªÉn th·ªã c√≥ t·ªìn t·∫°i kh√¥ng
            if (!list) return;

            const token = localStorage.getItem('access_token');

            try {
                const res = await fetch('/api/user/logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) return; // N·∫øu l·ªói th√¨ b·ªè qua lu√¥n

                const logs = await res.json();
                list.innerHTML = ''; // X√≥a d√≤ng "ƒêang t·∫£i..."

                if (logs.length === 0) {
                    list.innerHTML = '<li class="text-gray-400 text-sm text-center italic py-4">Ch∆∞a c√≥ ghi nh·∫≠n ƒëi·ªÉm s·ªë n√†o.</li>';
                    return;
                }

                logs.forEach(log => {
                    // 1. X·ª≠ l√Ω th·ªùi gian (Chuy·ªÉn sang gi·ªù Vi·ªát Nam)
                    const date = new Date(log.created_at + "Z"); // Th√™m Z ƒë·ªÉ tr√¨nh duy·ªát hi·ªÉu l√† UTC
                    const timeStr = date.toLocaleString('vi-VN', { 
                        hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' 
                    });

                    // 2. X·ª≠ l√Ω m√†u s·∫Øc v√† icon
                    let icon = '';
                    let colorClass = '';
                    let bgClass = '';
                    let valDisplay = '';

                    if (log.category === 'academic') {
                        icon = '<i class="fas fa-plus-circle text-green-500"></i>';
                        colorClass = 'text-green-700';
                        bgClass = 'bg-green-50 border-green-100';
                        valDisplay = `+${log.value_change}`;
                    } else {
                        icon = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                        colorClass = 'text-red-700';
                        bgClass = 'bg-red-50 border-red-100';
                        valDisplay = `${log.value_change}`;
                    }

                    // 3. T·∫°o d√≤ng HTML
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-lg border shadow-sm flex justify-between items-start ${bgClass} animate-fade-in`;
                    li.innerHTML = `
                        <div>
                            <div class="font-bold text-sm ${colorClass}">
                                ${icon} ${log.description} 
                                <span class="font-black ml-1 text-lg">(${valDisplay})</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                <span class="font-bold text-amber-700 bg-amber-100 px-1 rounded">${log.sender_name}</span>
                                <i class="fas fa-caret-right text-gray-400"></i>
                                <span>${log.target_name}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-400 font-mono font-bold mt-1 bg-white px-1 rounded border border-gray-200">
                            ${timeStr}
                        </div>
                    `;
                    list.appendChild(li);
                });

            } catch (err) {
                console.error("L·ªói t·∫£i log:", err);
                list.innerHTML = '<li class="text-red-400 text-sm text-center">L·ªói k·∫øt n·ªëi server</li>';
            }
        }


        // --- H√ÄM b·∫£o tr√¨ ---
        async function checkMaintenanceIngame() {
            try {
                // 1. Ki·ªÉm tra xem ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p c√≥ ph·∫£i Admin kh√¥ng
                // (L·∫•y info t·ª´ localStorage m√† l√∫c login ta ƒë√£ l∆∞u)
                const userInfoStr = localStorage.getItem('user_info');
                if (userInfoStr) {
                    const user = JSON.parse(userInfoStr);
                    // N·∫øu role l√† 'admin' ho·∫∑c 'U1' (t√πy quy ƒë·ªãnh c·ªßa b·∫°n) th√¨ KH√îNG CH·∫∂N
                    // ·ªû ƒë√¢y ta gi·∫£ s·ª≠ role admin l√† "admin" trong DB
                    if (user.role === 'admin') return; 
                }

                // 2. G·ªçi API ki·ªÉm tra
                const res = await fetch('/api/data/maintenance-status');
                const data = await res.json();

                if (data.is_maintenance) {
                    document.body.innerHTML = `
                        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:99999;">
                            <i class="fas fa-exclamation-triangle" style="font-size:5rem; color:#ef4444; margin-bottom:20px; animation: bounce 1s infinite;"></i>
                            <h1 style="font-size:3rem; font-weight:bold;">B·∫¢O TR√å M√ÅY CH·ª¶</h1>
                            <p style="font-size:1.5rem; margin-top:20px; color:#9ca3af;">${data.message}</p>
                            <button onclick="window.location.reload()" style="margin-top:30px; padding:10px 20px; background:#2563eb; border:none; color:white; border-radius:5px; cursor:pointer;">
                                Ki·ªÉm tra l·∫°i
                            </button>
                        </div>
                    `;
                }
            } catch (err) {
                console.log("Server error check");
            }
        }

        // Ch·∫°y ki·ªÉm tra m·ªói 30 gi√¢y (ƒë·ªÉ n·∫øu ƒëang ch∆°i m√† Admin b·∫≠t b·∫£o tr√¨ th√¨ b·ªã kick ra lu√¥n)
        checkMaintenanceIngame();
        setInterval(checkMaintenanceIngame, 30000);

        // n√∫t ·∫©n menu sidebar
        function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const btn = document.getElementById('toggle-btn');
        
        // B·∫≠t/T·∫Øt class ·∫©n
        sidebar.classList.toggle('hidden-sidebar');
        
        // Tailwind c√≥ class 'hidden' v√† 'md:flex' g√¢y xung ƒë·ªôt
        // N√™n ta c·∫ßn x·ª≠ l√Ω th√™m: N·∫øu ƒëang ·∫©n -> X√≥a class 'hidden' v√† 'md:flex' c·ªßa Tailwind ƒëi ƒë·ªÉ CSS custom ho·∫°t ƒë·ªông
        if (sidebar.classList.contains('hidden-sidebar')) {
            // ƒêang ·∫®N
            btn.innerText = "Hi·ªán Menu";
            btn.style.backgroundColor = "#28a745"; // M√†u xanh
            
            // T·∫°m th·ªùi x√≥a class flex c·ªßa tailwind ƒë·ªÉ tr√°nh xung ƒë·ªôt layout
            sidebar.classList.remove('md:flex', 'flex'); 
        } else {
            // ƒêang HI·ªÜN
            btn.innerText = "·∫®n Menu";
            btn.style.backgroundColor = "#b45f06"; // M√†u cam
            
            // Tr·∫£ l·∫°i class cho Tailwind
            sidebar.classList.add('md:flex', 'flex');
        }
    }


        // 2. Thi·∫øt l·∫≠p v√≤ng l·∫∑p th√¥ng minh (Smart Polling)
        // D√πng bi·∫øn window ƒë·ªÉ ƒë·∫£m b·∫£o qu·∫£n l√Ω to√†n c·ª•c
        if (window.bossPollInterval) clearInterval(window.bossPollInterval);

        window.bossPollInterval = setInterval(() => {
            // üëá [QUAN TR·ªåNG] B∆Ø·ªöC 1: KI·ªÇM TRA D·ªÆ LI·ªÜU C√ì T·ªíN T·∫†I KH√îNG?
            // N·∫øu dashboardData l√† null (m·ªõi F5 ch∆∞a t·∫£i xong) HO·∫∂C ch∆∞a c√≥ stats
            // TH√å D·ª™NG NGAY, kh√¥ng ch·∫°y ti·∫øp ƒë·ªÉ tr√°nh l·ªói "Reading stats of null"
            if (!dashboardData || !dashboardData.stats) {
                return; 
            }

            // A. Ki·ªÉm tra xem c√≥ ƒëang m·ªü Tab Boss kh√¥ng?
            const bossTab = document.getElementById('main-view-boss');
            const isBossTabVisible = bossTab && !bossTab.classList.contains('hidden');

            // B. Ki·ªÉm tra xem Player c√≤n s·ªëng kh√¥ng?
            // (L√∫c n√†y dashboardData ch·∫Øc ch·∫Øn ƒë√£ c√≥, n√™n g·ªçi .stats.hp kh√¥ng b·ªã l·ªói n·ªØa)
            let isAlive = dashboardData.stats.hp > 0;

            // üëâ CH·ªà G·ªåI CHECK KHI: ƒêang m·ªü Tab Boss V√Ä C√≤n s·ªëng
            if (isBossTabVisible && isAlive) {
                checkBossStatus();
            } 
        }, 5000); // 5 gi√¢y check 1 l·∫ßn

        window.onload = async function() {
            console.log("üöÄ App start...");

            // 1. C·ªîNG B·∫¢O V·ªÜ: Ki·ªÉm tra Token
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            if (!token) {
                console.warn("‚ö†Ô∏è Ch∆∞a c√≥ Token. Chuy·ªÉn h∆∞·ªõng...");
                window.location.href = 'index.html'; // ƒê∆∞a v·ªÅ trang ch·ªß ƒëƒÉng nh·∫≠p
                return;
            }

            try {
                // --- üëá THAY ƒê·ªîI QUAN TR·ªåNG NH·∫§T T·∫†I ƒê√ÇY üëá ---
                
                // B∆Ø·ªöC 1: T·∫£i "T·ª´ ƒëi·ªÉn Skill" (Global Skills) TR∆Ø·ªöC TI√äN
                // Ph·∫£i c√≥ cu·ªën t·ª´ ƒëi·ªÉn n√†y tr∆∞·ªõc th√¨ t√≠ n·ªØa game m·ªõi bi·∫øt ID "TH·∫¶N_KI·∫æM" l√† chi√™u g√¨
                if (typeof loadGlobalSkills === 'function') {
                    console.log("üìö ƒêang t·∫£i danh s√°ch Skill...");
                    await loadGlobalSkills(); 
                    // D√≤ng await n√†y ƒë·∫£m b·∫£o t·∫£i xong 100% m·ªõi ch·∫°y ti·∫øp d√≤ng d∆∞·ªõi
                }

                // B∆Ø·ªöC 2: T·∫£i th√¥ng tin Nh√¢n v·∫≠t (Dashboard)
                // L√∫c n√†y Dashboard t·∫£i v·ªÅ th·∫•y ID "TH·∫¶N_KI·∫æM" l√† tra ƒë∆∞·ª£c ngay trong danh s√°ch ·ªü B∆∞·ªõc 1
                if (typeof loadDashboardData === 'function') {
                    console.log("üë§ ƒêang t·∫£i d·ªØ li·ªáu nh√¢n v·∫≠t...");
                    await loadDashboardData(); 
                }

                // B∆Ø·ªöC 3: T·∫£i c√°c status ph·ª• (n·∫øu c√≥)
                if (typeof loadMyStatus === 'function') {
                    await loadMyStatus();
                }
                
                // üëá B∆Ø·ªöC 4: T·∫¢I L·ªäCH S·ª¨ NH·∫¨P ƒêI·ªÇM (Th√™m ƒëo·∫°n n√†y v√†o ƒë√¢y) üëá
                if (typeof loadActivityLogs === 'function') {
                    console.log("üìú ƒêang t·∫£i l·ªãch s·ª≠ ho·∫°t ƒë·ªông...");
                    loadActivityLogs();
                }

                console.log("‚úÖ KH·ªûI ƒê·ªòNG HO√ÄN T·∫§T! S·∫µn s√†ng chi·∫øn ƒë·∫•u.");

            } catch (error) {
                console.error("‚ùå L·ªói kh·ªüi ƒë·ªông ·ª©ng d·ª•ng:", error);
                alert("L·ªói t·∫£i d·ªØ li·ªáu game: " + error.message);
            }
        };
    </script>

    <div id="class-modal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-50 backdrop-blur-xl transition-all duration-700">
        <div class="bg-[url('/assets/bg_paper.jpg')] bg-cover bg-amber-50 w-full max-w-5xl p-6 md:p-12 rounded-3xl border-4 border-amber-900/40 shadow-[0_0_100px_rgba(251,191,36,0.1)] relative overflow-hidden mx-4">
            
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-amber-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -right-24 w-64 h-64 bg-red-500/10 rounded-full blur-3xl"></div>

            <div class="relative z-10 mb-12 text-center">
                <h2 class="text-5xl md:text-7xl font-black text-amber-950 mb-4 font-cinzel tracking-tighter drop-shadow-md">
                    TH·ª®C T·ªàNH S·ª®C M·∫†NH
                </h2>
                <div class="flex items-center justify-center gap-6">
                    <div class="h-[1px] w-24 bg-gradient-to-r from-transparent to-amber-800"></div>
                    <p class="text-amber-900 font-serif text-lg md:text-xl italic tracking-widest uppercase">Ch·ªçn Con ƒê∆∞·ªùng C·ªßa B·∫°n</p>
                    <div class="h-[1px] w-24 bg-gradient-to-l from-transparent to-amber-800"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
                
                <div onclick="selectClass('WARRIOR')" 
                    class="group cursor-pointer relative bg-zinc-950 rounded-2xl overflow-hidden border-2 border-amber-900/30 hover:border-red-600 transition-all duration-500 hover:shadow-[0_0_40px_rgba(220,38,38,0.3)] transform hover:-translate-y-3">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-950 via-zinc-950/40 to-transparent z-10"></div>
                    
                    <img src="frontend/assets/character/warrior.png" 
                        class="w-full h-80 object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-1000" alt="Warrior">
                    
                    <div class="absolute bottom-0 left-0 right-0 p-8 z-20">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-4xl font-bold text-white font-cinzel tracking-wider group-hover:text-red-500 transition-colors">CHI·∫æN BINH</h3>
                            <div class="p-2 bg-red-600/20 rounded-lg border border-red-600/40">
                                <i class="fas fa-shield-alt text-red-500 text-2xl"></i>
                            </div>
                        </div>
                        <p class="text-red-200/70 text-sm mb-6 font-light leading-relaxed italic border-l-2 border-red-600 pl-4">
                            "Khi k·ª∑ lu·∫≠t tr·ªü th√†nh b·∫£n nƒÉng, s·ª©c m·∫°nh s·∫Ω tr·ªü th√†nh b·∫•t t·ª≠."
                        </p>
                        
                        <div class="flex items-center gap-4 py-2 px-4 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                            <span class="text-[10px] font-bold uppercase text-gray-400">Ch·ªâ s·ªë ch√≠nh:</span>
                            <span class="text-red-500 font-bold text-sm tracking-widest">SINH M·ªÜNH (HP++)</span>
                        </div>
                    </div>
                </div>

                <div onclick="selectClass('MAGE')" 
                    class="group cursor-pointer relative bg-zinc-950 rounded-2xl overflow-hidden border-2 border-amber-900/30 hover:border-cyan-500 transition-all duration-500 hover:shadow-[0_0_40px_rgba(6,182,212,0.3)] transform hover:-translate-y-3">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-950 via-zinc-950/40 to-transparent z-10"></div>
                    
                    <img src="frontend/assets/character/mage.png" 
                        class="w-full h-80 object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-1000" alt="Mage">
                    
                    <div class="absolute bottom-0 left-0 right-0 p-8 z-20">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-4xl font-bold text-white font-cinzel tracking-wider group-hover:text-cyan-400 transition-colors">PH√ÅP S∆Ø</h3>
                            <div class="p-2 bg-cyan-600/20 rounded-lg border border-cyan-600/40">
                                <i class="fas fa-magic text-cyan-400 text-2xl"></i>
                            </div>
                        </div>
                        <p class="text-cyan-200/70 text-sm mb-6 font-light leading-relaxed italic border-l-2 border-cyan-500 pl-4">
                            "Tri th·ª©c l√† ch√¨a kh√≥a m·ªü ra c√°nh c·ªïng c·ªßa nh·ªØng quy·ªÅn nƒÉng c·∫•m ƒëo√°n."
                        </p>
                        
                        <div class="flex items-center gap-4 py-2 px-4 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                            <span class="text-[10px] font-bold uppercase text-gray-400">Ch·ªâ s·ªë ch√≠nh:</span>
                            <span class="text-cyan-400 font-bold text-sm tracking-widest">S√ÅT TH∆Ø∆†NG (ATK++)</span>
                        </div>
                    </div>
                </div>

            </div>

            <p class="text-center text-amber-900/40 text-xs mt-12 font-bold tracking-[0.3em] uppercase transition-opacity group-hover:opacity-100">
                ‚Äî Quy·∫øt ƒë·ªãnh c·ªßa b·∫°n s·∫Ω kh√¥ng th·ªÉ thay ƒë·ªïi ‚Äî
            </p>
        </div>
    </div>


    <div id="sellModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 border-2 border-amber-500">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üí∞ Ni√™m Y·∫øt Gi√° B√°n</h3>
            
            <div class="mb-4 text-center">
                <img id="sell-item-img" src="" class="w-16 h-16 object-contain mx-auto border border-gray-200 rounded p-1">
                <p id="sell-item-name" class="font-bold mt-2 text-amber-700"></p>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-bold text-gray-700">S·ªë l∆∞·ª£ng b√°n:</label>
                    <input type="number" id="sell-amount" value="1" min="1" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Gi√° b√°n (T·ªïng):</label>
                    <input type="number" id="sell-price" value="10" min="0" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Lo·∫°i ti·ªÅn mu·ªën nh·∫≠n:</label>
                    <select id="sell-currency" class="w-full border p-2 rounded bg-gray-50">
                        <option value="tri_thuc">üü° Tri Th·ª©c (V√†ng)</option>
                        <option value="chien_tich">üî¥ Chi·∫øn T√≠ch (Ruby)</option>
                        <option value="vinh_du">üîµ Vinh D·ª± (Badge)</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('sellModal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">H·ªßy</button>
                <button onclick="confirmSellItem()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold">ƒêƒÉng B√°n</button>
            </div>
        </div>
    </div>

    <div id="boss-feedback-overlay" class="hidden fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-gray-900 border-2 border-amber-600 rounded-xl p-6 max-w-md w-full text-center shadow-[0_0_50px_rgba(245,158,11,0.3)] relative">
            
            <div id="boss-feedback-icon" class="text-6xl mb-4 animate-bounce">‚ùå</div>
            <h2 id="boss-feedback-title" class="text-2xl font-bold text-red-500 mb-4 uppercase tracking-widest font-game">
                BOSS T·∫§N C√îNG!
            </h2>
            <div id="boss-feedback-correct-box" class="bg-green-900/40 border border-green-500 p-3 rounded-lg mb-2 w-full text-left hidden">
                <p class="text-green-400 text-xs font-bold mb-1 uppercase">‚úÖ ƒê√°p √°n ƒë√∫ng:</p>
                <p id="boss-feedback-correct-text" class="text-white font-bold text-lg leading-tight">
                    </p>
            </div>
            <div class="bg-black/40 border border-gray-600 p-3 rounded-lg mb-6 w-full text-left overflow-y-auto max-h-[150px] custom-scrollbar">
                <p class="text-gray-400 text-xs font-bold mb-1 uppercase">üí° Ki·∫øn th·ª©c:</p>
                <p id="boss-feedback-explain" class="text-amber-100 font-serif text-base leading-relaxed pl-2 border-l-2 border-amber-600">
                    </p>
            </div>

            <button onclick="closeBossFeedback()" class="w-full bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-white font-bold py-3 rounded-lg uppercase tracking-wider transition-all transform hover:scale-105 border border-amber-400 shadow-lg">
                ƒê√£ hi·ªÉu, chi·∫øn ti·∫øp!
            </button>
        </div>
    </div>

    <div id="changePassModal" class="hidden fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-amber-600/50 p-6 rounded-xl w-80 shadow-[0_0_20px_rgba(245,158,11,0.2)]">
            
            <h3 class="text-xl font-bold text-white mb-4 text-center fantasy-font tracking-wider">
                üîê B·∫£o M·∫≠t
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 font-bold ml-1 uppercase">M·∫≠t kh·∫©u c≈©</label>
                    <input type="password" id="cp-old" 
                        class="w-full bg-gray-900 text-white p-2.5 rounded border border-gray-600 focus:border-amber-500 outline-none transition font-mono"
                        placeholder="********">
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 font-bold ml-1 uppercase">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="cp-new" 
                        class="w-full bg-gray-900 text-white p-2.5 rounded border border-gray-600 focus:border-amber-500 outline-none transition font-mono"
                        placeholder="********">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="document.getElementById('changePassModal').classList.add('hidden')" 
                        class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-2 rounded font-bold transition text-sm">
                    Quay l·∫°i
                </button>
                <button onclick="submitChangePass()" 
                        class="bg-amber-600 hover:bg-amber-500 text-white py-2 rounded font-bold shadow-lg transition text-sm">
                    X√°c Nh·∫≠n
                </button>
            </div>
        </div>
    </div>

    

    <div id="vfx-container" class="vfx-container hidden"></div>

</body>
</html>