<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Kingdom - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/skills.css">
    <link rel="icon" href="data:,">
    <style>
        /* Hi·ªáu ·ª©ng chuy·ªÉn tab m∆∞·ª£t m√† */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Style cho thanh cu·ªôn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Toggle Switch Animation */
        input:checked ~ .dot {
            transform: translateX(100%);
            background-color: #f97316; /* M√†u cam */
        }
        input:checked ~ .block {
            background-color: #374151;
        }

        /* Hi·ªáu ·ª©ng Boss th·ªü (Breathe) */
        .anim-breathe { animation: breathe 3s ease-in-out infinite; }
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* Hi·ªáu ·ª©ng Boss bay (Float) */
        .anim-float { animation: float 4s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Hi·ªáu ·ª©ng Boss rung l·∫Øc (Shake) */
        .anim-shake { animation: shake 0.3s infinite; }
        @keyframes shake {
            0% { transform: translate(0,0); }
            25% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, -2px); }
            75% { transform: translate(2px, -2px); }
        }

        /* --- H·ªÜ TH·ªêNG VFX (L·ª¨A & TUY·∫æT) --- */
        #vfx-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 30; 
            pointer-events: none;
        }
        .vfx-particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 31;
        }

        /* Hi·ªáu ·ª©ng L·ª≠a */
        .fire-particle {
            background: radial-gradient(circle, #ffca28, #ff5722);
            box-shadow: 0 0 8px #ff5722;
            bottom: -10px;
            animation: vfx-rise linear forwards;
        }

        /* Hi·ªáu ·ª©ng Tuy·∫øt */
        .snow-particle {
            background: white;
            bottom: auto;
            top: -10px;
            animation: vfx-fall linear forwards;
        }

        @keyframes vfx-rise {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-250px) scale(0); opacity: 0; }
        }

        @keyframes vfx-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(280px) rotate(360deg); opacity: 0; }
        }

        /* --- HI·ªÜU ·ª®NG SSR: PADDING CHI·∫æN THU·∫¨T --- */
        @keyframes spin-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ssr-active {
            position: relative !important;
            overflow: hidden !important;
            z-index: 0 !important;
            
            /* 1. T·∫°o kho·∫£ng h·ªü 4px ƒë·ªÉ √°nh s√°ng l·ªçt qua */
            padding: 4px !important; 
            
            /* 2. Bo g√≥c m·ªÅm m·∫°i */
            border-radius: 0.75rem !important; 
            
            /* 3. B√≥ng ƒë·ªï t√≠m ƒë·ªÉ t·∫°o h√†o quang */
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.8) !important;
            
            /* X√≥a border c≈© */
            border: none !important;
        }

        /* L·ªöP √ÅNH S√ÅNG XOAY (N·∫±m d∆∞·ªõi c√πng) */
        .ssr-active::before {
            content: '' !important;
            position: absolute !important;
            z-index: -1 !important; /* Ch√¨m xu·ªëng d∆∞·ªõi */
            
            /* K√≠ch th∆∞·ªõc l·ªõn g·∫•p ƒë√¥i ƒë·ªÉ ph·ªß k√≠n khi xoay */
            left: -50% !important; 
            top: -50% !important;
            width: 200% !important; 
            height: 200% !important;
            
            /* M√†u ƒë√®n Led: ƒêen -> T√≠m -> TR·∫ÆNG S√ÅNG */
            background: conic-gradient(
                transparent, 
                transparent, 
                transparent, 
                #9333ea, 
                #ffffff 
            ) !important;
            
            animation: spin-border 2.5s linear infinite !important;
        }

        /* =========================================
        MAGIC EFFECT PACK (OVERLAY VERSION)
        ========================================= */

        /* 1. L·ª¨A (FIRE) */
        @keyframes fire-anim {
            0% { box-shadow: inset 0 -10px 30px rgba(255, 69, 0, 0.5); }
            50% { box-shadow: inset 0 -30px 50px rgba(255, 140, 0, 0.8); }
            100% { box-shadow: inset 0 -10px 30px rgba(255, 69, 0, 0.5); }
        }
        .effect-fire {
            /* ƒê·ªï b√≥ng ƒë·ªè r·ª±c t·ª´ d∆∞·ªõi ƒë√°y l√™n */
            animation: fire-anim 2s infinite;
            border-bottom: 4px solid #ff4500;
        }

        /* 2. TUY·∫æT (SNOW) */
        @keyframes snow-anim {
            0% { background-position: 0 0; }
            100% { background-position: 50px 100px; } /* Tuy·∫øt r∆°i xu·ªëng */
        }
        .effect-snow {
            background-image: radial-gradient(white 2px, transparent 2px), radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px, 30px 30px;
            animation: snow-anim 3s linear infinite;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.4);
        }

        /* 3. S·∫§M S√âT (LIGHTNING) */
        @keyframes flash-anim {
            0%, 92% { background-color: transparent; }
            93% { background-color: rgba(255, 255, 255, 0.6); } /* Nh√°y tr·∫Øng */
            94% { background-color: transparent; }
            96% { background-color: rgba(0, 255, 255, 0.4); } /* Nh√°y xanh */
            100% { background-color: transparent; }
        }
        .effect-lightning {
            border: 2px solid #00e5ff;
            animation: flash-anim 3s infinite;
            box-shadow: 0 0 15px #00e5ff;
        }

        /* 4. HI·ªÜU ·ª®NG B√ìNG MA (GHOST) - THAY TH·∫æ GI√ì */
        @keyframes ghost-pulse {
            0% { 
                box-shadow: inset 0 0 20px #000000, 0 0 5px #4c1d95; 
                background-color: rgba(0, 0, 0, 0.2); /* ƒêen m·ªù nh·∫π */
                opacity: 0.8;
            }
            50% { 
                box-shadow: inset 0 0 60px #000000, 0 0 20px #a855f7; 
                background-color: rgba(76, 29, 149, 0.3); /* T√≠m ma qu√°i */
                opacity: 1;
            }
            100% { 
                box-shadow: inset 0 0 20px #000000, 0 0 5px #4c1d95; 
                background-color: rgba(0, 0, 0, 0.2); 
                opacity: 0.8;
            }
        }

        .effect-ghost {
            /* Hi·ªáu ·ª©ng th·ªü (Pulse) r·∫•t m∆∞·ª£t, kh√¥ng bao gi·ªù b·ªã l·ªách */
            animation: ghost-pulse 3s infinite alternate;
            
            /* Vi·ªÅn t√≠m ƒë·∫≠m */
            border: 2px solid #6b21a8; 
            
            /* Bo g√≥c kh·ªõp v·ªõi overlay */
            border-radius: 0.75rem; 
        }

    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex h-screen overflow-hidden">

    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col shadow-2xl z-10">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-yellow-500 flex items-center gap-2">
                <i class="fa-solid fa-crown"></i> KPI King
            </h1>
            <span class="text-xs text-green-400 font-mono mt-1 block pl-8">Admin Portal v3.0</span>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchTab('dashboard')" data-tab="dashboard" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 hover:bg-gray-700 hover:text-white hover:border-yellow-500 
                active-tab bg-gray-700 border-yellow-500 text-white">
                <i class="fa-solid fa-chart-line w-6 text-center"></i> T·ªïng quan
            </button>

            <button onclick="switchTab('security')" data-tab="security" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-red-500">
                <i class="fa-solid fa-database w-6 text-center"></i> B·∫£o m·∫≠t & Reset
            </button>

            <button onclick="switchTab('boss')" data-tab="boss" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-purple-500">
                <i class="fa-solid fa-dragon w-6 text-center"></i> Qu·∫£n l√Ω Boss
            </button>

            <button onclick="switchTab('titles'); loadTitles()" data-tab="titles" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-pink-500">
                <i class="fa-solid fa-medal w-6 text-center"></i> Qu·∫£n L√Ω Danh Hi·ªáu
            </button>

            <button onclick="switchTab('dungeon-tower')" data-tab="dungeon-tower" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-gray-400">
                <i class="fas fa-chess-rook w-6 text-center"></i> Th√°p Th√≠ Luy·ªán
            </button>

            <button onclick="switchTab('arena')" data-tab="arena" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-blue-500">
                <i class="fa-solid fa-swords w-6 text-center"></i> L√¥i ƒë√†i
            </button>

            <button onclick="switchTab('market')" data-tab="market" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-green-500">
                <i class="fa-solid fa-ghost w-6 text-center"></i> Ch·ª£ ƒëen
            </button>

            <button onclick="switchTab('notifications')" data-tab="notifications" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 hover:bg-gray-700 hover:text-white hover:border-yellow-500 text-gray-400 border-transparent">
                <i class="fa-solid fa-bullhorn w-6 text-center"></i> Qu·∫£n L√Ω Th√¥ng B√°o
            </button>
            <button onclick="switchTab('charm-settings')" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg flex items-center gap-3 transition">
                <span class="text-xl">üîÆ</span>
                <span class="font-bold">Charm & L√≤ R√®n</span>
            </button>

            <button onclick="switchTab('shop')" data-tab="shop" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-pink-500">
                <i class="fa-solid fa-store w-6 text-center"></i> Ti·ªám t·∫°p h√≥a
            </button>

            <button onclick="switchTab('pet')" data-tab="pet" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-orange-500">
                <i class="fas fa-paw w-6 text-center"></i> Qu·∫£n L√Ω Th√∫ C∆∞ng
            </button>

            <button onclick="switchTab('skills')" data-tab="skills" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-400 hover:bg-gray-700 hover:text-white hover:border-yellow-500">
                <i class="fa-solid fa-wand-magic-sparkles w-6 text-center"></i> Qu·∫£n l√Ω K·ªπ nƒÉng
            </button>

            <button onclick="switchTab('data')" data-tab="data" 
                class="nav-item w-full text-left px-6 py-3 transition border-l-4 border-transparent text-gray-300 hover:bg-gray-700 hover:text-white hover:border-gray-500">
                <i class="fa-solid fa-database w-6 text-center"></i> D·ªØ li·ªáu
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-700">
            <button onclick="logoutAdmin()" class="w-full bg-red-900/50 hover:bg-red-900 text-red-200 py-2 rounded border border-red-800 transition text-sm">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-gray-900 p-8 relative">
        
        <div id="tab-dashboard" class="tab-content active max-w-7xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <i class="fa-solid fa-chart-pie mr-3 text-yellow-500"></i> Th·ªëng k√™ & Qu·∫£n tr·ªã L·ªõp
                </h2>
                
                <div class="flex gap-3">
                    <div class="relative">
                        <input type="file" id="excel-upload" accept=".xlsx" class="hidden" onchange="handleFileUpload(this)">
                        <label for="excel-upload" class="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center shadow-lg transition">
                            <i class="fa-solid fa-file-excel mr-2"></i> N·∫°p Danh S√°ch L·ªõp (.xlsx)
                        </label>
                    </div>
                    <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 text-sm flex items-center">
                        <span class="text-gray-400 mr-2">Status:</span> 
                        <span class="text-green-400 font-bold">Online ‚óè</span>
                    </div>
                </div>
            </header>

            <div id="debug-console" class="hidden mb-6 bg-black text-green-400 font-mono text-xs p-4 rounded-lg border border-gray-700 h-32 overflow-y-auto shadow-inner">
                <div class="border-b border-gray-800 pb-1 mb-2 text-gray-500">System Log...</div>
                <div id="log-content"></div>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-blue-400 mb-4 flex items-center">
                    <i class="fa-solid fa-sitemap mr-2"></i> S∆° ƒê·ªì T·ªï ƒê·ªôi
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            
                    <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                            <input type="text" value="T·ªï 1" class="bg-transparent font-bold text-yellow-500 text-lg w-24 focus:outline-none focus:border-b border-yellow-500 text-center" onchange="updateTeamName(1, this.value)">
                            <span class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded">0 TV</span>
                        </div>
                        <div id="team-1-list" class="space-y-2 flex-1 overflow-y-auto max-h-[400px] pr-1 scrollbar-thin">
                            <div class="text-center text-gray-500 text-sm py-4 italic">Tr·ªëng</div>
                        </div>
                        <button onclick="openAddMemberModal(1)" class="mt-3 w-full border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 py-2 rounded text-sm transition">
                            <i class="fa-solid fa-plus"></i> Th√™m ng∆∞·ªùi
                        </button>
                    </div>

                    <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                            <input type="text" value="T·ªï 2" class="bg-transparent font-bold text-blue-500 text-lg w-24 focus:outline-none focus:border-b border-blue-500 text-center">
                            <span class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded">0 TV</span>
                        </div>
                        <div id="team-2-list" class="space-y-2 flex-1 overflow-y-auto max-h-[400px] pr-1 scrollbar-thin">
                            <div class="text-center text-gray-500 text-sm py-4 italic">Tr·ªëng</div>
                        </div>
                        <button onclick="openAddMemberModal(2)" class="mt-3 w-full border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 py-2 rounded text-sm transition">
                            <i class="fa-solid fa-plus"></i> Th√™m ng∆∞·ªùi
                        </button>
                    </div>

                    <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                            <input type="text" value="T·ªï 3" class="bg-transparent font-bold text-green-500 text-lg w-24 focus:outline-none focus:border-b border-green-500 text-center">
                            <span class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded">0 TV</span>
                        </div>
                        <div id="team-3-list" class="space-y-2 flex-1 overflow-y-auto max-h-[400px] pr-1 scrollbar-thin">
                            <div class="text-center text-gray-500 text-sm py-4 italic">Tr·ªëng</div>
                        </div>
                        <button onclick="openAddMemberModal(3)" class="mt-3 w-full border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 py-2 rounded text-sm transition">
                            <i class="fa-solid fa-plus"></i> Th√™m ng∆∞·ªùi
                        </button>
                    </div>

                    <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                            <input type="text" value="T·ªï 4" class="bg-transparent font-bold text-purple-500 text-lg w-24 focus:outline-none focus:border-b border-purple-500 text-center">
                            <span class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded">0 TV</span>
                        </div>
                        <div id="team-4-list" class="space-y-2 flex-1 overflow-y-auto max-h-[400px] pr-1 scrollbar-thin">
                            <div class="text-center text-gray-500 text-sm py-4 italic">Tr·ªëng</div>
                        </div>
                        <button onclick="openAddMemberModal(4)" class="mt-3 w-full border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 py-2 rounded text-sm transition">
                            <i class="fa-solid fa-plus"></i> Th√™m ng∆∞·ªùi
                        </button>
                    </div>

                </div>
            </div>

            <div class="mb-6">
                <button onclick="togglePlayerList()" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 p-4 rounded-xl flex justify-between items-center transition-all shadow-lg">
                    <span class="text-xl font-semibold"><i class="fa-solid fa-list mr-3 text-gray-400"></i> B·∫£ng d·ªØ li·ªáu chi ti·∫øt (D·∫°ng danh s√°ch)</span>
                    <i id="chevron-icon" class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="player-list-area" class="hidden mt-4 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-900 text-yellow-600 uppercase text-[10px] tracking-widest">
                                <tr>
                                    <th class="px-6 py-4">ID</th>
                                    <th class="px-6 py-4">H·ªçc Sƒ©</th>
                                    <th class="px-6 py-4 text-center">T·ªï</th>
                                    <th class="px-6 py-4 text-center">KPI / Tri Th·ª©c / Chi·∫øn T√≠ch / Vinh D·ª±</th>
                                    <th class="px-6 py-4 text-right">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="player-table-body" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl">
                    <h3 class="text-lg font-bold mb-4 text-green-400 flex items-center">
                        <i class="fa-solid fa-medal mr-2"></i> ‚ö° Khen Th∆∞·ªüng / K·ª∑ Lu·∫≠t (KPI)
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Ch·ªçn ƒë·ªëi t∆∞·ª£ng √°p d·ª•ng</label>
                            <select id="reward-player-id" class="player-select w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white outline-none focus:border-green-500">
                                <option value="">-- ƒêang t·∫£i... --</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">S·ªë l∆∞·ª£ng KPI</label>
                                <input type="number" id="reward-amount" value="10" min="1" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">L√Ω do (T√πy ch·ªçn)</label>
                                <input type="text" id="reward-reason" placeholder="Vd: Ph√°t bi·ªÉu..." class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-green-500">
                            </div>
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button onclick="sendFormalReward(1)" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition shadow-lg flex items-center justify-center">
                                <i class="fa-solid fa-plus mr-2"></i> Th∆∞·ªüng
                            </button>
                            <button onclick="sendFormalReward(-1)" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded transition shadow-lg flex items-center justify-center">
                                <i class="fa-solid fa-gavel mr-2"></i> Ph·∫°t
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl border-t-4 border-t-purple-500">
                    <h3 class="text-lg font-bold mb-4 text-purple-400 flex items-center">
                        <i class="fa-solid fa-gift mr-2"></i> üéÅ Qu√† T·∫∑ng & T√†i Nguy√™n
                    </h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold">Ng∆∞·ªùi nh·∫≠n / B·ªã thu h·ªìi</label>
                            <div class="relative">
                                <select id="gift-player-id" class="player-select w-full bg-gray-900 border border-gray-600 rounded p-2.5 text-sm text-white outline-none focus:border-purple-500 transition">
                                    <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                                </select>
                            </div>
                        </div>

                        <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-700">
                            <label class="text-[10px] text-purple-300 font-bold uppercase mb-2 block flex justify-between">
                                <span>üí∞ T√†i nguy√™n (Point)</span> <i class="fas fa-coins text-purple-500"></i>
                            </label>
                            <div class="flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <select id="currency-type" class="w-1/2 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white outline-none">
                                        <option value="tri_thuc">üìò Tri Th·ª©c</option>
                                        <option value="chien_tich">‚öîÔ∏è Chi·∫øn T√≠ch</option>
                                        <option value="vinh_du">üéñÔ∏è Vinh D·ª±</option>
                                        <option value="kpi">‚≠ê KPI Point</option>
                                    </select>
                                    <input type="number" id="currency-amount" placeholder="S·ªë l∆∞·ª£ng" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white outline-none">
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="sendGiftCurrency(1)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded text-xs font-bold transition">T·∫∑ng</button>
                                    <button onclick="sendGiftCurrency(-1)" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-1.5 rounded text-xs font-bold transition">Thu h·ªìi</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-700">
                            <label class="text-[10px] text-blue-300 font-bold uppercase mb-2 block flex justify-between">
                                <span>üéí V·∫≠t Ph·∫©m (Item)</span> <i class="fas fa-box-open text-blue-500"></i>
                            </label>
                            <div class="flex flex-col gap-2">
                                <select id="item-template-select" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white outline-none">
                                    <option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>
                                </select>
                                <div class="flex gap-2">
                                    <input type="number" id="item-qty" value="1" min="1" class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white text-center outline-none">
                                    <button onclick="sendGiftItem(1)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-1.5 rounded text-xs font-bold transition">G·ª≠i ƒë·ªì</button>
                                    <button onclick="sendGiftItem(-1)" class="flex-1 bg-red-900/80 hover:bg-red-800 text-white py-1.5 rounded text-xs font-bold transition">X√≥a ƒë·ªì</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="tab-security" class="tab-content max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-red-400 mb-6 flex items-center"><i class="fa-solid fa-user-shield mr-3"></i> Trung T√¢m B·∫£o M·∫≠t</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl">
                    <h3 class="text-lg font-bold mb-4 text-white">üîê ƒê·ªïi M·∫≠t Kh·∫©u Admin</h3>
                    <div class="space-y-3">
                        <input type="password" id="admin-old-pass" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                        <input type="password" id="admin-new-pass" placeholder="M·∫≠t kh·∫©u m·ªõi" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                        <input type="password" id="admin-confirm-pass" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                        <button onclick="handleChangeAdminPass()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">
                            L∆∞u Thay ƒê·ªïi
                        </button>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl">
                    <h3 class="text-lg font-bold mb-4 text-white">‚ö†Ô∏è Reset M·∫≠t Kh·∫©u User</h3>
                    <div class="mb-4">
                        <label class="text-xs text-gray-400 block mb-2">Ch·ªçn h·ªçc sinh ƒë·ªÉ Reset v·ªÅ "123456"</label>
                        <div class="flex gap-2">
                            <select id="reset-student-select" class="flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-yellow-500 outline-none">
                                <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                            </select>
                            <button onclick="handleSingleReset()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded text-sm font-bold transition">
                                <i class="fa-solid fa-key mr-1"></i> Reset
                            </button>
                        </div>
                    </div>
                    <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg">
                        <p class="text-[11px] text-gray-400 mb-2">Ho·∫∑c Reset <strong>TO√ÄN B·ªò SERVER</strong>:</p>
                        <button onclick="confirmResetAll()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition text-xs flex items-center justify-center">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i> RESET ALL (123456)
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-xl overflow-hidden">
                <div class="p-4 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-list mr-2"></i> Danh S√°ch T√†i Kho·∫£n</h3>
                    <span class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded">Hi·ªÉn th·ªã password_hash</span>
                </div>
                
                <div class="overflow-y-auto max-h-96 custom-scrollbar">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-900 text-gray-400 sticky top-0 shadow-md">
                            <tr>
                                <th class="p-3 font-semibold">ID</th>
                                <th class="p-3 font-semibold">H·ªç T√™n</th>
                                <th class="p-3 font-semibold">Username</th>
                                <th class="p-3 font-semibold">M·∫≠t kh·∫©u (Hi·ªán t·∫°i)</th>
                                <th class="p-3 font-semibold text-center">T·ªï</th>
                            </tr>
                        </thead>
                        <tbody id="security-table-body">
                            <tr><td colspan="5" class="p-4 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-8 p-6 bg-red-950/30 border-2 border-red-800 border-dashed rounded-xl">
                <h3 class="text-xl font-bold text-red-500 mb-2 flex items-center">
                    <i class="fa-solid fa-radiation text-2xl mr-3"></i> V√ôNG NGUY HI·ªÇM: KH·ªûI ƒê·ªòNG M√ôA GI·∫¢I M·ªöI
                </h3>
                <p class="text-gray-400 text-sm mb-6 ml-9">
                    Ch·ª©c nƒÉng n√†y d√πng khi <strong>k·∫øt th√∫c nƒÉm h·ªçc/m√πa gi·∫£i</strong>. H·ªá th·ªëng s·∫Ω:
                    <ul class="list-disc list-inside ml-9 text-gray-400 text-sm mt-2 space-y-1">
                        <li><span class="text-red-400">X√ìA vƒ©nh vi·ªÖn</span> to√†n b·ªô h·ªçc sinh v√† d·ªØ li·ªáu c√° nh√¢n (Ti·ªÅn, Level, Kho ƒë·ªì, ƒêi·ªÉm s·ªë...).</li>
                        <li><span class="text-red-400">X√ìA</span> to√†n b·ªô nh·∫≠t k√Ω ho·∫°t ƒë·ªông, l·ªãch s·ª≠ l√¥i ƒë√†i.</li>
                        <li><span class="text-green-400 font-bold">GI·ªÆ L·∫†I</span> t√†i kho·∫£n Admin, d·ªØ li·ªáu Shop, Ng√¢n h√†ng c√¢u h·ªèi v√† C·∫•u h√¨nh game.</li>
                    </ul>
                </p>

                <div class="ml-9">
                    <button onclick="confirmResetSeason()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fa-solid fa-trash-can"></i> X√ÅC NH·∫¨N X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU H·ªåC SINH
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-boss" class="tab-content max-w-7xl mx-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-400 flex items-center">
                    <i class="fa-solid fa-dragon mr-3"></i> TRUNG T√ÇM CH·ªà HUY BOSS (PvE)
                </h2>
                <button onclick="clearBattleLog()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded text-sm font-bold border border-gray-600 transition">
                    <i class="fa-solid fa-broom mr-2"></i> D·ªçn d·∫πp Nh·∫≠t k√Ω
                </button>
            </div>

            <div class="grid grid-cols-12 gap-6 mb-8">
                <div class="col-span-12 lg:col-span-8 space-y-6">
                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                        <h3 class="text-white font-bold mb-4 border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-sliders mr-2"></i> C·∫•u h√¨nh Tr·∫≠n ƒê·∫•u
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="text-xs text-gray-400 block mb-1">T√™n Boss</label>
                                <input type="text" id="boss-name" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">Kh·ªëi L·ªõp</label>
                                <select id="boss-grade" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white outline-none">
                                    <option value="6">Kh·ªëi 6</option>
                                    <option value="7">Kh·ªëi 7</option>
                                    <option value="8">Kh·ªëi 8</option>
                                    <option value="9">Kh·ªëi 9</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">M√¥n H·ªçc</label>
                                <select id="boss-subject" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white outline-none">
                                    <option value="toan">To√°n H·ªçc</option>
                                    <option value="ly">V·∫≠t L√Ω</option>
                                    <option value="hoa">H√≥a H·ªçc</option>
                                    <option value="anh">Ti·∫øng Anh</option>
                                    <option value="sinh">Sinh H·ªçc</option>
                                    <option value="van">Ng·ªØ VƒÉn</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-red-400 block mb-1 font-bold">HP T·ªïng</label>
                                <input type="number" id="boss-hp" value="5000" class="w-full bg-gray-900 border border-red-900 rounded px-3 py-2 text-white outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-yellow-400 block mb-1 font-bold">Th·ªùi gian (gi√¢y)</label>
                                <input type="number" id="boss-time-limit" value="15" class="w-full bg-gray-900 border border-yellow-900 rounded px-3 py-2 text-white outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs text-gray-400 block mb-1">S√°t th∆∞∆°ng (ATK)</label>
                                <input type="number" id="boss-atk" value="10" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white outline-none">
                            </div>
                            
                            <div class="col-span-2 pt-2">
                                <button onclick="saveBoss()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-bolt"></i> TRI·ªÜU H·ªíI BOSS NGAY
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                        <h3 class="text-white font-bold mb-4 border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-gift mr-2"></i> Ph·∫ßn th∆∞·ªüng khi ti√™u di·ªát
                        </h3>

                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <input type="number" id="reward-kpi" placeholder="KPI" class="bg-gray-900 border border-green-900 rounded px-2 py-2 text-white text-center text-sm">
                            <input type="number" id="reward-trithuc" placeholder="Tri Th·ª©c" class="bg-gray-900 border border-blue-900 rounded px-2 py-2 text-white text-center text-sm">
                            <input type="number" id="reward-chientich" placeholder="C.T√≠ch" class="bg-gray-900 border border-red-900 rounded px-2 py-2 text-white text-center text-sm">
                            <input type="number" id="reward-vinhdu" placeholder="Vinh D·ª±" class="bg-gray-900 border border-purple-900 rounded px-2 py-2 text-white text-center text-sm">
                        </div>

                        <div class="mt-4 border-t border-gray-700 pt-4">
                            <label class="text-xs text-yellow-400 block mb-2 font-bold">üéÅ C·∫•u h√¨nh Danh s√°ch R∆°i ƒë·ªì (Drop Pool)</label>
                            
                            <div class="flex gap-2 mb-3">
                                <select id="boss-drop-select" class="flex-1 bg-gray-900 border border-gray-600 rounded px-2 py-2 text-white text-sm outline-none">
                                    <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                                </select>
                                
                                <input type="number" id="boss-drop-rate" placeholder="T·ªâ l·ªá %" class="w-24 bg-gray-900 border border-gray-600 rounded px-2 text-center text-white text-sm outline-none">
                                
                                <button type="button" onclick="addBossDropItem()" class="bg-green-700 hover:bg-green-600 text-white px-3 rounded font-bold transition shadow-md active:scale-95">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>

                            <div id="boss-drop-list" class="space-y-2 bg-gray-900 p-2 rounded min-h-[50px] border border-gray-700 max-h-40 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-500 text-xs text-center italic mt-1" id="empty-drop-msg">Ch∆∞a c√≥ v·∫≠t ph·∫©m n√†o trong danh s√°ch r∆°i...</p>
                                </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-12 lg:col-span-4 space-y-6">
                    <div class="bg-gray-800 p-5 rounded-xl border-2 border-purple-500/50 shadow-lg">
                        <h3 class="text-purple-400 font-bold mb-3 text-sm flex justify-between">
                            <span><i class="fa-solid fa-tower-broadcast mr-2"></i> ƒêANG DI·ªÑN RA</span>
                            <span id="boss-timer-display" class="text-yellow-500 font-mono">00s</span>
                        </h3>
                        
                        <div id="battle-scene" class="bg-black/60 rounded-lg border border-gray-700 h-64 flex flex-col items-center justify-center relative overflow-hidden p-4">
                            <img id="active-boss-img" src="" class="w-40 h-40 object-contain z-10 drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
                            
                            <div id="vfx-layer" class="absolute inset-0 pointer-events-none"></div>

                            <div class="w-full mt-4">
                                <div class="w-full bg-gray-900 rounded-full h-4 overflow-hidden relative border border-gray-700">
                                    <div id="boss-hp-bar" class="bg-gradient-to-r from-red-600 to-orange-500 h-full transition-all duration-700" style="width: 0%"></div>
                                    <span id="boss-hp-text" class="absolute inset-0 flex items-center justify-center text-[10px] text-white font-bold">0 / 0 HP</span>
                                </div>
                                <div id="boss-status-text" class="text-[10px] text-gray-500 text-center mt-1 uppercase tracking-tighter">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 space-y-2">
                            <label class="text-[10px] text-gray-400 block uppercase">Thi·∫øt l·∫≠p ngo·∫°i quan (Xem tr∆∞·ªõc)</label>
                            <input type="text" id="boss-img" placeholder="D√°n Link ·∫£nh Boss t·∫°i ƒë√¢y..." class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-1.5 text-xs text-white outline-none focus:border-purple-500">
                            <div class="grid grid-cols-2 gap-2">
                                <select id="boss-anim" class="bg-gray-900 border border-gray-700 rounded px-2 py-1 text-[10px] text-white outline-none">
                                    <option value="stand">ƒê·ª©ng y√™n</option>
                                    <option value="breathe">Th·ªü (Breathe)</option>
                                    <option value="float">Bay (Float)</option>
                                    <option value="shake">Rung (Shake)</option>
                                </select>
                                <select id="boss-vfx" class="bg-gray-900 border border-gray-700 rounded px-2 py-1 text-[10px] text-white outline-none">
                                    <option value="none">Kh√¥ng VFX</option>
                                    <option value="fire">L·ª≠a ch√°y</option>
                                    <option value="snow">Tuy·∫øt r∆°i</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg flex-1">
                        <h3 class="text-white font-bold mb-3 text-sm border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-scroll mr-2"></i> NH·∫¨T K√ù CHI·∫æN TR∆Ø·ªúNG
                        </h3>
                        <div id="battle-log-window" class="h-48 overflow-y-auto text-[10px] font-mono space-y-1 pr-2 scrollbar-thin">
                            <div class="text-gray-600 italic text-center py-4">H·ªá th·ªëng s·∫µn s√†ng...</div>
                        </div>
                        <button onclick="deleteBoss()" class="w-full mt-4 bg-red-900/20 hover:bg-red-900/40 text-red-400 py-2 rounded border border-red-900/50 transition text-[10px] font-bold">
                            H·ª¶Y TR·∫¨N ƒê·∫§U HI·ªÜN T·∫†I
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-shop" class="tab-content hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Qu·∫£n L√Ω Ti·ªám T·∫°p H√≥a</h2>
                <button onclick="openCreateItemModal()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                    <i class="fas fa-plus mr-2"></i> T·∫°o V·∫≠t Ph·∫©m M·ªõi
                </button>
            </div>

            <div id="shop-inventory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <p class="text-gray-500 italic text-center col-span-full">ƒêang t·∫£i danh s√°ch v·∫≠t ph·∫©m...</p>
            </div>
        </div>

        <div id="tab-dungeon-tower" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div>
                    <h2 class="text-xl font-bold text-white">üè∞ Qu·∫£n L√Ω Th√°p Th√≠ Luy·ªán</h2>
                    <p class="text-gray-400 text-xs">C·∫•u tr√∫c 100 t·∫ßng - Nh·∫≠p li·ªáu th√¥ng minh t·ª´ AI</p>
                </div>
                <button onclick="openAiImportModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center">
                    <i class="fas fa-robot mr-2"></i> Nh·∫≠p JSON Si√™u T·ªëc
                </button>
            </div>
            <div id="tower-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                </div>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center">
                    <h3 class="text-white font-bold text-sm">Th·ªëng k√™ Ng√¢n h√†ng c√¢u h·ªèi</h3>
                    <span class="text-xs text-gray-400 italic">D·ªØ li·ªáu t·ªïng h·ª£p theo m√¥n h·ªçc</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-900/50 text-gray-400 uppercase">
                            <tr>
                                <th class="px-4 py-3">M√¥n h·ªçc</th>
                                <th class="px-4 py-3 text-center">Ph√¢n lo·∫°i ƒë·ªô kh√≥</th>
                                <th class="px-4 py-3 text-center">T·ªïng s·ªë c√¢u</th>
                                <th class="px-4 py-3 text-right">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="tower-question-list" class="divide-y divide-gray-700 text-gray-300">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <label class="block text-[10px] text-red-400 mb-2 uppercase font-bold tracking-widest">
                        <i class="fas fa-ghost mr-1"></i> Pool H√¨nh ·∫£nh Qu√°i V·∫≠t (Link m·ªói d√≤ng)
                    </label>
                    <textarea id="monster-pool" class="w-full h-24 bg-gray-900 border border-gray-700 rounded-lg p-2 text-[10px] text-gray-300 font-mono outline-none focus:border-red-500" 
                        placeholder="https://link-anh-quai-vath-1.png..."></textarea>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <label class="block text-[10px] text-green-400 mb-2 uppercase font-bold tracking-widest">
                        <i class="fas fa-image mr-1"></i> Pool Background Th√°p (Link m·ªói d√≤ng)
                    </label>
                    <textarea id="bg-pool" class="w-full h-24 bg-gray-900 border border-gray-700 rounded-lg p-2 text-[10px] text-gray-300 font-mono outline-none focus:border-green-500" 
                        placeholder="https://link-background-tang-1.jpg..."></textarea>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl mb-6">
                <h4 class="text-white font-bold mb-4 flex items-center text-sm uppercase italic">
                    <i class="fas fa-plus-circle mr-2 text-green-500"></i> T·∫°o "G√≥i Ph·∫ßn Th∆∞·ªüng" m·ªõi
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold tracking-tighter">B·∫≠c Th√°p</label>
                        <select id="reward-target-diff" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg p-2 text-xs outline-none focus:border-blue-500">
                            <option value="Medium">MEDIUM (1-10)</option>
                            <option value="Hard">HARD (11-20)</option>
                            <option value="Extreme">EXTREME (21-60)</option>
                            <option value="Hell">HELL (61-100)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold tracking-tighter">Lo·∫°i qu√†</label>
                        <select id="reward-type" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg p-2 text-xs outline-none" onchange="toggleRewardInputs()">
                            <option value="exp">EXP</option>
                            <option value="currency">Ti·ªÅn t·ªá (Xanh/T√≠m/Cam)</option>
                            <option value="item">V·∫≠t ph·∫©m / R∆∞∆°ng</option>
                            <option value="charm"> Charm </option>
                        </select>
                    </div>

                    <div id="reward-detail-container">
                        <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold tracking-tighter">Chi ti·∫øt & S·ªë l∆∞·ª£ng</label>
                        <div class="flex space-x-1">
                            <select id="reward-sub-type" class="hidden w-1/2 bg-gray-900 border border-gray-700 text-white rounded-lg p-2 text-[10px] outline-none"></select>
                            <input type="number" id="tower-reward-amount" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg p-2 text-xs outline-none" placeholder="S·ªë l∆∞·ª£ng...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold tracking-tighter">T·ª∑ l·ªá r∆°i (%)</label>
                        <input type="number" id="reward-drop-rate" class="w-full bg-gray-900 border border-gray-700 text-yellow-500 rounded-lg p-2 text-xs outline-none font-bold" value="100">
                    </div>

                    <button onclick="addRewardToPool()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg text-xs transition transform active:scale-95 shadow-lg shadow-blue-900/40">
                        <i class="fas fa-plus mr-1"></i> TH√äM V√ÄO B·∫¨C
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden flex flex-col">
                    <div class="p-3 bg-blue-600/20 border-b border-blue-500/30 flex justify-between items-center">
                        <h5 class="text-blue-400 font-bold text-xs">MEDIUM (1-10)</h5>
                        <button onclick="clearPool('Medium')" 
                                class="flex items-center gap-1 bg-red-900/50 hover:bg-red-600 border border-red-500/50 text-red-200 hover:text-white px-2 py-1 rounded shadow transition-all" 
                                title="X√≥a s·∫°ch Medium">
                            <i class="fas fa-trash"></i> 
                            <span class="text-[10px] font-bold">X√ìA</span>
                        </button>
                    </div>
                    <div id="pool-Medium" class="p-3 space-y-2 flex-grow min-h-[200px]"></div>
                </div>

                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden flex flex-col">
                    <div class="p-3 bg-green-600/20 border-b border-green-500/30 flex justify-between items-center">
                        <h5 class="text-green-400 font-bold text-xs">HARD (11-20)</h5>
                        <button onclick="clearPool('Hard')" 
                                class="flex items-center gap-1 bg-red-900/50 hover:bg-red-600 border border-red-500/50 text-red-200 hover:text-white px-2 py-1 rounded shadow transition-all"
                                title="X√≥a s·∫°ch Hard">
                            <i class="fas fa-trash"></i>
                            <span class="text-[10px] font-bold">X√ìA</span>
                        </button>
                    </div>
                    <div id="pool-Hard" class="p-3 space-y-2 flex-grow min-h-[200px]"></div>
                </div>

                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden flex flex-col">
                    <div class="p-3 bg-orange-600/20 border-b border-orange-500/30 flex justify-between items-center">
                        <h5 class="text-orange-400 font-bold text-xs">EXTREME (21-60)</h5>
                        <button onclick="clearPool('Extreme')" 
                                class="flex items-center gap-1 bg-red-900/50 hover:bg-red-600 border border-red-500/50 text-red-200 hover:text-white px-2 py-1 rounded shadow transition-all"
                                title="X√≥a s·∫°ch Extreme">
                            <i class="fas fa-trash"></i>
                            <span class="text-[10px] font-bold">X√ìA</span>
                        </button>
                    </div>
                    <div id="pool-Extreme" class="p-3 space-y-2 flex-grow min-h-[200px]"></div>
                </div>

                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden flex flex-col">
                    <div class="p-3 bg-red-600/20 border-b border-red-500/30 flex justify-between items-center">
                        <h5 class="text-red-500 font-bold text-xs">HELL (61-100)</h5>
                        <button onclick="clearPool('Hell')" 
                                class="flex items-center gap-1 bg-red-900/50 hover:bg-red-600 border border-red-500/50 text-red-200 hover:text-white px-2 py-1 rounded shadow transition-all"
                                title="X√≥a s·∫°ch Hell">
                            <i class="fas fa-trash"></i>
                            <span class="text-[10px] font-bold">X√ìA</span>
                        </button>
                    </div>
                    <div id="pool-Hell" class="p-3 space-y-2 flex-grow min-h-[200px]"></div>
                </div>
                <div class="mt-8 mb-12 flex justify-center border-t border-gray-700 pt-6">
                    <button onclick="saveTowerFullConfig()" class="bg-gradient-to-r from-yellow-600 to-red-600 hover:from-yellow-500 hover:to-red-500 text-white font-bold py-3 px-12 rounded-full shadow-lg transform transition hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> L∆ØU TO√ÄN B·ªò C·∫§U H√åNH & T·ª∂ L·ªÜ R∆†I
                    </button>
                </div>
            </div>
        </div>

        <div id="ai-import-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
            <div class="bg-gray-900 border border-gray-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                    <h3 class="text-white font-bold text-lg flex items-center">
                        <i class="fas fa-file-import mr-3 text-blue-500"></i> Nh·∫≠p C√¢u H·ªèi T·ª´ AI
                    </h3>
                    <button onclick="closeAiImportModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-2 uppercase font-bold">Ch·∫ø ƒë·ªô nh·∫≠p</label>
                        <div class="flex gap-4">
                            <label class="flex items-center text-white cursor-pointer">
                                <input type="radio" name="import-mode" value="append" checked class="mr-2 accent-blue-500"> N·∫°p th√™m (Append)
                            </label>
                            <label class="flex items-center text-white cursor-pointer">
                                <input type="radio" name="import-mode" value="replace" class="mr-2 accent-red-500"> Thay th·∫ø theo M√¥n/ƒê·ªô kh√≥ (Replace)
                            </label>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1 italic">* Ch·∫ø ƒë·ªô Replace s·∫Ω x√≥a d·ªØ li·ªáu c≈© c·ªßa m√¥n & ƒë·ªô kh√≥ t∆∞∆°ng ·ª©ng tr∆∞·ªõc khi n·∫°p.</p>
                    </div>
                        <div class="mb-4 p-4 border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/50 flex flex-col items-center justify-center">
                            <i class="fas fa-file-code text-3xl text-gray-600 mb-2"></i>
                            <p class="text-gray-400 text-[10px] mb-2">K√©o th·∫£ file .json ho·∫∑c</p>
                            <input type="file" id="json-file-input" accept=".json" class="hidden" onchange="handleFileSelect(this)">
                            <button onclick="document.getElementById('json-file-input').click()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg text-[10px] transition">
                                CH·ªåN FILE T·ª™ M√ÅY T√çNH
                            </button>
                        </div>
                        <div class="relative flex items-center py-2">
                            <div class="flex-grow border-t border-gray-700"></div>
                            <span class="flex-shrink mx-4 text-gray-500 text-[10px] uppercase">Ho·∫∑c d√°n n·ªôi dung</span>
                            <div class="flex-grow border-t border-gray-700"></div>
                        </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-2 uppercase font-bold">D√°n m√£ JSON t·ª´ AI v√†o ƒë√¢y</label>
                        <textarea id="ai-json-input" rows="10" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-green-400 font-mono text-xs focus:border-blue-500 outline-none" placeholder='[{"subject": "To√°n", "difficulty": "Hell", "content": "...", "a": "...", "b": "...", "c": "...", "d": "...", "correct": "a", "explain": "..."}]'></textarea>
                    </div>
                    <button onclick="submitAiImport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-900/20">
                        X√ÅC NH·∫¨N N·∫†P D·ªÆ LI·ªÜU
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-data" class="tab-content hidden p-6 animate-fade-in">
            <div class="flex space-x-4 mb-6 border-b border-gray-700 pb-2">
                <button onclick="switchSubTab('stats')" id="btn-sub-stats" class="sub-tab-btn text-blue-400 border-b-2 border-blue-400 font-bold px-4 py-2">
                    <i class="fas fa-chart-pie mr-2"></i>Th·ªëng K√™
                </button>
                <button onclick="switchSubTab('logs')" id="btn-sub-logs" class="sub-tab-btn text-gray-400 hover:text-white px-4 py-2 transition">
                    <i class="fas fa-history mr-2"></i>Nh·∫≠t K√Ω & Logs
                </button>
                <button onclick="switchSubTab('backup')" id="btn-sub-backup" class="sub-tab-btn text-gray-400 hover:text-white px-4 py-2 transition">
                    <i class="fas fa-database mr-2"></i>Sao L∆∞u & Ti·ªán √çch
                </button>
                <button onclick="switchSubTab('maintenance')" id="btn-sub-maintenance" class="sub-tab-btn text-gray-400 hover:text-white px-4 py-2 transition">
                    <i class="fas fa-hammer mr-2"></i>B·∫£o Tr√¨
                </button>
            </div>

            <div id="sub-stats" class="sub-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <h3 class="text-yellow-400 font-bold mb-3 uppercase text-sm border-b border-gray-700 pb-2">
                            <i class="fas fa-trophy mr-2"></i>Top 5 Chi·∫øn Binh (KPI)
                        </h3>
                        <div id="top-kpi-list" class="space-y-2 text-sm">
                            <div class="text-gray-500 italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <h3 class="text-red-400 font-bold mb-3 uppercase text-sm border-b border-gray-700 pb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>C·∫ßn Nh·∫Øc Nh·ªü (Vinh D·ª± Th·∫•p)
                        </h3>
                        <div id="top-violation-list" class="space-y-2 text-sm">
                            <div class="text-gray-500 italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-blue-400 font-bold mb-4 uppercase text-sm">
                        <i class="fas fa-users mr-2"></i>Th·ªëng K√™ S·ª©c M·∫°nh T·ªï ƒê·ªôi
                    </h3>
                    <div id="team-chart-container" class="space-y-4">
                        </div>
                </div>
            </div>

            <div id="sub-logs" class="sub-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex space-x-2">
                        <select id="log-filter" class="bg-gray-900 border border-gray-700 text-white text-xs rounded p-2 outline-none">
                            <option value="all">T·∫•t c·∫£ h√†nh ƒë·ªông</option>
                            <option value="shop">Mua s·∫Øm (Shop)</option>
                            <option value="admin">Admin can thi·ªáp</option>
                            <option value="combat">Chi·∫øn ƒë·∫•u</option>
                        </select>
                        <button onclick="loadSystemLogs()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                            <i class="fas fa-filter mr-1"></i> L·ªçc
                        </button>
                    </div>
                    <span class="text-gray-500 text-xs italic">*Ch·ªâ l∆∞u tr·ªØ 7 ng√†y g·∫ßn nh·∫•t</span>
                </div>

                <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-800 text-gray-400 uppercase font-bold">
                            <tr>
                                <th class="p-3">Th·ªùi gian</th>
                                <th class="p-3">ƒê·ªëi t∆∞·ª£ng</th>
                                <th class="p-3">H√†nh ƒë·ªông</th>
                                <th class="p-3">Chi ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body" class="text-gray-300 divide-y divide-gray-800">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="sub-backup" class="sub-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-600 text-center hover:bg-gray-750 transition">
                        <i class="fas fa-cloud-download-alt text-4xl text-green-500 mb-4"></i>
                        <h3 class="text-lg font-bold text-white mb-2">Sao L∆∞u D·ªØ Li·ªáu</h3>
                        <p class="text-gray-400 text-xs mb-4">T·∫£i file "game.db" v·ªÅ m√°y t√≠nh. H√£y th·ª±c hi·ªán vi·ªác n√†y cu·ªëi m·ªói bu·ªïi h·ªçc.</p>
                        <a href="/admin/data/backup" target="_blank" class="inline-block bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded shadow-lg">
                            <i class="fas fa-download mr-2"></i>T·∫£i Xu·ªëng Ngay
                        </a>
                    </div>

                    <div class="bg-gray-900 p-6 rounded-lg border border-red-800 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1">DANGER ZONE</div>
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-red-500 mb-4 group-hover:animate-bounce"></i>
                            <h3 class="text-lg font-bold text-white mb-2">Kh√¥i Ph·ª•c D·ªØ Li·ªáu</h3>
                            <p class="text-gray-400 text-xs mb-4">T·∫£i file .db l√™n ƒë·ªÉ ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i. <br><span class="text-red-400">C·∫£nh b√°o: D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn!</span></p>
                            
                            <form id="restore-form" class="flex flex-col items-center space-y-3">
                                <input type="file" id="restore-file" accept=".db" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600"/>
                                <button type="button" onclick="handleRestoreDB()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded shadow-lg w-full">
                                    <i class="fas fa-skull-crossbones mr-2"></i>GHI ƒê√à D·ªÆ LI·ªÜU
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sub-maintenance" class="sub-content hidden">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-white font-bold mb-4 uppercase text-sm border-b border-gray-700 pb-2">
                        <i class="fas fa-door-closed mr-2 text-red-500"></i>Qu·∫£n L√Ω Kh√≥a C·ªïng H·ªá Th·ªëng
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg">
                            <div>
                                <div class="text-xs text-gray-500 uppercase">Tr·∫°ng th√°i hi·ªán t·∫°i</div>
                                <div id="maintenance-status-text" class="text-xl font-bold text-green-500">H·ªÜ TH·ªêNG ƒêANG M·ªû</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="maintenance-toggle" class="sr-only peer">
                                <div class="w-14 h-7 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-500 uppercase mb-2">Th√¥ng b√°o hi·ªÉn th·ªã cho h·ªçc sinh</label>
                            <textarea id="maintenance-msg" rows="3" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none" placeholder="Nh·∫≠p l√Ω do b·∫£o tr√¨..."></textarea>
                        </div>

                        <button onclick="saveMaintenance()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition shadow-lg">
                            <i class="fas fa-save mr-2"></i>C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-pet" class="tab-content hidden">
            <div class="card bg-gray-800 text-white p-6 rounded-lg shadow-lg">
                
                <h2 class="text-2xl font-bold mb-6 text-orange-500 border-b border-gray-700 pb-2">
                    <i class="fas fa-paw mr-2"></i> Danh S√°ch Linh Th√∫
                </h2>

                <div class="bg-gray-700 p-6 rounded-lg mb-8 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-300 mb-4 border-l-4 border-orange-500 pl-3">Kh·ªüi T·∫°o Linh Th√∫ M·ªõi</h3>
                    
                    <div class="flex flex-col md:flex-row gap-8">
                        
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-2 md:col-span-1">
                                <label class="text-xs text-gray-400 mb-1 block">T√™n Linh Th√∫</label>
                                <input type="text" id="pet-name" oninput="updatePreview()" placeholder="Vd: Ph∆∞·ª£ng Ho√†ng L·ª≠a" 
                                    class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2 focus:border-orange-500 outline-none">
                            </div>

                            <div class="col-span-2 md:col-span-1">
                                <label class="text-xs text-gray-400 mb-1 block">Link ·∫¢nh (URL)</label>
                                <input type="text" id="pet-image" oninput="updatePreview()" placeholder="https://..." 
                                    class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2 focus:border-orange-500 outline-none">
                            </div>

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Lo·∫°i Buff</label>
                                <select id="pet-buff-type" class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2 outline-none cursor-pointer">
                                    <option value="ATK">TƒÉng C√¥ng (ƒêi·ªÉm)</option>
                                    <option value="HP">TƒÉng M√°u (ƒêi·ªÉm)</option>
                                    <option value="EXP">TƒÉng EXP (%)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Gi√° tr·ªã Buff</label>
                                <input type="number" id="pet-buff-value" placeholder="Vd: 500" 
                                    class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2 focus:border-orange-500 outline-none">
                            </div>

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Ph·∫©m Ch·∫•t</label>
                                <select id="pet-rarity" onchange="updatePreview()" class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2 outline-none font-bold cursor-pointer">
                                    <option value="R" class="text-gray-400">Th∆∞·ªùng (R)</option>
                                    <option value="SR" class="text-yellow-400">Hi·∫øm (SR)</option>
                                    <option value="SSR" class="text-purple-400">Si√™u Hi·∫øm (SSR)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-orange-400 mb-1 block font-bold"><i class="fas fa-magic"></i> Hi·ªáu ·ª®ng ƒê·ªông</label>
                                <select id="pet-effect" onchange="updatePreview()" class="w-full bg-gray-900 text-white border border-orange-500 rounded px-3 py-2 outline-none cursor-pointer font-bold">
                                    <option value="NONE">-- Kh√¥ng --</option>
                                    <option value="FIRE">üî• L·ª≠a Ch√°y (Fire)</option>
                                    <option value="SNOW">‚ùÑÔ∏è Tuy·∫øt R∆°i (Snow)</option>
                                    <option value="LIGHTNING">‚ö° S·∫•m S√©t (Lightning)</option>
                                    <option value="GHOST">üëª B√≥ng Ma (Ghost)</option>
                                </select>
                            </div>
                            <div class="col-span-2 border-t border-gray-600 pt-3 mt-2">
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center cursor-pointer group">
                                        <div class="relative">
                                            <input type="checkbox" id="is-fragment" onchange="updatePreview()" class="sr-only">
                                            <div class="block bg-gray-600 w-10 h-6 rounded-full group-hover:bg-gray-500 transition"></div>
                                            <div id="toggle-dot" class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform duration-300"></div>
                                        </div>
                                        <span class="ml-3 text-sm font-bold text-gray-300 group-hover:text-white">ƒê√¢y l√† M·∫£nh Gh√©p?</span>
                                    </label>

                                    <div id="frag-qty-group" class="hidden flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-600">
                                        <span class="text-xs text-gray-400">C·∫ßn gh√©p:</span>
                                        <input type="number" id="frag-req" value="10" class="w-12 bg-transparent text-orange-400 font-bold text-center outline-none border-b border-gray-500 focus:border-orange-500">
                                        <span class="text-xs text-gray-400">m·∫£nh</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-span-2 mt-4">
                                <button onclick="createNewPet()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 rounded shadow-lg transform active:scale-95 transition-all">
                                    <i class="fas fa-bolt mr-2"></i> TRI·ªÜU H·ªíI LINH TH√ö
                                </button>
                            </div>
                        </div>

                        <div class="w-full md:w-1/3 flex flex-col items-center justify-center bg-gray-800/50 rounded-lg p-4 border border-gray-600 border-dashed">
                            <span class="text-gray-400 text-xs mb-3 uppercase tracking-wider">Xem tr∆∞·ªõc th·∫ª b√†i</span>
                            
                            <div id="preview-card" class="relative w-48 h-72 bg-gray-900 rounded-xl border-4 border-gray-600 shadow-xl transition-all duration-300 overflow-hidden group">
                                <div id="preview-badge" class="absolute top-2 left-2 bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded shadow z-30">R</div>
                                
                                <img id="preview-img-src" src="https://via.placeholder.com/300?text=PET" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 z-0">
                                
                                <div id="fragment-overlay-text" class="hidden absolute inset-0 z-10 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-3xl font-black text-white uppercase tracking-widest opacity-80 border-4 border-white px-2 py-1 transform -rotate-12" style="text-shadow: 0 0 10px black;">
                                        M·∫¢NH
                                    </span>
                                    <span class="text-xs font-bold text-gray-300 mt-1 bg-black/50 px-2 rounded">C·∫ßn: <span id="preview-frag-req">10</span></span>
                                </div>
                                <div id="effect-overlay" class="absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-xl"></div>

                                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent p-3 pt-8 text-center z-30">
                                    <h4 id="preview-name-text" class="text-white font-bold text-lg leading-tight truncate">T√™n Linh Th√∫</h4>
                                    <p class="text-orange-400 text-xs mt-1"><i class="fas fa-star"></i> Lv.1</p>
                                </div>
                            </div>
                            
                            <p class="text-gray-500 text-xs mt-4 text-center italic">"Hi·ªáu ·ª©ng s·∫Ω thay ƒë·ªïi theo ph·∫©m ch·∫•t"</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container overflow-x-auto rounded-lg border border-gray-700">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-900 text-gray-300 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">·∫¢nh</th>
                                <th class="py-3 px-6 text-left">T√™n Linh Th√∫</th>
                                <th class="py-3 px-6 text-center">Ph·∫©m Ch·∫•t</th>
                                <th class="py-3 px-6 text-left">M√¥ T·∫£ (Hi·ªáu ·ª©ng)</th>
                                <th class="py-3 px-6 text-center">H√†nh ƒê·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="pet-list-body" class="text-gray-300 text-sm font-light">
                            </tbody>
                    </table>
                </div>

                <div class="bg-gray-800 border border-gray-600 p-6 rounded-lg mb-8 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i class="fas fa-dice-d20 text-9xl text-orange-500"></i>
                    </div>

                    <h3 class="text-xl font-bold text-orange-400 mb-6 flex items-center">
                        <i class="fas fa-cogs mr-2"></i> C·∫•u H√¨nh T·ª∑ L·ªá Gacha (Global Config)
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <div class="bg-gray-900 rounded-lg p-4 border-t-4 border-gray-500 relative group hover:bg-gray-700 transition-colors">
                            <div class="absolute -top-3 left-4 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded shadow">R - TH∆Ø·ªúNG</div>
                            
                            <div class="mt-2 space-y-4">
                                <div>
                                    <label class="text-xs text-gray-400 block mb-1">T·ª∑ l·ªá xu·∫•t hi·ªán (Total %)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-r-appear" value="70" class="w-full bg-black text-white border border-gray-600 rounded-l px-3 py-2 focus:border-gray-400 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-700 pt-2">
                                    <label class="text-xs text-gray-400 block mb-1">Trong ƒë√≥: T·ª∑ l·ªá ra Th·∫ª (Card)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-r-card" value="30" class="w-full bg-black text-green-400 border border-gray-600 rounded-l px-3 py-2 focus:border-green-500 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1 italic">=> T·ª∑ l·ªá ra M·∫£nh: <span id="text-r-frag">70</span>%</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-lg p-4 border-t-4 border-yellow-500 relative group hover:bg-gray-700 transition-colors">
                            <div class="absolute -top-3 left-4 bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded shadow">SR - HI·∫æM</div>
                            
                            <div class="mt-2 space-y-4">
                                <div>
                                    <label class="text-xs text-gray-400 block mb-1">T·ª∑ l·ªá xu·∫•t hi·ªán (Total %)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-sr-appear" value="25" class="w-full bg-black text-yellow-400 border border-gray-600 rounded-l px-3 py-2 focus:border-yellow-400 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-700 pt-2">
                                    <label class="text-xs text-gray-400 block mb-1">Trong ƒë√≥: T·ª∑ l·ªá ra Th·∫ª (Card)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-sr-card" value="10" class="w-full bg-black text-green-400 border border-gray-600 rounded-l px-3 py-2 focus:border-green-500 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1 italic">=> T·ª∑ l·ªá ra M·∫£nh: <span id="text-sr-frag">90</span>%</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-lg p-4 border-t-4 border-purple-500 relative group hover:bg-gray-700 transition-colors shadow-[0_0_15px_rgba(168,85,247,0.1)]">
                            <div class="absolute -top-3 left-4 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded shadow">SSR - SI√äU HI·∫æM</div>
                            
                            <div class="mt-2 space-y-4">
                                <div>
                                    <label class="text-xs text-gray-400 block mb-1">T·ª∑ l·ªá xu·∫•t hi·ªán (Total %)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-ssr-appear" value="5" class="w-full bg-black text-purple-400 border border-gray-600 rounded-l px-3 py-2 focus:border-purple-400 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-700 pt-2">
                                    <label class="text-xs text-gray-400 block mb-1">Trong ƒë√≥: T·ª∑ l·ªá ra Th·∫ª (Card)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="rate-ssr-card" value="2" class="w-full bg-black text-green-400 border border-gray-600 rounded-l px-3 py-2 focus:border-green-500 outline-none font-bold">
                                        <span class="bg-gray-700 text-gray-300 px-3 py-2 rounded-r border border-l-0 border-gray-600">%</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1 italic">=> T·ª∑ l·ªá ra M·∫£nh: <span id="text-ssr-frag">98</span>%</p>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="mt-6 flex flex-col md:flex-row justify-between items-center border-t border-gray-700 pt-4">
                        <div class="text-sm mb-4 md:mb-0">
                            <span class="text-gray-400">T·ªïng t·ª∑ l·ªá xu·∫•t hi·ªán: </span>
                            <span id="total-rate-display" class="font-bold text-green-400 text-lg">100%</span>
                            <span id="rate-warning" class="text-red-500 text-xs ml-2 hidden"><i class="fas fa-exclamation-triangle"></i> Ph·∫£i b·∫±ng 100%</span>
                        </div>
                        
                        <button onclick="saveGachaConfig()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold shadow-lg transform active:scale-95 transition-all">
                            <i class="fas fa-save mr-2"></i> L∆ØU C·∫§U H√åNH GACHA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-skills" class="tab-content hidden h-full overflow-hidden">
            <div class="flex h-full gap-4 p-4">
                
                <div class="w-1/3 flex flex-col bg-gray-800 border border-gray-700 rounded-lg shadow-xl">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                        <h3 class="font-bold text-yellow-500"><i class="fa-solid fa-book-skull mr-2"></i>Th∆∞ Vi·ªán K·ªπ NƒÉng</h3>
                        <button onclick="openNewSkillForm()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold transition">
                            <i class="fa-solid fa-plus mr-1"></i> TH√äM
                        </button>
                    </div>
                    
                    <div class="flex p-2 gap-2 bg-gray-900/30 border-b border-gray-700">
                        <button onclick="filterSkills('WARRIOR')" data-type="WARRIOR" class="filter-btn flex-1 py-1 text-[10px] font-bold rounded border border-red-900/50 text-red-400 bg-red-900/20 hover:bg-red-900/40 transition">WARRIOR</button>
                        <button onclick="filterSkills('MAGE')" data-type="MAGE" class="filter-btn flex-1 py-1 text-[10px] font-bold rounded border border-blue-900/50 text-blue-400 bg-blue-900/20 hover:bg-blue-900/40 transition">MAGE</button>
                    </div>

                    <div id="admin-skill-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <div class="text-center py-10 text-gray-500 text-sm italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>

                <div id="skill-editor" class="w-2/3 bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 overflow-y-auto relative">
                    <div id="skill-editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-800 z-10">
                        <i class="fa-solid fa-hand-pointer text-4xl mb-4 opacity-20"></i>
                        <p>Ch·ªçn m·ªôt k·ªπ nƒÉng ho·∫∑c t·∫°o m·ªõi ƒë·ªÉ bi√™n so·∫°n</p>
                    </div>

                    <div id="skill-editor-form" class="space-y-6 hidden relative z-20">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-4">
                            <h3 class="text-xl font-bold text-white"><i class="fa-solid fa-pen-nib mr-2 text-blue-400"></i>Thi·∫øt l·∫≠p k·ªπ nƒÉng</h3>
                            <span id="display-skill-id" class="text-xs font-mono text-gray-500 bg-gray-900 px-2 py-1 rounded">ID: NEW_SKILL</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">T√™n K·ªπ NƒÉng</label>
                                <input type="text" id="edit-skill-name" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">M√¥ t·∫£ k·ªπ nƒÉng</label>
                                <textarea id="skill-description" 
                                        class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none h-24 resize-none" 
                                        placeholder="Nh·∫≠p chi ti·∫øt hi·ªáu ·ª©ng k·ªπ nƒÉng (v√≠ d·ª•: TƒÉng 20% s√°t th∆∞∆°ng ch√≠ m·∫°ng...)"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-yellow-500 uppercase mb-1">D√†nh cho Class</label>
                                <select id="edit-skill-class" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-yellow-500 outline-none">
                                    <option value="WARRIOR">Chi·∫øn Binh (Warrior)</option>
                                    <option value="MAGE">Ph√°p S∆∞ (Mage)</option>
                                    <option value="ARCHER">Cung Th·ªß (Archer)</option>
                                </select>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Lo·∫°i K·ªπ NƒÉng</label>
                                <select id="edit-skill-type" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                                    <option value="ACTIVE">Ch·ªß ƒë·ªông (Active)</option>
                                    <option value="PASSIVE">B·ªã ƒë·ªông (Passive)</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-900/50 rounded-lg border border-blue-900/30 mt-4">
                            <h4 class="text-blue-400 font-bold text-sm mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-network-wired"></i> C·∫§U H√åNH SKILL TREE
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">C·∫•p ƒë·ªô y√™u c·∫ßu (Min Level)</label>
                                    <input type="number" id="edit-skill-min-level" value="1" min="1" 
                                        class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                                </div>
                                
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">Skill Ti·ªÅn ƒê·ªÅ (ID Cha)</label>
                                    <input type="text" id="edit-skill-prereq" placeholder="VD: mage_fireball" 
                                        class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                                    <p class="text-[9px] text-gray-500 mt-1 italic">* ƒê·ªÉ tr·ªëng n·∫øu l√† Tier 1</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-900/50 rounded-lg border border-orange-900/30">
                            <h4 class="text-orange-400 font-bold text-sm mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-swords"></i> CH·ªà S·ªê S·ª®C M·∫†NH
                            </h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">S√°t th∆∞∆°ng g·ªëc (x)</label>
                                    <input type="number" id="edit-skill-mult" step="0.1" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-orange-500">
                                </div>
                                <div class="col-span-2 bg-gray-900/50 p-4 rounded-xl border border-gray-700 mt-4">
                                    <label class="block text-yellow-500 font-bold mb-3 uppercase text-sm">
                                        <i class="fa-solid fa-cogs"></i> C·∫•u h√¨nh N·ªôi T·∫°i (Passive)
                                    </label>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-xs text-gray-400 block mb-1">ƒêi·ªÅu ki·ªán k√≠ch ho·∫°t</label>
                                            <select id="passive-condition" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm focus:border-yellow-500 outline-none">
                                                <option value="always">Lu√¥n k√≠ch ho·∫°t (Vƒ©nh vi·ªÖn)</option>
                                                <option value="hp_below">HP D∆∞·ªõi ng∆∞·ª°ng (Nguy hi·ªÉm)</option>
                                                <option value="hp_above">HP Tr√™n ng∆∞·ª°ng (An to√†n)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-400 block mb-1">Ng∆∞·ª°ng k√≠ch ho·∫°t (VD: 0.5 l√† 50%)</label>
                                            <input type="number" step="0.1" id="passive-threshold" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm" placeholder="0.5">
                                        </div>

                                        <div>
                                            <label class="text-xs text-green-400 block mb-1">Lo·∫°i hi·ªáu ·ª©ng</label>
                                            <select id="passive-effect-type" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm focus:border-green-500 outline-none">
                                                <option value="heal">Ch·ªâ H·ªìi M√°u</option>
                                                <option value="heal_and_buff">V·ª´a H·ªìi M√°u + V·ª´a Buff</option>
                                            </select>
                                        </div>

                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-green-400 block mb-1">H·ªìi % Max HP</label>
                                                <input type="number" step="0.05" id="passive-heal-percent" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm" placeholder="0.3">
                                            </div>
                                            <div>
                                                <label class="text-xs text-green-400 block mb-1">H·ªìi HP C·ªë ƒë·ªãnh</label>
                                                <input type="number" id="passive-heal-flat" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm" placeholder="500">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <p class="text-[10px] text-gray-500 mt-2 italic">* Ch·ªçn "Lu√¥n k√≠ch ho·∫°t" th√¨ c√°c √¥ Ng∆∞·ª°ng/H·ªìi m√°u s·∫Ω b·ªã b·ªè qua.</p>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">VFX Class (CSS)</label>
                                    <input type="text" id="edit-skill-vfx" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-orange-500" placeholder="fx-meteor">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="testVFX()" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-xs transition">
                                        <i class="fa-solid fa-fire mr-1"></i> TEST VFX
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-900/50 rounded-lg border border-purple-900/30">
                            <h4 class="text-purple-400 font-bold text-sm mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-book-open"></i> CHI PH√ç Lƒ®NH NG·ªò (H·ªåC L·∫¶N ƒê·∫¶U)
                            </h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                
                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">Lo·∫°i Ti·ªÅn Y√™u C·∫ßu</label>
                                    <select id="edit-skill-currency" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-purple-500">
                                        <option value="TRI_THUC">Tri Th·ª©c (Xanh)</option>
                                        <option value="VINH_DU">Vinh D·ª± (T√≠m)</option>
                                        <option value="CHIEN_TICH">Chi·∫øn T√≠ch (Cam)</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-[10px] text-gray-500 uppercase mb-1">Gi√° Lƒ©nh Ng·ªô</label>
                                    <input type="number" id="edit-skill-cost" placeholder="VD: 100" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-purple-500">
                                </div>
                                
                                </div>
                                    <div class="mt-2 text-[10px] text-gray-400 italic">
                                        * L∆∞u √Ω: ƒê√¢y l√† chi ph√≠ ƒë·ªÉ h·ªçc k·ªπ nƒÉng level 1. C√°c level sau s·∫Ω n√¢ng c·∫•p b·∫±ng Item.
                                    </div>
                                </div>

                        <div class="flex justify-end gap-3 pt-6 border-t border-gray-700">
                            <button onclick="cancelEdit()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-sm transition">H·ª¶Y</button>
                            <button onclick="saveSkill()" class="px-8 py-2 bg-green-600 hover:bg-green-500 text-white rounded font-bold text-sm shadow-lg transition">
                                <i class="fa-solid fa-save mr-2"></i>L∆ØU K·ª∏ NƒÇNG
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-titles" class="tab-content hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">H·ªá Th·ªëng Danh Hi·ªáu</h2>
                
                <button onclick="document.getElementById('modal-create-title').classList.remove('hidden')" 
                        class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                    <i class="fas fa-plus mr-2"></i> Th√™m Danh Hi·ªáu
                </button>
            </div>

            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <table class="w-full text-left text-gray-300">
                    <thead class="bg-gray-900 text-gray-400 font-bold uppercase text-xs">
                        <tr>
                            <th class="p-4">M·ªëc KPI</th>
                            <th class="p-4">T√™n Danh Hi·ªáu</th>
                            <th class="p-4">M√†u S·∫Øc</th>
                            <th class="p-4 text-right">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="titles-list-body" class="divide-y divide-gray-700">
                        <tr><td colspan="4" class="p-4 text-center italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="modal-create-title" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-xl p-6 w-96 border border-gray-600 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4">Th√™m Danh Hi·ªáu M·ªõi</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400 text-sm">T√™n Danh Hi·ªáu</label>
                        <input type="text" id="inp-title-name" class="w-full bg-gray-900 text-white border border-gray-700 rounded p-2 mt-1 focus:border-pink-500 outline-none" placeholder="Vd: T√¢n Binh">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm">KPI Y√™u C·∫ßu</label>
                        <input type="number" id="inp-title-kpi" class="w-full bg-gray-900 text-white border border-gray-700 rounded p-2 mt-1 focus:border-pink-500 outline-none" placeholder="Vd: 100">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm">M√†u Hi·ªÉn Th·ªã</label>
                        <div class="flex gap-2 mt-1">
                            <input type="color" id="inp-title-color" class="h-10 w-12 cursor-pointer bg-transparent border-0" value="#fbbf24">
                            <input type="text" id="inp-title-color-text" class="flex-1 bg-gray-900 text-white border border-gray-700 rounded p-2" value="#fbbf24" onchange="document.getElementById('inp-title-color').value = this.value">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="document.getElementById('modal-create-title').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">H·ªßy</button>
                    <button onclick="createTitleSubmit()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded">L∆∞u L·∫°i</button>
                </div>
            </div>
        </div>

        <div id="tab-arena" class="tab-content hidden p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Qu·∫£n L√Ω L√¥i ƒê√†i</h2>
                <button onclick="loadAdminArenaData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                    <i class="fas fa-sync-alt mr-2"></i> L√†m M·ªõi D·ªØ Li·ªáu
                </button>
            </div>

            <div class="bg-gray-800 rounded-xl p-5 mb-8 border border-gray-700">
                <h3 class="text-lg font-bold text-yellow-500 mb-4 flex items-center">
                    <i class="fas fa-hourglass-half mr-2"></i> Tr·∫≠n ƒê·∫•u ƒêang Treo (C·∫ßn x·ª≠ l√Ω)
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-gray-300">
                        <thead class="bg-gray-700 text-gray-400 uppercase text-xs">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Ng∆∞·ªùi T·∫°o</th>
                                <th class="p-3 text-center">M·ª©c C∆∞·ª£c</th>
                                <th class="p-3">Ng√†y T·∫°o (VN)</th>
                                <th class="p-3 text-right">Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="admin-pending-matches-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <h3 class="text-lg font-bold text-green-500 mb-4 flex items-center">
                    <i class="fas fa-history mr-2"></i> Nh·∫≠t K√Ω Chi·∫øn Tr∆∞·ªùng To√†n Server
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-gray-300">
                        <thead class="bg-gray-700 text-gray-400 uppercase text-xs">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Ch·∫ø ƒê·ªô</th>
                                <th class="p-3 text-center">K·∫øt Qu·∫£</th>
                                <th class="p-3">Th·ªùi Gian Xong</th>
                                <th class="p-3 text-right">Chi Ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody id="admin-match-history-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-notifications" class="tab-content hidden p-6">
            <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-600 pb-2">üì¢ C·∫•u H√¨nh Th√¥ng B√°o H·ªá Th·ªëng</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4"><i class="fas fa-scroll mr-2"></i>Ch·∫°y Ch·ªØ (Header)</h3>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="marquee-input" placeholder="Nh·∫≠p n·ªôi dung ch·∫°y ch·ªØ..." 
                            class="flex-1 bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-yellow-500 outline-none">
                        
                        <button onclick="addNotification('marquee')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition font-bold whitespace-nowrap">
                            <i class="fas fa-plus"></i> Th√™m
                        </button>
                    </div>

                    <div id="marquee-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                        </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700">
                    <h3 class="text-xl font-bold text-pink-400 mb-4"><i class="fas fa-window-restore mr-2"></i>Popup (Gi·ªØa m√†n h√¨nh)</h3>
                    
                    <div class="flex flex-col gap-2 mb-4">
                        <textarea id="popup-input" rows="3" placeholder="Nh·∫≠p n·ªôi dung Popup (H·ªó tr·ª£ HTML c∆° b·∫£n)..." 
                            class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-pink-500 outline-none"></textarea>
                        
                        <button onclick="addNotification('popup')" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded transition w-full font-bold">
                            <i class="fas fa-plus mr-2"></i> Th√™m Popup M·ªõi
                        </button>
                    </div>

                    <div id="popup-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                        </div>
                </div>
            </div>
        </div>

        <div id="tab-charm-settings" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                    üîÆ C·∫•u h√¨nh H·ªá th·ªëng Charm
                </h2>
                <button onclick="saveSystemConfig()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2">
                    üíæ L∆∞u C·∫•u H√¨nh
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                    <h3 class="text-xl font-bold text-purple-400 mb-4 border-b border-gray-700 pb-2">üì¶ Th√¥ng s·ªë Charm (Drop)</h3>
                    
                    <div class="mb-4 bg-gray-900/50 p-4 rounded border border-blue-500/30">
                        <div class="flex justify-between mb-2">
                            <span class="text-blue-400 font-bold">Ma Thu·∫≠t (Magic)</span>
                            <span class="text-xs text-gray-500">1 d√≤ng stats</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">ATK Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="magic-atk-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm" placeholder="Min">
                                    <input type="number" id="magic-atk-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm" placeholder="Max">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">HP Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="magic-hp-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm" placeholder="Min">
                                    <input type="number" id="magic-hp-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm" placeholder="Max">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 bg-gray-900/50 p-4 rounded border border-purple-500/30">
                        <div class="flex justify-between mb-2">
                            <span class="text-purple-400 font-bold">S·ª≠ Thi (Epic)</span>
                            <span class="text-xs text-gray-500">2 d√≤ng stats</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">ATK Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="epic-atk-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                    <input type="number" id="epic-atk-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">HP Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="epic-hp-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                    <input type="number" id="epic-hp-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 bg-gray-900/50 p-4 rounded border border-yellow-500/30">
                        <div class="flex justify-between mb-2">
                            <span class="text-yellow-400 font-bold">Huy·ªÅn Tho·∫°i (Legend)</span>
                            <span class="text-xs text-gray-500">2 d√≤ng stats (Max)</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">ATK Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="legend-atk-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                    <input type="number" id="legend-atk-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">HP Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="legend-hp-min" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                    <input type="number" id="legend-hp-max" class="w-full bg-gray-700 rounded px-2 py-1 text-white text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                    <h3 class="text-xl font-bold text-orange-500 mb-4 border-b border-gray-700 pb-2">üî• Th√¥ng s·ªë L√≤ R√®n (Upgrade)</h3>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-4 gap-2 items-center text-sm p-3 bg-gray-900/50 rounded">
                            <div class="col-span-1 font-bold text-gray-400">C·∫•p +1 ‚ûî +3</div>
                            <div class="col-span-1"><input type="number" id="forge-g1-rate" class="w-full bg-gray-700 rounded px-2 py-1 text-green-400" placeholder="% Win"></div>
                            <div class="col-span-1"><input type="number" id="forge-g1-stone" class="w-full bg-gray-700 rounded px-2 py-1 text-yellow-400" placeholder="ƒê√° t·ªën"></div>
                            <div class="col-span-1"><input type="number" id="forge-g1-bonus" class="w-full bg-gray-700 rounded px-2 py-1 text-blue-400" placeholder="% TƒÉng"></div>
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center text-sm p-3 bg-gray-900/50 rounded">
                            <div class="col-span-1 font-bold text-orange-400">C·∫•p +4 ‚ûî +7</div>
                            <div class="col-span-1"><input type="number" id="forge-g2-rate" class="w-full bg-gray-700 rounded px-2 py-1 text-green-400"></div>
                            <div class="col-span-1"><input type="number" id="forge-g2-stone" class="w-full bg-gray-700 rounded px-2 py-1 text-yellow-400"></div>
                            <div class="col-span-1"><input type="number" id="forge-g2-bonus" class="w-full bg-gray-700 rounded px-2 py-1 text-blue-400"></div>
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center text-sm p-3 bg-gray-900/50 rounded">
                            <div class="col-span-1 font-bold text-red-500">C·∫•p +8 ‚ûî +10</div>
                            <div class="col-span-1"><input type="number" id="forge-g3-rate" class="w-full bg-gray-700 rounded px-2 py-1 text-green-400"></div>
                            <div class="col-span-1"><input type="number" id="forge-g3-stone" class="w-full bg-gray-700 rounded px-2 py-1 text-yellow-400"></div>
                            <div class="col-span-1"><input type="number" id="forge-g3-bonus" class="w-full bg-gray-700 rounded px-2 py-1 text-blue-400"></div>
                        </div>
                    </div>

                    <div class="mt-6 text-xs text-gray-500 italic">
                        * L∆∞u √Ω: T·ª∑ l·ªá Win t√≠nh theo %, ƒê√° t·ªën l√† s·ªë l∆∞·ª£ng vi√™n c·∫ßn, % TƒÉng l√† ch·ªâ s·ªë c·ªông th√™m so v·ªõi g·ªëc.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        
        var vfxTimer = null; 
        let adminAllSkills = []; // L∆∞u to√†n b·ªô skill t·∫£i t·ª´ server
        let currentFilter = 'WARRIOR'; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã Warrior tr∆∞·ªõc
        let currentBossDrops = [];

        // --- H√ÄM CHUY·ªÇN TAB ƒê√É S·ª¨A L·ªñI (ƒê·ªíNG B·ªò CSS & TAILWIND) ---
        function switchTab(tabName) {
            console.log("ƒêang chuy·ªÉn sang tab:", tabName);

            // --- 1. ·∫®N T·∫§T C·∫¢ C√ÅC TAB ---
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
                el.classList.add('hidden');
            });

            // --- 2. HI·ªÜN TAB C·∫¶N CH·ªåN ---
            const targetId = 'tab-' + tabName;
            const target = document.getElementById(targetId);

            if (target) {
                target.classList.remove('hidden');
                target.classList.add('active'); 
            } else {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y tab ID:", targetId);
                return;
            }

            // --- 3. X·ª¨ L√ù ACTIVE BUTTON (C√°ch an to√†n h∆°n) ---
            // T√¨m n√∫t c√≥ data-tab tr√πng v·ªõi tabName, ho·∫∑c check onclick nh∆∞ c≈© n·∫øu l∆∞·ªùi s·ª≠a HTML
            const navButtons = document.querySelectorAll('.nav-item');
            
            navButtons.forEach(btn => {
                // Reset style c≈©
                btn.classList.remove('active-tab', 'bg-gray-700', 'border-yellow-500', 'text-white');
                btn.classList.add('text-gray-300', 'border-transparent');

                // L·∫•y t√™n tab t·ª´ data-tab (∆Øu ti√™n) ho·∫∑c parse t·ª´ onclick (D·ª± ph√≤ng)
                const btnTab = btn.getAttribute('data-tab'); 
                const clickAttr = btn.getAttribute('onclick');
                
                // ƒêi·ªÅu ki·ªán: N·∫øu data-tab tr√πng HO·∫∂C onclick ch·ª©a t√™n tab
                const isMatch = (btnTab === tabName) || 
                                (!btnTab && clickAttr && clickAttr.includes(`'${tabName}'`));

                if (isMatch) {
                    btn.classList.add('active-tab', 'bg-gray-700', 'border-yellow-500', 'text-white');
                    btn.classList.remove('text-gray-300', 'border-transparent');
                }
            });

            // --- 4. LAZY LOAD DATA (D√πng switch case cho g·ªçn & d·ªÖ ƒë·ªçc) ---
            // Helper function ƒë·ªÉ g·ªçi h√†m an to√†n
            const safeCall = (fnName) => {
                if (typeof window[fnName] === 'function') window[fnName](); // G·ªçi h√†m global
                else if (typeof eval(fnName) === 'function') eval(fnName)(); // Fallback n·∫øu h√†m c·ª•c b·ªô (√≠t d√πng eval h∆°n)
            };

            // C√°ch th·ªß c√¥ng nh∆∞ng an to√†n v√† d·ªÖ debug h∆°n eval:
            switch (tabName) {
                case 'arena': // üëà Th√™m case n√†y cho L√¥i ƒê√†i
                    if (typeof loadAdminArenaData === 'function') loadAdminArenaData();
                    break;
                case 'boss':
                    if (typeof loadCurrentBoss === 'function') loadCurrentBoss();
                    break;
                case 'security':
                    if (typeof loadSecurityTable === 'function') loadSecurityTable();
                    break;
                case 'dashboard':
                    if (typeof loadOverview === 'function') loadOverview();
                    break;
                case 'shop':
                    if (typeof loadShopItems === 'function') loadShopItems();
                    break;
                case 'dungeon-tower':
                    if (typeof loadTowerQuestions === 'function') loadTowerQuestions();
                    if (typeof loadTowerStats === 'function') loadTowerStats();
                    break;
                case 'pet':
                    if (typeof loadPets === 'function') loadPets();
                    break;
                case 'skills': // T√™n tabId m√† b·∫°n ƒë√£ ƒë·∫∑t cho n√∫t b·∫•m v√† div n·ªôi dung
                    if (typeof loadAdminSkills === 'function') loadAdminSkills();
                    break;
                case 'notifications': 
                    if (typeof loadNotifications === 'function') loadNotifications();
                    break;
                case 'charm-settings': // üëà T√™n tab m·ªõi
                    if (typeof loadSystemConfig === 'function') {
                        loadSystemConfig(); // G·ªçi h√†m load API Admin m√† ta v·ª´a vi·∫øt
                    }
                    break;
                default:
                    console.log("Tab n√†y ch∆∞a c√≥ h√†m load d·ªØ li·ªáu ri√™ng.");
            }
        }



        // --- 2. H√ÄM TOGGLE DANH S√ÅCH (THEO CODE C·ª¶A B·∫†N) ---
        
        // Bi·∫øn to√†n c·ª•c (ƒë·ªÉ t∆∞∆°ng th√≠ch code c≈©)
        var allPlayers = []; 

        function togglePlayerList() {
            // ID kh·ªõp v·ªõi code b·∫°n g·ª≠i: player-list-area
            const listArea = document.getElementById('player-list-area'); 
            const icon = document.getElementById('chevron-icon');
            
            if (listArea) {
                if (listArea.classList.contains('hidden')) {
                    listArea.classList.remove('hidden');
                    if(icon) icon.style.transform = 'rotate(180deg)';
                    
                    // G·ªçi h√†m load d·ªØ li·ªáu m·ªõi nh·∫•t (loadOverview)
                    if(typeof loadOverview === 'function') loadOverview();
                } else {
                    listArea.classList.add('hidden');
                    if(icon) icon.style.transform = 'rotate(0deg)';
                }
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y ID 'player-list-area' trong HTML");
            }
        }
        // H√ÄM T·∫¢I D·ªÆ LI·ªÜU (ƒê√£ s·ª≠a l·ªói l·ªách c·ªôt)
        async function loadOverview() {
            try {
                // 1. G·ªçi API l·∫•y d·ªØ li·ªáu
                const response = await fetch('/admin/players/overview');
                allPlayers = await response.json();
                
                const tableBody = document.getElementById('player-table-body');
                const playerSelects = document.querySelectorAll('.player-select');
                
                // X√≥a d·ªØ li·ªáu c≈© trong b·∫£ng
                if(tableBody) tableBody.innerHTML = '';
                
                // C·∫≠p nh·∫≠t Dropdown (Gi·ªØ nguy√™n)
                playerSelects.forEach(select => {
                    select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sƒ© --</option>' +
                                     '<option value="ALL" class="font-bold text-yellow-400 bg-gray-700">--- üì¢ √ÅP D·ª§NG CHO TO√ÄN L·ªöP ---</option>';
                });

                // 2. V·∫Ω b·∫£ng danh s√°ch
                allPlayers.forEach(p => {
                    // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n T·ªï cho ƒë·∫πp
                    let teamDisplay = '';
                    if (p.team_id === 0) {
                        teamDisplay = '<span class="text-gray-500 italic">Ch∆∞a c√≥</span>';
                    } else {
                        teamDisplay = '<span class="px-2 py-1 rounded bg-blue-900 text-blue-300 font-bold text-xs">T·ªï ' + p.team_id + '</span>';
                    }

                    // B·∫Øt ƒë·∫ßu t·∫°o h√†ng (row)
                    let row = '';
                    row += '<tr class="border-b border-gray-700 hover:bg-gray-750 transition">';
                    
                    // C·ªòT 1: ID
                    row +=      '<td class="px-6 py-3 font-mono text-gray-500">' + p.id + '</td>';
                    
                    // C·ªòT 2: H·ªåC Sƒ® (T√™n & Username)
                    row +=      '<td class="px-6 py-3">';
                    row +=          '<div class="font-bold text-blue-300">' + p.full_name + '</div>';
                    row +=          '<div class="text-[10px] text-gray-500">@' + p.username + '</div>';
                    row +=      '</td>';
                    
                    // C·ªòT 3: T·ªî (ƒê√ÇY L√Ä C·ªòT M·ªöI ƒê∆Ø·ª¢C TH√äM ƒê·ªÇ H·∫æT L·ªÜCH)
                    row +=      '<td class="px-6 py-3 text-center">';
                    row +=          teamDisplay;
                    row +=      '</td>';
                    
                    // C·ªòT 4: C√ÅC CH·ªà S·ªê (KPI, Tri th·ª©c...)
                    row +=      '<td class="px-6 py-3 text-center">';
                    row +=          '<div class="flex items-center justify-center space-x-2 text-xs">';
                    row +=              '<span class="text-green-400 font-bold" title="KPI">' + p.kpi + '</span> <span class="text-gray-600">|</span> ';
                    row +=              '<span class="text-blue-400" title="Tri Th·ª©c">' + p.tri_thuc + '</span> <span class="text-gray-600">/</span> ';
                    row +=              '<span class="text-orange-400" title="Chi·∫øn T√≠ch">' + p.chien_tich + '</span> <span class="text-gray-600">/</span> ';
                    row +=              '<span class="text-purple-400" title="Vinh D·ª±">' + p.vinh_du + '</span> <span class="text-gray-600">/</span> ';
                    row +=              '<span class="text-red-400" title="HP">' + p.hp + '/' + p.hp_max + '</span>';
                    row +=          '</div>';
                    row +=      '</td>';
                    
                    // C·ªòT 5: THAO T√ÅC (Input + N√∫t)
                    row +=      '<td class="px-6 py-3 text-right">';
                    row +=          '<div class="flex items-center justify-end space-x-2">';
                    row +=              '<input type="number" id="input-' + p.id + '" value="0" class="w-16 bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs outline-none text-center focus:border-green-500">';
                    row +=              '<button onclick="handleUpdate(' + p.id + ', \'add\')" class="bg-green-600 hover:bg-green-700 p-1 px-2 rounded text-xs text-white font-bold" title="C·ªông">+</button>';
                    row +=              '<button onclick="handleUpdate(' + p.id + ', \'sub\')" class="bg-red-600 hover:bg-red-700 p-1 px-2 rounded text-xs text-white font-bold" title="Tr·ª´">-</button>';
                    row +=          '</div>';
                    row +=      '</td>';
                    
                    row += '</tr>';
                    
                    if(tableBody) tableBody.innerHTML += row;

                    // Th√™m option v√†o dropdown
                    playerSelects.forEach(select => {
                        select.innerHTML += '<option value="' + p.id + '">' + p.full_name + '</option>';
                    });
                });
                
                // V·∫Ω l·∫°i s∆° ƒë·ªì 4 t·ªï (N·∫øu h√†m n√†y t·ªìn t·∫°i)
                if(typeof refreshTeamUI === 'function') refreshTeamUI(allPlayers);
                loadResetDropdown();
                loadSecurityTable();
                loadCurrentBoss()
            } catch (error) { console.error("L·ªói n·∫°p danh s√°ch:", error); }
        }

        // H√ÄM C·∫¨P NH·∫¨T NHANH (ƒê√£ s·ª≠a l·ªói c√∫ ph√°p fetch)
        async function handleUpdate(id, mode) {
            const inputEl = document.getElementById('input-' + id);
            const inputVal = parseInt(inputEl.value);
            
            if (isNaN(inputVal) || inputVal <= 0) {
                alert("Vui l√≤ng nh·∫≠p m·ªôt s·ªë l·ªõn h∆°n 0");
                return;
            }
            const change = mode === 'add' ? inputVal : -inputVal;
            
            try {
                // URL an to√†n
                const url = '/admin/players/' + id + '/stats?kpi_change=' + change;
                
                const res = await fetch(url, { method: 'PATCH' }); // ƒê√É S·ª¨A L·ªñI C√ö PH√ÅP ·ªû ƒê√ÇY
                
                if (res.ok) { 
                    loadOverview(); // G·ªçi l·∫°i h√†m load ch√≠nh
                } else {
                    alert("L·ªói c·∫≠p nh·∫≠t!");
                }
            } catch (error) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // 2. H√†m X·ª≠ l√Ω Khen th∆∞·ªüng/Ph·∫°t (KPI) - PHI√äN B·∫¢N AN TO√ÄN (KH√îNG D√ôNG BACKTICK)
        async function sendFormalReward(multiplier) {
            const id = document.getElementById('reward-player-id').value;
            const amountStr = document.getElementById('reward-amount').value;
            
            // Chuy·ªÉn v·ªÅ s·ªë nguy√™n
            let amount = parseInt(amountStr);

            if (!id || isNaN(amount) || amount <= 0) {
                alert("Vui l√≤ng ch·ªçn ƒë·ªëi t∆∞·ª£ng v√† nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!");
                return;
            }

            amount = amount * multiplier; // Th∆∞·ªüng l√† d∆∞∆°ng, Ph·∫°t l√† √¢m
            const actionType = multiplier > 0 ? "Th∆∞·ªüng" : "Ph·∫°t";

            // X√°c nh·∫≠n n·∫øu l√† l√†m h√†ng lo·∫°t (D√πng nh√°y ƒë∆°n + c·ªông chu·ªói ƒë·ªÉ tr√°nh l·ªói)
            if (id === 'ALL') {
                const confirmMsg = '‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën ' + actionType + ' ' + Math.abs(amount) + ' KPI cho TO√ÄN B·ªò L·ªöP kh√¥ng?';
                if (!confirm(confirmMsg)) return;
            }

            try {
                // Log th√¥ng b√°o (D√πng nh√°y ƒë∆°n)
                if (typeof logSystem === 'function') {
                    logSystem('ƒêang th·ª±c hi·ªán ' + actionType + '...', 'info');
                }

                // T·∫°o URL b·∫±ng c√°ch c·ªông chu·ªói (An to√†n nh·∫•t)
                const url = '/admin/players/' + id + '/stats?kpi_change=' + amount;

                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (data.success) {
                    // Th√¥ng b√°o th√†nh c√¥ng
                    if (typeof logSystem === 'function') {
                        logSystem('‚úÖ ' + data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    
                    // C·∫≠p nh·∫≠t l·∫°i b·∫£ng
                    if (typeof loadOverview === 'function') loadOverview();
                } else {
                    // Th√¥ng b√°o l·ªói
                    const errorMsg = '‚ùå L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh');
                    if (typeof logSystem === 'function') {
                        logSystem(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                if (typeof logSystem === 'function') {
                    logSystem('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!', 'error');
                } else {
                    alert('L·ªói k·∫øt n·ªëi server!');
                }
            }
        }

        // 3. H√†m n·∫°p danh s√°ch (An to√†n)
        async function loadPlayersToSelect() {
            try {
                const res = await fetch('/admin/players/overview');
                const players = await res.json();
                const selects = document.querySelectorAll('.player-select');
                
                selects.forEach(select => {
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);

                    players.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.full_name + ' (T·ªï ' + p.team_id + ')'; 
                        select.appendChild(opt);
                    });
                });
            } catch (e) { console.error(e); }
        }

        // G·ªçi h√†m n√†y khi trang web v·ª´a load xong
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayersToSelect();
        });



        // 3. H√†m X·ª≠ l√Ω Ti·ªÅn t·ªá (Tri th·ª©c, Vinh d·ª±...) - PHI√äN B·∫¢N K·∫æT N·ªêI API & AN TO√ÄN
        async function sendGiftCurrency(multiplier) {
            const id = document.getElementById('gift-player-id').value;
            const type = document.getElementById('currency-type').value;
            const amountStr = document.getElementById('currency-amount').value;
            let amount = parseInt(amountStr);

            // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
            if (!id || !type || isNaN(amount) || amount <= 0) {
                alert("Vui l√≤ng ch·ªçn h·ªçc sinh, lo·∫°i t√†i nguy√™n v√† nh·∫≠p s·ªë l∆∞·ª£ng!");
                return;
            }

            amount = amount * multiplier; // D∆∞∆°ng l√† t·∫∑ng, √Çm l√† thu h·ªìi
            const actionName = multiplier > 0 ? "T·∫∑ng" : "Thu h·ªìi";

            // X√°c nh·∫≠n h√†nh ƒë·ªông (D√πng nh√°y ƒë∆°n + c·ªông chu·ªói)
            if (id === 'ALL') {
                const confirmMsg = '‚ö†Ô∏è X√°c nh·∫≠n: ' + actionName + ' ' + Math.abs(amount) + ' [' + type + '] cho T·∫§T C·∫¢ h·ªçc sinh?';
                if (!confirm(confirmMsg)) return;
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang x·ª≠ l√Ω...', 'info');

                const paramName = type + '_change';
                
                // T·∫°o URL: /admin/players/{id}/stats?{lo·∫°i_ti·ªÅn}_change={s·ªë_l∆∞·ª£ng}
                const url = '/admin/players/' + id + '/stats?' + paramName + '=' + amount;

                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    if (typeof loadOverview === 'function') loadOverview(); // Load l·∫°i b·∫£ng ngay
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // 4. H√†m X·ª≠ l√Ω V·∫≠t ph·∫©m (Item) - PHI√äN B·∫¢N AN TO√ÄN & LOOP FRONTEND
        async function sendGiftItem(multiplier) {
            const id = document.getElementById('gift-player-id').value;
            const itemId = document.getElementById('item-template-select').value;
            const qtyStr = document.getElementById('item-qty').value;
            let qty = parseInt(qtyStr);

            // Ki·ªÉm tra ƒë·∫ßu v√†o
            if (!id || !itemId || isNaN(qty) || qty <= 0) {
                alert("Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n, v·∫≠t ph·∫©m v√† nh·∫≠p s·ªë l∆∞·ª£ng!");
                return;
            }

            // T√≠nh to√°n s·ªë l∆∞·ª£ng th·ª±c (D∆∞∆°ng: G·ª≠i, √Çm: X√≥a)
            const finalQty = qty * multiplier;
            const actionName = multiplier > 0 ? "G·ª≠i" : "X√≥a";

            // --- TR∆Ø·ªúNG H·ª¢P 1: √ÅP D·ª§NG CHO TO√ÄN L·ªöP (ALL) ---
            if (id === 'ALL') {
                const confirmMsg = 'üì¶ X√°c nh·∫≠n: ' + actionName + ' ' + qty + ' v·∫≠t ph·∫©m n√†y cho TO√ÄN B·ªò L·ªöP?';
                if (!confirm(confirmMsg)) return;

                if (typeof logSystem === 'function') logSystem('ƒêang x·ª≠ l√Ω h√†ng lo·∫°t...', 'info');

                try {
                    // B∆∞·ªõc 1: L·∫•y danh s√°ch ID h·ªçc sinh v·ªÅ tr∆∞·ªõc
                    const resList = await fetch('/admin/players/overview');
                    const players = await resList.json();

                    let count = 0;
                    // B∆∞·ªõc 2: Ch·∫°y v√≤ng l·∫∑p g·ª≠i t·ª´ng ng∆∞·ªùi
                    for (var i = 0; i < players.length; i++) {
                        const p = players[i];
                        const url = '/admin/players/' + p.id + '/items?item_id=' + itemId + '&quantity=' + finalQty;
                        
                        // G·ª≠i l·ªánh (kh√¥ng c·∫ßn await ƒë·ªÉ ch·∫°y song song cho nhanh, ho·∫∑c await ƒë·ªÉ an to√†n)
                        await fetch(url, { method: 'POST' });
                        count++;
                    }

                    if (typeof logSystem === 'function') logSystem('‚úÖ ƒê√£ x·ª≠ l√Ω xong cho ' + count + ' h·ªçc sinh.', 'success');
                    if (typeof loadOverview === 'function') loadOverview();

                } catch (e) {
                    console.error(e);
                    alert('L·ªói trong qu√° tr√¨nh x·ª≠ l√Ω h√†ng lo·∫°t!');
                }
                return; // K·∫øt th√∫c h√†m
            }

            // --- TR∆Ø·ªúNG H·ª¢P 2: √ÅP D·ª§NG C√Å NH√ÇN ---
            try {
                if (typeof logSystem === 'function') logSystem('ƒêang ' + actionName + '...', 'info');

                // T·∫°o URL v·ªõi query parameters
                const url = '/admin/players/' + id + '/items?item_id=' + itemId + '&quantity=' + finalQty;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    if (typeof loadOverview === 'function') loadOverview();
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù M·ªöI CHO T·ªî ƒê·ªòI & EXCEL (PHI√äN B·∫¢N AN TO√ÄN) ---

        // 1. H√†m Log Debug (Ghi nh·∫≠t k√Ω h·ªá th·ªëng ra m√†n h√¨nh)
        function logSystem(message, type) {
            // M·∫∑c ƒë·ªãnh type l√† 'info' n·∫øu kh√¥ng truy·ªÅn
            if (!type) type = 'info';

            const consoleDiv = document.getElementById('debug-console');
            const contentDiv = document.getElementById('log-content');
            
            // Hi·ªán khung log n·∫øu ƒëang ·∫©n
            if (consoleDiv) consoleDiv.classList.remove('hidden');
            
            // Ch·ªçn m√†u ch·ªØ (D√πng to√°n t·ª≠ 3 ng√¥i an to√†n)
            const color = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
            const time = new Date().toLocaleTimeString();
            const logLine = '<div class="' + color + '">[' + time + '] ' + message + '</div>';
            
            if (contentDiv) {
                contentDiv.innerHTML += logLine;
                // T·ª± ƒë·ªông cu·ªôn xu·ªëng d√≤ng cu·ªëi c√πng
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        }

        // 2. X·ª≠ l√Ω Upload File Excel (K·∫æT N·ªêI API TH·∫¨T)
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Ki·ªÉm tra ƒëu√¥i file
            if (!file.name.endsWith('.xlsx')) {
                alert("Vui l√≤ng ch·ªâ ch·ªçn file Excel (.xlsx)");
                return;
            }

            if (typeof logSystem === 'function') logSystem('ƒêang ƒë·∫©y file l√™n m√°y ch·ªß...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                // G·ªçi API Python ch√∫ng ta v·ª´a vi·∫øt ·ªü B∆∞·ªõc 2
                const res = await fetch('/admin/import-excel', { 
                    method: 'POST', 
                    body: formData 
                });
                
                const data = await res.json();

                if (res.ok && data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    
                    // T·∫£i l·∫°i b·∫£ng ƒë·ªÉ th·∫•y h·ªçc sinh m·ªõi
                    if (typeof loadOverview === 'function') loadOverview(); 
                    alert("N·∫°p th√†nh c√¥ng!");
                } else {
                    throw new Error(data.detail || "L·ªói server");
                }

            } catch (error) {
                console.error(error);
                if (typeof logSystem === 'function') logSystem('‚ùå L·ªñI: ' + error.message, 'error');
                alert("L·ªói khi n·∫°p file: " + error.message);
            } finally {
                input.value = ''; // Reset input ƒë·ªÉ ch·ªçn l·∫°i file ƒë∆∞·ª£c
            }
        }

        // 3. H√†m Render Th·∫ª H·ªçc Sinh (PHI√äN B·∫¢N AN TO√ÄN - KH√îNG BACKTICK)
        function renderTeamMemberCard(player) {
            let roleIcon = '';
            let roleClass = 'border-gray-600 bg-gray-700/30'; 
            
            // X·ª≠ l√Ω icon ch·ª©c v·ª• (D√πng nh√°y ƒë∆°n)
            if (player.role === 'U1') {
                roleIcon = '<i class="fa-solid fa-crown text-yellow-400 text-xs ml-2" title="T·ªï Tr∆∞·ªüng"></i>';
                roleClass = 'border-yellow-600/50 bg-yellow-900/20';
            } else if (player.role === 'U2') {
                roleIcon = '<i class="fa-solid fa-shield-halved text-blue-400 text-xs ml-2" title="T·ªï Ph√≥"></i>';
                roleClass = 'border-blue-600/50 bg-blue-900/20';
            }
            
            let html = '';
            html += '<div class="flex items-start justify-between p-3 rounded border ' + roleClass + ' group hover:bg-gray-700 transition cursor-pointer relative">';
            
            // Ph·∫ßn Avatar v√† T√™n
            html +=     '<div class="flex items-start w-full">';
            html +=         '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-xs mr-3 text-white mt-1">';
            html +=             getInitials(player.full_name);
            html +=         '</div>';
            
            html +=         '<div class="flex-1 min-w-0">';
            html +=             '<div class="font-bold text-sm text-gray-200 break-words leading-tight">';
            html +=                 player.full_name;
            html +=             '</div>';
            html +=             '<div class="text-[10px] text-gray-500 flex items-center mt-1">';
            html +=                 'KPI: ' + player.kpi + ' ' + roleIcon;
            html +=             '</div>';
            html +=         '</div>';
            html +=     '</div>';
            
            // Ph·∫ßn N√∫t b·∫•m (Hi·ªán khi hover)
            html +=     '<div class="hidden group-hover:flex flex-col gap-1 absolute right-2 top-2 bg-gray-800 p-1 rounded shadow-lg border border-gray-600 z-10">';
            
            // N√∫t ƒë·ªïi ch·ª©c v·ª•
            html +=         '<button onclick="changeRole(' + player.id + ')" class="text-xs bg-blue-600 p-1.5 rounded hover:bg-blue-500 text-white" title="ƒê·ªïi ch·ª©c v·ª•"><i class="fa-solid fa-user-tag"></i></button>';
            
            // N√∫t chuy·ªÉn t·ªï
            html +=         '<button onclick="moveToTeam(' + player.id + ')" class="text-xs bg-gray-600 p-1.5 rounded hover:bg-gray-500 text-white" title="Chuy·ªÉn t·ªï"><i class="fa-solid fa-arrow-right-arrow-left"></i></button>';
            
            // N√∫t x√≥a (Kick) - C·∫ßn c·∫©n th·∫≠n logic n√†y sau n√†y
            html +=         '<button onclick="kickMember(' + player.id + ')" class="text-xs bg-red-600 p-1.5 rounded hover:bg-red-500 text-white" title="X√≥a"><i class="fa-solid fa-trash"></i></button>';
            
            html +=     '</div>';
            html += '</div>';

            return html;
        }

        // H√†m ph·ª• tr·ª£ l·∫•y ch·ªØ c√°i ƒë·∫ßu (Gi·ªØ nguy√™n ho·∫∑c th√™m v√†o n·∫øu thi·∫øu)
        function getInitials(name) {
            if (!name) return '??';
            const parts = name.split(' ');
            // L·∫•y 2 t·ª´ cu·ªëi c√πng (V√≠ d·ª•: Nguyen Van An -> VA)
            if (parts.length >= 2) return parts[parts.length - 2].charAt(0) + parts[parts.length - 1].charAt(0);
            return name.charAt(0);
        }

        // --- BI·∫æN TO√ÄN C·ª§C M·ªöI ---
        let currentTargetTeamId = null;

        // 1. H√†m m·ªü Modal (L·∫•y danh s√°ch h·ªçc sinh m·ªõi nh·∫•t t·ª´ Server)
        async function openAddMemberModal(teamId) {
            currentTargetTeamId = teamId;
            document.getElementById('modal-target-team').innerText = teamId;
            
            const select = document.getElementById('modal-student-select');
            // Reset dropdown
            select.innerHTML = '<option value="">-- ƒêang t·∫£i danh s√°ch... --</option>';
            document.getElementById('add-member-modal').classList.remove('hidden');

            try {
                // G·ªçi API l·∫•y danh s√°ch m·ªõi nh·∫•t ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã s√≥t ai
                const res = await fetch('/admin/players/overview');
                const players = await res.json();
                
                select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sinh --</option>';
                
                players.forEach(p => {
                    let currentTeamStr = '(Ch∆∞a c√≥ t·ªï)';
                    if (p.team_id && p.team_id > 0) {
                        currentTeamStr = '(ƒêang ·ªü T·ªï ' + p.team_id + ')';
                    }
                    
                    const optionHtml = '<option value="' + p.id + '">' + p.full_name + ' - ' + currentTeamStr + '</option>';
                    select.innerHTML += optionHtml;
                });
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">L·ªói t·∫£i d·ªØ li·ªáu</option>';
            }
        }

        // 2. H√†m ƒë√≥ng Modal
        function closeAddMemberModal() {
            document.getElementById('add-member-modal').classList.add('hidden');
            currentTargetTeamId = null;
        }

        // 3. H√†m X·ª≠ l√Ω khi b·∫•m n√∫t "X√°c nh·∫≠n" (K·∫æT N·ªêI API TH·∫¨T)
        async function submitAddMember() {
            const studentId = document.getElementById('modal-student-select').value;
            
            if (!studentId || !currentTargetTeamId) {
                alert("Vui l√≤ng ch·ªçn h·ªçc sinh!");
                return;
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang th√™m th√†nh vi√™n...', 'info');

                // G·ªçi API PATCH /admin/players/{id}/team
                // Body g·ª≠i l√™n: { "team_id": s·ªë_t·ªï }
                const url = '/admin/players/' + studentId + '/team';
                
                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team_id: currentTargetTeamId })
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    
                    // Reload l·∫°i to√†n b·ªô giao di·ªán (B·∫£ng + S∆° ƒë·ªì t·ªï)
                    if (typeof loadOverview === 'function') loadOverview();
                    
                    closeAddMemberModal(); // ƒê√≥ng modal
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }

            } catch (error) {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // 4. H√†m v·∫Ω l·∫°i giao di·ªán 4 T·ªï (QUAN TR·ªåNG - PHI√äN B·∫¢N AN TO√ÄN)
        // H√†m n√†y nh·∫≠n danh s√°ch h·ªçc sinh (players) ƒë·ªÉ v·∫Ω. 
        function refreshTeamUI(players) {
            // N·∫øu kh√¥ng truy·ªÅn v√†o danh s√°ch th√¨ l·∫•y t·ª´ bi·∫øn to√†n c·ª•c (n·∫øu c√≥)
            const dataToRender = players || window.allPlayers || [];
            
            // B∆∞·ªõc 1: X√≥a s·∫°ch danh s√°ch c≈© c·ªßa 4 t·ªï
            for(var i=1; i<=4; i++) {
                const listDiv = document.getElementById('team-' + i + '-list');
                if(listDiv) listDiv.innerHTML = '';
            }

            // B∆∞·ªõc 2: Duy·ªát qua t·∫•t c·∫£ h·ªçc sinh v√† chia b√†i v·ªÅ ƒë√∫ng t·ªï
            dataToRender.forEach(p => {
                // Ki·ªÉm tra n·∫øu h·ªçc sinh c√≥ team_id h·ª£p l·ªá (1-4)
                if (p.team_id >= 1 && p.team_id <= 4) {
                    const listDiv = document.getElementById('team-' + p.team_id + '-list');
                    if(listDiv) {
                        // G·ªçi h√†m renderTeamMemberCard (ƒë√£ vi·∫øt ·ªü b∆∞·ªõc tr∆∞·ªõc)
                        listDiv.innerHTML += renderTeamMemberCard(p);
                    }
                }
            });
            
            // B∆∞·ªõc 3: C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh vi√™n (Badge ƒë·∫øm s·ªë)
            for(var i=1; i<=4; i++) {
                const listDiv = document.getElementById('team-' + i + '-list');
                if (listDiv && listDiv.parentElement) {
                    const countSpan = listDiv.parentElement.querySelector('span.text-xs');
                    if(countSpan) {
                        // C·∫≠p nh·∫≠t text ƒë·∫øm s·ªë (D√πng c·ªông chu·ªói an to√†n)
                        countSpan.innerText = listDiv.children.length + ' th√†nh vi√™n';
                    }
                }
            }
        }

        // 5. H√†m ƒê·ªïi ch·ª©c v·ª• (U1, U2, U3) - K·∫æT N·ªêI API TH·∫¨T
        async function changeRole(playerId) {
            // D√πng prompt ƒë·ªÉ nh·∫≠p li·ªáu nhanh
            const newRole = prompt("Nh·∫≠p ch·ª©c v·ª• m·ªõi (U1: T·ªï tr∆∞·ªüng, U2: T·ªï ph√≥, U3: Th√†nh vi√™n):", "U3");
            if (!newRole) return; 

            const validRoles = ['U1', 'U2', 'U3'];
            const roleUpper = newRole.toUpperCase().trim();

            if (!validRoles.includes(roleUpper)) {
                alert("Ch·ª©c v·ª• kh√¥ng h·ª£p l·ªá! Ch·ªâ ch·∫•p nh·∫≠n: U1, U2, U3");
                return;
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang c·∫≠p nh·∫≠t ch·ª©c v·ª•...', 'info');

                // --- G·ª¨I API PATCH ---
                const url = '/admin/players/' + playerId + '/role';
                
                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: roleUpper })
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    
                    // T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
                    if (typeof loadOverview === 'function') loadOverview();
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (e) { 
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // 6. H√†m Chuy·ªÉn t·ªï (K·∫æT N·ªêI API TH·∫¨T & AN TO√ÄN)
        async function moveToTeam(playerId) {
            const newTeamStr = prompt("Nh·∫≠p s·ªë th·ª© t·ª± t·ªï mu·ªën chuy·ªÉn ƒë·∫øn (1-4):");
            if (!newTeamStr) return;

            const newTeamId = parseInt(newTeamStr);
            if (isNaN(newTeamId) || newTeamId < 1 || newTeamId > 4) {
                alert("T·ªï kh√¥ng t·ªìn t·∫°i! Vui l√≤ng nh·∫≠p s·ªë t·ª´ 1 ƒë·∫øn 4.");
                return;
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang chuy·ªÉn sang T·ªï ' + newTeamId + '...', 'info');

                // G·ªçi API PATCH update team
                const url = '/admin/players/' + playerId + '/team';
                
                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team_id: newTeamId })
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ' + data.message, 'success');
                    // T·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán (H·ªçc sinh s·∫Ω t·ª± bay sang c·ªôt m·ªõi)
                    if (typeof loadOverview === 'function') loadOverview();
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (e) { 
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // 7. H√†m X√≥a kh·ªèi t·ªï (Kick) - K·∫æT N·ªêI API TH·∫¨T
        async function kickMember(playerId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√†nh vi√™n n√†y kh·ªèi t·ªï? H·ªç s·∫Ω tr·ªü th√†nh 'Ch∆∞a c√≥ t·ªï'.")) return;

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang x√≥a kh·ªèi t·ªï...', 'warning');

                // G·ªçi API chuy·ªÉn v·ªÅ team_id = 0 (Ch∆∞a c√≥ t·ªï)
                const url = '/admin/players/' + playerId + '/team';
                
                const res = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    // Backend quy ∆∞·ªõc team_id = 0 l√† ch∆∞a c√≥ t·ªï
                    body: JSON.stringify({ team_id: 0 }) 
                });

                const data = await res.json();

                if (data.success) {
                    if (typeof logSystem === 'function') logSystem('‚úÖ ƒê√£ x√≥a th√†nh vi√™n kh·ªèi t·ªï.', 'success');
                    if (typeof loadOverview === 'function') loadOverview();
                } else {
                    alert('L·ªói: ' + (data.detail || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (e) { 
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        }

        // 8. H√†m b·∫≠t/t·∫Øt hi·ªÉn th·ªã danh s√°ch t·ªï (Accordion - ƒê√É S·ª¨A L·ªñI ƒê√ìNG NGO·∫∂C)
        function toggleTeam(teamId) {
            // D√πng c·ªông chu·ªói an to√†n
            const content = document.getElementById('team-' + teamId + '-content');
            const icon = document.getElementById('icon-' + teamId);
            
            if (content) {
                if (content.classList.contains('hidden')) {
                    // M·ªü ra
                    content.classList.remove('hidden');
                    content.classList.add('flex');
                    if(icon) icon.style.transform = 'rotate(90deg)'; 
                } else {
                    // ƒê√≥ng l·∫°i
                    content.classList.add('hidden');
                    content.classList.remove('flex');
                    if(icon) icon.style.transform = 'rotate(0deg)'; 
                }
            }
        } 
        
        async function confirmResetAll() {
            if(!confirm("X√°c nh·∫≠n Reset TO√ÄN B·ªò v·ªÅ 123456?")) return;

            try {
                const res = await fetch('/admin/security/reset-all', { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    console.log("‚úÖ Th√†nh c√¥ng:", data);
                    alert("Reset th√†nh c√¥ng!");
                } else {
                    // üî• TOOL SOI L·ªñI T·∫†I CONSOLE:
                    console.group("%c ‚ùå L·ªñI SERVER PH√ÅT HI·ªÜN! ", "background: red; color: white; padding: 5px;");
                    console.error("Th√¥ng tin l·ªói:", data.detail.error_type);
                    console.warn("Chi ti·∫øt l·ªói (Traceback):");
                    console.log(data.detail.debug_info); // ƒê√¢y l√† n∆°i hi·ªán d√≤ng code n√†o b·ªã l·ªói
                    console.groupEnd();

                    alert("‚ùå L·ªói 500! H√£y nh·∫•n F12, v√†o tab Console ƒë·ªÉ xem d√≤ng code b·ªã l·ªói.");
                }
            } catch (error) {
                console.error("‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c l·ªói JS:", error);
            }
        }
        // 9. H√†m n·∫°p danh s√°ch v√†o Dropdown Reset PASS
        function loadResetDropdown() {
            const select = document.getElementById('reset-student-select');
            if (!select) return;

            select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sinh --</option>';

            if (window.allPlayers && window.allPlayers.length > 0) {
                window.allPlayers.forEach(p => {
                    const option = document.createElement('option');
                    // üëá THAY ID TH√ÄNH USERNAME
                    option.value = p.username; 
                    option.innerText = `${p.full_name} (@${p.username})`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">(Ch∆∞a c√≥ d·ªØ li·ªáu)</option>';
            }
        }

        // 10. H√†m x·ª≠ l√Ω n√∫t Reset
        async function handleSingleReset() {
            const select = document.getElementById('reset-student-select');
            const username = select.value; // L√∫c n√†y value ƒë√£ l√† username
            const selectedText = select.options[select.selectedIndex].text;

            if (!username) {
                alert("Vui l√≤ng ch·ªçn m·ªôt h·ªçc sinh!");
                return;
            }

            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën Reset m·∫≠t kh·∫©u c·ªßa [" + selectedText + "] v·ªÅ '123456'?")) {
                return;
            }

            try {
                // üëá G·ªåI API POST V·ªöI BODY JSON
                const res = await fetch('/admin/security/reset-password', { 
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ username: username }) 
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + data.message);
                    loadSecurityTable(); // C·∫≠p nh·∫≠t l·∫°i m·∫≠t kh·∫©u th√¥ l√™n b·∫£ng ngay l·∫≠p t·ª©c
                    select.value = ""; 
                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ reset"));
                }
            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        // 11. H√†m ƒê·ªïi M·∫≠t Kh·∫©u Admin (K·∫øt n·ªëi API th·∫≠t)
        async function handleChangeAdminPass() {
            const oldPass = document.getElementById('admin-old-pass').value;
            const newPass = document.getElementById('admin-new-pass').value;
            const confirmPass = document.getElementById('admin-confirm-pass').value;

            // Validate d·ªØ li·ªáu
            if (!oldPass || !newPass || !confirmPass) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            if (newPass !== confirmPass) {
                alert("M·∫≠t kh·∫©u m·ªõi v√† Nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");
                return;
            }

            if (newPass.length < 6) {
                alert("M·∫≠t kh·∫©u m·ªõi n√™n d√†i h∆°n 6 k√Ω t·ª± ƒë·ªÉ an to√†n.");
                // return; // B·ªè comment n·∫øu mu·ªën b·∫Øt bu·ªôc
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang ƒë·ªïi m·∫≠t kh·∫©u admin...', 'info');

                const res = await fetch('/admin/security/change-admin-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: oldPass,
                        new_password: newPass
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + data.message);
                    if (typeof logSystem === 'function') logSystem('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng', 'success');
                    
                    // X√≥a tr·∫Øng c√°c √¥ nh·∫≠p
                    document.getElementById('admin-old-pass').value = '';
                    document.getElementById('admin-new-pass').value = '';
                    document.getElementById('admin-confirm-pass').value = '';
                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Th·∫•t b·∫°i"));
                }

            } catch (error) {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        // 12. H√†m hi·ªÉn th·ªã danh s√°ch m·∫≠t kh·∫©u (G·ªçi trong loadOverview)
        async function loadSecurityTable() {
            const tbody = document.getElementById('security-table-body');
            if (!tbody) return;

            // Loading effect
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang gi·∫£i m√£ d·ªØ li·ªáu m·∫≠t...</td></tr>';

            try {
                // G·ªåI API RI√äNG ƒê·ªÇ L·∫§Y M·∫¨T KH·∫®U
                const res = await fetch('/admin/security/all-players');
                const players = await res.json();

                tbody.innerHTML = ''; // X√≥a loading

                if (players && players.length > 0) {
                    players.forEach(p => {
                        const roleColor = (p.username === 'admin') ? 'text-red-500 font-bold' : 'text-gray-300';
                        
                        // üëá ƒêO·∫†N QUAN TR·ªåNG ƒê√É S·ª¨A üëá
                        // Ki·ªÉm tra: N·∫øu c√≥ m·∫≠t kh·∫©u th√¥ (plain_password) th√¨ hi·ªán, kh√¥ng th√¨ b√°o "ƒê√£ m√£ h√≥a"
                        const passDisplay = p.plain_password 
                            ? `<span class="font-mono text-red-400 font-bold bg-red-900/20 px-2 py-1 rounded border border-red-500/30 select-all tracking-wider" title="M·∫≠t kh·∫©u g·ªëc">${p.plain_password}</span>`
                            : `<span class="text-gray-600 text-xs italic opacity-50 cursor-help" title="M·∫≠t kh·∫©u n√†y ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc khi h·ªá th·ªëng gi√°m s√°t ho·∫°t ƒë·ªông">üîí ƒê√£ m√£ h√≥a</span>`;
                        
                        const row = `
                            <tr class="border-b border-gray-700 hover:bg-gray-700 transition">
                                <td class="p-3 text-gray-500 text-xs text-center">#${p.id}</td>
                                <td class="p-3 ${roleColor}">${p.full_name || 'Ch∆∞a ƒë·∫∑t t√™n'}</td>
                                <td class="p-3 text-yellow-500 font-bold">${p.username}</td>
                                
                                <td class="p-3 text-center">${passDisplay}</td>
                                
                                <td class="p-3 text-center">
                                    <span class="bg-gray-600 text-xs px-2 py-1 rounded text-white">
                                        T·ªï ${p.team_id || '?'}
                                    </span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu t√†i kho·∫£n</td></tr>';
                }
            } catch (error) {
                console.error("L·ªói t·∫£i b·∫£ng b·∫£o m·∫≠t:", error);
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">‚ùå L·ªói k·∫øt n·ªëi Server! Ki·ªÉm tra l·∫°i API /admin/security/all-players</td></tr>';
            }
        }
        // 13. H√†m Reset M√πa Gi·∫£i M·ªõi (C·∫£nh b√°o 2 l·ªõp)
        async function confirmResetSeason() {
            // C·∫£nh b√°o l·∫ßn 1
            if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO C·ª∞C K·ª≤ QUAN TR·ªåNG ‚ö†Ô∏è\n\nB·∫°n ƒëang y√™u c·∫ßu X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU H·ªåC SINH ƒë·ªÉ b·∫Øt ƒë·∫ßu l·ªõp m·ªõi.\n\n- T·∫•t c·∫£ t√†i kho·∫£n h·ªçc sinh s·∫Ω b·ªã m·∫•t.\n- T·∫•t c·∫£ v·∫≠t ph·∫©m, ti·ªÅn v√†ng, ƒëi·ªÉm s·ªë s·∫Ω v·ªÅ 0.\n- T√†i kho·∫£n Admin v√† Shop s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c kh√¥ng?")) {
                return;
            }

            // C·∫£nh b√°o l·∫ßn 2 (Ch·ªëng b·∫•m nh·∫ßm)
            const checkCode = Math.floor(1000 + Math.random() * 9000); // T·∫°o m√£ ng·∫´u nhi√™n 4 s·ªë
            const userInput = prompt(`H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!\n\nƒê·ªÉ x√°c nh·∫≠n, vui l√≤ng nh·∫≠p m√£ x√°c th·ª±c sau v√†o √¥ b√™n d∆∞·ªõi:\n${checkCode}`);

            if (userInput != checkCode) {
                alert("‚ùå M√£ x√°c th·ª±c kh√¥ng ƒë√∫ng. H·ªßy b·ªè thao t√°c.");
                return;
            }

            try {
                if (typeof logSystem === 'function') logSystem('ƒêang kh·ªüi ƒë·ªông quy tr√¨nh Reset Season...', 'warning');

                const res = await fetch('/admin/security/reset-season', { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ TH√ÄNH C√îNG: " + data.message);
                    if (typeof logSystem === 'function') logSystem('‚úÖ SERVER ƒê√É ƒê∆Ø·ª¢C RESET', 'success');
                    
                    // T·∫£i l·∫°i c√°c b·∫£ng d·ªØ li·ªáu ƒë·ªÉ th·∫•y s·ª± tr·ªëng tr∆°n
                    if (typeof loadOverview === 'function') loadOverview();
                    if (typeof loadSecurityTable === 'function') loadSecurityTable();
                    if (typeof loadResetDropdown === 'function') loadResetDropdown();
                    
                } else {
                    alert("‚ùå L·ªói: " + data.detail);
                }
            } catch (error) {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        // ============================================================
        // üêâ MODULE QU·∫¢N L√ù BOSS (LOGIC FRONTEND)
        // ============================================================

        // 14. H√ÄM C·∫¨P NH·∫¨T PREVIEW (XEM TR∆Ø·ªöC H√åNH ·∫¢NH & HI·ªÜU ·ª®NG)

        function updateBossPreview() {
            // 1. L·∫•y ph·∫ßn t·ª≠ an to√†n
            var inputImgEl = document.getElementById('boss-img');
            var inputAnimEl = document.getElementById('boss-anim');
            var inputVfxEl = document.getElementById('boss-vfx');
            
            var imgUrl = inputImgEl ? inputImgEl.value : "";
            var anim = inputAnimEl ? inputAnimEl.value : "stand";
            var vfxType = inputVfxEl ? inputVfxEl.value : "none";
            
            var previewImg = document.getElementById('preview-boss-img');
            var activeImg = document.getElementById('active-boss-img');
            var vfxContainer = document.getElementById('vfx-layer');

            // 2. C·∫≠p nh·∫≠t h√¨nh ·∫£nh v√† Animation
            var applyToImage = function(el) {
                if (!el) return;
                el.src = imgUrl || "https://i.imgur.com/6Xq8X8S.png";
                
                // Reset class v·ªÅ m·∫∑c ƒë·ªãnh (gi·ªØ l·∫°i c√°c class layout)
                el.className = "w-40 h-40 object-contain transition-all duration-500 drop-shadow-2xl";
                
                // Th√™m hi·ªáu ·ª©ng bay/th·ªü/rung
                if (anim && anim !== 'stand') {
                    el.classList.add('anim-' + anim);
                }
            };

            applyToImage(previewImg);
            applyToImage(activeImg);

            // 3. X·ª≠ l√Ω L·ª≠a / Tuy·∫øt (VFX)
            if (vfxContainer) {
                if (vfxTimer) clearInterval(vfxTimer);
                vfxContainer.innerHTML = '';

                if (vfxType && vfxType !== 'none') {
                    vfxTimer = setInterval(function() {
                        var p = document.createElement('div');
                        var isFire = (vfxType === 'fire');
                        
                        p.className = 'vfx-particle ' + (isFire ? 'fire-particle' : 'snow-particle');
                        
                        var size = (Math.random() * 6 + 2) + 'px';
                        p.style.width = size;
                        p.style.height = size;
                        p.style.left = (Math.random() * 100) + '%';
                        p.style.animationDuration = (Math.random() * 1.5 + 1) + 's';
                        
                        vfxContainer.appendChild(p);
                        
                        setTimeout(function() { 
                            if(p) p.remove(); 
                        }, 2500);
                    }, 100);
                }
            }
        }

        // G·∫Øn s·ª± ki·ªán ƒë·ªÉ khi nh·∫≠p l√† th·∫•y ƒë·ªïi ngay
        // Ch·ªâ g·∫Øn s·ª± ki·ªán n·∫øu t√¨m th·∫•y element
        const bossImgInput = document.getElementById('boss-img');
        const bossAnimSelect = document.getElementById('boss-anim');

        if (bossImgInput) {
            bossImgInput.addEventListener('input', updateBossPreview);
        } else {
            // (T√πy ch·ªçn) Ghi log nh·∫π ƒë·ªÉ bi·∫øt n·∫øu thi·∫øu HTML, nh∆∞ng kh√¥ng b√°o l·ªói ƒë·ªè
            console.log("‚ÑπÔ∏è Ch∆∞a t√¨m th·∫•y √¥ nh·∫≠p ·∫£nh Boss (C√≥ th·ªÉ ƒëang ·ªü Tab kh√°c)");
        }

        if (bossAnimSelect) {
            bossAnimSelect.addEventListener('change', updateBossPreview);
        }

        // 15. H√ÄM L∆ØU / TRI·ªÜU H·ªíI BOSS (G·ªåI API)
        async function saveBoss() {
            // 1. Thu th·∫≠p d·ªØ li·ªáu t·ª´ Form
            const bossData = {
                name: document.getElementById('boss-name').value,
                grade: parseInt(document.getElementById('boss-grade').value),
                subject: document.getElementById('boss-subject').value,
                max_hp: parseInt(document.getElementById('boss-hp').value),
                atk: parseInt(document.getElementById('boss-atk').value),
                time_limit: parseInt(document.getElementById('boss-time-limit').value),
                
                image_url: document.getElementById('boss-img').value,
                animation: document.getElementById('boss-anim').value,
                vfx: document.getElementById('boss-vfx').value,
                
                reward_kpi: parseInt(document.getElementById('reward-kpi').value) || 0,
                reward_tri_thuc: parseInt(document.getElementById('reward-trithuc').value) || 0,
                reward_chien_tich: parseInt(document.getElementById('reward-chientich').value) || 0,
                reward_vinh_du: parseInt(document.getElementById('reward-vinhdu').value) || 0,
                
                drop_pool: JSON.stringify(currentBossDrops),
                rare_item_id: null,
                rare_item_rate: 0
            };

            // 2. Validate c∆° b·∫£n
            if (!bossData.name || !bossData.image_url) {
                alert("‚ùå Vui l√≤ng nh·∫≠p T√™n Boss v√† Link H√¨nh ·∫¢nh!");
                return;
            }

            try {
                if(typeof logSystem === 'function') logSystem('ƒêang tri·ªáu h·ªìi Boss...', 'info');
                
                const res = await fetch('/admin/boss/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bossData)
                });

                // CH·ªà ƒê·ªåC JSON M·ªòT L·∫¶N DUY NH·∫§T ·ªû ƒê√ÇY
                const data = await res.json();
                
                if (res.ok) {
                    alert("‚úÖ " + (data.message || "Tri·ªáu h·ªìi th√†nh c√¥ng!"));

                    // --- √âP HI·ªÇN TH·ªä ·∫¢NH NGAY T·∫†I ƒê√ÇY (CLIENT-SIDE UPDATE) ---
                    const activeImg = document.getElementById('active-boss-img');
                    const animType = bossData.animation;

                    if (activeImg) {
                        activeImg.src = bossData.image_url; 
                        activeImg.className = "w-40 h-40 object-contain z-10 drop-shadow-lg"; // Reset class c≈©
                        
                        if (animType !== 'stand') {
                            activeImg.classList.add('anim-' + animType);
                        }
                    }

                    // C·∫≠p nh·∫≠t thanh HP v√† text ngay l·∫≠p t·ª©c
                    const hpBar = document.getElementById('boss-hp-bar');
                    if (hpBar) hpBar.style.width = "100%";
                    
                    const hpText = document.getElementById('boss-hp-text');
                    if (hpText) hpText.innerText = bossData.max_hp + " / " + bossData.max_hp + " HP";
                    
                    const statusText = document.getElementById('boss-status-text');
                    if (statusText) statusText.innerText = "ƒêANG CHI·∫æN ƒê·∫§U: " + bossData.name;

                    // ƒê·ªìng b·ªô l·∫°i v·ªõi Server l·∫ßn cu·ªëi
                    if (typeof loadCurrentBoss === 'function') loadCurrentBoss();

                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ l∆∞u Boss"));
                }
            } catch (error) {
                console.error("L·ªói tri·ªáu h·ªìi:", error);
                alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng ki·ªÉm tra CMD.");
            }
        }

        // 16. H√ÄM T·∫¢I TH√îNG TIN BOSS HI·ªÜN T·∫†I (KHI M·ªû TAB)
        async function loadCurrentBoss() {
            try {
                const res = await fetch('/admin/boss/current');
                // Ki·ªÉm tra n·∫øu API l·ªói th√¨ tho√°t lu√¥n
                if (!res.ok) return;

                const boss = await res.json();

                // H√†m con: ƒêi·ªÅn d·ªØ li·ªáu an to√†n (Ch·ªâ ƒëi·ªÅn n·∫øu t√¨m th·∫•y √¥ input)
                const safeSet = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value || "";
                };

                if (boss) {
                    // ƒêi·ªÅn d·ªØ li·ªáu v√†o Form (D√πng h√†m an to√†n safeSet)
                    safeSet('boss-name', boss.name);
                    safeSet('boss-grade', boss.grade);
                    safeSet('boss-subject', boss.subject);
                    safeSet('boss-hp', boss.max_hp);
                    safeSet('boss-atk', boss.atk);
                    safeSet('boss-time-limit', boss.time_limit);
                    
                    safeSet('boss-img', boss.image_url);
                    safeSet('boss-anim', boss.animation);
                    safeSet('boss-vfx', boss.vfx);
                    
                    safeSet('reward-kpi', boss.reward_kpi);
                    safeSet('reward-trithuc', boss.reward_tri_thuc);
                    safeSet('reward-chientich', boss.reward_chien_tich);
                    safeSet('reward-vinhdu', boss.reward_vinh_du);
                    
                    safeSet('reward-item-id', boss.rare_item_id);
                    safeSet('reward-item-rate', boss.rare_item_rate);

                    // C·∫≠p nh·∫≠t xem tr∆∞·ªõc (N·∫øu h√†m t·ªìn t·∫°i)
                    if (typeof updateBossPreview === 'function') updateBossPreview();
                    
                    // C·∫≠p nh·∫≠t UI thanh m√°u (N·∫øu h√†m t·ªìn t·∫°i)
                    if (typeof updateBossStatusUI === 'function') updateBossStatusUI(boss);

                } else {
                    console.log("Ch∆∞a c√≥ boss n√†o active.");
                    
                    // --- ƒêO·∫†N G√ÇY L·ªñI C≈® ƒê√É ƒê∆Ø·ª¢C B·ªåC K·ª∏ ---
                    const statusText = document.getElementById('boss-status-text');
                    if (statusText) {
                        statusText.innerHTML = '<span class="text-gray-500">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o di·ªÖn ra.</span>';
                    }
                    // ---------------------------------------
                }
            } catch (error) {
                console.error("L·ªói t·∫£i boss:", error);
            }
        }

        // 17. H√ÄM C·∫¨P NH·∫¨T THANH M√ÅU (REAL-TIME UI)
        function updateBossStatusUI(boss) {
            if (!boss) return;

            // Hi·ªÉn th·ªã ·∫£nh v√† √°p d·ª•ng hi·ªáu ·ª©ng ƒë·ªông
            const activeImg = document.getElementById('active-boss-img');
            if (activeImg) {
                activeImg.src = boss.image_url || "";
                
                // X√≥a c√°c class hi·ªáu ·ª©ng c≈©
                activeImg.classList.remove('anim-breathe', 'anim-float', 'anim-shake');
                
                // Th√™m class hi·ªáu ·ª©ng m·ªõi d·ª±a tr√™n c√†i ƒë·∫∑t
                if (boss.animation === 'breathe') activeImg.classList.add('anim-breathe');
                if (boss.animation === 'float') activeImg.classList.add('anim-float');
                if (boss.animation === 'shake') activeImg.classList.add('anim-shake');
            }

            // C·∫≠p nh·∫≠t thanh m√°u v√† vƒÉn b·∫£n
            const hpBar = document.getElementById('boss-hp-bar');
            const hpText = document.getElementById('boss-hp-text');
            const statusText = document.getElementById('boss-status-text');

            if (hpBar) {
                const percent = (boss.current_hp / boss.max_hp) * 100;
                hpBar.style.width = percent + "%";
                
                // ƒê·ªïi m√†u thanh m√°u theo t√¨nh tr·∫°ng (Xanh -> V√†ng -> ƒê·ªè)
                if (percent > 50) hpBar.className = "bg-gradient-to-r from-green-500 to-green-400 h-full transition-all duration-700";
                else if (percent > 20) hpBar.className = "bg-gradient-to-r from-yellow-500 to-orange-400 h-full transition-all duration-700";
                else hpBar.className = "bg-gradient-to-r from-red-600 to-red-500 h-full transition-all duration-700";
            }

            if (hpText) hpText.innerText = `${boss.current_hp} / ${boss.max_hp} HP`;
            if (statusText) statusText.innerText = `BOSS: ${boss.name} (L·ªõp ${boss.grade} - ${boss.subject})`;
            
            // C·∫≠p nh·∫≠t th·ªùi gian
            const timerDisplay = document.getElementById('boss-timer-display');
            if (timerDisplay) timerDisplay.innerText = boss.time_limit + "s";
        }

        // 1. H√†m th√™m item v√†o danh s√°ch droplist
        function addBossDropItem() {
            const select = document.getElementById('boss-drop-select');
            const rateInput = document.getElementById('boss-drop-rate');
            
            const itemId = select.value;
            const itemName = select.options[select.selectedIndex].text;
            const rate = parseInt(rateInput.value);

            if (!itemId || !rate || rate <= 0) {
                alert("Vui l√≤ng ch·ªçn V·∫≠t ph·∫©m v√† nh·∫≠p T·ªâ l·ªá h·ª£p l·ªá!");
                return;
            }

            // Th√™m v√†o m·∫£ng
            currentBossDrops.push({ id: itemId, name: itemName, rate: rate });
            
            // V·∫Ω l·∫°i giao di·ªán
            renderBossDropList();
            
            // Reset √¥ nh·∫≠p
            rateInput.value = '';
        }

        // 2. H√†m v·∫Ω danh s√°ch ra m√†n h√¨nh
        function renderBossDropList() {
            const container = document.getElementById('boss-drop-list');
            const emptyMsg = document.getElementById('empty-drop-msg');
            
            container.innerHTML = ''; // X√≥a tr·∫Øng c≈©
            
            if (currentBossDrops.length === 0) {
                if(emptyMsg) container.appendChild(emptyMsg);
                return;
            }

            currentBossDrops.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-600";
                div.innerHTML = `
                    <span class="text-sm text-gray-200">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-yellow-400">${item.rate}%</span>
                        <button onclick="removeBossDrop(${index})" class="text-red-400 hover:text-red-200">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 3. H√†m x√≥a item
        function removeBossDrop(index) {
            currentBossDrops.splice(index, 1);
            renderBossDropList();
        }

        // 18. H√ÄM H·ª¶Y TR·∫¨N ƒê·∫§U (X√ìA BOSS)
        async function deleteBoss() {
            if(!confirm("‚ö†Ô∏è B·∫°n ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y tr·∫≠n ƒë·∫•u n√†y?\nBoss v√† Nh·∫≠t k√Ω s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!")) return;
            
            try {
                const res = await fetch('/admin/boss/delete', { method: 'POST' });
                const data = await res.json();
                
                if(res.ok) {
                    alert(data.message);
                    
                    // 1. Reset c√°c √¥ nh·∫≠p li·ªáu (Ch·ªâ x√≥a n·∫øu t√¨m th·∫•y ID)
                    const nameInput = document.getElementById('boss-name');
                    if (nameInput) nameInput.value = "";
                    
                    // 2. D·ªçn d·∫πp h√¨nh ·∫£nh (D√πng ki·ªÉm tra an to√†n ƒë·ªÉ tr√°nh l·ªói ID)
                    const previewImg = document.getElementById('preview-boss-img');
                    if (previewImg) previewImg.src = "";
                    
                    const activeImg = document.getElementById('active-boss-img');
                    if (activeImg) activeImg.src = ""; // X√≥a lu√¥n ·∫£nh Boss ƒëang bay

                    // 3. D·ª´ng hi·ªáu ·ª©ng VFX ngay l·∫≠p t·ª©c
                    if (vfxTimer) clearInterval(vfxTimer);
                    const vfxContainer = document.getElementById('vfx-layer');
                    if (vfxContainer) vfxContainer.innerHTML = '';

                    // 4. T·∫£i l·∫°i tr·∫°ng th√°i tr·ªëng t·ª´ Server
                    await loadCurrentBoss(); 
                } else {
                    alert(data.message);
                }
            } catch(e) { 
                console.error("Chi ti·∫øt l·ªói:", e);
                alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t giao di·ªán!"); 
            }
        }
        // 19. H√ÄM D·ªåN D·∫∏P LOG
        async function clearBattleLog() {
            if(!confirm("X√≥a s·∫°ch nh·∫≠t k√Ω chi·∫øn ƒë·∫•u?")) return;
            await fetch('/admin/boss/logs/clear', { method: 'POST' });
            alert("ƒê√£ x√≥a nh·∫≠t k√Ω!");
            // TODO: Reload b·∫£ng log khi l√†m xong ch·ª©c nƒÉng log
        }
        // H√†m t·∫£i nh·∫≠t k√Ω chi·∫øn tr∆∞·ªùng
        async function fetchBattleLogs() {
            try {
                // üëá [QUAN TR·ªåNG] S·ª≠a ID n√†y th√†nh 'battle-log-window' cho kh·ªõp v·ªõi HTML c·ªßa b·∫°n
                const container = document.getElementById('battle-log-window');

                // N·∫øu kh√¥ng t√¨m th·∫•y khung th√¨ d·ª´ng lu√¥n (tr√°nh l·ªói null)
                if (!container) return;

                const response = await fetch('/api/boss/logs?limit=50');
                const data = await response.json();

                if (data.success) {
                    
                    // N·∫øu ch∆∞a c√≥ log n√†o
                    if (!data.logs || data.logs.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 italic text-center py-4">Ch∆∞a c√≥ giao tranh n√†o...</div>';
                        return;
                    }

                    let html = '';
                    data.logs.forEach(log => {
                        // üëá T·ª∞ ƒê·ªòNG GH√âP C√ÇU TH√îNG B√ÅO T·ª™ D·ªÆ LI·ªÜU
                        // (V√¨ database ch∆∞a c√≥ c·ªôt message n√™n ta gh√©p tay ·ªü ƒë√¢y)
                        
                        let damageText = '';
                        let actionText = '';
                        
                        if (log.action === 'attack_hit') {
                            // T√¥ m√†u: Damage to (>50) m√†u ƒë·ªè ƒë·∫≠m, nh·ªè m√†u v√†ng
                            let dmgColor = log.dmg_dealt > 50 ? 'text-red-400 font-bold' : 'text-yellow-400';
                            actionText = `g√¢y <span class="${dmgColor}">${log.dmg_dealt} dmg</span> l√™n Boss`;
                        } else if (log.action === 'attack_miss') {
                            actionText = `<span class="text-gray-400">t·∫•n c√¥ng tr∆∞·ª£t</span>`;
                        } else {
                            // Tr∆∞·ªùng h·ª£p database ƒë√£ c√≥ c·ªôt message (d·ª± ph√≤ng)
                            actionText = log.message || log.action;
                        }

                        // Format th·ªùi gian ng·∫Øn g·ªçn (VD: 14:30:05)
                        const timeStr = new Date(log.created_at).toLocaleTimeString('vi-VN', { hour12: false });

                        // üëá HTML THEO PHONG C√ÅCH TAILWIND (Kh·ªõp v·ªõi giao di·ªán Admin c·ªßa b·∫°n)
                        html += `
                            <div class="border-b border-gray-800 pb-1 mb-1 last:border-0 hover:bg-white/5 px-2 rounded transition">
                                <span class="text-gray-500 mr-1">[${timeStr}]</span>
                                <span class="text-blue-400 font-bold">${log.player_name}</span> 
                                <span class="text-gray-300">${actionText}</span>
                                <span class="float-right text-gray-600 text-[9px] mt-0.5">HP: ${log.hp_left}</span>
                            </div>
                        `;
                    });

                    // Ch·ªâ c·∫≠p nh·∫≠t HTML n·∫øu c√≥ s·ª± thay ƒë·ªïi (ƒë·ªÉ ƒë·ª° b·ªã nh√°y khi scroll)
                    if (container.innerHTML !== html) {
                        container.innerHTML = html;
                        // T·ª± ƒë·ªông cu·ªôn xu·ªëng d∆∞·ªõi c√πng ƒë·ªÉ xem tin m·ªõi nh·∫•t (t√πy ch·ªçn)
                        // container.scrollTop = container.scrollHeight;
                    }
                }
            } catch (error) {
                console.error("L·ªói t·∫£i nh·∫≠t k√Ω:", error);
            }
        }

        // G·ªçi h√†m m·ªói 2 gi√¢y
        setInterval(fetchBattleLogs, 3000);
        document.addEventListener('DOMContentLoaded', fetchBattleLogs);

        // Ch·∫°y h√†m n√†y m·ªói 2 gi√¢y
        setInterval(fetchBattleLogs, 3000);
        document.addEventListener('DOMContentLoaded', fetchBattleLogs);
        /* ============================================================
        1. H√ÄM T·∫¢I ITEM V√ÄO DROPDOWN BOSS (Th√™m v√†o script)
        ============================================================ */
        async function loadItemsForBossSelect() {
            console.log("üîÑ ƒêang n·∫°p danh s√°ch Item v√†o Dropdown Boss...");
            
            try {
                // 1. G·ªçi API (ƒê∆∞·ªùng d·∫´n n√†y ƒë√£ ƒë∆∞·ª£c ki·ªÉm ch·ª©ng l√† ch·∫°y ngon)
                const res = await fetch('/api/all-items'); 
                
                if (!res.ok) {
                    console.error("‚ùå L·ªói API khi t·∫£i item");
                    return;
                }

                const items = await res.json();
                
                // 2. üëá QUAN TR·ªåNG: L·∫§Y ƒê√öNG C√ÅI ID M√Ä TOOL DEBUG V·ª™A T√åM TH·∫§Y
                const selectEl = document.getElementById('boss-drop-select'); 
                
                if (!selectEl) {
                    console.error("‚ùå L·ªñI: Kh√¥ng t√¨m th·∫•y th·∫ª <select id='boss-drop-select'> trong HTML!");
                    return;
                }

                // 3. X√≥a c≈©, th√™m m·ªõi
                selectEl.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m ƒë·ªÉ th√™m --</option>';

                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id; 
                    // Hi·ªÉn th·ªã: [ID 1] B√¨nh m√°u (consumable)
                    option.textContent = `[ID ${item.id}] ${item.name} (${item.type})`;
                    selectEl.appendChild(option);
                });
                
                console.log(`‚úÖ ƒê√£ n·∫°p th√†nh c√¥ng ${items.length} m√≥n v√†o Dropdown.`);

            } catch (e) {
                console.error("‚ùå L·ªói JS k·∫øt n·ªëi:", e);
            }
        }

        // üëá G·ªåI H√ÄM NAY NGAY L·∫¨P T·ª®C ƒê·ªÇ N√ì CH·∫†Y
        // (Th√™m d√≤ng n√†y v√†o cu·ªëi file script ho·∫∑c trong document.addEventListener)
        document.addEventListener('DOMContentLoaded', loadItemsForBossSelect);
        // =========================================================
        // H√ÄM X·ª¨ L√ù L∆ØU form item (LOGIC GACHA ƒê√É G·ªòP V√ÄO TRONG)
        // =========================================================
        async function handleFormSubmit(event) {
            event.preventDefault();
            console.log("üñ±Ô∏è ƒêang x·ª≠ l√Ω form submit...");

            // 1. L·∫§Y D·ªÆ LI·ªÜU C∆† B·∫¢N T·ª™ FORM
            const nameVal = document.getElementById('item-name').value.trim();
            const imgVal = document.getElementById('item-img').value.trim();
            const descVal = document.getElementById('item-desc').value.trim();
            
            // Dropdown
            const currencyVal = document.getElementById('item-currency').value;
            const priceVal = parseInt(document.getElementById('item-price').value) || 0;
            const isHiddenVal = document.getElementById('item-hidden').value === "true";
            const limitTypeVal = parseInt(document.getElementById('item-limit').value) || 0;

            // Validate c∆° b·∫£n
            if (!nameVal) { 
                alert("T√™n v·∫≠t ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); 
                return; 
            }

            // 2. X·ª¨ L√ù LOGIC N√ÇNG CAO
            const actionType = document.getElementById('item-action-type').value;
            
            // Kh·ªüi t·∫°o config m·∫∑c ƒë·ªãnh
            let logicConfig = {
                type: actionType,
                value: 0,
                target: "SELF"
            };

            // --- B·∫ÆT ƒê·∫¶U X·ª¨ L√ù T·ª™NG LO·∫†I LOGIC ---
            try {
                // TR∆Ø·ªúNG H·ª¢P 1: H·ªíI M√ÅU
                if (actionType === 'heal') {
                    const valEl = document.getElementById('logic-value');
                    logicConfig.value = valEl ? parseInt(valEl.value) : 0;
                } 
                
                // TR∆Ø·ªúNG H·ª¢P 2: C·ªòNG TI·ªÄN / KPI
                else if (actionType === 'add_currency') {
                    const valEl = document.getElementById('logic-value');
                    logicConfig.value = valEl ? parseInt(valEl.value) : 0;
                    
                    const currTypeEl = document.getElementById('logic-currency-type');
                    if (currTypeEl) logicConfig.target_currency = currTypeEl.value;
                }
                
                // TR∆Ø·ªúNG H·ª¢P 3: R∆Ø∆†NG GACHA (X·ª¨ L√ù TR·ª∞C TI·∫æP T·∫†I ƒê√ÇY)
                else if (actionType === 'gacha_open') {
                    const gachaItems = [];
                    // T√¨m container ch·ª©a danh s√°ch (ƒë∆∞·ª£c t·∫°o b·ªüi toggleLogicFields)
                    const container = document.getElementById('gacha-items-list');
                    
                    if (container) {
                        // Qu√©t t·∫•t c·∫£ c√°c d√≤ng v·∫≠t ph·∫©m ƒë√£ th√™m
                        // L∆∞u √Ω: Class 'gacha-item-id' v√† 'gacha-item-rate' ph·∫£i kh·ªõp v·ªõi h√†m addGachaRow
                        const idInputs = container.querySelectorAll('.gacha-item-id');
                        const rateInputs = container.querySelectorAll('.gacha-item-rate');

                        // Duy·ªát qua danh s√°ch inputs t√¨m th·∫•y
                        for (let i = 0; i < idInputs.length; i++) {
                            const iId = parseInt(idInputs[i].value);
                            // L·∫•y t·ª∑ l·ªá t∆∞∆°ng ·ª©ng (n·∫øu input t·ª∑ l·ªá th·ª© i t·ªìn t·∫°i)
                            const iRate = rateInputs[i] ? parseFloat(rateInputs[i].value) : 0;

                            if (iId > 0) { // Ch·ªâ l·∫•y n·∫øu ƒë√£ ch·ªçn v·∫≠t ph·∫©m
                                gachaItems.push({
                                    item_id: iId,
                                    rate: iRate
                                });
                            }
                        }
                    }

                    // Ki·ªÉm tra n·∫øu t·∫°o r∆∞∆°ng r·ªóng
                    if (gachaItems.length === 0) {
                        alert("‚ö†Ô∏è B·∫°n ch·ªçn lo·∫°i R∆∞∆°ng Gacha nh∆∞ng ch∆∞a th√™m v·∫≠t ph·∫©m n√†o v√†o trong!");
                        return;
                    }

                    logicConfig.gacha_items = gachaItems;
                    logicConfig.value = "GACHA_BOX"; // ƒê√°nh d·∫•u lo·∫°i
                }
                
                // TR∆Ø·ªúNG H·ª¢P 4: G·ª¨I TH√îNG ƒêI·ªÜP
                else if (actionType === 'send_message') {
                    logicConfig.value = 1; 
                }

                // TR∆Ø·ªúNG H·ª¢P 5: ƒê√Å C∆Ø·ªúNG H√ìA
                else if (actionType === 'enhance_stone') {
                    // ƒê√° c∆∞·ªùng h√≥a kh√¥ng c·∫ßn gi√° tr·ªã s·ªë c·ª• th·ªÉ, 
                    // nh∆∞ng ta g√°n = 1 ƒë·ªÉ ƒë·∫£m b·∫£o logic kh√¥ng b·ªã null
                    logicConfig.value = 1; 
                    logicConfig.target = "FORGE_SYSTEM"; 
                }

            } catch (e) {
                console.warn("L·ªói ƒë·ªçc logic config:", e);
                alert("L·ªói d·ªØ li·ªáu c·∫•u h√¨nh: " + e.message);
                return;
            }

            // 3. ƒê√ìNG G√ìI PAYLOAD
            const payload = {
                name: nameVal,
                image_url: imgVal,
                description: descVal,
                currency_type: currencyVal,
                price: priceVal,
                is_hidden: isHiddenVal,
                limit_type: limitTypeVal,
                config: JSON.stringify(logicConfig)
            };

            // 4. G·ª¨I API (ƒê√É S·ª¨A URL)
            try {
                // üëá URL CHU·∫®N THEO FILE SHOP.PY
                const response = await fetch('/admin/shop/items/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("‚úÖ ƒê√£ t·∫°o v·∫≠t ph·∫©m th√†nh c√¥ng!");
                    if (typeof closeItemModal === 'function') closeItemModal(); 
                    
                    // üëá G·ªåI L·∫†I H√ÄM LOAD (Nh·ªõ s·ª≠a URL trong h√†m load n·ªØa nh√©)
                    if (typeof loadShopItems === 'function') loadShopItems();
                } else {
                    const err = await response.json();
                    alert("‚ùå L·ªói Server: " + (err.detail || "Kh√¥ng r√µ"));
                }
            } catch (error) {
                console.error(error);
                alert("‚ùå L·ªói k·∫øt n·ªëi!");
            }
        }

        // =========================================================
        // H√ÄM T·∫¢I DANH S√ÅCH V·∫¨T PH·∫®M (ƒê√É FIX L·ªñI ·∫¢NH & FONT)
        // =========================================================
        async function loadShopItems() {
            const container = document.getElementById('shop-inventory-grid');
            if (!container) return;

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            container.innerHTML = '<p class="text-gray-400 col-span-full text-center">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>';

            try {
                // G·ªçi API l·∫•y danh s√°ch
                const res = await fetch('/admin/shop/items'); 
                
                if (!res.ok) throw new Error("L·ªói t·∫£i danh s√°ch items");
                
                const items = await res.json();

                // X·ª≠ l√Ω khi kh√¥ng c√≥ d·ªØ li·ªáu
                if (!items || items.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-gray-500 text-center py-10">Ch∆∞a c√≥ v·∫≠t ph·∫©m n√†o trong Shop.</p>';
                    return;
                }
                
                // Render danh s√°ch
                container.innerHTML = items.map(item => {
                    // Ki·ªÉm tra tr·∫°ng th√°i ·∫©n
                    const borderClass = item.is_hidden ? "border-red-500 opacity-60" : "border-green-500";
                    const statusText = item.is_hidden ? "(ƒêANG ·∫®N)" : "";
                    
                    // Parse config an to√†n
                    let typeLabel = "V·∫≠t ph·∫©m th∆∞·ªùng";
                    try {
                        const cfg = JSON.parse(item.config);
                        if (cfg.type === 'heal') typeLabel = "‚ù§Ô∏è H·ªìi m√°u";
                        else if (cfg.type === 'add_currency') typeLabel = "üíé C·ªông ti·ªÅn";
                        else if (cfg.type === 'gacha_open') typeLabel = "üéÅ R∆∞∆°ng Gacha";
                        else if (cfg.type === 'send_message') typeLabel = "üì© Th√¥ng ƒëi·ªáp";
                    } catch (e) {}

                    // üëáüëáüëá KH·∫ÆC PH·ª§C L·ªñI ·ªû ƒê√ÇY üëáüëáüëá
                    // Thay v√¨ vi·∫øt logic ph·ª©c t·∫°p trong onerror, ta d√πng ·∫£nh gi·ªØ ch·ªó (placeholder) ƒë∆°n gi·∫£n
                    const fallbackImage = "https://placehold.co/100x100/333/FFF?text=No+Img";

                    return `
                        <div class="bg-gray-800 rounded-xl p-4 border-2 ${borderClass} relative flex flex-col items-center group transition hover:scale-105">
                            
                            <div class="w-full h-32 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden border border-gray-700 mb-2 relative">
                                <img src="${item.image_url}" 
                                    class="w-full h-full object-contain"
                                    alt="${item.name}"
                                    onerror="this.onerror=null; this.src='${fallbackImage}';">
                                
                                <span class="absolute top-1 right-1 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded backdrop-blur-sm border border-gray-600">
                                    ${typeLabel}
                                </span>
                            </div>
                            
                            <h3 class="text-white font-bold text-sm text-center w-full truncate" title="${item.name}">
                                ${item.name} <span class="text-red-400 text-xs">${statusText}</span>
                            </h3>
                            
                            <p class="text-yellow-400 text-xs mb-3 font-mono">
                                üí∞ ${item.price.toLocaleString()} ${item.currency_type}
                            </p>
                            
                            <button onclick="deleteItem(${item.id})" 
                                    class="bg-red-900/50 hover:bg-red-600 text-red-200 hover:text-white border border-red-800 hover:border-red-500 font-bold py-1 px-3 rounded text-xs w-full transition">
                                <i class="fas fa-trash-alt mr-1"></i> X√ìA
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error("L·ªói:", e);
                container.innerHTML = `<p class="text-red-500 col-span-full text-center">‚ùå L·ªói hi·ªÉn th·ªã: ${e.message}</p>`;
            }
        }
        //21. H√ÄM X√ìA V·∫¨T PH·∫®M
        // 21. H√ÄM X√ìA V·∫¨T PH·∫®M (ƒê√£ s·ª≠a ƒë∆∞·ªùng d·∫´n API cho kh·ªõp Backend)
        async function deleteItem(itemId) {
            if(!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn v·∫≠t ph·∫©m n√†y?")) return;

            try {
                // üëá S·ª≠a ƒë∆∞·ªùng d·∫´n cho kh·ªõp v·ªõi @router.delete("/items/templates/{item_id}")
                const res = await fetch(`/admin/items/templates/${itemId}`, {
                    method: 'DELETE' 
                });
                
                const data = await res.json();
                
                if(res.ok) {
                    // alert("‚úÖ " + data.message);
                    loadShopItems(); // T·∫£i l·∫°i danh s√°ch ngay l·∫≠p t·ª©c
                } else {
                    alert("‚ùå L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ x√≥a v·∫≠t ph·∫©m"));
                }
            } catch (e) {
                console.error(e);
                alert("‚ùå L·ªói k·∫øt n·ªëi server!");
            }
        }

        //22. H√†m ƒë·ªÉ HI·ªÜN c√°i khung nh·∫≠p li·ªáu (Modal)
        function openCreateItemModal() {
            const modal = document.getElementById('item-modal');
            if (modal) {
                modal.classList.remove('hidden'); // G·ª° b·ªè l·ªõp ·∫©n
                
                // 1. Reset to√†n b·ªô c√°c input c∆° b·∫£n (T√™n, Gi√°, Lo·∫°i ti·ªÅn...)
                document.getElementById('item-form').reset(); 
                
                // 2. L√†m s·∫°ch √¥ M√¥ t·∫£ (textarea)
                const descField = document.getElementById('item-desc');
                if (descField) descField.value = ''; 
                
                // 3. Reset dropdown ch·ª©c nƒÉng v·ªÅ m·∫∑c ƒë·ªãnh
                const actionSelect = document.getElementById('item-action-type');
                if (actionSelect) actionSelect.value = 'none';

                // 4. X√≥a c√°c tr∆∞·ªùng logic ph·ª• (c·ªßa Gacha ho·∫∑c H·ªìi m√°u c≈©)
                document.getElementById('logic-fields').innerHTML = ''; 
                
                // 5. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ Modal (ƒë·ªÉ ph√¢n bi·ªát v·ªõi ch·∫ø ƒë·ªô Ch·ªânh s·ª≠a sau n√†y)
                document.getElementById('modal-title').innerText = "T·∫°o V·∫≠t Ph·∫©m M·ªõi";
            }
        }

        //23. H√†m ƒë·ªÉ ·∫®N c√°i khung nh·∫≠p li·ªáu (Modal)
        function closeItemModal() {
            const modal = document.getElementById('item-modal');
            if (modal) {
                modal.classList.add('hidden'); // Th√™m l·ªõp ·∫©n
            }
        }

        //24 h√†m Ma thu·∫≠t toggleLogicFields()
        function toggleLogicFields() {
            const type = document.getElementById('item-action-type').value;
            const container = document.getElementById('logic-fields');
            container.innerHTML = ''; // X√≥a tr·∫Øng ƒë·ªÉ x√¢y d·ª±ng l·∫°i

            if (type === 'heal') {
                container.innerHTML = `
                    <label class="block text-gray-400 text-xs">S·ªë l∆∞·ª£ng HP h·ªìi ph·ª•c</label>
                    <input type="number" id="logic-value" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white" placeholder="V√≠ d·ª•: 500">
                `;
            } 
            else if (type === 'add_currency') {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-gray-400 text-xs">Lo·∫°i nh·∫≠n ƒë∆∞·ª£c</label>
                            <select id="logic-currency-type" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white">
                                <option value="tri_thuc">Tri th·ª©c</option>
                                <option value="chien_tich">Chi·∫øn t√≠ch</option>
                                <option value="vinh_du">Vinh d·ª±</option>
                                <option value="kpi">ƒêi·ªÉm KPI</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-400 text-xs">S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="logic-value" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white" placeholder="10">
                        </div>
                    </div>
                `;
            }
            else if (type === 'gacha_open') {
                container.innerHTML = `
                    <div class="border-t border-pink-900/50 pt-4 mt-2">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-pink-400 font-bold">üì¶ THI·∫æT L·∫¨P R∆Ø∆†NG GACHA</label>
                            <button type="button" onclick="addGachaRow()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded shadow-lg transition">
                                + Th√™m v·∫≠t ph·∫©m v√†o r∆∞∆°ng
                            </button>
                        </div>
                        
                        <div class="text-[10px] text-gray-500 mb-3 bg-gray-900 p-2 rounded">
                            üí° L∆∞u √Ω: T·ª∑ l·ªá (%) c·ªßa m·ªói m√≥n l√† ƒë·ªôc l·∫≠p. Ng∆∞·ªùi ch∆°i c√≥ th·ªÉ nh·∫≠n nhi·ªÅu m√≥n c√πng l√∫c n·∫øu may m·∫Øn.
                        </div>

                        <div id="gacha-items-list" class="space-y-3">
                            </div>
                    </div>
                `;
            }
            else if (type === 'send_message') {
                container.innerHTML = `
                    <div class="bg-blue-900/20 p-3 rounded border border-blue-500/30">
                        <p class="text-[10px] text-blue-300 italic">
                            <i class="fas fa-info-circle mr-1"></i> 
                            Lo·∫°i n√†y cho ph√©p h·ªçc sinh vi·∫øt l·ªùi nh·∫Øn khi s·ª≠ d·ª•ng. 
                            N·ªôi dung s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn b·∫£ng tin ho·∫∑c gi√°o vi√™n.
                        </p>
                        <input type="hidden" id="logic-value" value="1"> 
                    </div>
                `;
            }
        }

        //25 H√†m addGachaRow
        async function addGachaRow() {
            const list = document.getElementById('gacha-items-list');
            const rowId = Date.now();
            
            let itemsOptions = '<option value="">-- Ch·ªçn Item --</option>';
            try {
                // L·∫•y danh s√°ch item t·ª´ API c≈©
                const res = await fetch('/admin/shop/items');
                const items = await res.json();
                
                // L·ªçc item (An to√†n h∆°n code c≈©)
                items.forEach(i => {
                    let action = '';
                    try {
                        // Parse an to√†n, n·∫øu l·ªói th√¨ coi nh∆∞ kh√¥ng c√≥ config
                        if (i.config) {
                            const cfg = JSON.parse(i.config);
                            action = cfg.action || '';
                        }
                    } catch (e) {}

                    // Ch·ªâ hi·ªán item KH√îNG ph·∫£i l√† R∆∞∆°ng Gacha (tr√°nh r∆∞∆°ng m·ªü ra r∆∞∆°ng v√¥ t·∫≠n)
                    if (action !== 'gacha_open') {
                        itemsOptions += `<option value="${i.id}">${i.name} (ID: ${i.id})</option>`;
                    }
                });
            } catch (e) { console.error("L·ªói t·∫£i item:", e); }

            const row = document.createElement('div');
            // Style kh·ªõp v·ªõi h√¨nh ·∫£nh b·∫°n g·ª≠i
            row.className = "flex items-center space-x-2 bg-gray-800 p-2 rounded border border-gray-700 mt-2 animate-fade-in";
            row.id = `gacha-row-${rowId}`;
            
            row.innerHTML = `
                <div class="flex-1">
                    <select class="gacha-item-id w-full bg-gray-900 border border-gray-600 rounded p-1.5 text-white text-xs focus:ring-2 focus:ring-pink-500 outline-none">
                        ${itemsOptions}
                    </select>
                </div>
                <div class="w-24 relative">
                    <input type="number" placeholder="T·ª∑ l·ªá" class="gacha-item-rate w-full bg-gray-900 border border-gray-600 rounded p-1.5 text-white text-xs pr-6 focus:ring-2 focus:ring-pink-500 outline-none" min="0" max="100">
                    <span class="absolute right-2 top-1.5 text-gray-500 text-xs">%</span>
                </div>
                <button type="button" onclick="document.getElementById('gacha-row-${rowId}').remove()" class="text-gray-400 hover:text-red-500 px-2 transition">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(row);
        }

        // 25.1 H√†m L∆ØU c·∫•u h√¨nh Gacha (G·ª≠i v·ªÅ Backend)
        // 26. H√ÄM GOM D·ªÆ LI·ªÜU C·∫§U H√åNH (D√πng khi b·∫•m n√∫t L∆ØU V·∫¨T PH·∫®M)
        function collectItemConfig() {
            const type = document.getElementById('item-action-type').value; // L·∫•y lo·∫°i ƒëang ch·ªçn
            let configData = {};

            // TR∆Ø·ªúNG H·ª¢P 1: H·ªìi m√°u (Heal)
            if (type === 'heal') {
                const val = document.getElementById('logic-value').value;
                configData = { 
                    action: 'heal', 
                    hp_restore: parseInt(val) || 0 
                };
            }
            
            // TR∆Ø·ªúNG H·ª¢P 2: R∆∞∆°ng Gacha (ƒê√∫ng giao di·ªán ·∫£nh g·ª≠i)
            else if (type === 'gacha_open') {
                const rows = document.querySelectorAll('#gacha-items-list > div');
                const drops = [];
                let totalRate = 0;

                rows.forEach(row => {
                    const itemId = row.querySelector('.gacha-item-id').value;
                    const rate = parseFloat(row.querySelector('.gacha-item-rate').value) || 0;

                    if (itemId && rate > 0) {
                        drops.push({ id: parseInt(itemId), rate: rate });
                        totalRate += rate;
                    }
                });

                // C·∫£nh b√°o nh·∫π n·∫øu t·ª∑ l·ªá ·∫£o (nh∆∞ng v·∫´n cho l∆∞u)
                if (drops.length > 0 && Math.abs(totalRate - 100) > 1) {
                    console.warn(`‚ö†Ô∏è T·ªïng t·ª∑ l·ªá Gacha l√† ${totalRate}%, kh√¥ng ph·∫£i 100%`);
                }

                configData = {
                    action: 'gacha_open',
                    drops: drops // L∆∞u m·∫£ng item v√†o ƒë√¢y
                };
            }

            // TR∆Ø·ªúNG H·ª¢P 3: G·ª≠i l·ªùi nh·∫Øn (Message)
            else if (type === 'send_message') {
                configData = { action: 'send_message' };
            }

            // Tr·∫£ v·ªÅ chu·ªói JSON ƒë·ªÉ Backend l∆∞u v√†o c·ªôt 'config'
            return JSON.stringify(configData);
        }

        //26 T√¨m √¥ ch·ªçn V·∫≠t ph·∫©m trong b·∫£ng Qu√† t·∫∑ng admin
        async function loadItemsToSelect() {
            // T√¨m c√°i √¥ ch·ªçn V·∫≠t ph·∫©m trong b·∫£ng Qu√† t·∫∑ng
            // L∆∞u √Ω: B·∫°n h√£y ki·ªÉm tra xem ID c·ªßa √¥ select ƒë√≥ c√≥ ƒë√∫ng l√† 'gift-item-id' kh√¥ng nh√©
            const select = document.getElementById('item-template-select'); 
            if (!select) {
                console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y √¥ ch·ªçn 'item-template-select'");
                return;
            }

            try {
                const res = await fetch('/admin/shop/items');
                const items = await res.json();

                // X√≥a c√°c t√πy ch·ªçn c≈©, ch·ªâ ƒë·ªÉ l·∫°i t√πy ch·ªçn m·∫∑c ƒë·ªãnh
                select.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';

                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    // Hi·ªÉn th·ªã t√™n k√®m ID ƒë·ªÉ admin d·ªÖ ph√¢n bi·ªát
                    option.textContent = `${item.name} (ID: ${item.id})`;
                    select.appendChild(option);
                });
                
                console.log("‚úÖ ƒê√£ n·∫°p danh s√°ch v·∫≠t ph·∫©m v√†o b·∫£ng Qu√† t·∫∑ng");
            } catch (e) {
                console.error("‚ùå L·ªói n·∫°p danh s√°ch v·∫≠t ph·∫©m:", e);
            }
        }

        //27 M·ªü/ƒê√≥ng Modal
        function openAiImportModal() {
            document.getElementById('ai-import-modal').classList.remove('hidden');
        }

        function closeAiImportModal() {
            document.getElementById('ai-import-modal').classList.add('hidden');
            document.getElementById('ai-json-input').value = '';
        }

        //28 G·ª≠i d·ªØ li·ªáu l√™n Server
        async function submitAiImport() {
            const fileInput = document.getElementById('json-file-input');
            // L·∫•y gi√° tr·ªã mode t·ª´ radio buttons (ƒê·∫£m b·∫£o name="import-mode" ch√≠nh x√°c trong HTML)
            const modeElement = document.querySelector('input[name="import-mode"]:checked');
            
            // Ki·ªÉm tra an to√†n
            if (!fileInput || !fileInput.files[0]) {
                return alert("Vui l√≤ng ch·ªçn file .json!");
            }
            
            const mode = modeElement ? modeElement.value : "append";

            const formData = new FormData();
            // T√™n 'file' v√† 'mode' ph·∫£i kh·ªõp 100% v·ªõi tham s·ªë trong Python
            formData.append('file', fileInput.files[0]); 
            formData.append('mode', mode);

            try {
                const response = await fetch('/admin/tower/import-questions', {
                    method: 'POST',
                    // TUY·ªÜT ƒê·ªêI kh√¥ng ƒë·∫∑t headers Content-Type ·ªü ƒë√¢y
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeAiImportModal();
                    loadTowerQuestions();
                    fileInput.value = ""; 
                } else {
                    // Xem chi ti·∫øt l·ªói ·ªü Console n·∫øu v·∫´n b·ªã 422
                    console.error("Server tr·∫£ v·ªÅ l·ªói:", result);
                    alert(`‚ùå L·ªói ${response.status}: ${JSON.stringify(result.detail)}`);
                }
            } catch (e) {
                console.error("L·ªói k·∫øt n·ªëi:", e);
            }
        }
        // 29. H√†m Hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi (ƒê√£ Fix l·ªói n√∫t ·∫©n)
        async function loadTowerQuestions() {
            const tbody = document.getElementById('tower-question-list');
            if (!tbody) return;

            try {
                // G·ªçi API th·ªëng k√™
                const response = await fetch('/admin/tower/stats');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-400">L·ªói: ${errorData.detail || 'Kh√¥ng t√¨m th·∫•y API'}</td></tr>`;
                    return;
                }

                const stats = await response.json();
                const entries = Object.entries(stats);

                tbody.innerHTML = ''; 
                if (entries.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 italic">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™.</td></tr>`;
                    return;
                }

                // Duy·ªát qua t·ª´ng m√¥n h·ªçc
                entries.forEach(([subject, data]) => {
                    // Gom nh√≥m chi ti·∫øt ƒë·ªô kh√≥
                    const difficultyDetail = Object.entries(data.details)
                        .map(([diff, count]) => `<span class="text-gray-400 text-[10px]">${diff}:</span> <span class="text-white font-bold text-xs">${count}</span>`)
                        .join(' <span class="text-gray-700 mx-1">|</span> ');

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-800/50 transition border-b border-gray-700/50 group">
                            <td class="px-4 py-4">
                                <span class="px-3 py-1 rounded bg-blue-900/30 text-blue-400 text-xs font-bold border border-blue-800 uppercase tracking-wide">
                                    ${subject}
                                </span>
                            </td>
                            <td class="px-4 py-4 text-center">
                                <div class="flex items-center justify-center bg-gray-900/50 rounded py-1 px-2 border border-gray-800">
                                    ${difficultyDetail}
                                </div>
                            </td>
                            <td class="px-4 py-4 text-center">
                                <div class="flex flex-col">
                                    <span class="text-green-400 text-lg font-mono font-bold">${data.total}</span>
                                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">C√¢u h·ªèi</span>
                                </div>
                            </td>
                            <td class="px-4 py-4 text-right">
                                <button onclick="deleteSubjectGroup('${subject}')" 
                                        class="inline-flex items-center justify-center space-x-1 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/50 px-3 py-1.5 rounded transition duration-200 group-hover:shadow-lg hover:shadow-red-900/50">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                    <span class="text-xs font-bold uppercase">X√≥a</span>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error("‚ùå L·ªói t·∫£i th·ªëng k√™ c√¢u h·ªèi:", e);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-400">L·ªói k·∫øt n·ªëi Server</td></tr>`;
            }
        }

        //30 Logic ƒë·ªçc file JSON
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Ki·ªÉm tra xem n·ªôi dung c√≥ ph·∫£i JSON h·ª£p l·ªá kh√¥ng
                    const content = e.target.result;
                    JSON.parse(content); 
                    document.getElementById('ai-json-input').value = content;
                    alert("‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng!");
                } catch (err) {
                    alert("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON chu·∫©n!");
                    input.value = ''; // Reset input
                }
            };
            reader.readAsText(file);
        }

        //31 Script t·ª± ƒë·ªông c·∫≠p nh·∫≠t th·ªëng k√™
        async function loadTowerStats() {
            const container = document.getElementById('tower-stats-container');
            if (!container) return;

            try {
                const response = await fetch('/admin/tower/stats');
                const stats = await response.json();

                container.innerHTML = '';
                
                for (const [subject, data] of Object.entries(stats)) {
                    let detailsHtml = Object.entries(data.details)
                        .map(([diff, count]) => `<span class="text-[10px] bg-gray-900 px-2 py-0.5 rounded text-gray-400">${diff}: ${count}</span>`)
                        .join(' ');

                    container.innerHTML += `
                        <div class="bg-gray-800 border border-gray-700 p-4 rounded-xl shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-white font-bold">${subject}</h4>
                                <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">${data.total} c√¢u</span>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${detailsHtml}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("‚ùå L·ªói t·∫£i th·ªëng k√™:", e);
            }
        }

        //31 x√≥a c√¢u h·ªèi
        async function deleteSubjectGroup(subject) {
            // 1. X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a ƒë·ªÉ tr√°nh b·∫•m nh·∫ßm
            if (!confirm(`C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò c√¢u h·ªèi c·ªßa m√¥n [${subject}] kh√¥ng?\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            try {
                // 2. G·ªçi API x√≥a (ƒê∆∞·ªùng d·∫´n ƒë√£ c√≥ ti·ªÅn t·ªë /admin theo c·∫•u tr√∫c m·ªõi)
                const response = await fetch(`/admin/tower/delete-subject/${subject}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    // 3. G·ªçi l·∫°i h√†m load ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ ngay l·∫≠p t·ª©c
                    loadTowerQuestions(); 
                } else {
                    alert(`‚ùå L·ªói: ${result.detail || "Kh√¥ng th·ªÉ x√≥a m√¥n h·ªçc"}`);
                }
            } catch (error) {
                console.error("L·ªói khi x√≥a m√¥n h·ªçc:", error);
                alert("‚ùå L·ªói k·∫øt n·ªëi Server ho·∫∑c l·ªói h·ªá th·ªëng.");
            }
        }

        //32 H√†m chuy·ªÉn ƒë·ªïi giao di·ªán d·ª±a tr√™n lo·∫°i ph·∫ßn th∆∞·ªüng (Phi√™n b·∫£n d√πng chung d·ªØ li·ªáu Shop)
        async function toggleRewardInputs() {
            const type = document.getElementById('reward-type').value;
            const subSelect = document.getElementById('reward-sub-type');
            
            // 1. Reset dropdown
            subSelect.innerHTML = ''; 
            subSelect.classList.remove('hidden');

            // 2. N·∫øu ch·ªçn EXP
            if (type === 'exp') {
                subSelect.classList.add('hidden');
                return;
            }

            // 3. N·∫øu ch·ªçn Ti·ªÅn t·ªá
            if (type === 'currency') {
                subSelect.innerHTML = `
                    <option value="kpi">ƒêi·ªÉm KPI (Ch√≠nh)</option>
                    <option value="tri_thuc">Tri Th·ª©c (Xanh)</option>
                    <option value="vinh_du">Vinh D·ª± (T√≠m)</option>
                    <option value="chien_tich">Chi·∫øn T√≠ch (Cam)</option>
                `;
            } 
            // 4. N·∫øu ch·ªçn V·∫≠t ph·∫©m (Item th∆∞·ªùng)
            else if (type === 'item') {
                subSelect.innerHTML = `<option>‚è≥ ƒêang t·∫£i ƒë·ªì...</option>`;
                try {
                    const res = await fetch('/admin/items/templates');
                    if (res.ok) {
                        const items = await res.json();
                        subSelect.innerHTML = items.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
                    } else {
                        subSelect.innerHTML = `<option value="">L·ªói t·∫£i ƒë·ªì</option>`;
                    }
                } catch (e) { console.error(e); }
            }
            // 5. üëá N·∫æU CH·ªåN CHARM (M·ªöI TH√äM) üëá
            else if (type === 'charm') {
                subSelect.innerHTML = `
                    <option value="RANDOM_CHARM_MAGIC">üîÆ Charm Ma Thu·∫≠t (Magic)</option>
                    <option value="RANDOM_CHARM_EPIC">üü£ Charm S·ª≠ Thi (Epic)</option>
                    <option value="RANDOM_CHARM_LEGEND">üü° Charm Huy·ªÅn Tho·∫°i (Legend)</option>
                `;
            }
        }

        //33 H√†m th√™m ph·∫ßn th∆∞·ªüng v√†o giao di·ªán (V·∫Ω card)
        function addRewardToPool() {
            const diff = document.getElementById('reward-target-diff').value;
            const type = document.getElementById('reward-type').value;
            const amount = document.getElementById('tower-reward-amount').value;
            const rate = document.getElementById('reward-drop-rate').value;
            
            // L·∫•y gi√° tr·ªã ph·ª• (ID item ho·∫∑c ID charm)
            const subType = document.getElementById('reward-sub-type').value;
            let subTypeText = document.getElementById('reward-sub-type').options[document.getElementById('reward-sub-type').selectedIndex]?.text || '';

            if (!amount) return alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng!");

            // --- X·ª¨ L√ù HI·ªÇN TH·ªä T√äN CHARM ---
            // N·∫øu l√† Charm, ta s·ª≠a l·∫°i c√°i text hi·ªÉn th·ªã cho ƒë·∫πp
            if (type === 'charm') {
                // T·ª± ƒë·ªông b·ªè ch·ªØ "RANDOM_CHARM_" ƒë·ªÉ hi·ªÉn th·ªã cho g·ªçn
                if (subType === 'RANDOM_CHARM_MAGIC') subTypeText = "Charm Ma Thu·∫≠t";
                if (subType === 'RANDOM_CHARM_EPIC') subTypeText = "Charm S·ª≠ Thi";
                if (subType === 'RANDOM_CHARM_LEGEND') subTypeText = "Charm Huy·ªÅn Tho·∫°i";
            }

            const pool = document.getElementById(`pool-${diff}`);
            const rewardId = Date.now(); 

            // D·ªØ li·ªáu ·∫©n ƒë·ªÉ g·ª≠i v·ªÅ Server (L∆∞u v√†o data-attribute)
            // Quan tr·ªçng: Ta l∆∞u subType v√†o data-subtype ƒë·ªÉ l√∫c Save c√≤n bi·∫øt ƒë∆∞·ªùng l·∫•y
            const card = document.createElement('div');
            card.className = "bg-gray-900 border border-gray-700 p-2 rounded-lg flex justify-between items-center group animate-fade-in mb-2";
            card.id = `reward-${rewardId}`;
            
            // üëá Th√™m c√°c thu·ªôc t√≠nh data- ƒë·ªÉ h√†m Save d·ªÖ l·∫•y
            card.dataset.type = type;
            card.dataset.subtype = subType; // L∆∞u ID item ho·∫∑c m√£ Charm (VD: RANDOM_CHARM_MAGIC)
            card.dataset.amount = amount;
            card.dataset.rate = rate;

            card.innerHTML = `
                <div>
                    <div class="text-[9px] text-gray-500 font-bold uppercase">${type === 'charm' ? 'V·∫¨T PH·∫®M CHARM' : type}</div>
                    <div class="text-xs text-white">
                        ${type === 'exp' ? 'KPI/EXP' : subTypeText}: 
                        <span class="text-yellow-400 font-bold">${amount}</span>
                    </div>
                    <div class="text-[8px] text-gray-600 italic">T·ª∑ l·ªá r∆°i: ${rate}%</div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-700 group-hover:text-red-500 transition px-2">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            pool.appendChild(card);
        }

        //34 H√†m L∆∞u C·∫•u H√¨nh Th√°p

        async function saveTowerFullConfig() {
            // 1. Thu th·∫≠p d·ªØ li·ªáu h√¨nh ·∫£nh
            const monsterPool = document.getElementById('monster-pool')?.value.trim() || "";
            const bgPool = document.getElementById('bg-pool')?.value.trim() || "";

            // 2. Thu th·∫≠p d·ªØ li·ªáu ph·∫ßn th∆∞·ªüng t·ª´ 4 c·ªôt
            const difficulties = ['Medium', 'Hard', 'Extreme', 'Hell'];
            const rewardConfig = {};

            difficulties.forEach(diff => {
                const pool = document.getElementById(`pool-${diff}`);
                // L·∫•y t·∫•t c·∫£ c√°c th·∫ª c√≥ id b·∫Øt ƒë·∫ßu b·∫±ng reward-
                const cards = pool.querySelectorAll('[id^="reward-"]');
                
                rewardConfig[diff] = Array.from(cards).map(card => {
                    // [C·∫¨P NH·∫¨T QUAN TR·ªåNG] 
                    // Thay v√¨ ƒë·ªçc text hi·ªÉn th·ªã, ta ƒë·ªçc t·ª´ dataset (d·ªØ li·ªáu g·ªëc) 
                    // ƒë·ªÉ l·∫•y ƒë√∫ng m√£ charm (VD: RANDOM_CHARM_MAGIC)
                    
                    // L·∫•y type (exp/item/charm...)
                    const type = card.dataset.type || card.querySelector('.uppercase').innerText.toLowerCase();
                    
                    // L·∫•y subtype (Quan tr·ªçng: ƒê√¢y l√† n∆°i ch·ª©a ID item ho·∫∑c M√£ Charm)
                    // N·∫øu l√† Charm, n√≥ s·∫Ω l√† "RANDOM_CHARM_MAGIC". N·∫øu l√† item, n√≥ l√† ID s·ªë.
                    const name = card.dataset.subtype || card.querySelector('.text-xs').innerText.split(':')[0].trim();
                    
                    // L·∫•y s·ªë l∆∞·ª£ng
                    const amount = parseInt(card.dataset.amount || card.querySelector('.text-yellow-400').innerText);
                    
                    // L·∫•y t·ª∑ l·ªá r∆°i
                    let rateRaw = card.dataset.rate;
                    if (!rateRaw) {
                        // Fallback n·∫øu th·∫ª c≈© ch∆∞a c√≥ dataset
                        rateRaw = card.querySelector('.italic').innerText.replace(/\D/g, '');
                    }
                    const rate = parseInt(rateRaw);

                    return {
                        type: type,
                        name: name,   // Server c·∫ßn c√°i n√†y chu·∫©n code
                        amount: amount,
                        rate: rate
                    };
                });
            });

            // 3. ƒê√≥ng g√≥i v√† g·ª≠i ƒëi
            const finalData = {
                monster_pool: monsterPool,
                bg_pool: bgPool,
                rewards: rewardConfig
            };

            try {
                const response = await fetch('/admin/tower/save-config', { // Ho·∫∑c /tower/save-config t√πy router b·∫°n
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalData)
                });

                if (response.ok) {
                    console.log("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng!");
                    // alert("ƒê√£ l∆∞u c·∫•u h√¨nh!"); 
                    // Thay alert b·∫±ng th√¥ng b√°o nh·∫π nh√†ng n·∫øu c√≥ library, ho·∫∑c gi·ªØ nguy√™n alert
                    if(typeof Swal !== 'undefined') {
                        Swal.fire("Th√†nh c√¥ng", "ƒê√£ l∆∞u c·∫•u h√¨nh th√°p!", "success");
                    } else {
                        alert("ƒê√£ l∆∞u c·∫•u h√¨nh th√°p th√†nh c√¥ng!");
                    }
                } else {
                    alert("‚ùå L·ªói khi l∆∞u c·∫•u h√¨nh.");
                }
            } catch (e) {
                console.error("L·ªói save:", e);
                alert("‚ùå L·ªói k·∫øt n·ªëi Server.");
            }
        }

        // 35. H√†m t·∫£i v√† ƒëi·ªÅn d·ªØ li·ªáu c≈©
        async function loadSavedTowerConfig() {
            try {
                const res = await fetch('/admin/tower/get-config');
                if (!res.ok) return; // N·∫øu API ch∆∞a s·∫µn s√†ng th√¨ b·ªè qua
                
                const config = await res.json();

                // A. ƒêi·ªÅn l·∫°i link ·∫£nh (N·∫øu b·∫°n ƒë√£ t·∫°o √¥ input)
                if(document.getElementById('monster-pool')) 
                    document.getElementById('monster-pool').value = config.monster_pool || "";
                if(document.getElementById('bg-pool')) 
                    document.getElementById('bg-pool').value = config.bg_pool || "";

                // B. V·∫Ω l·∫°i th·∫ª qu√† cho 4 c·ªôt
                if (config.rewards) {
                    const difficulties = ['Medium', 'Hard', 'Extreme', 'Hell'];
                    
                    difficulties.forEach(diff => {
                        const items = config.rewards[diff];
                        const pool = document.getElementById(`pool-${diff}`);
                        
                        if (pool && items) {
                            pool.innerHTML = ""; // X√≥a tr·∫Øng tr∆∞·ªõc khi v·∫Ω
                            items.forEach(item => {
                                renderSavedRewardCard(pool, item);
                            });
                        }
                    });
                }
                console.log("‚úÖ ƒê√£ t·∫£i c·∫•u h√¨nh Th√°p th√†nh c√¥ng.");
            } catch (e) {
                console.log("Ch∆∞a c√≥ c·∫•u h√¨nh c≈© ho·∫∑c l·ªói t·∫£i:", e);
            }
        }

        // 36. H√†m v·∫Ω th·∫ª (Helper)
        function renderSavedRewardCard(container, item) {
            const rewardId = Date.now() + Math.random();
            // Ch·ªçn m√†u ch·ªØ
            const typeColor = item.type === 'exp' ? 'text-blue-400' : (item.type === 'currency' ? 'text-green-400' : 'text-purple-400');
            
            const card = document.createElement('div');
            card.className = "bg-gray-900 border border-gray-700 p-2 rounded-lg flex justify-between items-center group shadow-inner mb-2 animate-fade-in";
            card.id = `reward-${rewardId}`;
            
            // G√°n l·∫°i dataset ƒë·ªÉ n√∫t L∆∞u sau n√†y ƒë·ªçc ƒë∆∞·ª£c
            card.dataset.type = item.type;
            card.dataset.name = item.name;
            card.dataset.amount = item.amount;
            card.dataset.rate = item.rate;

            card.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-1 h-8 bg-gray-700 rounded"></div>
                    <div>
                        <div class="text-[10px] ${typeColor} font-black uppercase">${item.type === 'exp' ? 'EXP' : item.name}</div>
                        <div class="text-xs text-white">S·ªë l∆∞·ª£ng: <span class="text-yellow-400 font-bold">${item.amount}</span></div>
                        <div class="text-[8px] text-gray-500 italic">T·ª∑ l·ªá: ${item.rate}%</div>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-600 hover:text-red-500 transition-all p-2">
                    <i class="fas fa-trash-alt text-[10px]"></i>
                </button>
            `;
            container.appendChild(card);
        }

        // H√†m x√≥a s·∫°ch ph·∫ßn th∆∞·ªüng trong m·ªôt ƒë·ªô kh√≥ c·ªßa th√°p
        async function clearPool(difficulty) {
            if (confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA S·∫†CH ph·∫ßn th∆∞·ªüng c·ªßa b·∫≠c ${difficulty}?`)) {
                const pool = document.getElementById(`pool-${difficulty}`);
                if (pool) {
                    pool.innerHTML = ''; // X√≥a giao di·ªán
                    
                    // üëá QUAN TR·ªåNG: G·ªçi h√†m l∆∞u ngay l·∫≠p t·ª©c ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi Server
                    await saveTowerFullConfig(); 
                }
            }
        }

        //37 --- LOGIC TAB D·ªÆ LI·ªÜU ---

        // 37.1. Chuy·ªÉn ƒë·ªïi Sub-tab
        function switchSubTab(tabName) {
            // ·∫®n t·∫•t c·∫£ n·ªôi dung
            document.querySelectorAll('.sub-content').forEach(el => el.classList.add('hidden'));
            // Reset style n√∫t b·∫•m
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.className = "sub-tab-btn text-gray-400 hover:text-white px-4 py-2 transition";
            });

            // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(`sub-${tabName}`).classList.remove('hidden');
            // Highlight n√∫t ƒë∆∞·ª£c ch·ªçn
            const activeBtn = document.getElementById(`btn-sub-${tabName}`);
            activeBtn.className = "sub-tab-btn text-blue-400 border-b-2 border-blue-400 font-bold px-4 py-2";

            // Load d·ªØ li·ªáu t∆∞∆°ng ·ª©ng
            if (tabName === 'stats') loadDashboardStats();
            if (tabName === 'logs') loadSystemLogs();
            if (tabName === 'maintenance') loadMaintenanceStatus();
            if (tabName === 'TabPet') loadPets();
        }

        // 37.2. Load Th·ªëng k√™ (Statistics)
        async function loadDashboardStats() {
            try {
                const res = await fetch('/admin/data/dashboard-stats');
                const data = await res.json();

                // A. Render Top KPI
                const topKpiContainer = document.getElementById('top-kpi-list');
                topKpiContainer.innerHTML = data.top_kpi.map((p, index) => `
                    <div class="flex justify-between items-center bg-gray-900 p-2 rounded border-l-4 ${index === 0 ? 'border-yellow-400' : 'border-gray-600'}">
                        <div class="flex items-center">
                            <span class="font-bold w-6 text-center ${index < 3 ? 'text-yellow-400' : 'text-gray-500'}">#${index + 1}</span>
                            <span class="text-white ml-2">${p.full_name}</span>
                        </div>
                        <span class="font-mono text-green-400 font-bold">${p.kpi} KPI</span>
                    </div>
                `).join('');

                // B. Render Top Vi Ph·∫°m (Vinh d·ª± th·∫•p)
                const topVioContainer = document.getElementById('top-violation-list');
                topVioContainer.innerHTML = data.top_violation.map(p => `
                    <div class="flex justify-between items-center bg-gray-900 p-2 rounded border-l-4 border-red-500">
                        <span class="text-white ml-2">${p.full_name}</span>
                        <span class="font-mono text-purple-400 font-bold">${p.vinh_du} VD</span>
                    </div>
                `).join('');

                // C. Render Bi·ªÉu ƒë·ªì T·ªï ƒë·ªôi (D√πng CSS Width %)
                const chartContainer = document.getElementById('team-chart-container');
                // T√¨m team c√≥ ƒëi·ªÉm cao nh·∫•t ƒë·ªÉ t√≠nh % width
                const maxKpi = Math.max(...data.teams.map(t => t.total_kpi), 1); 
                
                chartContainer.innerHTML = data.teams.map(t => {
                    const widthPercent = (t.total_kpi / maxKpi) * 100;
                    // M√†u s·∫Øc kh√°c nhau cho t·ª´ng ƒë·ªôi
                    const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500'];
                    const colorClass = colors[(t.team_id - 1) % 4] || 'bg-gray-500';

                    return `
                    <div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>T·ªî ${t.team_id} (${t.member_count} tv)</span>
                            <span>${t.total_kpi} KPI</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="${colorClass} h-4 rounded-full transition-all duration-1000" style="width: ${widthPercent}%"></div>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                console.error("L·ªói t·∫£i th·ªëng k√™:", e);
            }
        }

        // 37.3. Load Logs
        async function loadSystemLogs() {
            const filter = document.getElementById('log-filter').value;
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">ƒêang t·∫£i...</td></tr>';

            try {
                const res = await fetch(`/admin/data/logs?type_filter=${filter}`);
                const logs = await res.json();

                if(logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr class="hover:bg-gray-800 transition">
                        <td class="p-3 text-gray-500 font-mono text-[10px]">${log.timestamp || 'N/A'}</td>
                        <td class="p-3 font-bold text-blue-300">${log.actor_name || 'System'}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded bg-gray-700 text-xs">${log.action}</span>
                        </td>
                        <td class="p-3 text-gray-400 italic text-xs truncate max-w-xs" title="${log.details}">
                            ${log.details}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error("L·ªói t·∫£i logs:", e);
            }
        }

        // 37.4. X·ª≠ l√Ω Restore DB
        async function handleRestoreDB() {
            const fileInput = document.getElementById('restore-file');
            if (!fileInput.files[0]) {
                alert("Vui l√≤ng ch·ªçn file .db ƒë·ªÉ kh√¥i ph·ª•c!");
                return;
            }

            // Confirm 2 l·ªõp cho ch·∫Øc ch·∫Øn
            if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO NGUY HI·ªÇM ‚ö†Ô∏è\n\nH√†nh ƒë·ªông n√†y s·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng file b·∫°n v·ª´a ch·ªçn.\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?")) return;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch('/admin/data/restore', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success) {
                    alert(result.message);
                    location.reload(); // F5 l·∫°i trang ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu m·ªõi
                } else {
                    alert("L·ªói: " + result.message);
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        //38 Load tr·∫°ng th√°i b·∫£o tr√¨ khi m·ªü tab
        async function loadMaintenanceStatus() {
            try {
                const res = await fetch('/admin/data/maintenance-status');
                const data = await res.json();
                
                const toggle = document.getElementById('maintenance-toggle');
                const statusText = document.getElementById('maintenance-status-text');
                const msgInput = document.getElementById('maintenance-msg');
                
                toggle.checked = data.is_maintenance;
                msgInput.value = data.message;
                
                if (data.is_maintenance) {
                    statusText.innerText = "H·ªÜ TH·ªêNG ƒêANG KH√ìA (B·∫¢O TR√å)";
                    statusText.className = "text-xl font-bold text-red-500";
                } else {
                    statusText.innerText = "H·ªÜ TH·ªêNG ƒêANG M·ªû";
                    statusText.className = "text-xl font-bold text-green-500";
                }
            } catch (e) { console.error("L·ªói t·∫£i tr·∫°ng th√°i b·∫£o tr√¨", e); }
        }

        //38.1 L∆∞u tr·∫°ng th√°i
        async function saveMaintenance() {
            const isMaintenance = document.getElementById('maintenance-toggle').checked;
            const message = document.getElementById('maintenance-msg').value;

            if (!confirm("X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i truy c·∫≠p c·ªßa to√†n b·ªô h·ªçc sinh?")) return;

            try {
                const res = await fetch('/admin/data/maintenance-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_maintenance: isMaintenance, message: message })
                });
                const result = await res.json();
                if (result.success) {
                    alert(result.message);
                    loadMaintenanceStatus();
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }
        
        //39 ===============================================
        //   LOGIC QU·∫¢N L√ù PET (S·ª≠ d·ª•ng API Shop/Item)
        //   ===============================================

        // 1. H√†m load danh s√°ch Pet
        async function loadPets() {
            try {
                // G·ªçi API l·∫•y to√†n b·ªô Item
                const res = await fetch('/admin/shop/items');
                const items = await res.json();
                
                const tbody = document.getElementById('pet-list-body');
                tbody.innerHTML = '';

                // L·ªçc ch·ªâ l·∫•y nh·ªØng Item c√≥ category l√† "PET" ho·∫∑c "PET_SHARD"
                // (·ªû ƒë√¢y ta t·∫°m quy ∆∞·ªõc category="PET" l√† th√∫ c∆∞ng)
                const pets = items.filter(i => i.category === 'PET');

                if (pets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Ch∆∞a c√≥ linh th√∫ n√†o. H√£y t·∫°o m·ªõi!</td></tr>';
                    return;
                }

                pets.forEach(p => {
                    const row = `
                        <tr>
                            <td>${p.id}</td>
                            <td><img src="${p.image_url}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;"></td>
                            <td style="font-weight:bold; color: #d35400;">${p.name}</td>
                            <td><span class="badge badge-${p.rarity}">${p.rarity}</span></td>
                            <td>${p.description}</td>
                            <td>
                                <button onclick="deleteItem(${p.id})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
                                    <i class="fas fa-trash"></i> X√≥a
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error("L·ªói t·∫£i Pet:", error);
            }
        }

        // 2. H√†m t·∫°o Pet m·ªõi
        // H√†m t·ª± ƒë·ªông ƒëi·ªÅn m√¥ t·∫£ khi ch·ªçn lo·∫°i Buff
        function autoUpdateDesc() {
            const type = document.getElementById('pet-buff-type').value;
            const val = document.getElementById('pet-buff-value').value;
            const descInput = document.getElementById('pet-desc');

            if (!val) return;

            let text = "";
            if (type === 'EXP') text = `TƒÉng ${val}% kinh nghi·ªám (EXP) khi k√≠ch ho·∫°t`;
            else if (type === 'ATK') text = `C·ªông ${val} s·ª©c t·∫•n c√¥ng cho ch·ªß nh√¢n`;
            else if (type === 'HP') text = `C·ªông ${val} m√°u t·ªëi ƒëa cho ch·ªß nh√¢n`;

            descInput.value = text;
        }

        // H√†m c·∫≠p nh·∫≠t Preview - PHI√äN B·∫¢N OVERLAY (·ªîn ƒë·ªãnh nh·∫•t)
        function updatePreview() {
            // 1. L·∫•y d·ªØ li·ªáu
            const name = document.getElementById('pet-name').value || "T√™n Linh Th√∫";
            const imgUrl = document.getElementById('pet-image').value;
            const rarity = document.getElementById('pet-rarity').value;
            const effect = document.getElementById('pet-effect').value;
            
            // üëá L·∫•y d·ªØ li·ªáu M·∫£nh
            const isFragment = document.getElementById('is-fragment').checked;
            const fragReq = document.getElementById('frag-req').value;

            // 2. DOM Elements
            const previewCard = document.getElementById('preview-card');
            const previewImg = document.getElementById('preview-img-src');
            const previewBadge = document.getElementById('preview-badge');
            const previewName = document.getElementById('preview-name-text');
            const effectOverlay = document.getElementById('effect-overlay');
            
            // üëá DOM M·ªõi cho M·∫£nh
            const fragText = document.getElementById('fragment-overlay-text');
            const fragInputGroup = document.getElementById('frag-qty-group');
            const fragReqDisplay = document.getElementById('preview-frag-req');

            // C·∫≠p nh·∫≠t n·ªôi dung c∆° b·∫£n
            previewName.innerText = name;
            previewImg.src = imgUrl || "https://placehold.co/300x450/374151/white?text=NO+IMAGE";
            previewBadge.innerText = rarity;

            // 3. X·ª≠ l√Ω Ch·∫ø ƒë·ªô M·∫£nh (QUAN TR·ªåNG)
            if (isFragment) {
                // Hi·ªán input nh·∫≠p s·ªë l∆∞·ª£ng
                fragInputGroup.classList.remove('hidden');
                
                // Hi·ªán ch·ªØ M·∫¢NH GH√âP ƒë√® l√™n
                fragText.classList.remove('hidden');
                fragReqDisplay.innerText = fragReq;

                // L√†m m·ªù ·∫£nh & Chuy·ªÉn ƒëen tr·∫Øng nh·∫π
                previewImg.className = "w-full h-full object-cover z-0 relative filter blur-[2px] grayscale-[50%]";
            } else {
                // T·∫Øt ch·∫ø ƒë·ªô m·∫£nh
                fragInputGroup.classList.add('hidden');
                fragText.classList.add('hidden');
                
                // ·∫¢nh b√¨nh th∆∞·ªùng
                previewImg.className = "w-full h-full object-cover z-0 relative";
            }

            // 4. X·ª≠ l√Ω Rarity (Khung vi·ªÅn) - GI·ªÆ NGUY√äN CODE C≈®
            previewCard.className = "relative w-48 h-72 rounded-xl overflow-hidden group border-4 transition-all duration-300";
            previewCard.style.boxShadow = ""; 
            previewCard.classList.remove("ssr-active");

            if (rarity === 'R') {
                previewCard.classList.add("bg-gray-900", "border-gray-500");
                previewBadge.className = "absolute top-2 left-2 text-white text-xs font-bold px-2 py-1 rounded shadow z-30 bg-gray-600";
            } 
            else if (rarity === 'SR') {
                previewCard.classList.add("bg-gray-900", "border-yellow-400");
                previewCard.style.boxShadow = "0 0 15px rgba(250, 204, 21, 0.6)";
                previewBadge.className = "absolute top-2 left-2 text-white text-xs font-bold px-2 py-1 rounded shadow z-30 bg-yellow-600";
            } 
            else if (rarity === 'SSR') {
                previewCard.className = "relative w-48 h-72 rounded-xl group ssr-active"; 
                previewBadge.className = "absolute top-2 left-2 text-white text-xs font-bold px-2 py-1 rounded shadow z-30 bg-purple-600 shadow-lg";
                // N·∫øu l√† SSR m√† l·∫°i l√† M·∫£nh -> V·∫´n c·∫ßn bo g√≥c ·∫£nh
                if (isFragment) {
                    previewImg.className = "w-full h-full object-cover rounded-lg z-10 relative filter blur-[2px] grayscale-[50%]";
                } else {
                    previewImg.className = "w-full h-full object-cover rounded-lg z-10 relative"; 
                }
            }

            // 5. Hi·ªáu ·ª©ng Overlay (Gi·ªØ nguy√™n)
            effectOverlay.className = "absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-xl";
            if (effect === 'FIRE') effectOverlay.classList.add("effect-fire");
            else if (effect === 'SNOW') effectOverlay.classList.add("effect-snow");
            else if (effect === 'LIGHTNING') effectOverlay.classList.add("effect-lightning");
            else if (effect === 'GHOST') effectOverlay.classList.add("effect-ghost");
        }
        
        //40 H√†m t·∫°o Pet m·ªõi (Updated)
        async function createNewPet() {
            const name = document.getElementById('pet-name').value;
            const image = document.getElementById('pet-image').value || "https://placehold.co/300x450/374151/white?text=PET";
            const rarity = document.getElementById('pet-rarity').value;
            
            const buffType = document.getElementById('pet-buff-type').value;
            const buffValue = document.getElementById('pet-buff-value').value || 0;
            const visualEffect = document.getElementById('pet-effect').value;
            
            // üëá L·∫•y th√¥ng tin M·∫£nh
            const isFragment = document.getElementById('is-fragment').checked;
            const fragReq = parseInt(document.getElementById('frag-req').value) || 10;

            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n Linh Th√∫!");

            // T·ª± ƒë·ªông t·∫°o m√¥ t·∫£
            let autoDesc = "";
            if (isFragment) {
                autoDesc = `M·∫£nh gh√©p c·ªßa ${name}. C·∫ßn thu th·∫≠p ƒë·ªß ${fragReq} m·∫£nh ƒë·ªÉ tri·ªáu h·ªìi.`;
            } else {
                autoDesc = `Linh th√∫ h·ªá ${rarity}. `;
                if (buffType === 'ATK') autoDesc += `TƒÉng ${buffValue} t·∫•n c√¥ng.`;
                else if (buffType === 'HP') autoDesc += `TƒÉng ${buffValue} m√°u.`;
                else if (buffType === 'EXP') autoDesc += `TƒÉng ${buffValue}% kinh nghi·ªám.`;
                if (visualEffect !== 'NONE') autoDesc += ` [Hi·ªáu ·ª©ng: ${visualEffect}]`;
            }

            // ƒê√≥ng g√≥i Config
            const petConfig = {
                buff_type: buffType,
                buff_value: parseInt(buffValue),
                visual_effect: visualEffect,
                // üëá L∆∞u th√™m c·ªù hi·ªáu M·∫£nh
                is_fragment: isFragment,
                fusion_required: isFragment ? fragReq : 0
            };

            const newPet = {
                name: isFragment ? `[M·∫£nh] ${name}` : name, // Th√™m prefix cho d·ªÖ qu·∫£n l√Ω
                image_url: image,
                description: autoDesc, 
                rarity: rarity,
                category: isFragment ? "PET_FRAGMENT" : "PET", // Ph√¢n lo·∫°i r√µ r√†ng
                price: 0,
                currency_type: "NONE",
                config: JSON.stringify(petConfig)
            };

            try {
                const res = await fetch('/admin/shop/items/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newPet)
                });

                if (res.ok) {
                    alert(`‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng: ${newPet.name}`);
                    loadPets(); 
                } else {
                    alert("‚ùå L·ªói khi t·∫°o!");
                }
            } catch (e) {
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi!");
            }
        }

        //41 --- LOGIC QU·∫¢N L√ù GACHA CONFIG ---

        // 41.1. T·ª± ƒë·ªông t√≠nh to√°n t·ª∑ l·ªá M·∫£nh khi nh·∫≠p t·ª∑ l·ªá Th·∫ª
        function bindRateInputs() {
            const pairs = [
                { card: 'rate-r-card', text: 'text-r-frag' },
                { card: 'rate-sr-card', text: 'text-sr-frag' },
                { card: 'rate-ssr-card', text: 'text-ssr-frag' }
            ];

            pairs.forEach(pair => {
                const input = document.getElementById(pair.card);
                const display = document.getElementById(pair.text);
                
                input.addEventListener('input', () => {
                    let val = parseInt(input.value) || 0;
                    if (val > 100) val = 100;
                    if (val < 0) val = 0;
                    
                    // T·ª∑ l·ªá m·∫£nh = 100 - T·ª∑ l·ªá th·∫ª (Trong ph·∫°m vi Tier ƒë√≥)
                    display.innerText = 100 - val;
                });
            });

            // C·∫≠p nh·∫≠t t·ªïng t·ª∑ l·ªá Appear
            const appears = ['rate-r-appear', 'rate-sr-appear', 'rate-ssr-appear'];
            appears.forEach(id => {
                document.getElementById(id).addEventListener('input', checkTotalRate);
            });
        }

        function checkTotalRate() {
            const r = parseInt(document.getElementById('rate-r-appear').value) || 0;
            const sr = parseInt(document.getElementById('rate-sr-appear').value) || 0;
            const ssr = parseInt(document.getElementById('rate-ssr-appear').value) || 0;
            
            const total = r + sr + ssr;
            const display = document.getElementById('total-rate-display');
            const warning = document.getElementById('rate-warning');
            
            display.innerText = total + "%";
            
            if (total !== 100) {
                display.className = "font-bold text-red-500 text-lg";
                warning.classList.remove('hidden');
                return false;
            } else {
                display.className = "font-bold text-green-400 text-lg";
                warning.classList.add('hidden');
                return true;
            }
        }

        // 41.2. H√†m L∆∞u C·∫•u H√¨nh
        async function saveGachaConfig() {
            if (!checkTotalRate()) {
                alert("‚ùå T·ªïng t·ª∑ l·ªá xu·∫•t hi·ªán (R + SR + SSR) ph·∫£i ƒë√∫ng b·∫±ng 100%!");
                return;
            }

            const config = {
                R: {
                    appear_rate: parseInt(document.getElementById('rate-r-appear').value),
                    card_rate: parseInt(document.getElementById('rate-r-card').value),
                    frag_rate: 100 - parseInt(document.getElementById('rate-r-card').value)
                },
                SR: {
                    appear_rate: parseInt(document.getElementById('rate-sr-appear').value),
                    card_rate: parseInt(document.getElementById('rate-sr-card').value),
                    frag_rate: 100 - parseInt(document.getElementById('rate-sr-card').value)
                },
                SSR: {
                    appear_rate: parseInt(document.getElementById('rate-ssr-appear').value),
                    card_rate: parseInt(document.getElementById('rate-ssr-card').value),
                    frag_rate: 100 - parseInt(document.getElementById('rate-ssr-card').value)
                }
            };

            console.log("Saving Gacha Config:", config);
            
            // ·ªû ƒë√¢y ta s·∫Ω g·ªçi API ƒë·ªÉ l∆∞u v√†o DB (s·∫Ω l√†m ·ªü Phase sau)
            // T·∫°m th·ªùi hi·ªÉn th·ªã th√†nh c√¥ng
            alert("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh t·ª∑ l·ªá Gacha th√†nh c√¥ng!\n(D·ªØ li·ªáu ƒë√£ s·∫µn s√†ng ƒë·ªÉ Backend x·ª≠ l√Ω)");
        }

        // ==========================================
        // ü™Ñ TR√åNH ƒêI·ªÄU KHI·ªÇN QU·∫¢N L√ù K·ª∏ NƒÇNG (ADMIN)
        // ==========================================
        let allSkills = []; 

        // T·∫£i d·ªØ li·ªáu t·ª´ Server
        async function loadAdminSkills() {
            const container = document.getElementById('admin-skill-list');
            container.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';

            try {
                const res = await fetch('/admin/get-skills');
                adminAllSkills = await res.json(); // L∆∞u v√†o bi·∫øn to√†n c·ª•c
                
                // G·ªçi h√†m hi·ªÉn th·ªã theo b·ªô l·ªçc hi·ªán t·∫°i
                filterSkills(currentFilter); 
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-red-500 text-center text-xs">L·ªói t·∫£i d·ªØ li·ªáu</div>';
            }
        }

        // H√†m l·ªçc v√† hi·ªÉn th·ªã (G√°n v√†o 2 n√∫t WARRIOR / MAGE b√™n tr√°i)
        function filterSkills(classType) {
            currentFilter = classType; // C·∫≠p nh·∫≠t b·ªô l·ªçc ƒëang ch·ªçn

            // 1. Update UI n√∫t b·∫•m (S√°ng n√∫t ƒëang ch·ªçn, t·ªëi n√∫t kia)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.type === classType) {
                    btn.classList.add('bg-opacity-100', 'ring-2', 'ring-white');
                    btn.classList.remove('bg-opacity-20');
                } else {
                    btn.classList.remove('bg-opacity-100', 'ring-2', 'ring-white');
                    btn.classList.add('bg-opacity-20');
                }
            });

            // 2. L·ªçc d·ªØ li·ªáu
            const filtered = adminAllSkills.filter(s => s.class_type === classType);
            const container = document.getElementById('admin-skill-list');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500 text-sm italic">Ch∆∞a c√≥ k·ªπ nƒÉng n√†o cho ${classType}</div>`;
                return;
            }

            // 3. V·∫Ω danh s√°ch
            filtered.forEach(skill => {
                const div = document.createElement('div');
                div.className = "bg-gray-700/50 p-3 rounded border border-gray-600 hover:bg-gray-700 cursor-pointer transition flex justify-between items-center group";
                div.onclick = () => selectSkillForEdit(skill);
                
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-blue-300 group-hover:text-white">${skill.name}</div>
                        <div class="text-[10px] text-gray-500">ID: ${skill.skill_id} | Lv.${skill.min_level}</div>
                    </div>
                    <div class="text-[10px] font-bold px-2 py-1 rounded bg-black/30 border border-gray-600 text-gray-400">
                        ${skill.skill_type}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 2. Hi·ªÉn th·ªã danh s√°ch l√™n c·ªôt tr√°i
        function renderSkillList(skills) {
            const listContainer = document.getElementById('admin-skill-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            if (skills.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-10 text-gray-500 text-sm">Ch∆∞a c√≥ k·ªπ nƒÉng n√†o.</div>';
                return;
            }
            skills.forEach(skill => {
                const color = skill.class_type === 'WARRIOR' ? 'text-red-400' : 'text-blue-400';
                const card = document.createElement('div');
                card.className = "p-3 bg-gray-900/40 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-all mb-2";
                card.onclick = () => selectSkillForEdit(skill);
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold ${color}">${skill.name}</span>
                        <span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-800 text-gray-400 border border-gray-600 uppercase">${skill.skill_type}</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1 italic">ID: ${skill.skill_id} | S·ª©c m·∫°nh: x${skill.config.base_mult || 0}</p>
                `;
                listContainer.appendChild(card);
            });
        }

        // 3. ƒê·ªï d·ªØ li·ªáu v√†o Form
        // H√ÄM M·ªû FORM S·ª¨A (ƒê√£ Fix l·ªói null d√≤ng scaling)
        function selectSkillForEdit(skill) {
            console.log(`üìù ƒêang s·ª≠a skill: ${skill.name}`);

            // 1. HELPER: H√†m ƒëi·ªÅn d·ªØ li·ªáu an to√†n (T·ª± t√¨m ID ho·∫∑c edit-ID)
            const setSafeVal = (idSuffix, value) => {
                // Th·ª≠ t√¨m id th∆∞·ªùng (vd: skill-mult) ho·∫∑c id c√≥ edit- (vd: edit-skill-mult)
                const el = document.getElementById(idSuffix) || document.getElementById('edit-' + idSuffix);
                if (el) {
                    el.value = (value === undefined || value === null) ? '' : value;
                } else {
                    // console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu cho: ${idSuffix}`);
                }
            };

            // 2. ·∫®n m√†n h√¨nh ch·ªù, hi·ªán Form
            const emptyScreen = document.getElementById('skill-editor-empty');
            const formScreen = document.getElementById('skill-editor-form');
            if (emptyScreen) emptyScreen.classList.add('hidden');
            if (formScreen) {
                formScreen.classList.remove('hidden');
                // L∆∞u ID skill ƒëang s·ª≠a v√†o dataset
                formScreen.dataset.currentSkillId = skill.skill_id;
            }

            // 3. ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
            const displayId = document.getElementById('display-skill-id');
            if (displayId) displayId.innerText = `ID: ${skill.skill_id}`;

            // D√πng h√†m setSafeVal thay v√¨ document.getElementById(...).value c·ª©ng nh·∫Øc
            setSafeVal('skill-name', skill.name);
            setSafeVal('skill-description', skill.description); // <--- D√≤ng n√†y hay g√¢y l·ªói nh·∫•t n·∫øu thi·∫øu √¥ m√¥ t·∫£
            setSafeVal('skill-type', skill.skill_type || "ACTIVE");
            setSafeVal('skill-min-level', skill.min_level || 1);
            setSafeVal('skill-prereq', skill.prerequisite_id || '');
            setSafeVal('skill-class', skill.class_type || "WARRIOR");

            // 4. X·ª¨ L√ù CONFIG (JSON)
            let c = skill.config_data || skill.config || {};
            if (typeof c === 'string') { 
                try { c = JSON.parse(c); } catch(e) { c = {}; } 
            }

            // --- A. LOAD ƒêI·ªÄU KI·ªÜN & NG∆Ø·ª†NG ---
            setSafeVal('passive-condition', c.condition || 'always');
            
            // X·ª≠ l√Ω ng∆∞·ª°ng (0.5 -> 50)
            const threshVal = (c.threshold || 0) * 100;
            setSafeVal('passive-threshold', threshVal);

            // --- B. LOAD S·ª®C M·∫†NH G·ªêC ---
            let displayMult = c.base_mult;
            if (skill.skill_type === 'PASSIVE') {
                displayMult = (c.value !== undefined) ? c.value : 0;
            } else {
                if (displayMult === undefined || displayMult === null) displayMult = 1.0;
            }
            setSafeVal('skill-mult', displayMult); // <--- Fix l·ªói d√≤ng 4666 ti·ªÅm nƒÉng

            // --- C. C√ÅC CH·ªà S·ªê PH·ª§ ---
            setSafeVal('skill-vfx', c.vfx_class || '');
            setSafeVal('skill-currency', c.currency || 'TRI_THUC');
            setSafeVal('skill-cost', c.base_cost !== undefined ? c.base_cost : 100);

            // ============================================================
            // üëá LOAD D·ªÆ LI·ªÜU H·ªíI M√ÅU (SAFE MODE) üëá
            // ============================================================
            
            // Reset tr∆∞·ªõc
            setSafeVal('passive-effect-type', 'none');
            setSafeVal('passive-heal-percent', '');
            setSafeVal('passive-heal-flat', '');

            if (skill.skill_type === 'PASSIVE') {
                const hasHealData = (c.effect_type === 'heal') || 
                                    (c.heal_percent && c.heal_percent > 0) || 
                                    (c.heal_flat && c.heal_flat > 0);

                if (hasHealData) {
                    setSafeVal('passive-effect-type', 'heal');
                    setSafeVal('passive-heal-percent', c.heal_percent || 0);
                    setSafeVal('passive-heal-flat', c.heal_flat || 0);
                }
            }
            // ============================================================

            console.log(`üìù ƒêang s·ª≠a: ${skill.name} (Ch·∫ø ƒë·ªô Safe Mode)`);
        }

        // --- H√ÄM M·ªû FORM T·∫†O M·ªöI (ƒê√£ c·∫≠p nh·∫≠t: B·ªè Scaling) ---
        function openNewSkillForm() {
            // 1. ·∫®n m√†n h√¨nh ch·ªù, hi·ªán Form
            document.getElementById('skill-editor-empty').classList.add('hidden');
            document.getElementById('skill-editor-form').classList.remove('hidden');

            // 2. Reset c√°c √¥ nh·∫≠p li·ªáu v·ªÅ m·∫∑c ƒë·ªãnh
            document.getElementById('edit-skill-name').value = '';
            
            // N·∫øu c√≥ √¥ m√¥ t·∫£ th√¨ reset lu√¥n cho s·∫°ch
            if(document.getElementById('edit-skill-description')) {
                document.getElementById('edit-skill-description').value = '';
            }
            
            document.getElementById('edit-skill-type').value = 'ACTIVE';
            document.getElementById('edit-skill-min-level').value = '1';
            document.getElementById('edit-skill-prereq').value = '';
            // Reset v·ªÅ filter hi·ªán t·∫°i cho ti·ªán
            document.getElementById('edit-skill-class').value = currentFilter;
            
            // ƒê·∫∑t th√¥ng s·ªë m·∫∑c ƒë·ªãnh cho ƒë·ª° ph·∫£i nh·∫≠p nhi·ªÅu
            document.getElementById('edit-skill-mult').value = '1.5';
            document.getElementById('edit-skill-vfx').value = 'fx-fireball'; // G·ª£i √Ω s·∫µn 1 c√°i cho ti·ªán
            document.getElementById('edit-skill-currency').value = 'TRI_THUC';
            
            // üëá QUAN TR·ªåNG: Reset gi√° ti·ªÅn v·ªÅ 100
            if(document.getElementById('edit-skill-cost')) {
                document.getElementById('edit-skill-cost').value = '100';
            }


            // 3. X√≥a ID c≈© trong dataset ƒë·ªÉ l√∫c L∆∞u h·ªá th·ªëng bi·∫øt l√† T·∫°o M·ªõi
            document.getElementById('skill-editor-form').dataset.currentSkillId = "";

            // 4. C·∫≠p nh·∫≠t nh√£n hi·ªÉn th·ªã
            document.getElementById('display-skill-id').innerText = "ID: (T·ª± ƒë·ªông t·∫°o)";
            
            console.log("‚ú® ƒê√£ m·ªü form t·∫°o m·ªõi");
        }

        // --- H√ÄM L∆ØU K·ª∏ NƒÇNG (PHI√äN B·∫¢N SAFE MODE - CH·ªêNG L·ªñI NULL) ---
        async function saveSkill() {
            console.log("üíæ B·∫Øt ƒë·∫ßu l∆∞u Skill...");

            // 1. HELPER: H√†m t·ª± ƒë·ªông t√¨m ID (D√π c√≥ ch·ªØ 'edit-' hay kh√¥ng)
            const getSafeVal = (idSuffix, type = 'string') => {
                const id1 = idSuffix;           // V√≠ d·ª•: passive-condition
                const id2 = 'edit-' + idSuffix; // V√≠ d·ª•: edit-passive-condition
                const el = document.getElementById(id1) || document.getElementById(id2);
                
                if (!el) {
                    // console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y: ${id1} ho·∫∑c ${id2}`);
                    return type === 'number' ? 0 : (type === 'value' ? null : "");
                }
                
                if (type === 'number') return parseFloat(el.value) || 0;
                if (type === 'int') return parseInt(el.value) || 0;
                return el.value;
            };

            // 2. L·∫§Y D·ªÆ LI·ªÜU C∆† B·∫¢N
            const name = getSafeVal('skill-name');
            if (!name && !document.getElementById('edit-skill-name').value) return alert("Vui l√≤ng nh·∫≠p t√™n k·ªπ nƒÉng!");

            const costVal = getSafeVal('skill-cost', 'int');
            const skillType = getSafeVal('skill-type');
            const inputMult = getSafeVal('skill-mult', 'number');
            const vfxClass = getSafeVal('skill-vfx');

            // 3. T·∫†O CONFIG DATA & LOGIC PASSIVE
            let configData = {
                vfx_class: vfxClass,
                base_cost: costVal
            };

            let finalBaseMult = 0; 
            let finalTarget = "enemy";

            if (skillType === 'PASSIVE') {
                // --- PASSIVE ---
                finalBaseMult = 0;      
                finalTarget = "self";

                // L·∫•y th√¥ng tin (D√πng h√†m an to√†n, kh√¥ng s·ª£ sai ID)
                const condition = getSafeVal('passive-condition'); 
                
                // Input th∆∞·ªùng nh·∫≠p 50 (%), ta chia 100 ƒë·ªÉ l∆∞u 0.5
                // N·∫øu input c·ªßa b·∫°n ƒë√£ l√† 0.5 th√¨ b·ªè d√≤ng /100 ƒëi
                let rawThresh = getSafeVal('passive-threshold', 'number');
                const threshold = rawThresh > 1 ? rawThresh / 100 : rawThresh;

                // L·∫•y th√¥ng tin H·ªìi M√°u
                const effectType = getSafeVal('passive-effect-type');
                let healPercent = 0;
                let healFlat = 0;

                if (effectType === 'heal' || effectType === 'heal_and_buff') {
                    healPercent = getSafeVal('passive-heal-percent', 'number');
                    healFlat = getSafeVal('passive-heal-flat', 'int');
                }

                // ƒê√≥ng g√≥i
                configData.type = "passive_conditional"; 
                configData.condition = condition;
                configData.threshold = threshold;
                configData.value = inputMult; // % Buff Damage
                configData.effect_type = effectType; 
                configData.heal_percent = healPercent; 
                configData.heal_flat = healFlat; 

            } else {
                // --- ACTIVE ---
                finalBaseMult = inputMult;
                finalTarget = "enemy";
                configData.type = "active_damage";
                configData.base_mult = inputMult;
            }

            // 4. T·∫†O PAYLOAD
            const formEl = document.getElementById('skill-editor-form');
            const currentID = formEl ? formEl.dataset.currentSkillId : null;

            const payload = {
                skill_id: currentID || name.toUpperCase().replace(/\s+/g, '_'),
                name: name,
                description: getSafeVal('skill-description'),
                class_type: getSafeVal('skill-class'),
                
                skill_type: skillType, 
                min_level: getSafeVal('skill-min-level', 'int') || 1,
                prerequisite_id: getSafeVal('skill-prereq').trim(),
                
                // C√°c tr∆∞·ªùng c≈©
                base_mult: finalBaseMult,   
                base_cost: costVal,
                vfx_class: vfxClass,
                vfx_target: finalTarget,
                currency: getSafeVal('skill-currency'),

                // Config JSON
                config_data: JSON.stringify(configData) 
            };

            console.log("üì¶ Payload:", payload);

            // 5. G·ª¨I API
            try {
                const response = await fetch('/admin/save-skill', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || "L∆∞u th√†nh c√¥ng!");
                    const modal = document.getElementById('skill-editor-modal');
                    if (modal) modal.classList.add('hidden');
                    if(typeof loadAdminSkills === 'function') loadAdminSkills();
                } else {
                    alert("‚ùå L·ªói Server: " + (result.detail || "Kh√¥ng x√°c ƒë·ªãnh"));
                }
            } catch (error) { 
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi!"); 
            }
        }

        // 5. Test VFX
        // H√ÄM TEST VFX (PHI√äN B·∫¢N COMBO: METEOR + EXPLODE)
        function testVFX() {
            const vfxInput = document.getElementById('edit-skill-vfx');
            const vfxName = vfxInput ? vfxInput.value.trim() : '';

            if (!vfxName) return alert("‚ö†Ô∏è H√£y nh·∫≠p t√™n class VFX!");

            // X√≥a d·∫•u ch·∫•m
            const className = vfxName.replace('.', '');
            const preview = document.createElement('div');
            preview.className = className;

            // --- LOGIC X·ª¨ L√ù ---
            if (className === 'fx-meteor') {
                // 1. CHO THI√äN TH·∫†CH BAY
                document.body.appendChild(preview);
                console.log("‚òÑÔ∏è Thi√™n th·∫°ch ƒëang bay...");

                // 2. H·∫∏N GI·ªú N·ªî (Chain Reaction)
                setTimeout(() => {
                    spawnExplosion();
                }, 900);
                
            } // <--- üõë B·∫†N B·ªä THI·∫æU D·∫§U ƒê√ìNG NGO·∫∂C N√ÄY ·ªû CODE C≈®

            // --- CASE 2: C·ªòT L·ª¨A (Quay v·ªÅ nguy√™n b·∫£n) ---
            else if (className === 'fx-flame-pillar') {
                // V·ªã tr√≠ chu·∫©n: Ch√¢n qu√°i v·∫≠t
                preview.style.position = 'fixed';
                preview.style.left = '65%'; 
                preview.style.top = '65%'; 
                
                
                document.body.appendChild(preview);
                console.log("üî• C·ªôt l·ª≠a tri·ªáu h·ªìi!"); 
            }
            
            // 3. C√ÅC SKILL KH√ÅC
            else {
                // C√°c skill kh√°c (Fireball, Heal...)
                preview.style.position = 'fixed';
                preview.style.top = '50%';
                preview.style.left = '50%';
                preview.style.transform = 'translate(-50%, -50%) scale(2)';
                preview.style.zIndex = '99999';
                document.body.appendChild(preview);
            }

            // X√≥a hi·ªáu ·ª©ng ch√≠nh sau khi ch·∫°y xong
            setTimeout(() => preview.remove(), 2000);
        }

        // H√ÄM PH·ª§: T·∫†O V·ª§ N·ªî (Gi·ªØ nguy√™n, kh√¥ng l·ªói)
        function spawnExplosion() {
            const boom = document.createElement('div');
            boom.className = 'fx-explode'; 
            boom.style.top = '55%';
            boom.style.left = '65%';
            boom.style.transform = 'translate(-30%, -30%) scale(1.5)'; 
            
            document.body.appendChild(boom);
            console.log("üí• B√ôM!");

            setTimeout(() => boom.remove(), 600);
        }
        
        // --- LOGIC QU·∫¢N L√ù DANH HI·ªÜU ---

        // 1. Load danh s√°ch
        async function loadTitles() {
            const tbody = document.getElementById('titles-list-body');
            if(!tbody) return; // N·∫øu ƒëang ·ªü trang kh√°c ko c√≥ b·∫£ng n√†y th√¨ b·ªè qua

            try {
                const res = await fetch('/admin/titles');
                const titles = await res.json();

                if (titles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">Ch∆∞a c√≥ danh hi·ªáu n√†o.</td></tr>';
                    return;
                }

                tbody.innerHTML = titles.map(t => `
                    <tr class="hover:bg-gray-700/50 transition">
                        <td class="p-4 font-mono text-yellow-500 font-bold">${t.min_kpi}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded border bg-opacity-20 text-sm font-bold" 
                                style="color:${t.color}; border-color:${t.color}; background-color:${t.color}20">
                                ${t.name}
                            </span>
                        </td>
                        <td class="p-4 flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color:${t.color}"></div>
                            <span class="text-xs text-gray-500">${t.color}</span>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="deleteTitle(${t.id})" class="text-red-400 hover:text-red-200 transition bg-red-900/20 p-2 rounded hover:bg-red-900/50">
                                <i class="fas fa-trash-alt"></i> X√≥a
                            </button>
                        </td>
                    </tr>
                `).join('');

                // ƒê·ªìng b·ªô m√†u input trong modal (ch·ª©c nƒÉng ph·ª•)
                document.getElementById('inp-title-color').onchange = function() {
                    document.getElementById('inp-title-color-text').value = this.value;
                }

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">L·ªói k·∫øt n·ªëi!</td></tr>';
            }
        }

        // 2. G·ª≠i l·ªánh t·∫°o m·ªõi
        async function createTitleSubmit() {
            const name = document.getElementById('inp-title-name').value;
            const kpi = document.getElementById('inp-title-kpi').value;
            const color = document.getElementById('inp-title-color-text').value;

            if (!name || !kpi) {
                alert("Vui l√≤ng nh·∫≠p t√™n v√† KPI!");
                return;
            }

            try {
                const res = await fetch('/admin/titles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, min_kpi: parseInt(kpi), color })
                });

                const data = await res.json();
                if (res.ok) {
                    alert("‚úÖ T·∫°o th√†nh c√¥ng!");
                    document.getElementById('modal-create-title').classList.add('hidden');
                    loadTitles(); // T·∫£i l·∫°i b·∫£ng
                } else {
                    alert("‚ùå L·ªói: " + data.detail);
                }
            } catch (e) {
                alert("L·ªói h·ªá th·ªëng!");
            }
        }

        // 3. X√≥a
        async function deleteTitle(id) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a danh hi·ªáu n√†y?")) return;
            try {
                await fetch(`/admin/titles/${id}`, { method: 'DELETE' });
                loadTitles();
            } catch(e) {
                alert("L·ªói khi x√≥a!");
            }
        }

        // --- H√ÄM ƒêƒÇNG XU·∫§T admin---
        function logoutAdmin() {
            // 1. H·ªèi l·∫°i cho ch·∫Øc (tr√°nh b·∫•m nh·∫ßm)
            if (!confirm("S·∫øp c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang qu·∫£n tr·ªã kh√¥ng?")) {
                return; 
            }

            // 2. X√≥a s·∫°ch d·∫•u v·∫øt trong kho l∆∞u tr·ªØ
            localStorage.removeItem("access_token"); // Quan tr·ªçng nh·∫•t: X√≥a ch√¨a kh√≥a v√†o c·ª≠a
            localStorage.removeItem("user_info");    // X√≥a th√¥ng tin c√° nh√¢n
            localStorage.removeItem("username");     // X√≥a t√™n ƒëƒÉng nh·∫≠p
            localStorage.removeItem("kpi_role");     // X√≥a vai tr√≤ (n·∫øu c√≥ l∆∞u)

            // 3. ƒê√° vƒÉng v·ªÅ trang ch·ªß
            alert("üëã ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng! H·∫πn g·∫∑p l·∫°i S·∫øp.");
            window.location.href = "index.html";
        }

        // --- LOGIC QU·∫¢N L√ù L√îI ƒê√ÄI ---
        async function loadAdminArenaData() {
            const pendingTable = document.getElementById('admin-pending-matches-body');
            const historyTable = document.getElementById('admin-match-history-body');
            const token = localStorage.getItem('access_token');

            try {
                // G·ª≠i y√™u c·∫ßu ƒë·∫øn API g·ªôp m·ªõi
                const res = await fetch('/admin/arena/data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                if (!result.success) {
                    console.error("L·ªói t·ª´ Server:", result.message);
                    return;
                }

                // 1. V·∫Ω b·∫£ng Pending (ƒêang treo)
                if (pendingTable) { // Ki·ªÉm tra k·ªπ xem th·∫ª c√≥ t·ªìn t·∫°i kh√¥ng
                    pendingTable.innerHTML = '';
                    if (!result.pending || result.pending.length === 0) {
                        pendingTable.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 italic">Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o ƒëang treo.</td></tr>';
                    } else {
                        result.pending.forEach(m => {
                            const timeStr = new Date(m.created_at).toLocaleString('vi-VN');
                            pendingTable.innerHTML += `
                                <tr class="border-b border-gray-700/50 hover:bg-gray-700/30 transition">
                                    <td class="p-3 text-yellow-500 font-mono">#${m.id}</td>
                                    <td class="p-3 text-white font-bold">${m.created_by}</td>
                                    <td class="p-3 text-center text-red-400 font-mono">${m.bet_amount} KPI</td>
                                    <td class="p-3 text-gray-400 text-sm">${timeStr}</td>
                                    <td class="p-3 text-right">
                                        <button onclick="adminCancelMatch(${m.id})" class="bg-red-900/30 text-red-500 border border-red-900/50 px-3 py-1 rounded hover:bg-red-900 transition text-xs font-bold">
                                            <i class="fas fa-trash-alt mr-1"></i> H·ª¶Y
                                        </button>
                                    </td>
                                </tr>`;
                        });
                    }
                }

                // 2. V·∫Ω b·∫£ng History (L·ªãch s·ª≠)
                if (historyTable) { // Ki·ªÉm tra k·ªπ xem th·∫ª c√≥ t·ªìn t·∫°i kh√¥ng
                    historyTable.innerHTML = '';
                    if (!result.history || result.history.length === 0) {
                        historyTable.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 italic">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫•u.</td></tr>';
                    } else {
                        result.history.forEach(m => {
                            const timeStr = new Date(m.created_at).toLocaleString('vi-VN');
                            // Logic m√†u s·∫Øc ƒë·ªôi th·∫Øng
                            let winnerDisplay = '<span class="text-gray-500">H√≤a</span>';
                            if (m.winner_team === 'A') winnerDisplay = '<span class="text-blue-400 font-black">ƒê·ªôi A Th·∫Øng</span>';
                            if (m.winner_team === 'B') winnerDisplay = '<span class="text-orange-400 font-black">ƒê·ªôi B Th·∫Øng</span>';

                            historyTable.innerHTML += `
                                <tr class="border-b border-gray-700/50 hover:bg-gray-700/30 transition">
                                    <td class="p-3 text-gray-500">#${m.id}</td>
                                    <td class="p-3 text-gray-300 font-bold">${m.mode || 'Th∆∞·ªùng'}</td>
                                    <td class="p-3 text-center">${winnerDisplay}</td>
                                    <td class="p-3 text-gray-400 text-sm">${timeStr}</td>
                                    <td class="p-3 text-right">
                                        <button onclick="viewMatchResult(${m.id})" class="text-blue-400 hover:text-blue-300 font-bold text-xs">
                                            <i class="fas fa-eye mr-1"></i> CHI TI·∫æT
                                        </button>
                                    </td>
                                </tr>`;
                        });
                    }
                }
            } catch (err) {
                console.error("L·ªói k·∫øt n·ªëi API Arena:", err);
            }
        }

        // H√†m h·ªßy tr·∫≠n ƒë·∫•u
        async function adminCancelMatch(matchId) {
            if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y tr·∫≠n ƒë·∫•u #${matchId}?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/admin/arena/cancel/${matchId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    loadAdminArenaData(); // T·∫£i l·∫°i b·∫£ng
                }
            } catch (err) {
                alert("L·ªói khi h·ªßy tr·∫≠n!");
            }
        }


        // H√†m qu·∫£n l√Ω th√¥ng b√°o 
        // 1. H√†m t·∫£i danh s√°ch th√¥ng b√°o t·ª´ Server
        // 1. H√†m t·∫£i danh s√°ch th√¥ng b√°o (PHI√äN B·∫¢N C√ì N√öT X√ìA R√ï R√ÄNG)
        async function loadNotifications() {
            console.log("üîÑ ƒêang t·∫£i danh s√°ch th√¥ng b√°o...");
            try {
                const res = await fetch('/api/noti/all');
                if (!res.ok) {
                    console.error("L·ªói API:", res.status);
                    return;
                }
                const data = await res.json();
                
                const marqueeList = document.getElementById('marquee-list');
                const popupList = document.getElementById('popup-list');
                
                // X√≥a danh s√°ch c≈©
                marqueeList.innerHTML = ''; 
                popupList.innerHTML = '';

                if (data.length === 0) {
                    const emptyMsg = '<div class="text-gray-500 text-sm italic p-2 text-center">Ch∆∞a c√≥ th√¥ng b√°o n√†o.</div>';
                    marqueeList.innerHTML = emptyMsg;
                    popupList.innerHTML = emptyMsg;
                }

                data.forEach(n => {
                    // Style cho tr·∫°ng th√°i Active
                    const isActiveClass = n.is_active 
                        ? 'border-green-500 bg-gray-700/50' 
                        : 'border-red-500 bg-gray-800 opacity-60';
                    
                    // N√∫t B·∫≠t/T·∫Øt: Thay ƒë·ªïi m√†u v√† ch·ªØ d·ª±a tr√™n tr·∫°ng th√°i
                    const toggleBtnHtml = n.is_active
                        ? `<button onclick="toggleNoti(${n.id})" class="px-3 py-1 bg-green-900/30 hover:bg-green-800 text-green-400 border border-green-700 rounded text-xs font-bold transition">B·∫¨T</button>`
                        : `<button onclick="toggleNoti(${n.id})" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-400 border border-gray-500 rounded text-xs font-bold transition">T·∫ÆT</button>`;

                    const html = `
                        <div class="flex justify-between items-center p-3 rounded mb-2 border-l-4 ${isActiveClass} shadow-sm hover:bg-gray-700 transition group">
                            <div class="flex-1 mr-3">
                                <div class="text-xs text-gray-400 mb-1">${new Date(n.created_at).toLocaleString()}</div>
                                <div class="text-gray-200 font-medium break-all text-sm">${n.content}</div>
                            </div>

                            <div class="flex items-center gap-2 shrink-0">
                                ${toggleBtnHtml}
                                
                                <button onclick="deleteNoti(${n.id})" class="px-3 py-1 bg-red-900/20 hover:bg-red-900 text-red-400 border border-red-800 rounded text-xs font-bold transition flex items-center">
                                    <span class="mr-1">X√ìA</span> 
                                    <i class="fas fa-trash text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    if (n.type === 'marquee') marqueeList.insertAdjacentHTML('beforeend', html);
                    else popupList.insertAdjacentHTML('beforeend', html);
                });

            } catch (error) {
                console.error("‚ùå L·ªói t·∫£i th√¥ng b√°o:", error);
            }
        }

        // 2. H√†m Th√™m M·ªõi
        async function addNotification(type) {
            const inputId = type === 'marquee' ? 'marquee-input' : 'popup-input';
            const input = document.getElementById(inputId);
            const content = input.value.trim();
            
            if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

            try {
                const res = await fetch('/api/noti/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, content, is_active: true })
                });

                if (res.ok) {
                    // Reset √¥ nh·∫≠p v√† t·∫£i l·∫°i danh s√°ch ngay l·∫≠p t·ª©c
                    input.value = '';
                    await loadNotifications(); 
                    alert("‚úÖ Th√™m th√†nh c√¥ng!");
                } else {
                    alert("‚ùå L·ªói server: " + res.status);
                }
            } catch (e) {
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi!");
            }
        }

        // 3. H√†m X√≥a
        async function deleteNoti(id) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng b√°o n√†y?")) return;
            await fetch(`/api/noti/delete/${id}`, { method: 'DELETE' });
            loadNotifications(); // Reload l·∫°i sau khi x√≥a
        }

        // 4. H√†m B·∫≠t/T·∫Øt
        async function toggleNoti(id) {
            await fetch(`/api/noti/toggle/${id}`, { method: 'PUT' });
            loadNotifications(); // Reload l·∫°i sau khi ƒë·ªïi tr·∫°ng th√°i
        }

        // --- LOGIC C·∫§U H√åNH CHARM & FORGE ---

        // 1. H√†m Load Config (Ch·∫°y khi m·ªü tab ho·∫∑c m·ªü trang)
        async function loadSystemConfig() {
            try {
                const res = await fetch('/admin/get-system-config');
                const data = await res.json();
                
                // --- ƒêI·ªÄN D·ªÆ LI·ªÜU CHARM ---
                if (data.charm_setup) {
                    const c = data.charm_setup;
                    // Magic
                    document.getElementById('magic-atk-min').value = c.MAGIC.atk_range[0];
                    document.getElementById('magic-atk-max').value = c.MAGIC.atk_range[1];
                    document.getElementById('magic-hp-min').value = c.MAGIC.hp_range[0];
                    document.getElementById('magic-hp-max').value = c.MAGIC.hp_range[1];
                    
                    // Epic
                    document.getElementById('epic-atk-min').value = c.EPIC.atk_range[0];
                    document.getElementById('epic-atk-max').value = c.EPIC.atk_range[1];
                    document.getElementById('epic-hp-min').value = c.EPIC.hp_range[0];
                    document.getElementById('epic-hp-max').value = c.EPIC.hp_range[1];

                    // Legend
                    document.getElementById('legend-atk-min').value = c.LEGEND.atk_range[0];
                    document.getElementById('legend-atk-max').value = c.LEGEND.atk_range[1];
                    document.getElementById('legend-hp-min').value = c.LEGEND.hp_range[0];
                    document.getElementById('legend-hp-max').value = c.LEGEND.hp_range[1];
                }

                // --- ƒêI·ªÄN D·ªÆ LI·ªÜU FORGE ---
                if (data.forge_setup) {
                    const f = data.forge_setup;
                    // Group 1
                    document.getElementById('forge-g1-rate').value = f.group_1.rate;
                    document.getElementById('forge-g1-stone').value = f.group_1.stone;
                    document.getElementById('forge-g1-bonus').value = f.group_1.bonus_pct;

                    // Group 2
                    document.getElementById('forge-g2-rate').value = f.group_2.rate;
                    document.getElementById('forge-g2-stone').value = f.group_2.stone;
                    document.getElementById('forge-g2-bonus').value = f.group_2.bonus_pct;

                    // Group 3
                    document.getElementById('forge-g3-rate').value = f.group_3.rate;
                    document.getElementById('forge-g3-stone').value = f.group_3.stone;
                    document.getElementById('forge-g3-bonus').value = f.group_3.bonus_pct;
                }

            } catch (e) {
                console.error("L·ªói load config:", e);
                // N·∫øu l·ªói th√¨ ƒëi·ªÅn m·∫∑c ƒë·ªãnh ƒë·ªÉ admin ƒë·ª° ph·∫£i g√µ t·ª´ ƒë·∫ßu
                fillDefaultConfig();
            }
        }

        // 2. H√†m L∆∞u Config
        async function saveSystemConfig() {
            // Helper l·∫•y s·ªë
            const num = (id) => parseInt(document.getElementById(id).value) || 0;

            const payload = {
                charm_data: {
                    MAGIC: { 
                        lines: 1, 
                        atk_range: [num('magic-atk-min'), num('magic-atk-max')],
                        hp_range: [num('magic-hp-min'), num('magic-hp-max')]
                    },
                    EPIC: { 
                        lines: 2, 
                        atk_range: [num('epic-atk-min'), num('epic-atk-max')],
                        hp_range: [num('epic-hp-min'), num('epic-hp-max')]
                    },
                    LEGEND: { 
                        lines: 2, 
                        atk_range: [num('legend-atk-min'), num('legend-atk-max')],
                        hp_range: [num('legend-hp-min'), num('legend-hp-max')]
                    }
                },
                forge_data: {
                    group_1: { min:0, max:3, rate: num('forge-g1-rate'), stone: num('forge-g1-stone'), bonus_pct: num('forge-g1-bonus') },
                    group_2: { min:3, max:7, rate: num('forge-g2-rate'), stone: num('forge-g2-stone'), bonus_pct: num('forge-g2-bonus') },
                    group_3: { min:7, max:10, rate: num('forge-g3-rate'), stone: num('forge-g3-stone'), bonus_pct: num('forge-g3-bonus') }
                }
            };

            try {
                const res = await fetch('/admin/save-system-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                alert(result.message || "ƒê√£ l∆∞u th√†nh c√¥ng!");
            } catch (e) {
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        // Helper: ƒêi·ªÅn s·ªë m·∫∑c ƒë·ªãnh n·∫øu DB tr·ªëng
        function fillDefaultConfig() {
            // Magic
            document.getElementById('magic-atk-min').value = 10; document.getElementById('magic-atk-max').value = 50;
            document.getElementById('magic-hp-min').value = 100; document.getElementById('magic-hp-max').value = 500;
            // Forge G1
            document.getElementById('forge-g1-rate').value = 100;
            document.getElementById('forge-g1-stone').value = 1;
            document.getElementById('forge-g1-bonus').value = 10;
        }


        // --- KH·ªûI T·∫†O KHI TRANG LOAD XONG ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ Admin Panel Loaded");

            // 1. G√ÅN S·ª∞ KI·ªÜN CHO FORM TI·ªÜM T·∫†P H√ìA (ƒê√£ g·ªôp v√†o ƒë√¢y ƒë·ªÉ tr√°nh l·ªói null)
            const itemForm = document.getElementById('item-form');
            if (itemForm) {
                itemForm.onsubmit = async function(e) {
                    e.preventDefault();
                    
                    const actionType = document.getElementById('item-action-type').value;
                    if (actionType === 'none') { 
                        alert("Vui l√≤ng ch·ªçn ch·ª©c nƒÉng cho v·∫≠t ph·∫©m!"); 
                        return; 
                    }

                    // Thu th·∫≠p th√¥ng tin c∆° b·∫£n
                    const itemData = {
                        name: document.getElementById('item-name').value,
                        image_url: document.getElementById('item-img').value,
                        description: document.getElementById('item-desc').value,
                        currency_type: document.getElementById('item-currency').value,
                        price: parseInt(document.getElementById('item-price').value) || 0,
                        is_hidden: document.getElementById('item-hidden').value === "true",
                        limit_type: parseInt(document.getElementById('item-limit').value),
                        config: "" 
                    };

                    // Thu th·∫≠p "T∆∞ duy Logic"
                    let configObj = { action: actionType };

                    if (actionType === 'heal' || actionType === 'reset_cooldown') {
                        configObj.value = parseInt(document.getElementById('logic-value')?.value || 0);
                    } 
                    else if (actionType === 'add_currency') {
                        configObj.type = document.getElementById('logic-currency-type').value;
                        configObj.value = parseInt(document.getElementById('logic-value').value);
                    }
                    else if (actionType === 'gacha_open') {
                        const rows = document.querySelectorAll('#gacha-items-list > div');
                        configObj.pool = Array.from(rows).map(row => ({
                            id: row.querySelector('.gacha-item-id').value,
                            rate: parseInt(row.querySelector('.gacha-item-rate').value) || 0
                        })).filter(entry => entry.id !== ""); 
                    }

                    itemData.config = JSON.stringify(configObj);

                    // G·ª≠i d·ªØ li·ªáu l√™n Server
                    try {
                        const res = await fetch('/admin/shop/items/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(itemData)
                        });
                        
                        if (res.ok) {
                            alert(actionType === 'gacha_open' ? "üì¶ ƒê√£ ƒë√≥ng g√≥i R∆∞∆°ng th√†nh c√¥ng!" : "‚úÖ ƒê√£ t·∫°o V·∫≠t ph·∫©m th√†nh c√¥ng!");
                            closeItemModal();
                            if (typeof loadShopItems === 'function') loadShopItems();
                        }
                    } catch (err) {
                        alert("L·ªói k·∫øt n·ªëi Server!");
                    }
                };
            }

            // 2. C√ÅC S·ª∞ KI·ªÜN CHO BOSS
            const bossImgInput = document.getElementById('boss-img');
            const bossAnimSelect = document.getElementById('boss-anim');
            const bossVfxSelect = document.getElementById('boss-vfx');

            if (bossImgInput) bossImgInput.addEventListener('input', updateBossPreview);
            if (bossAnimSelect) bossAnimSelect.addEventListener('change', updateBossPreview);
            if (bossVfxSelect) bossVfxSelect.addEventListener('change', updateBossPreview);
            
            if (typeof updateBossPreview === 'function') updateBossPreview();

            // 3. N·∫†P D·ªÆ LI·ªÜU BAN ƒê·∫¶U
            if (typeof loadPlayersToSelect === 'function') loadPlayersToSelect();
            if (typeof loadItemsToSelect === 'function') loadItemsToSelect();
            if (typeof loadItemsForBossSelect === 'function') loadItemsForBossSelect();
            if (typeof loadSavedTowerConfig === 'function') loadSavedTowerConfig();
            if (typeof loadAdminSkills === 'function') loadAdminSkills();
            if (typeof loadOverview === 'function') {
                loadOverview(); 
            } else {
                console.warn("‚ö†Ô∏è Ch∆∞a t√¨m th·∫•y h√†m loadOverview!");
            }
            if (typeof bindRateInputs === 'function') bindRateInputs();

            // 4. M·∫∂C ƒê·ªäNH V·ªÄ DASHBOARD
            if (typeof switchTab === 'function') switchTab('dashboard');
        });


        
    </script>
    <div id="add-member-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 shadow-2xl w-96 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                <i class="fa-solid fa-user-plus mr-2 text-green-400"></i>
                Th√™m v√†o T·ªï <span id="modal-target-team" class="text-yellow-500 ml-1">1</span>
            </h3>
            
            <p class="text-xs text-gray-400 mb-2">Ch·ªçn h·ªçc sinh mu·ªën th√™m v√†o t·ªï n√†y:</p>
            <select id="modal-student-select" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white focus:border-green-500 outline-none mb-6">
                <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
            </select>

            <div class="flex justify-end gap-3">
                <button onclick="closeAddMemberModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 font-medium transition">
                    H·ªßy b·ªè
                </button>
                <button onclick="submitAddMember()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold shadow-lg transition flex items-center">
                    <i class="fa-solid fa-check mr-2"></i> X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center sticky top-0 bg-gray-900 z-10">
                <h3 class="text-xl font-bold text-white" id="modal-title">T·∫°o V·∫≠t Ph·∫©m M·ªõi</h3>
                <button onclick="closeItemModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="item-form" class="p-6 space-y-4" onsubmit="handleFormSubmit(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">T√™n v·∫≠t ph·∫©m</label>
                        <input type="text" id="item-name" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white focus:border-pink-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">H√¨nh ·∫£nh (URL)</label>
                        <input type="text" id="item-img" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white focus:border-pink-500 outline-none" placeholder="https://...">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-400 text-sm mb-1">M√¥ t·∫£ v·∫≠t ph·∫©m</label>
                        <textarea id="item-desc" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white focus:border-pink-500 outline-none" placeholder="VD: H·ªìi ph·ª•c 500 m√°u ngay l·∫≠p t·ª©c..."></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Lo·∫°i ti·ªÅn</label>
                        <select id="item-currency" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white">
                            <option value="tri_thuc">Tri th·ª©c</option>
                            <option value="chien_tich">Chi·∫øn t√≠ch</option>
                            <option value="vinh_du">Vinh d·ª±</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Gi√° b√°n</label>
                        <input type="number" id="item-price" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white" value="0">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Tr·∫°ng th√°i</label>
                        <select id="item-hidden" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white">
                            <option value="false">ƒêang b√°n</option>
                            <option value="true">·∫®n (Kho)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Gi·ªõi h·∫°n mua</label>
                        <select id="item-limit" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2 text-white focus:border-pink-500 outline-none">
                            <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
                            <option value="1">Mua 1 l·∫ßn duy nh·∫•t</option>
                            <option value="2">M·ªói th√°ng 1 l·∫ßn</option>
                        </select>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 space-y-3">
                    <label class="block text-pink-400 font-bold text-sm underline">C·∫•u h√¨nh ch·ª©c nƒÉng (T∆∞ duy Logic)</label>
                    
                    <select id="item-action-type" onchange="toggleLogicFields()" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white">
                        <option value="none">-- Ch·ªçn ch·ª©c nƒÉng v·∫≠t ph·∫©m --</option>
                        <option value="heal">H·ªìi m√°u (HP)</option>
                        <option value="add_currency">Nh·∫≠n ti·ªÅn t·ªá/KPI</option>
                        <option value="enhance_stone">Nguy√™n li·ªáu: ƒê√° C∆∞·ªùng H√≥a</option>
                        <option value="reset_cooldown">X√≥a th·ªùi gian ch·ªù h·ªìi sinh</option>
                        <option value="gacha_open">R∆∞∆°ng Gacha (Quay v·∫≠t ph·∫©m)</option>
                        <option value="send_message">Thi·ªáp th√¥ng ƒëi·ªáp</option>
                    </select>

                    <div id="logic-fields" class="space-y-3 pt-2">
                        </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeItemModal()" class="px-6 py-2 text-gray-400 hover:text-white transition">H·ªßy</button>
                    <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white px-8 py-2 rounded-lg font-bold transition">L∆ØU V·∫¨T PH·∫®M</button>
                </div>
            </form>
        </div>
    </div>


</body>
</html>